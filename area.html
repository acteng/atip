<!DOCTYPE html>
<html>
  <head>
    <title>ATIP Area Intervention</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
    <script src="deps/geojson-extent.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.3.0/mapbox-gl-draw.js"></script>
    <link
      href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.3.0/mapbox-gl-draw.css"
      type="text/css"
    />
    <style>
      /* The map */
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }

      /* The sidebar */

      .rounded-rect {
        background: white;
        border-radius: 10px;
        box-shadow: 0 0 50px -25px black;
      }

      .flex-center {
        position: absolute;
        display: flex;
        align-items: center;
      }

      .flex-center.left {
        left: 0px;
      }

      .sidebar-content {
        position: absolute;
        width: 95%;
        height: 95%;
        flex-direction: column;
      }

      .sidebar-toggle {
        position: absolute;
        width: 1.3em;
        height: 1.3em;
        overflow: visible;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 32px;
      }

      .sidebar-toggle.left {
        right: -1.5em;
      }

      .sidebar-toggle:hover {
        color: #0aa1cf;
        cursor: pointer;
      }

      .sidebar {
        transition: transform 0.1s;
        z-index: 1;
        width: 300px;
        height: 100%;
      }

      .left.collapsed {
        transform: translateX(-295px);
      }

      /* The modal popup */
      .mapboxgl-popup {
        width: 600px;
        /* TODO Height seems responsive to content, can't make it take lots of the screen */
      }
    </style>
  </head>
  <body>
    <div id="map">
      <div id="left" class="sidebar flex-center left">
        <div class="sidebar-content rounded-rect flex-center">
          <a href="index.html">Back</a>
          <div
            class="sidebar-toggle rounded-rect left"
            onclick="document.getElementById('left').classList.toggle('collapsed')"
          >
            &rarr;
          </div>
        </div>
      </div>
    </div>

    <script>
      const authority = new URLSearchParams(window.location.search).get(
        "authority"
      );

      async function loadBoundary() {
        const resp = await fetch("authorities.geojson");
        const body = await resp.text();
        const geojson = JSON.parse(body);
        geojson.features = geojson.features.filter(
          (feature) => feature.properties.Name == authority
        );
        return geojson;
      }

      var map = new maplibregl.Map({
        container: "map",
        style:
          "https://api.maptiler.com/maps/streets/style.json?key=get_your_own_OpIi9ZULNHzrESv6T2vL",
      });

      map.on("load", async function () {
        const boundaryGeojson = await loadBoundary();

        const sidebar = document.getElementsByClassName("sidebar-content")[0];
        sidebar.innerHTML += `<h1>${authority}</h1>`;
        sidebar.innerHTML += `<i>Population (2020): ${boundaryGeojson.features[0].properties.Population_2020}</i>`;

        map.fitBounds(geojsonExtent(boundaryGeojson), {
          padding: 20,
          animate: false,
        });

        map.addSource("boundary", {
          type: "geojson",
          data: boundaryGeojson,
        });
        map.addLayer({
          id: "boundary",
          type: "line",
          source: "boundary",
          layout: {},
          paint: {
            "line-color": "black",
            "line-width": 3,
          },
        });

        map.addControl(
          new MapboxDraw({
            displayControlsDefault: false,
            controls: {
              polygon: true,
            },
          })
        );

        map.on("draw.create", function (e) {
          // closeOnClick is needed, because finishing drawing also counts as a click
          new maplibregl.Popup({ closeOnClick: false, maxWidth: "none" })
            // TODO Center on the new polygon?
            .setLngLat(e.features[0].geometry.coordinates[0][0])
            .setHTML(`<u>Fill out some stuff</u>`)
            .addTo(map);
        });
      });
    </script>
  </body>
</html>
