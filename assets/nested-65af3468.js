var zr=Object.defineProperty;var Ur=(r,e,t)=>e in r?zr(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var fe=(r,e,t)=>(Ur(r,typeof e!="symbol"?e+"":e,t),t),Wr=(r,e,t)=>{if(!e.has(r))throw TypeError("Cannot "+t)};var We=(r,e,t)=>{if(e.has(r))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(r):e.set(r,t)};var ie=(r,e,t)=>(Wr(r,e,"access private method"),t);import{S as te,i as ne,s as Q,M as Hr,b as pe,a as Ze,d as H,m as V,k as Qe,n as q,o as j,q as Z,e as w,c as P,g as S,x as J,p as E,y as Ae,f as R,z as Ht,B as Vt,C as Vr,D as On,E as tn,F as Rn,G as yt,H as _t,I as bt,J as wt,K as $n,h as _,l as X,L as Zr,N as Qr,O as ee,P as Kr,w as An,Q as Ke,R as me,T as In,t as z,U as Oe,j as lt,r as pt,V as Pn,W as jn,X as Te,Y as Xn,Z as Rr,_ as Jn,$ as ei,a0 as ti,a1 as Ee,a2 as ni,a3 as ri,a4 as ii,a5 as zn,a6 as oi,a7 as Zt,a8 as dt,a9 as Qt,aa as kt,ab as Nn,ac as an,ad as si,ae as ft,af as Fn,ag as Je,ah as ct,ai as li,aj as Cn,ak as ai,al as ui,am as fi,an as Un,ao as Dt,ap as ci,aq as hi,ar as pi,A as di,u as gi}from"./authorities-3942dcde.js";function mi(r){let e,t,n,i,o,s,a,l,u,p,g,c,f;return{c(){e=w("p"),e.textContent="For each intervention:",t=P(),n=w("ol"),n.innerHTML=`<li>Click one of the draw icons to the top right of the map (the icons allow
      you to draw points, lines, polygons or routes)</li> 
    <li>Draw the intervention on the map, clicking the original point or &#39;Finish
      snapping&#39; for the Polygon and Route tools respectively</li> 
    <li>Fill in the details that appear (Intervention type, name, description)</li> 
    <li>Click the &quot;Save&quot; button or &quot;Delete&quot; button to save or remove the
      intervention</li>`,i=P(),o=w("p"),o.textContent=`Repeat the steps above for each substantial infrastructure intervention in
    the scheme.`,s=P(),a=w("p"),a.textContent=`To make further edits to attribute data, or to delete an intervention, click
    on its name in the left hand panel or its geometry in the map.`,l=P(),u=w("p"),u.textContent=`Click the "Export to GeoJSON" button to download the dataset representing
    the scheme, which can be made up of one or more intervention, as a GeoJSON
    file. After saving the file, you can delete the interventions, change the
    scheme name, and start a new set of interventions representing a new scheme.`,p=P(),g=w("p"),g.textContent=`To load a GeoJSON file that you have already saved from the tool, click the
    "Load from GeoJSON" button and select the file.`,c=P(),f=w("p"),f.innerHTML=`Note: the <strong>Route tool</strong> works by calculating routes between
    start and end points using the existing transport network according to
    OpenStreetMap. Use it by clicking on the location where you would like the
    route to start and then clicking on the location where you would like the
    route to end on the map. The route will be calculated and drawn on the map.
    After you click &quot;Finish snapping&quot; you can edit the route by dragging
    individual points. This can be useful for representing links that are not
    part of the existing transport network, such as a new bridge or path.
    However,
    <strong>you cannot add or remove points</strong> with the Route tool. If the
    planned route intervention you would like to sketch as part of a scheme contains
    one or more new links (for example containing new bridges or paths between cul-de-sacs),
    you may want to use the Line tool instead.`},m(m,y){S(m,e,y),S(m,t,y),S(m,n,y),S(m,i,y),S(m,o,y),S(m,s,y),S(m,a,y),S(m,l,y),S(m,u,y),S(m,p,y),S(m,g,y),S(m,c,y),S(m,f,y)},p:J,d(m){m&&E(e),m&&E(t),m&&E(n),m&&E(i),m&&E(o),m&&E(s),m&&E(a),m&&E(l),m&&E(u),m&&E(p),m&&E(g),m&&E(c),m&&E(f)}}}function vi(r){let e,t,n;function i(s){r[1](s)}let o={title:"Instructions",$$slots:{default:[mi]},$$scope:{ctx:r}};return r[0]!==void 0&&(o.open=r[0]),e=new Hr({props:o}),pe.push(()=>Ze(e,"open",i,r[0])),{c(){H(e.$$.fragment)},m(s,a){V(e,s,a),n=!0},p(s,[a]){const l={};a&4&&(l.$$scope={dirty:a,ctx:s}),!t&&a&1&&(t=!0,l.open=s[0],Qe(()=>t=!1)),e.$set(l)},i(s){n||(q(e.$$.fragment,s),n=!0)},o(s){j(e.$$.fragment,s),n=!1},d(s){Z(e,s)}}}function yi(r,e,t){let{open:n}=e;function i(o){n=o,t(0,n)}return r.$$set=o=>{"open"in o&&t(0,n=o.open)},[n,i]}class _i extends te{constructor(e){super(),ne(this,e,yi,vi,Q,{open:0})}}const nt=[];function gt(r,e=J){let t;const n=new Set;function i(a){if(Q(r,a)&&(r=a,t)){const l=!nt.length;for(const u of n)u[1](),nt.push(u,r);if(l){for(let u=0;u<nt.length;u+=2)nt[u][0](nt[u+1]);nt.length=0}}}function o(a){i(a(r))}function s(a,l=J){const u=[a,l];return n.add(u),n.size===1&&(t=e(i)||J),a(r),()=>{n.delete(u),n.size===0&&(t(),t=null)}}return{set:i,update:o,subscribe:s}}const Ie=gt(null),W=gt(Ae()),we=gt(null),Ce=gt(null),$t=gt(null),un=gt(null);function Kt(r){let e=new Set;for(let n of r.features)e.add(n.id);let t=e.size+1;for(;e.has(t);)t++;return t}function Ar(r){W.update(e=>(e.features=e.features.filter(t=>t.id!=r),e)),we.set(null),Ce.set(null),$t.set(null)}function Wn(r){let e;const t=r[4].default,n=yt(t,r,r[3],null);return{c(){n&&n.c()},m(i,o){n&&n.m(i,o),e=!0},p(i,o){n&&n.p&&(!e||o&8)&&_t(n,t,i,i[3],e?wt(t,i[3],o,null):bt(i[3]),null)},i(i){e||(q(n,i),e=!0)},o(i){j(n,i),e=!1},d(i){n&&n.d(i)}}}function bi(r){let e,t,n=r[1]&&Wn(r);return{c(){e=w("div"),n&&n.c(),R(e,"class","map svelte-12dpf1u")},m(i,o){S(i,e,o),n&&n.m(e,null),r[5](e),t=!0},p(i,[o]){i[1]?n?(n.p(i,o),o&2&&q(n,1)):(n=Wn(i),n.c(),q(n,1),n.m(e,null)):n&&(Ht(),j(n,1,1,()=>{n=null}),Vt())},i(i){t||(q(n),t=!0)},o(i){j(n),t=!1},d(i){i&&E(e),n&&n.d(),r[5](null)}}}function wi(r,e,t){let{$$slots:n={},$$scope:i}=e,{style:o}=e,s,a,l=!1;Vr("setCamera",!window.location.hash),On(()=>{s=new tn.Map({container:a,style:`https://api.maptiler.com/maps/${o}/style.json?key=MZEJTanw3WpxRvt7qDfo`,hash:!0}),s.addControl(new tn.ScaleControl({})),s.addControl(new tn.NavigationControl({visualizePitch:!0}),"bottom-right"),s.on("load",()=>{t(1,l=!0),Ie.set(s)}),new ResizeObserver(()=>{s.resize()}).observe(a)}),Rn(()=>{s.remove()});function u(p){pe[p?"unshift":"push"](()=>{a=p,t(0,a)})}return r.$$set=p=>{"style"in p&&t(2,o=p.style),"$$scope"in p&&t(3,i=p.$$scope)},[a,l,o,i,n,u]}class xi extends te{constructor(e){super(),ne(this,e,wi,bi,Q,{style:2})}}const Si=r=>({}),Hn=r=>({}),Ei=r=>({}),Vn=r=>({}),ki=r=>({}),Zn=r=>({});function Mi(r){let e,t,n,i,o,s,a,l,u,p,g,c;const f=r[3].nav,m=yt(f,r,r[2],Zn),y=r[3].sidebar,b=yt(y,r,r[2],Vn),A=r[3].main,h=yt(A,r,r[2],Hn);return{c(){e=w("aside"),t=w("div"),n=w("nav"),m&&m.c(),i=P(),b&&b.c(),o=P(),s=w("button"),s.textContent="â†’",l=P(),u=w("main"),h&&h.c(),R(n,"class","svelte-1u7vg8a"),R(t,"class","sidebar-content content-container svelte-1u7vg8a"),R(s,"type","button"),R(s,"class","sidebar-toggle rounded-rect svelte-1u7vg8a"),R(e,"class",a=$n(r[0]?"":"collapsed")+" svelte-1u7vg8a"),R(u,"class","svelte-1u7vg8a")},m(d,v){S(d,e,v),_(e,t),_(t,n),m&&m.m(n,null),_(t,i),b&&b.m(t,null),_(e,o),_(e,s),S(d,l,v),S(d,u,v),h&&h.m(u,null),p=!0,g||(c=X(s,"click",r[1]),g=!0)},p(d,[v]){m&&m.p&&(!p||v&4)&&_t(m,f,d,d[2],p?wt(f,d[2],v,ki):bt(d[2]),Zn),b&&b.p&&(!p||v&4)&&_t(b,y,d,d[2],p?wt(y,d[2],v,Ei):bt(d[2]),Vn),(!p||v&1&&a!==(a=$n(d[0]?"":"collapsed")+" svelte-1u7vg8a"))&&R(e,"class",a),h&&h.p&&(!p||v&4)&&_t(h,A,d,d[2],p?wt(A,d[2],v,Si):bt(d[2]),Hn)},i(d){p||(q(m,d),q(b,d),q(h,d),p=!0)},o(d){j(m,d),j(b,d),j(h,d),p=!1},d(d){d&&E(e),m&&m.d(d),b&&b.d(d),d&&E(l),d&&E(u),h&&h.d(d),g=!1,c()}}}function Li(r,e,t){let{$$slots:n={},$$scope:i}=e,o=!0;function s(){t(0,o=!o)}return r.$$set=a=>{"$$scope"in a&&t(2,i=a.$$scope)},[o,s,i,n]}class Oi extends te{constructor(e){super(),ne(this,e,Li,Mi,Q,{})}}/**
 * splaytree v3.1.1
 * Fast Splay tree for Node and browser
 *
 * @author Alexander Milevski <info@w8r.name>
 * @license MIT
 * @preserve
 *//*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */function Ri(r,e){var t={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},n,i,o,s;return s={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function a(u){return function(p){return l([u,p])}}function l(u){if(n)throw new TypeError("Generator is already executing.");for(;t;)try{if(n=1,i&&(o=u[0]&2?i.return:u[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,u[1])).done)return o;switch(i=0,o&&(u=[u[0]&2,o.value]),u[0]){case 0:case 1:o=u;break;case 4:return t.label++,{value:u[1],done:!1};case 5:t.label++,i=u[1],u=[0];continue;case 7:u=t.ops.pop(),t.trys.pop();continue;default:if(o=t.trys,!(o=o.length>0&&o[o.length-1])&&(u[0]===6||u[0]===2)){t=0;continue}if(u[0]===3&&(!o||u[1]>o[0]&&u[1]<o[3])){t.label=u[1];break}if(u[0]===6&&t.label<o[1]){t.label=o[1],o=u;break}if(o&&t.label<o[2]){t.label=o[2],t.ops.push(u);break}o[2]&&t.ops.pop(),t.trys.pop();continue}u=e.call(r,t)}catch(p){u=[6,p],i=0}finally{n=o=0}if(u[0]&5)throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}}var Ue=function(){function r(e,t){this.next=null,this.key=e,this.data=t,this.left=null,this.right=null}return r}();function Ai(r,e){return r>e?1:r<e?-1:0}function De(r,e,t){for(var n=new Ue(null,null),i=n,o=n;;){var s=t(r,e.key);if(s<0){if(e.left===null)break;if(t(r,e.left.key)<0){var a=e.left;if(e.left=a.right,a.right=e,e=a,e.left===null)break}o.left=e,o=e,e=e.left}else if(s>0){if(e.right===null)break;if(t(r,e.right.key)>0){var a=e.right;if(e.right=a.left,a.left=e,e=a,e.right===null)break}i.right=e,i=e,e=e.right}else break}return i.right=e.left,o.left=e.right,e.left=n.right,e.right=n.left,e}function nn(r,e,t,n){var i=new Ue(r,e);if(t===null)return i.left=i.right=null,i;t=De(r,t,n);var o=n(r,t.key);return o<0?(i.left=t.left,i.right=t,t.left=null):o>=0&&(i.right=t.right,i.left=t,t.right=null),i}function Qn(r,e,t){var n=null,i=null;if(e){e=De(r,e,t);var o=t(e.key,r);o===0?(n=e.left,i=e.right):o<0?(i=e.right,e.right=null,n=e):(n=e.left,e.left=null,i=e)}return{left:n,right:i}}function Ii(r,e,t){return e===null?r:(r===null||(e=De(r.key,e,t),e.left=r),e)}function fn(r,e,t,n,i){if(r){n(""+e+(t?"â””â”€â”€ ":"â”œâ”€â”€ ")+i(r)+`
`);var o=e+(t?"    ":"â”‚   ");r.left&&fn(r.left,o,!1,n,i),r.right&&fn(r.right,o,!0,n,i)}}var Tn=function(){function r(e){e===void 0&&(e=Ai),this._root=null,this._size=0,this._comparator=e}return r.prototype.insert=function(e,t){return this._size++,this._root=nn(e,t,this._root,this._comparator)},r.prototype.add=function(e,t){var n=new Ue(e,t);this._root===null&&(n.left=n.right=null,this._size++,this._root=n);var i=this._comparator,o=De(e,this._root,i),s=i(e,o.key);return s===0?this._root=o:(s<0?(n.left=o.left,n.right=o,o.left=null):s>0&&(n.right=o.right,n.left=o,o.right=null),this._size++,this._root=n),this._root},r.prototype.remove=function(e){this._root=this._remove(e,this._root,this._comparator)},r.prototype._remove=function(e,t,n){var i;if(t===null)return null;t=De(e,t,n);var o=n(e,t.key);return o===0?(t.left===null?i=t.right:(i=De(e,t.left,n),i.right=t.right),this._size--,i):t},r.prototype.pop=function(){var e=this._root;if(e){for(;e.left;)e=e.left;return this._root=De(e.key,this._root,this._comparator),this._root=this._remove(e.key,this._root,this._comparator),{key:e.key,data:e.data}}return null},r.prototype.findStatic=function(e){for(var t=this._root,n=this._comparator;t;){var i=n(e,t.key);if(i===0)return t;i<0?t=t.left:t=t.right}return null},r.prototype.find=function(e){return this._root&&(this._root=De(e,this._root,this._comparator),this._comparator(e,this._root.key)!==0)?null:this._root},r.prototype.contains=function(e){for(var t=this._root,n=this._comparator;t;){var i=n(e,t.key);if(i===0)return!0;i<0?t=t.left:t=t.right}return!1},r.prototype.forEach=function(e,t){for(var n=this._root,i=[],o=!1;!o;)n!==null?(i.push(n),n=n.left):i.length!==0?(n=i.pop(),e.call(t,n),n=n.right):o=!0;return this},r.prototype.range=function(e,t,n,i){for(var o=[],s=this._comparator,a=this._root,l;o.length!==0||a;)if(a)o.push(a),a=a.left;else{if(a=o.pop(),l=s(a.key,t),l>0)break;if(s(a.key,e)>=0&&n.call(i,a))return this;a=a.right}return this},r.prototype.keys=function(){var e=[];return this.forEach(function(t){var n=t.key;return e.push(n)}),e},r.prototype.values=function(){var e=[];return this.forEach(function(t){var n=t.data;return e.push(n)}),e},r.prototype.min=function(){return this._root?this.minNode(this._root).key:null},r.prototype.max=function(){return this._root?this.maxNode(this._root).key:null},r.prototype.minNode=function(e){if(e===void 0&&(e=this._root),e)for(;e.left;)e=e.left;return e},r.prototype.maxNode=function(e){if(e===void 0&&(e=this._root),e)for(;e.right;)e=e.right;return e},r.prototype.at=function(e){for(var t=this._root,n=!1,i=0,o=[];!n;)if(t)o.push(t),t=t.left;else if(o.length>0){if(t=o.pop(),i===e)return t;i++,t=t.right}else n=!0;return null},r.prototype.next=function(e){var t=this._root,n=null;if(e.right){for(n=e.right;n.left;)n=n.left;return n}for(var i=this._comparator;t;){var o=i(e.key,t.key);if(o===0)break;o<0?(n=t,t=t.left):t=t.right}return n},r.prototype.prev=function(e){var t=this._root,n=null;if(e.left!==null){for(n=e.left;n.right;)n=n.right;return n}for(var i=this._comparator;t;){var o=i(e.key,t.key);if(o===0)break;o<0?t=t.left:(n=t,t=t.right)}return n},r.prototype.clear=function(){return this._root=null,this._size=0,this},r.prototype.toList=function(){return Ni(this._root)},r.prototype.load=function(e,t,n){t===void 0&&(t=[]),n===void 0&&(n=!1);var i=e.length,o=this._comparator;if(n&&pn(e,t,0,i-1,o),this._root===null)this._root=cn(e,t,0,i),this._size=i;else{var s=Fi(this.toList(),Pi(e,t),o);i=this._size+i,this._root=hn({head:s},0,i)}return this},r.prototype.isEmpty=function(){return this._root===null},Object.defineProperty(r.prototype,"size",{get:function(){return this._size},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"root",{get:function(){return this._root},enumerable:!0,configurable:!0}),r.prototype.toString=function(e){e===void 0&&(e=function(n){return String(n.key)});var t=[];return fn(this._root,"",!0,function(n){return t.push(n)},e),t.join("")},r.prototype.update=function(e,t,n){var i=this._comparator,o=Qn(e,this._root,i),s=o.left,a=o.right;i(e,t)<0?a=nn(t,n,a,i):s=nn(t,n,s,i),this._root=Ii(s,a,i)},r.prototype.split=function(e){return Qn(e,this._root,this._comparator)},r.prototype[Symbol.iterator]=function(){var e;return Ri(this,function(t){switch(t.label){case 0:e=this.minNode(),t.label=1;case 1:return e?[4,e]:[3,3];case 2:return t.sent(),e=this.next(e),[3,1];case 3:return[2]}})},r}();function cn(r,e,t,n){var i=n-t;if(i>0){var o=t+Math.floor(i/2),s=r[o],a=e[o],l=new Ue(s,a);return l.left=cn(r,e,t,o),l.right=cn(r,e,o+1,n),l}return null}function Pi(r,e){for(var t=new Ue(null,null),n=t,i=0;i<r.length;i++)n=n.next=new Ue(r[i],e[i]);return n.next=null,t.next}function Ni(r){for(var e=r,t=[],n=!1,i=new Ue(null,null),o=i;!n;)e?(t.push(e),e=e.left):t.length>0?(e=o=o.next=t.pop(),e=e.right):n=!0;return o.next=null,i.next}function hn(r,e,t){var n=t-e;if(n>0){var i=e+Math.floor(n/2),o=hn(r,e,i),s=r.head;return s.left=o,r.head=r.head.next,s.right=hn(r,i+1,t),s}return null}function Fi(r,e,t){for(var n=new Ue(null,null),i=n,o=r,s=e;o!==null&&s!==null;)t(o.key,s.key)<0?(i.next=o,o=o.next):(i.next=s,s=s.next),i=i.next;return o!==null?i.next=o:s!==null&&(i.next=s),n.next}function pn(r,e,t,n,i){if(!(t>=n)){for(var o=r[t+n>>1],s=t-1,a=n+1;;){do s++;while(i(r[s],o)<0);do a--;while(i(r[a],o)>0);if(s>=a)break;var l=r[s];r[s]=r[a],r[a]=l,l=e[s],e[s]=e[a],e[a]=l}pn(r,e,t,a,i),pn(r,e,a+1,n,i)}}function xe(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function Kn(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}function ve(r,e,t){return e&&Kn(r.prototype,e),t&&Kn(r,t),r}var vt=function(e,t){return e.ll.x<=t.x&&t.x<=e.ur.x&&e.ll.y<=t.y&&t.y<=e.ur.y},dn=function(e,t){if(t.ur.x<e.ll.x||e.ur.x<t.ll.x||t.ur.y<e.ll.y||e.ur.y<t.ll.y)return null;var n=e.ll.x<t.ll.x?t.ll.x:e.ll.x,i=e.ur.x<t.ur.x?e.ur.x:t.ur.x,o=e.ll.y<t.ll.y?t.ll.y:e.ll.y,s=e.ur.y<t.ur.y?e.ur.y:t.ur.y;return{ll:{x:n,y:o},ur:{x:i,y:s}}},je=Number.EPSILON;je===void 0&&(je=Math.pow(2,-52));var Ci=je*je,gn=function(e,t){if(-je<e&&e<je&&-je<t&&t<je)return 0;var n=e-t;return n*n<Ci*e*t?0:e<t?-1:1},Ti=function(){function r(){xe(this,r),this.reset()}return ve(r,[{key:"reset",value:function(){this.xRounder=new er,this.yRounder=new er}},{key:"round",value:function(t,n){return{x:this.xRounder.round(t),y:this.yRounder.round(n)}}}]),r}(),er=function(){function r(){xe(this,r),this.tree=new Tn,this.round(0)}return ve(r,[{key:"round",value:function(t){var n=this.tree.add(t),i=this.tree.prev(n);if(i!==null&&gn(n.key,i.key)===0)return this.tree.remove(t),i.key;var o=this.tree.next(n);return o!==null&&gn(n.key,o.key)===0?(this.tree.remove(t),o.key):t}}]),r}(),Mt=new Ti,xt=function(e,t){return e.x*t.y-e.y*t.x},Ir=function(e,t){return e.x*t.x+e.y*t.y},tr=function(e,t,n){var i={x:t.x-e.x,y:t.y-e.y},o={x:n.x-e.x,y:n.y-e.y},s=xt(i,o);return gn(s,0)},jt=function(e){return Math.sqrt(Ir(e,e))},Bi=function(e,t,n){var i={x:t.x-e.x,y:t.y-e.y},o={x:n.x-e.x,y:n.y-e.y};return xt(o,i)/jt(o)/jt(i)},Gi=function(e,t,n){var i={x:t.x-e.x,y:t.y-e.y},o={x:n.x-e.x,y:n.y-e.y};return Ir(o,i)/jt(o)/jt(i)},nr=function(e,t,n){return t.y===0?null:{x:e.x+t.x/t.y*(n-e.y),y:n}},rr=function(e,t,n){return t.x===0?null:{x:n,y:e.y+t.y/t.x*(n-e.x)}},Yi=function(e,t,n,i){if(t.x===0)return rr(n,i,e.x);if(i.x===0)return rr(e,t,n.x);if(t.y===0)return nr(n,i,e.y);if(i.y===0)return nr(e,t,n.y);var o=xt(t,i);if(o==0)return null;var s={x:n.x-e.x,y:n.y-e.y},a=xt(s,t)/o,l=xt(s,i)/o,u=e.x+l*t.x,p=n.x+a*i.x,g=e.y+l*t.y,c=n.y+a*i.y,f=(u+p)/2,m=(g+c)/2;return{x:f,y:m}},Le=function(){ve(r,null,[{key:"compare",value:function(t,n){var i=r.comparePoints(t.point,n.point);return i!==0?i:(t.point!==n.point&&t.link(n),t.isLeft!==n.isLeft?t.isLeft?1:-1:Xt.compare(t.segment,n.segment))}},{key:"comparePoints",value:function(t,n){return t.x<n.x?-1:t.x>n.x?1:t.y<n.y?-1:t.y>n.y?1:0}}]);function r(e,t){xe(this,r),e.events===void 0?e.events=[this]:e.events.push(this),this.point=e,this.isLeft=t}return ve(r,[{key:"link",value:function(t){if(t.point===this.point)throw new Error("Tried to link already linked events");for(var n=t.point.events,i=0,o=n.length;i<o;i++){var s=n[i];this.point.events.push(s),s.point=this.point}this.checkForConsuming()}},{key:"checkForConsuming",value:function(){for(var t=this.point.events.length,n=0;n<t;n++){var i=this.point.events[n];if(i.segment.consumedBy===void 0)for(var o=n+1;o<t;o++){var s=this.point.events[o];s.consumedBy===void 0&&i.otherSE.point.events===s.otherSE.point.events&&i.segment.consume(s.segment)}}}},{key:"getAvailableLinkedEvents",value:function(){for(var t=[],n=0,i=this.point.events.length;n<i;n++){var o=this.point.events[n];o!==this&&!o.segment.ringOut&&o.segment.isInResult()&&t.push(o)}return t}},{key:"getLeftmostComparator",value:function(t){var n=this,i=new Map,o=function(a){var l=a.otherSE;i.set(a,{sine:Bi(n.point,t.point,l.point),cosine:Gi(n.point,t.point,l.point)})};return function(s,a){i.has(s)||o(s),i.has(a)||o(a);var l=i.get(s),u=l.sine,p=l.cosine,g=i.get(a),c=g.sine,f=g.cosine;return u>=0&&c>=0?p<f?1:p>f?-1:0:u<0&&c<0?p<f?-1:p>f?1:0:c<u?-1:c>u?1:0}}}]),r}(),qi=0,Xt=function(){ve(r,null,[{key:"compare",value:function(t,n){var i=t.leftSE.point.x,o=n.leftSE.point.x,s=t.rightSE.point.x,a=n.rightSE.point.x;if(a<i)return 1;if(s<o)return-1;var l=t.leftSE.point.y,u=n.leftSE.point.y,p=t.rightSE.point.y,g=n.rightSE.point.y;if(i<o){if(u<l&&u<p)return 1;if(u>l&&u>p)return-1;var c=t.comparePoint(n.leftSE.point);if(c<0)return 1;if(c>0)return-1;var f=n.comparePoint(t.rightSE.point);return f!==0?f:-1}if(i>o){if(l<u&&l<g)return-1;if(l>u&&l>g)return 1;var m=n.comparePoint(t.leftSE.point);if(m!==0)return m;var y=t.comparePoint(n.rightSE.point);return y<0?1:y>0?-1:1}if(l<u)return-1;if(l>u)return 1;if(s<a){var b=n.comparePoint(t.rightSE.point);if(b!==0)return b}if(s>a){var A=t.comparePoint(n.rightSE.point);if(A<0)return 1;if(A>0)return-1}if(s!==a){var h=p-l,d=s-i,v=g-u,k=a-o;if(h>d&&v<k)return 1;if(h<d&&v>k)return-1}return s>a?1:s<a||p<g?-1:p>g?1:t.id<n.id?-1:t.id>n.id?1:0}}]);function r(e,t,n,i){xe(this,r),this.id=++qi,this.leftSE=e,e.segment=this,e.otherSE=t,this.rightSE=t,t.segment=this,t.otherSE=e,this.rings=n,this.windings=i}return ve(r,[{key:"replaceRightSE",value:function(t){this.rightSE=t,this.rightSE.segment=this,this.rightSE.otherSE=this.leftSE,this.leftSE.otherSE=this.rightSE}},{key:"bbox",value:function(){var t=this.leftSE.point.y,n=this.rightSE.point.y;return{ll:{x:this.leftSE.point.x,y:t<n?t:n},ur:{x:this.rightSE.point.x,y:t>n?t:n}}}},{key:"vector",value:function(){return{x:this.rightSE.point.x-this.leftSE.point.x,y:this.rightSE.point.y-this.leftSE.point.y}}},{key:"isAnEndpoint",value:function(t){return t.x===this.leftSE.point.x&&t.y===this.leftSE.point.y||t.x===this.rightSE.point.x&&t.y===this.rightSE.point.y}},{key:"comparePoint",value:function(t){if(this.isAnEndpoint(t))return 0;var n=this.leftSE.point,i=this.rightSE.point,o=this.vector();if(n.x===i.x)return t.x===n.x?0:t.x<n.x?1:-1;var s=(t.y-n.y)/o.y,a=n.x+s*o.x;if(t.x===a)return 0;var l=(t.x-n.x)/o.x,u=n.y+l*o.y;return t.y===u?0:t.y<u?-1:1}},{key:"getIntersection",value:function(t){var n=this.bbox(),i=t.bbox(),o=dn(n,i);if(o===null)return null;var s=this.leftSE.point,a=this.rightSE.point,l=t.leftSE.point,u=t.rightSE.point,p=vt(n,l)&&this.comparePoint(l)===0,g=vt(i,s)&&t.comparePoint(s)===0,c=vt(n,u)&&this.comparePoint(u)===0,f=vt(i,a)&&t.comparePoint(a)===0;if(g&&p)return f&&!c?a:!f&&c?u:null;if(g)return c&&s.x===u.x&&s.y===u.y?null:s;if(p)return f&&a.x===l.x&&a.y===l.y?null:l;if(f&&c)return null;if(f)return a;if(c)return u;var m=Yi(s,this.vector(),l,t.vector());return m===null||!vt(o,m)?null:Mt.round(m.x,m.y)}},{key:"split",value:function(t){var n=[],i=t.events!==void 0,o=new Le(t,!0),s=new Le(t,!1),a=this.rightSE;this.replaceRightSE(s),n.push(s),n.push(o);var l=new r(o,a,this.rings.slice(),this.windings.slice());return Le.comparePoints(l.leftSE.point,l.rightSE.point)>0&&l.swapEvents(),Le.comparePoints(this.leftSE.point,this.rightSE.point)>0&&this.swapEvents(),i&&(o.checkForConsuming(),s.checkForConsuming()),n}},{key:"swapEvents",value:function(){var t=this.rightSE;this.rightSE=this.leftSE,this.leftSE=t,this.leftSE.isLeft=!0,this.rightSE.isLeft=!1;for(var n=0,i=this.windings.length;n<i;n++)this.windings[n]*=-1}},{key:"consume",value:function(t){for(var n=this,i=t;n.consumedBy;)n=n.consumedBy;for(;i.consumedBy;)i=i.consumedBy;var o=r.compare(n,i);if(o!==0){if(o>0){var s=n;n=i,i=s}if(n.prev===i){var a=n;n=i,i=a}for(var l=0,u=i.rings.length;l<u;l++){var p=i.rings[l],g=i.windings[l],c=n.rings.indexOf(p);c===-1?(n.rings.push(p),n.windings.push(g)):n.windings[c]+=g}i.rings=null,i.windings=null,i.consumedBy=n,i.leftSE.consumedBy=n.leftSE,i.rightSE.consumedBy=n.rightSE}}},{key:"prevInResult",value:function(){return this._prevInResult!==void 0?this._prevInResult:(this.prev?this.prev.isInResult()?this._prevInResult=this.prev:this._prevInResult=this.prev.prevInResult():this._prevInResult=null,this._prevInResult)}},{key:"beforeState",value:function(){if(this._beforeState!==void 0)return this._beforeState;if(!this.prev)this._beforeState={rings:[],windings:[],multiPolys:[]};else{var t=this.prev.consumedBy||this.prev;this._beforeState=t.afterState()}return this._beforeState}},{key:"afterState",value:function(){if(this._afterState!==void 0)return this._afterState;var t=this.beforeState();this._afterState={rings:t.rings.slice(0),windings:t.windings.slice(0),multiPolys:[]};for(var n=this._afterState.rings,i=this._afterState.windings,o=this._afterState.multiPolys,s=0,a=this.rings.length;s<a;s++){var l=this.rings[s],u=this.windings[s],p=n.indexOf(l);p===-1?(n.push(l),i.push(u)):i[p]+=u}for(var g=[],c=[],f=0,m=n.length;f<m;f++)if(i[f]!==0){var y=n[f],b=y.poly;if(c.indexOf(b)===-1)if(y.isExterior)g.push(b);else{c.indexOf(b)===-1&&c.push(b);var A=g.indexOf(y.poly);A!==-1&&g.splice(A,1)}}for(var h=0,d=g.length;h<d;h++){var v=g[h].multiPoly;o.indexOf(v)===-1&&o.push(v)}return this._afterState}},{key:"isInResult",value:function(){if(this.consumedBy)return!1;if(this._isInResult!==void 0)return this._isInResult;var t=this.beforeState().multiPolys,n=this.afterState().multiPolys;switch(ke.type){case"union":{var i=t.length===0,o=n.length===0;this._isInResult=i!==o;break}case"intersection":{var s,a;t.length<n.length?(s=t.length,a=n.length):(s=n.length,a=t.length),this._isInResult=a===ke.numMultiPolys&&s<a;break}case"xor":{var l=Math.abs(t.length-n.length);this._isInResult=l%2===1;break}case"difference":{var u=function(g){return g.length===1&&g[0].isSubject};this._isInResult=u(t)!==u(n);break}default:throw new Error("Unrecognized operation type found ".concat(ke.type))}return this._isInResult}}],[{key:"fromRing",value:function(t,n,i){var o,s,a,l=Le.comparePoints(t,n);if(l<0)o=t,s=n,a=1;else if(l>0)o=n,s=t,a=-1;else throw new Error("Tried to create degenerate segment at [".concat(t.x,", ").concat(t.y,"]"));var u=new Le(o,!0),p=new Le(s,!1);return new r(u,p,[i],[a])}}]),r}(),ir=function(){function r(e,t,n){if(xe(this,r),!Array.isArray(e)||e.length===0)throw new Error("Input geometry is not a valid Polygon or MultiPolygon");if(this.poly=t,this.isExterior=n,this.segments=[],typeof e[0][0]!="number"||typeof e[0][1]!="number")throw new Error("Input geometry is not a valid Polygon or MultiPolygon");var i=Mt.round(e[0][0],e[0][1]);this.bbox={ll:{x:i.x,y:i.y},ur:{x:i.x,y:i.y}};for(var o=i,s=1,a=e.length;s<a;s++){if(typeof e[s][0]!="number"||typeof e[s][1]!="number")throw new Error("Input geometry is not a valid Polygon or MultiPolygon");var l=Mt.round(e[s][0],e[s][1]);l.x===o.x&&l.y===o.y||(this.segments.push(Xt.fromRing(o,l,this)),l.x<this.bbox.ll.x&&(this.bbox.ll.x=l.x),l.y<this.bbox.ll.y&&(this.bbox.ll.y=l.y),l.x>this.bbox.ur.x&&(this.bbox.ur.x=l.x),l.y>this.bbox.ur.y&&(this.bbox.ur.y=l.y),o=l)}(i.x!==o.x||i.y!==o.y)&&this.segments.push(Xt.fromRing(o,i,this))}return ve(r,[{key:"getSweepEvents",value:function(){for(var t=[],n=0,i=this.segments.length;n<i;n++){var o=this.segments[n];t.push(o.leftSE),t.push(o.rightSE)}return t}}]),r}(),Di=function(){function r(e,t){if(xe(this,r),!Array.isArray(e))throw new Error("Input geometry is not a valid Polygon or MultiPolygon");this.exteriorRing=new ir(e[0],this,!0),this.bbox={ll:{x:this.exteriorRing.bbox.ll.x,y:this.exteriorRing.bbox.ll.y},ur:{x:this.exteriorRing.bbox.ur.x,y:this.exteriorRing.bbox.ur.y}},this.interiorRings=[];for(var n=1,i=e.length;n<i;n++){var o=new ir(e[n],this,!1);o.bbox.ll.x<this.bbox.ll.x&&(this.bbox.ll.x=o.bbox.ll.x),o.bbox.ll.y<this.bbox.ll.y&&(this.bbox.ll.y=o.bbox.ll.y),o.bbox.ur.x>this.bbox.ur.x&&(this.bbox.ur.x=o.bbox.ur.x),o.bbox.ur.y>this.bbox.ur.y&&(this.bbox.ur.y=o.bbox.ur.y),this.interiorRings.push(o)}this.multiPoly=t}return ve(r,[{key:"getSweepEvents",value:function(){for(var t=this.exteriorRing.getSweepEvents(),n=0,i=this.interiorRings.length;n<i;n++)for(var o=this.interiorRings[n].getSweepEvents(),s=0,a=o.length;s<a;s++)t.push(o[s]);return t}}]),r}(),or=function(){function r(e,t){if(xe(this,r),!Array.isArray(e))throw new Error("Input geometry is not a valid Polygon or MultiPolygon");try{typeof e[0][0][0]=="number"&&(e=[e])}catch{}this.polys=[],this.bbox={ll:{x:Number.POSITIVE_INFINITY,y:Number.POSITIVE_INFINITY},ur:{x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY}};for(var n=0,i=e.length;n<i;n++){var o=new Di(e[n],this);o.bbox.ll.x<this.bbox.ll.x&&(this.bbox.ll.x=o.bbox.ll.x),o.bbox.ll.y<this.bbox.ll.y&&(this.bbox.ll.y=o.bbox.ll.y),o.bbox.ur.x>this.bbox.ur.x&&(this.bbox.ur.x=o.bbox.ur.x),o.bbox.ur.y>this.bbox.ur.y&&(this.bbox.ur.y=o.bbox.ur.y),this.polys.push(o)}this.isSubject=t}return ve(r,[{key:"getSweepEvents",value:function(){for(var t=[],n=0,i=this.polys.length;n<i;n++)for(var o=this.polys[n].getSweepEvents(),s=0,a=o.length;s<a;s++)t.push(o[s]);return t}}]),r}(),$i=function(){ve(r,null,[{key:"factory",value:function(t){for(var n=[],i=0,o=t.length;i<o;i++){var s=t[i];if(!(!s.isInResult()||s.ringOut)){for(var a=null,l=s.leftSE,u=s.rightSE,p=[l],g=l.point,c=[];a=l,l=u,p.push(l),l.point!==g;)for(;;){var f=l.getAvailableLinkedEvents();if(f.length===0){var m=p[0].point,y=p[p.length-1].point;throw new Error("Unable to complete output ring starting at [".concat(m.x,",")+" ".concat(m.y,"]. Last matching segment found ends at")+" [".concat(y.x,", ").concat(y.y,"]."))}if(f.length===1){u=f[0].otherSE;break}for(var b=null,A=0,h=c.length;A<h;A++)if(c[A].point===l.point){b=A;break}if(b!==null){var d=c.splice(b)[0],v=p.splice(d.index);v.unshift(v[0].otherSE),n.push(new r(v.reverse()));continue}c.push({index:p.length,point:l.point});var k=l.getLeftmostComparator(a);u=f.sort(k)[0].otherSE;break}n.push(new r(p))}}return n}}]);function r(e){xe(this,r),this.events=e;for(var t=0,n=e.length;t<n;t++)e[t].segment.ringOut=this;this.poly=null}return ve(r,[{key:"getGeom",value:function(){for(var t=this.events[0].point,n=[t],i=1,o=this.events.length-1;i<o;i++){var s=this.events[i].point,a=this.events[i+1].point;tr(s,t,a)!==0&&(n.push(s),t=s)}if(n.length===1)return null;var l=n[0],u=n[1];tr(l,t,u)===0&&n.shift(),n.push(n[0]);for(var p=this.isExteriorRing()?1:-1,g=this.isExteriorRing()?0:n.length-1,c=this.isExteriorRing()?n.length:-1,f=[],m=g;m!=c;m+=p)f.push([n[m].x,n[m].y]);return f}},{key:"isExteriorRing",value:function(){if(this._isExteriorRing===void 0){var t=this.enclosingRing();this._isExteriorRing=t?!t.isExteriorRing():!0}return this._isExteriorRing}},{key:"enclosingRing",value:function(){return this._enclosingRing===void 0&&(this._enclosingRing=this._calcEnclosingRing()),this._enclosingRing}},{key:"_calcEnclosingRing",value:function(){for(var t=this.events[0],n=1,i=this.events.length;n<i;n++){var o=this.events[n];Le.compare(t,o)>0&&(t=o)}for(var s=t.segment.prevInResult(),a=s?s.prevInResult():null;;){if(!s)return null;if(!a)return s.ringOut;if(a.ringOut!==s.ringOut)return a.ringOut.enclosingRing()!==s.ringOut?s.ringOut:s.ringOut.enclosingRing();s=a.prevInResult(),a=s?s.prevInResult():null}}}]),r}(),sr=function(){function r(e){xe(this,r),this.exteriorRing=e,e.poly=this,this.interiorRings=[]}return ve(r,[{key:"addInterior",value:function(t){this.interiorRings.push(t),t.poly=this}},{key:"getGeom",value:function(){var t=[this.exteriorRing.getGeom()];if(t[0]===null)return null;for(var n=0,i=this.interiorRings.length;n<i;n++){var o=this.interiorRings[n].getGeom();o!==null&&t.push(o)}return t}}]),r}(),ji=function(){function r(e){xe(this,r),this.rings=e,this.polys=this._composePolys(e)}return ve(r,[{key:"getGeom",value:function(){for(var t=[],n=0,i=this.polys.length;n<i;n++){var o=this.polys[n].getGeom();o!==null&&t.push(o)}return t}},{key:"_composePolys",value:function(t){for(var n=[],i=0,o=t.length;i<o;i++){var s=t[i];if(!s.poly)if(s.isExteriorRing())n.push(new sr(s));else{var a=s.enclosingRing();a.poly||n.push(new sr(a)),a.poly.addInterior(s)}}return n}}]),r}(),Xi=function(){function r(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Xt.compare;xe(this,r),this.queue=e,this.tree=new Tn(t),this.segments=[]}return ve(r,[{key:"process",value:function(t){var n=t.segment,i=[];if(t.consumedBy)return t.isLeft?this.queue.remove(t.otherSE):this.tree.remove(n),i;var o=t.isLeft?this.tree.insert(n):this.tree.find(n);if(!o)throw new Error("Unable to find segment #".concat(n.id," ")+"[".concat(n.leftSE.point.x,", ").concat(n.leftSE.point.y,"] -> ")+"[".concat(n.rightSE.point.x,", ").concat(n.rightSE.point.y,"] ")+"in SweepLine tree. Please submit a bug report.");for(var s=o,a=o,l=void 0,u=void 0;l===void 0;)s=this.tree.prev(s),s===null?l=null:s.key.consumedBy===void 0&&(l=s.key);for(;u===void 0;)a=this.tree.next(a),a===null?u=null:a.key.consumedBy===void 0&&(u=a.key);if(t.isLeft){var p=null;if(l){var g=l.getIntersection(n);if(g!==null&&(n.isAnEndpoint(g)||(p=g),!l.isAnEndpoint(g)))for(var c=this._splitSafely(l,g),f=0,m=c.length;f<m;f++)i.push(c[f])}var y=null;if(u){var b=u.getIntersection(n);if(b!==null&&(n.isAnEndpoint(b)||(y=b),!u.isAnEndpoint(b)))for(var A=this._splitSafely(u,b),h=0,d=A.length;h<d;h++)i.push(A[h])}if(p!==null||y!==null){var v=null;if(p===null)v=y;else if(y===null)v=p;else{var k=Le.comparePoints(p,y);v=k<=0?p:y}this.queue.remove(n.rightSE),i.push(n.rightSE);for(var O=n.split(v),L=0,M=O.length;L<M;L++)i.push(O[L])}i.length>0?(this.tree.remove(n),i.push(t)):(this.segments.push(n),n.prev=l)}else{if(l&&u){var N=l.getIntersection(u);if(N!==null){if(!l.isAnEndpoint(N))for(var T=this._splitSafely(l,N),F=0,G=T.length;F<G;F++)i.push(T[F]);if(!u.isAnEndpoint(N))for(var x=this._splitSafely(u,N),C=0,re=x.length;C<re;C++)i.push(x[C])}}this.tree.remove(n)}return i}},{key:"_splitSafely",value:function(t,n){this.tree.remove(t);var i=t.rightSE;this.queue.remove(i);var o=t.split(n);return o.push(i),t.consumedBy===void 0&&this.tree.insert(t),o}}]),r}(),lr=typeof process<"u"&&{}.POLYGON_CLIPPING_MAX_QUEUE_SIZE||1e6,Ji=typeof process<"u"&&{}.POLYGON_CLIPPING_MAX_SWEEPLINE_SEGMENTS||1e6,zi=function(){function r(){xe(this,r)}return ve(r,[{key:"run",value:function(t,n,i){ke.type=t,Mt.reset();for(var o=[new or(n,!0)],s=0,a=i.length;s<a;s++)o.push(new or(i[s],!1));if(ke.numMultiPolys=o.length,ke.type==="difference")for(var l=o[0],u=1;u<o.length;)dn(o[u].bbox,l.bbox)!==null?u++:o.splice(u,1);if(ke.type==="intersection"){for(var p=0,g=o.length;p<g;p++)for(var c=o[p],f=p+1,m=o.length;f<m;f++)if(dn(c.bbox,o[f].bbox)===null)return[]}for(var y=new Tn(Le.compare),b=0,A=o.length;b<A;b++)for(var h=o[b].getSweepEvents(),d=0,v=h.length;d<v;d++)if(y.insert(h[d]),y.size>lr)throw new Error("Infinite loop when putting segment endpoints in a priority queue (queue size too big). Please file a bug report.");for(var k=new Xi(y),O=y.size,L=y.pop();L;){var M=L.key;if(y.size===O){var N=M.segment;throw new Error("Unable to pop() ".concat(M.isLeft?"left":"right"," SweepEvent ")+"[".concat(M.point.x,", ").concat(M.point.y,"] from segment #").concat(N.id," ")+"[".concat(N.leftSE.point.x,", ").concat(N.leftSE.point.y,"] -> ")+"[".concat(N.rightSE.point.x,", ").concat(N.rightSE.point.y,"] from queue. ")+"Please file a bug report.")}if(y.size>lr)throw new Error("Infinite loop when passing sweep line over endpoints (queue size too big). Please file a bug report.");if(k.segments.length>Ji)throw new Error("Infinite loop when passing sweep line over endpoints (too many sweep line segments). Please file a bug report.");for(var T=k.process(M),F=0,G=T.length;F<G;F++){var x=T[F];x.consumedBy===void 0&&y.insert(x)}O=y.size,L=y.pop()}Mt.reset();var C=$i.factory(k.segments),re=new ji(C);return re.getGeom()}}]),r}(),ke=new zi,Ui=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return ke.run("union",e,n)},Wi=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return ke.run("intersection",e,n)},Hi=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return ke.run("xor",e,n)},Vi=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return ke.run("difference",e,n)},Ct={union:Ui,intersection:Wi,xor:Hi,difference:Vi};function Zi(r,e){var t=Ki(e),n=null;return r.type==="FeatureCollection"?n=Qi(r):n=Pr(Ct.union(r.geometry.coordinates)),n.geometry.coordinates.forEach(function(i){t.geometry.coordinates.push(i[0])}),t}function Qi(r){var e=r.features.length===2?Ct.union(r.features[0].geometry.coordinates,r.features[1].geometry.coordinates):Ct.union.apply(Ct,r.features.map(function(t){return t.geometry.coordinates}));return Pr(e)}function Pr(r){return Zr(r)}function Ki(r){var e=[[[180,90],[-180,90],[-180,-90],[180,-90],[180,90]]],t=r&&r.geometry.coordinates||e;return Qr(t)}function eo(r,e,t){let n;ee(r,Ie,s=>t(1,n=s));let{boundaryGeojson:i}=e;return Kr("setCamera")&&n.fitBounds(An(i),{padding:20,animate:!1}),Ke(n,"boundary",{type:"geojson",data:Zi(i)}),me(n,{id:"boundary",source:"boundary",...In("black",.5)}),r.$$set=s=>{"boundaryGeojson"in s&&t(0,i=s.boundaryGeojson)},[i]}class to extends te{constructor(e){super(),ne(this,e,eo,null,Q,{boundaryGeojson:0})}}function ar(r){let e,t=ur(r[4])+"",n,i,o,s,a;return{c(){e=z("Length: "),n=z(t),i=P(),o=w("br"),s=P(),a=w("br")},m(l,u){S(l,e,u),S(l,n,u),S(l,i,u),S(l,o,u),S(l,s,u),S(l,a,u)},p(l,u){u&16&&t!==(t=ur(l[4])+"")&&Pn(n,t)},d(l){l&&E(e),l&&E(n),l&&E(i),l&&E(o),l&&E(s),l&&E(a)}}}function no(r){let e,t,n,i,o,s,a,l,u,p,g,c,f,m,y,b,A,h,d,v,k,O,L,M,N,T,F,G,x,C,re,de,be,oe,ye,Se,ge,U,et,Be,Ge,ae,ce,tt,Ye,mt,K,he=r[4]&&ar(r);return{c(){e=w("label"),t=z("Name:"),n=w("br"),i=P(),o=w("input"),s=P(),a=w("br"),l=P(),u=w("br"),p=P(),g=w("label"),c=w("input"),f=z(`
  Area`),m=P(),y=w("label"),b=w("input"),A=z(`
  Route`),h=P(),d=w("label"),v=w("input"),k=z(`
  Crossing`),O=P(),L=w("label"),M=w("input"),N=z(`
  Other`),T=P(),F=w("br"),G=P(),x=w("br"),C=P(),re=w("label"),de=z("Description:"),be=w("br"),oe=P(),ye=w("textarea"),Se=P(),ge=w("br"),U=P(),et=w("br"),Be=P(),he&&he.c(),Ge=P(),ae=w("div"),ce=w("button"),ce.textContent="Delete",tt=P(),Ye=w("button"),Ye.textContent="Save",R(o,"type","text"),Oe(o,"width","100%"),R(c,"type","radio"),c.__value="area",c.value=c.__value,r[7][0].push(c),R(b,"type","radio"),b.__value="route",b.value=b.__value,r[7][0].push(b),R(v,"type","radio"),v.__value="crossing",v.value=v.__value,r[7][0].push(v),R(M,"type","radio"),M.__value="other",M.value=M.__value,r[7][0].push(M),Oe(ye,"width","100%"),R(ye,"rows","5"),R(ye,"class","svelte-15lna0i"),R(ce,"type","button"),R(Ye,"type","button"),Oe(ae,"display","flex"),Oe(ae,"justify-content","space-between")},m(I,Y){S(I,e,Y),_(e,t),_(e,n),_(e,i),_(e,o),lt(o,r[0]),S(I,s,Y),S(I,a,Y),S(I,l,Y),S(I,u,Y),S(I,p,Y),S(I,g,Y),_(g,c),c.checked=c.__value===r[1],_(g,f),S(I,m,Y),S(I,y,Y),_(y,b),b.checked=b.__value===r[1],_(y,A),S(I,h,Y),S(I,d,Y),_(d,v),v.checked=v.__value===r[1],_(d,k),S(I,O,Y),S(I,L,Y),_(L,M),M.checked=M.__value===r[1],_(L,N),S(I,T,Y),S(I,F,Y),S(I,G,Y),S(I,x,Y),S(I,C,Y),S(I,re,Y),_(re,de),_(re,be),_(re,oe),_(re,ye),lt(ye,r[2]),S(I,Se,Y),S(I,ge,Y),S(I,U,Y),S(I,et,Y),S(I,Be,Y),he&&he.m(I,Y),S(I,Ge,Y),S(I,ae,Y),_(ae,ce),_(ae,tt),_(ae,Ye),mt||(K=[X(o,"input",r[5]),X(c,"change",r[6]),X(b,"change",r[8]),X(v,"change",r[9]),X(M,"change",r[10]),X(ye,"input",r[11]),X(ce,"click",r[12]),X(Ye,"click",r[13])],mt=!0)},p(I,[Y]){Y&1&&o.value!==I[0]&&lt(o,I[0]),Y&2&&(c.checked=c.__value===I[1]),Y&2&&(b.checked=b.__value===I[1]),Y&2&&(v.checked=v.__value===I[1]),Y&2&&(M.checked=M.__value===I[1]),Y&4&&lt(ye,I[2]),I[4]?he?he.p(I,Y):(he=ar(I),he.c(),he.m(Ge.parentNode,Ge)):he&&(he.d(1),he=null)},i:J,o:J,d(I){I&&E(e),I&&E(s),I&&E(a),I&&E(l),I&&E(u),I&&E(p),I&&E(g),r[7][0].splice(r[7][0].indexOf(c),1),I&&E(m),I&&E(y),r[7][0].splice(r[7][0].indexOf(b),1),I&&E(h),I&&E(d),r[7][0].splice(r[7][0].indexOf(v),1),I&&E(O),I&&E(L),r[7][0].splice(r[7][0].indexOf(M),1),I&&E(T),I&&E(F),I&&E(G),I&&E(x),I&&E(C),I&&E(re),I&&E(Se),I&&E(ge),I&&E(U),I&&E(et),I&&E(Be),he&&he.d(I),I&&E(Ge),I&&E(ae),mt=!1,pt(K)}}}function ur(r){return r<1e3?Math.round(r)+" m":(r/1e3).toFixed(1)+"km"}function ro(r,e,t){let{id:n}=e,{name:i}=e,{intervention_type:o}=e,{description:s}=e,{length_meters:a}=e;const l=[[]];function u(){i=this.value,t(0,i)}function p(){o=this.__value,t(1,o)}function g(){o=this.__value,t(1,o)}function c(){o=this.__value,t(1,o)}function f(){o=this.__value,t(1,o)}function m(){s=this.value,t(2,s)}const y=()=>Ar(n),b=()=>we.set(null);return r.$$set=A=>{"id"in A&&t(3,n=A.id),"name"in A&&t(0,i=A.name),"intervention_type"in A&&t(1,o=A.intervention_type),"description"in A&&t(2,s=A.description),"length_meters"in A&&t(4,a=A.length_meters)},[i,o,s,n,a,u,p,l,g,c,f,m,y,b]}class io extends te{constructor(e){super(),ne(this,e,ro,no,Q,{id:3,name:0,intervention_type:1,description:2,length_meters:4})}}function oo(r){const e=r-1;return e*e*e+1}function fr(r,{delay:e=0,duration:t=400,easing:n=oo}={}){const i=getComputedStyle(r),o=+i.opacity,s=parseFloat(i.height),a=parseFloat(i.paddingTop),l=parseFloat(i.paddingBottom),u=parseFloat(i.marginTop),p=parseFloat(i.marginBottom),g=parseFloat(i.borderTopWidth),c=parseFloat(i.borderBottomWidth);return{delay:e,duration:t,easing:n,css:f=>`overflow: hidden;opacity: ${Math.min(f*20,1)*o};height: ${f*s}px;padding-top: ${f*a}px;padding-bottom: ${f*l}px;margin-top: ${f*u}px;margin-bottom: ${f*p}px;border-top-width: ${f*g}px;border-bottom-width: ${f*c}px;`}}function cr(r){let e,t,n,i,o;const s=r[10].default,a=yt(s,r,r[9],null);return{c(){e=w("div"),a&&a.c(),Oe(e,"border","solid 1px black"),Oe(e,"padding","10px")},m(l,u){S(l,e,u),a&&a.m(e,null),r[13](e),n=!0,i||(o=X(e,"introend",r[14]),i=!0)},p(l,u){a&&a.p&&(!n||u&512)&&_t(a,s,l,l[9],n?wt(s,l[9],u,null):bt(l[9]),null)},i(l){n||(q(a,l),Rr(()=>{t||(t=Jn(e,fr,{duration:100},!0)),t.run(1)}),n=!0)},o(l){j(a,l),t||(t=Jn(e,fr,{duration:100},!1)),t.run(0),n=!1},d(l){l&&E(e),a&&a.d(l),r[13](null),l&&t&&t.end(),i=!1,o()}}}function so(r){let e,t,n,i,o,s,a,l,u,p,g=r[4]&&cr(r);return{c(){e=w("button"),t=jn("svg"),n=jn("path"),i=P(),o=z(r[1]),s=P(),g&&g.c(),a=Te(),R(n,"d","M9 5l7 7-7 7"),R(t,"style","tran"),R(t,"width","20"),R(t,"height","20"),R(t,"fill","none"),R(t,"stroke-linecap","round"),R(t,"stroke-linejoin","round"),R(t,"stroke-width","2"),R(t,"viewBox","0 0 24 24"),R(t,"stroke","currentColor"),R(t,"class","svelte-t7fpgu"),R(e,"aria-expanded",r[4]),R(e,"class","svelte-t7fpgu"),Xn(e,"underlined",r[3])},m(c,f){S(c,e,f),_(e,t),_(t,n),_(e,i),_(e,o),S(c,s,f),g&&g.m(c,f),S(c,a,f),l=!0,u||(p=[X(e,"click",r[5]),X(e,"mouseenter",r[11]),X(e,"mouseleave",r[12])],u=!0)},p(c,[f]){(!l||f&2)&&Pn(o,c[1]),(!l||f&16)&&R(e,"aria-expanded",c[4]),(!l||f&8)&&Xn(e,"underlined",c[3]),c[4]?g?(g.p(c,f),f&16&&q(g,1)):(g=cr(c),g.c(),q(g,1),g.m(a.parentNode,a)):g&&(Ht(),j(g,1,1,()=>{g=null}),Vt())},i(c){l||(q(g),l=!0)},o(c){j(g),l=!1},d(c){c&&E(e),c&&E(s),g&&g.d(c),c&&E(a),u=!1,pt(p)}}}function lo(r,e,t){let n,i,o,s;ee(r,Ce,h=>t(7,o=h)),ee(r,we,h=>t(8,s=h));let{$$slots:a={},$$scope:l}=e,{id:u}=e,{label:p}=e;const g=()=>{we.update(h=>h==u?null:u),s==u&&(un.set(null),un.set(u))};let c;function f(){c==null||c.scrollIntoView({behavior:"smooth"})}const m=()=>$t.set(u),y=()=>$t.set(null);function b(h){pe[h?"unshift":"push"](()=>{c=h,t(2,c)})}const A=()=>f();return r.$$set=h=>{"id"in h&&t(0,u=h.id),"label"in h&&t(1,p=h.label),"$$scope"in h&&t(9,l=h.$$scope)},r.$$.update=()=>{r.$$.dirty&257&&t(4,n=s==u),r.$$.dirty&129&&t(3,i=o==u)},[u,p,c,i,n,g,f,o,s,l,a,m,y,b,A]}class ao extends te{constructor(e){super(),ne(this,e,lo,so,Q,{id:0,label:1})}}function hr(r,e,t){const n=r.slice();return n[6]=e[t],n[7]=e,n[8]=t,n}function uo(r){let e,t,n,i,o,s;function a(g){r[2](g,r[6])}function l(g){r[3](g,r[6])}function u(g){r[4](g,r[6])}let p={id:r[6].id,length_meters:r[6].properties.length_meters};return r[6].properties.name!==void 0&&(p.name=r[6].properties.name),r[6].properties.intervention_type!==void 0&&(p.intervention_type=r[6].properties.intervention_type),r[6].properties.description!==void 0&&(p.description=r[6].properties.description),e=new io({props:p}),pe.push(()=>Ze(e,"name",a,r[6].properties.name)),pe.push(()=>Ze(e,"intervention_type",l,r[6].properties.intervention_type)),pe.push(()=>Ze(e,"description",u,r[6].properties.description)),{c(){H(e.$$.fragment),o=P()},m(g,c){V(e,g,c),S(g,o,c),s=!0},p(g,c){r=g;const f={};c&1&&(f.id=r[6].id),c&1&&(f.length_meters=r[6].properties.length_meters),!t&&c&1&&(t=!0,f.name=r[6].properties.name,Qe(()=>t=!1)),!n&&c&1&&(n=!0,f.intervention_type=r[6].properties.intervention_type,Qe(()=>n=!1)),!i&&c&1&&(i=!0,f.description=r[6].properties.description,Qe(()=>i=!1)),e.$set(f)},i(g){s||(q(e.$$.fragment,g),s=!0)},o(g){j(e.$$.fragment,g),s=!1},d(g){Z(e,g),g&&E(o)}}}function pr(r,e){let t,n,i;return n=new ao({props:{id:e[6].id,label:e[8]+1+") "+dr(e[6]),$$slots:{default:[uo]},$$scope:{ctx:e}}}),{key:r,first:null,c(){t=Te(),H(n.$$.fragment),this.first=t},m(o,s){S(o,t,s),V(n,o,s),i=!0},p(o,s){e=o;const a={};s&1&&(a.id=e[6].id),s&1&&(a.label=e[8]+1+") "+dr(e[6])),s&513&&(a.$$scope={dirty:s,ctx:e}),n.$set(a)},i(o){i||(q(n.$$.fragment,o),i=!0)},o(o){j(n.$$.fragment,o),i=!1},d(o){o&&E(t),Z(n,o)}}}function fo(r){let e=[],t=new Map,n,i,o,s,a=r[0].features;const l=u=>u[6].id;for(let u=0;u<a.length;u+=1){let p=hr(r,a,u),g=l(p);t.set(g,e[u]=pr(g,p))}return{c(){for(let u=0;u<e.length;u+=1)e[u].c();n=Te()},m(u,p){for(let g=0;g<e.length;g+=1)e[g].m(u,p);S(u,n,p),i=!0,o||(s=X(window,"keydown",r[1]),o=!0)},p(u,[p]){p&1&&(a=u[0].features,Ht(),e=ei(e,p,l,1,u,a,t,n.parentNode,ti,pr,n,hr),Vt())},i(u){if(!i){for(let p=0;p<a.length;p+=1)q(e[p]);i=!0}},o(u){for(let p=0;p<e.length;p+=1)j(e[p]);i=!1},d(u){for(let p=0;p<e.length;p+=1)e[p].d(u);u&&E(n),o=!1,s()}}}function dr(r){if(r.properties.name)return r.properties.name;var e=r.properties.intervention_type;return e=="other"&&(r.geometry.type=="Point"?e="point":r.geometry.type=="LineString"?e="line":e="polygon"),`Untitled ${e}`}function co(r,e,t){let n,i;ee(r,we,u=>t(5,n=u)),ee(r,W,u=>t(0,i=u));function o(u){if(u.key=="Delete"){const p=u.target.tagName;if(p=="INPUT"||p=="TEXTAREA")return;u.preventDefault();const g=n;g&&Ar(g)}}function s(u,p){r.$$.not_equal(p.properties.name,u)&&(p.properties.name=u,W.set(i))}function a(u,p){r.$$.not_equal(p.properties.intervention_type,u)&&(p.properties.intervention_type=u,W.set(i))}function l(u,p){r.$$.not_equal(p.properties.description,u)&&(p.properties.description=u,W.set(i))}return[i,o,s,a,l]}class ho extends te{constructor(e){super(),ne(this,e,co,fo,Q,{})}}function ze(r){if(!r)throw new Error("coord is required");if(!Array.isArray(r)){if(r.type==="Feature"&&r.geometry!==null&&r.geometry.type==="Point")return r.geometry.coordinates;if(r.type==="Point")return r.coordinates}if(Array.isArray(r)&&r.length>=2&&!Array.isArray(r[0])&&!Array.isArray(r[1]))return r;throw new Error("coord must be GeoJSON Point or an Array of numbers")}function Re(r){if(Array.isArray(r))return r;if(r.type==="Feature"){if(r.geometry!==null)return r.geometry.coordinates}else if(r.coordinates)return r.coordinates;throw new Error("coords must be GeoJSON Feature, Geometry Object or an Array")}function mn(r,e){return r.type==="FeatureCollection"?"FeatureCollection":r.type==="GeometryCollection"?"GeometryCollection":r.type==="Feature"&&r.geometry!==null?r.geometry.type:r.type}function $e(r,e,t){t===void 0&&(t={});var n=ze(r),i=ze(e),o=Ee(i[1]-n[1]),s=Ee(i[0]-n[0]),a=Ee(n[1]),l=Ee(i[1]),u=Math.pow(Math.sin(o/2),2)+Math.pow(Math.sin(s/2),2)*Math.cos(a)*Math.cos(l);return ni(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)),t.units)}function Tt(r,e){return e===void 0&&(e={}),ri(r,function(t,n){var i=n.geometry.coordinates;return t+$e(i[0],i[1],e)},0)}function po(r){let e,t,n,i,o,s,a,l,u,p,g,c,f,m,y,b,A,h,d,v=r[0].features.length+"",k,O,L,M,N,T,F,G;return{c(){e=w("div"),t=w("label"),n=z(`Scheme name:
    `),i=w("input"),o=P(),s=w("br"),a=P(),l=w("div"),u=w("label"),p=w("input"),g=P(),c=w("button"),c.textContent="Load from GeoJSON",f=P(),m=w("button"),m.textContent="Export to GeoJSON",y=P(),b=w("br"),A=P(),h=w("div"),d=w("span"),k=z(v),O=z(" interventions"),L=P(),M=w("button"),N=z("Clear all"),R(i,"type","text"),R(p,"type","file"),R(p,"id","load_geojson"),R(p,"class","svelte-lhyd1e"),R(c,"type","button"),R(m,"type","button"),R(m,"class","align-right svelte-lhyd1e"),R(M,"type","button"),R(M,"class","align-right svelte-lhyd1e"),M.disabled=T=r[0].features.length==0},m(x,C){S(x,e,C),_(e,t),_(t,n),_(t,i),lt(i,r[0].scheme_name),S(x,o,C),S(x,s,C),S(x,a,C),S(x,l,C),_(l,u),_(u,p),_(u,g),_(u,c),_(l,f),_(l,m),S(x,y,C),S(x,b,C),S(x,A,C),S(x,h,C),_(h,d),_(d,k),_(d,O),_(h,L),_(h,M),_(M,N),F||(G=[X(i,"input",r[5]),X(p,"change",r[3]),X(c,"click",mo),X(m,"click",r[2]),X(M,"click",r[1])],F=!0)},p(x,[C]){C&1&&i.value!==x[0].scheme_name&&lt(i,x[0].scheme_name),C&1&&v!==(v=x[0].features.length+"")&&Pn(k,v),C&1&&T!==(T=x[0].features.length==0)&&(M.disabled=T)},i:J,o:J,d(x){x&&E(e),x&&E(o),x&&E(s),x&&E(a),x&&E(l),x&&E(y),x&&E(b),x&&E(A),x&&E(h),F=!1,pt(G)}}}function go(r,e){var t=document.createElement("a");t.setAttribute("href","data:text/plain;charset=utf-8, "+encodeURIComponent(e)),t.setAttribute("download",r),document.body.appendChild(t),t.click(),document.body.removeChild(t)}function mo(){document.getElementById("load_geojson").click()}function vo(r,e,t){let n;ee(r,W,c=>t(0,n=c));let{authorityName:i}=e,o=window.localStorage.getItem(i);if(o)try{W.set(p(JSON.parse(o)))}catch(c){console.log(`Failed to load from local storage: ${c}`)}function s(){confirm("Do you want to clear the current scheme? (You should save it first!)")&&W.update(c=>(delete c.scheme_name,c.features=[],c))}function a(){const c=JSON.parse(JSON.stringify(n));for(let f of c.features)delete f.properties.hide_while_editing;return c}function l(){let c=a();var f=i;c.authority=i,c.origin="atip-v1",c.scheme_name&&(f+="_"+c.scheme_name),f+=".txt",go(f,JSON.stringify(c,null,"  "))}function u(c){const f=new FileReader;f.onload=y=>{try{W.set(p(JSON.parse(y.target.result)))}catch(b){window.alert(`Couldn't load scheme from a file: ${b}`)}};let m=c.target.files;f.readAsText(m[0])}function p(c){let f=1;for(let m of c.features)m.geometry.type=="LineString"&&!m.properties.length_meters&&(m.properties.length_meters=Tt(m,{units:"kilometers"})*1e3),m.id=f++;return c}function g(){n.scheme_name=this.value,W.set(n)}return r.$$set=c=>{"authorityName"in c&&t(4,i=c.authorityName)},r.$$.update=()=>{r.$$.dirty&17&&n&&(console.log("GJ changed, saving to local storage"),window.localStorage.setItem(i,JSON.stringify(a())))},[n,s,l,u,i,g]}class yo extends te{constructor(e){super(),ne(this,e,vo,po,Q,{authorityName:4})}}const _o="/atip/assets/zoom_out_map-b2e1091a.svg";function bo(r){let e,t,n,i,o;return{c(){e=w("button"),t=w("img"),ii(t.src,n=_o)||R(t,"src",n),R(t,"alt","Zoom to show entire boundary"),R(e,"type","button"),R(e,"title","Zoom to show entire boundary"),R(e,"class","svelte-qzjsqo")},m(s,a){S(s,e,a),_(e,t),i||(o=X(e,"click",r[0]),i=!0)},p:J,i:J,o:J,d(s){s&&E(e),i=!1,o()}}}function wo(r,e,t){let n;ee(r,Ie,s=>t(2,n=s));let{boundaryGeojson:i}=e;function o(){n.fitBounds(An(i),{padding:20,animate:!0,duration:500})}return r.$$set=s=>{"boundaryGeojson"in s&&t(1,i=s.boundaryGeojson)},[o,i]}class xo extends te{constructor(e){super(),ne(this,e,wo,bo,Q,{boundaryGeojson:1})}}function So(r){let e,t,n,i,o,s,a;return{c(){e=w("div"),t=z(`Basemap:
  `),n=w("select"),i=w("option"),i.textContent="Streets",o=w("option"),o.textContent="Satellite",i.__value="streets",i.value=i.__value,o.__value="hybrid",o.value=o.__value,r[0]===void 0&&Rr(()=>r[2].call(n)),R(e,"class","svelte-1tbnm6i")},m(l,u){S(l,e,u),_(e,t),_(e,n),_(n,i),_(n,o),zn(n,r[0]),s||(a=[X(n,"change",r[2]),X(n,"change",r[1])],s=!0)},p(l,[u]){u&1&&zn(n,l[0])},i:J,o:J,d(l){l&&E(e),s=!1,pt(a)}}}function Eo(r,e,t){let{style:n}=e;function i(){let s=new URLSearchParams(window.location.search);s.set("style",n);let a=`${window.location.pathname}?${s.toString()}${window.location.hash}`;window.location.href=a}function o(){n=oi(this),t(0,n)}return r.$$set=s=>{"style"in s&&t(0,n=s.style)},[n,i,o]}class ko extends te{constructor(e){super(),ne(this,e,Eo,So,Q,{style:0})}}const _e={area:"#e41a1c",route:"#377eb8",crossing:"#4daf4a",other:"#984ea3",hovering:"black",lineEndpointColor:"black"},en=10,Jt=10;function Mo(r){let e,t,n,i,o,s,a,l,u,p,g,c,f,m,y,b,A,h,d;return{c(){e=w("div"),t=w("h1"),t.textContent="Interventions",n=P(),i=w("ul"),o=w("li"),s=w("span"),a=z("Areas"),l=P(),u=w("li"),p=w("span"),g=z("Routes"),c=P(),f=w("li"),m=w("span"),y=z("Crossings"),b=P(),A=w("li"),h=w("span"),d=z("Other"),R(t,"class","svelte-p551i1"),R(s,"class","svelte-p551i1"),Oe(s,"background",_e.area),R(p,"class","svelte-p551i1"),Oe(p,"background",_e.route),R(m,"class","svelte-p551i1"),Oe(m,"background",_e.crossing),R(h,"class","svelte-p551i1"),Oe(h,"background",_e.other),R(e,"class","svelte-p551i1")},m(v,k){S(v,e,k),_(e,t),_(e,n),_(e,i),_(i,o),_(o,s),_(o,a),_(i,l),_(i,u),_(u,p),_(u,g),_(i,c),_(i,f),_(f,m),_(f,y),_(i,b),_(i,A),_(A,h),_(A,d)},p:J,i:J,o:J,d(v){v&&E(e)}}}class Lo extends te{constructor(e){super(),ne(this,e,null,Mo,Q,{})}}let rt="interventions";function Oo(r,e,t){let n,i;ee(r,Ie,l=>t(0,n=l)),ee(r,W,l=>t(1,i=l)),Ke(n,rt,{type:"geojson",data:i});const o=["match",["get","intervention_type"],"area",_e.area,"route",_e.route,"crossing",_e.crossing,"other",_e.other,"white"],s=["!=","hide_while_editing",!0];return me(n,{id:"interventions-points",source:rt,filter:["all",Zt,s,["!=","endpoint",!0]],...dt(o,en)}),me(n,{id:"interventions-lines",source:rt,filter:["all",Qt,s],...kt(o,Jt)},"route-lines"),me(n,{id:"interventions-lines-endpoints",source:rt,filter:["==","endpoint",!0],type:"circle",paint:{"circle-radius":.5*Jt,"circle-opacity":0,"circle-stroke-color":_e.lineEndpointColor,"circle-stroke-width":2}}),me(n,{id:"interventions-polygons",source:rt,filter:["all",Nn,s],...In(o,.5)},"hover-polygons"),r.$$.update=()=>{if(r.$$.dirty&3){let l=JSON.parse(JSON.stringify(i)),u=[];for(let p of l.features)if(p.geometry.type=="LineString")for(let g of[p.geometry.coordinates[0],p.geometry.coordinates[p.geometry.coordinates.length-1]])u.push({type:"Feature",properties:{endpoint:!0},geometry:{type:"Point",coordinates:g}});l.features=l.features.concat(u),n.getSource(rt).setData(l)}},[n,i]}class Ro extends te{constructor(e){super(),ne(this,e,Oo,null,Q,{})}}let it="hover";function Ao(r,e,t){let n,i,o,s,a;return ee(r,Ie,l=>t(0,n=l)),ee(r,W,l=>t(1,i=l)),ee(r,$t,l=>t(2,o=l)),ee(r,Ce,l=>t(3,s=l)),ee(r,we,l=>t(4,a=l)),Ke(n,it,{type:"geojson",data:Ae()}),me(n,{id:"hover-polygons",source:it,filter:Nn,...kt(_e.hovering,.5*Jt,1)}),me(n,{id:"hover-lines",source:it,filter:Qt,...kt(_e.hovering,1.5*Jt,1)},"interventions-lines"),me(n,{id:"hover-points",source:it,filter:Zt,...dt(_e.hovering,1.5*en,1)},"interventions-points"),r.$$.update=()=>{if(r.$$.dirty&31){let l=a||s||o;l!=null?n.getSource(it).setData(i.features.find(u=>u.id==l)):n.getSource(it).setData(Ae())}},[n,i,o,s,a]}class Io extends te{constructor(e){super(),ne(this,e,Ao,null,Q,{})}}const Pt="edit-point-mode";var Ot,vn;class Po{constructor(e){We(this,Ot);fe(this,"map");fe(this,"active");fe(this,"eventListeners");fe(this,"cursor");this.map=e,this.active=!1,this.eventListeners=[],this.cursor=null,e.on("mousemove",t=>{this.active&&(this.cursor=No(t.lngLat.toArray()),ie(this,Ot,vn).call(this))}),e.on("click",()=>{if(this.active&&this.cursor){for(let t of this.eventListeners)t(this.cursor);this.stop()}}),Ke(e,Pt,{type:"geojson",data:Ae()}),me(e,{id:"edit-point-mode",source:Pt,...dt(_e.hovering,en,1)})}addEventListener(e){this.eventListeners.push(e)}tearDown(){this.map.removeLayer("edit-point-mode"),this.map.removeSource(Pt)}start(){this.active=!0}stop(){this.cursor=null,this.active=!1,ie(this,Ot,vn).call(this)}}Ot=new WeakSet,vn=function(){let e=Ae();this.cursor&&e.features.push(this.cursor),this.map.getSource(Pt).setData(e)};function No(r){return{type:"Feature",properties:{},geometry:{type:"Point",coordinates:r}}}function Nr(r,e,t){if(t===void 0&&(t={}),t.final===!0)return Fo(r,e);var n=ze(r),i=ze(e),o=Ee(n[0]),s=Ee(i[0]),a=Ee(n[1]),l=Ee(i[1]),u=Math.sin(s-o)*Math.cos(l),p=Math.cos(a)*Math.sin(l)-Math.sin(a)*Math.cos(l)*Math.cos(s-o);return an(Math.atan2(u,p))}function Fo(r,e){var t=Nr(e,r);return t=(t+180)%360,t}function gr(r,e,t,n){n===void 0&&(n={});var i=ze(r),o=Ee(i[0]),s=Ee(i[1]),a=Ee(t),l=si(e,n.units),u=Math.asin(Math.sin(s)*Math.cos(l)+Math.cos(s)*Math.sin(l)*Math.cos(a)),p=o+Math.atan2(Math.sin(a)*Math.sin(l)*Math.cos(s),Math.cos(l)-Math.sin(s)*Math.sin(u)),g=an(p),c=an(u);return ft([g,c],n.properties)}function yn(r){if(!r)throw new Error("geojson is required");var e=[];return Fn(r,function(t){Co(t,e)}),Je(e)}function Co(r,e){var t=[],n=r.geometry;if(n!==null){switch(n.type){case"Polygon":t=Re(n);break;case"LineString":t=[Re(n)]}t.forEach(function(i){var o=To(i,r.properties);o.forEach(function(s){s.id=e.length,e.push(s)})})}}function To(r,e){var t=[];return r.reduce(function(n,i){var o=ct([n,i],e);return o.bbox=Bo(n,i),t.push(o),i}),t}function Bo(r,e){var t=r[0],n=r[1],i=e[0],o=e[1],s=t<i?t:i,a=n<o?n:o,l=t>i?t:i,u=n>o?n:o;return[s,a,l,u]}var ht={},Go={get exports(){return ht},set exports(r){ht=r}},_n={},Yo={get exports(){return _n},set exports(r){_n=r}};(function(r,e){(function(t,n){r.exports=n()})(li,function(){function t(h,d,v,k,O){(function L(M,N,T,F,G){for(;F>T;){if(F-T>600){var x=F-T+1,C=N-T+1,re=Math.log(x),de=.5*Math.exp(2*re/3),be=.5*Math.sqrt(re*de*(x-de)/x)*(C-x/2<0?-1:1),oe=Math.max(T,Math.floor(N-C*de/x+be)),ye=Math.min(F,Math.floor(N+(x-C)*de/x+be));L(M,N,oe,ye,G)}var Se=M[N],ge=T,U=F;for(n(M,T,N),G(M[F],Se)>0&&n(M,T,F);ge<U;){for(n(M,ge,U),ge++,U--;G(M[ge],Se)<0;)ge++;for(;G(M[U],Se)>0;)U--}G(M[T],Se)===0?n(M,T,U):n(M,++U,F),U<=N&&(T=U+1),N<=U&&(F=U-1)}})(h,d,v||0,k||h.length-1,O||i)}function n(h,d,v){var k=h[d];h[d]=h[v],h[v]=k}function i(h,d){return h<d?-1:h>d?1:0}var o=function(h){h===void 0&&(h=9),this._maxEntries=Math.max(4,h),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()};function s(h,d,v){if(!v)return d.indexOf(h);for(var k=0;k<d.length;k++)if(v(h,d[k]))return k;return-1}function a(h,d){l(h,0,h.children.length,d,h)}function l(h,d,v,k,O){O||(O=b(null)),O.minX=1/0,O.minY=1/0,O.maxX=-1/0,O.maxY=-1/0;for(var L=d;L<v;L++){var M=h.children[L];u(O,h.leaf?k(M):M)}return O}function u(h,d){return h.minX=Math.min(h.minX,d.minX),h.minY=Math.min(h.minY,d.minY),h.maxX=Math.max(h.maxX,d.maxX),h.maxY=Math.max(h.maxY,d.maxY),h}function p(h,d){return h.minX-d.minX}function g(h,d){return h.minY-d.minY}function c(h){return(h.maxX-h.minX)*(h.maxY-h.minY)}function f(h){return h.maxX-h.minX+(h.maxY-h.minY)}function m(h,d){return h.minX<=d.minX&&h.minY<=d.minY&&d.maxX<=h.maxX&&d.maxY<=h.maxY}function y(h,d){return d.minX<=h.maxX&&d.minY<=h.maxY&&d.maxX>=h.minX&&d.maxY>=h.minY}function b(h){return{children:h,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function A(h,d,v,k,O){for(var L=[d,v];L.length;)if(!((v=L.pop())-(d=L.pop())<=k)){var M=d+Math.ceil((v-d)/k/2)*k;t(h,M,d,v,O),L.push(d,M,M,v)}}return o.prototype.all=function(){return this._all(this.data,[])},o.prototype.search=function(h){var d=this.data,v=[];if(!y(h,d))return v;for(var k=this.toBBox,O=[];d;){for(var L=0;L<d.children.length;L++){var M=d.children[L],N=d.leaf?k(M):M;y(h,N)&&(d.leaf?v.push(M):m(h,N)?this._all(M,v):O.push(M))}d=O.pop()}return v},o.prototype.collides=function(h){var d=this.data;if(!y(h,d))return!1;for(var v=[];d;){for(var k=0;k<d.children.length;k++){var O=d.children[k],L=d.leaf?this.toBBox(O):O;if(y(h,L)){if(d.leaf||m(h,L))return!0;v.push(O)}}d=v.pop()}return!1},o.prototype.load=function(h){if(!h||!h.length)return this;if(h.length<this._minEntries){for(var d=0;d<h.length;d++)this.insert(h[d]);return this}var v=this._build(h.slice(),0,h.length-1,0);if(this.data.children.length)if(this.data.height===v.height)this._splitRoot(this.data,v);else{if(this.data.height<v.height){var k=this.data;this.data=v,v=k}this._insert(v,this.data.height-v.height-1,!0)}else this.data=v;return this},o.prototype.insert=function(h){return h&&this._insert(h,this.data.height-1),this},o.prototype.clear=function(){return this.data=b([]),this},o.prototype.remove=function(h,d){if(!h)return this;for(var v,k,O,L=this.data,M=this.toBBox(h),N=[],T=[];L||N.length;){if(L||(L=N.pop(),k=N[N.length-1],v=T.pop(),O=!0),L.leaf){var F=s(h,L.children,d);if(F!==-1)return L.children.splice(F,1),N.push(L),this._condense(N),this}O||L.leaf||!m(L,M)?k?(v++,L=k.children[v],O=!1):L=null:(N.push(L),T.push(v),v=0,k=L,L=L.children[0])}return this},o.prototype.toBBox=function(h){return h},o.prototype.compareMinX=function(h,d){return h.minX-d.minX},o.prototype.compareMinY=function(h,d){return h.minY-d.minY},o.prototype.toJSON=function(){return this.data},o.prototype.fromJSON=function(h){return this.data=h,this},o.prototype._all=function(h,d){for(var v=[];h;)h.leaf?d.push.apply(d,h.children):v.push.apply(v,h.children),h=v.pop();return d},o.prototype._build=function(h,d,v,k){var O,L=v-d+1,M=this._maxEntries;if(L<=M)return a(O=b(h.slice(d,v+1)),this.toBBox),O;k||(k=Math.ceil(Math.log(L)/Math.log(M)),M=Math.ceil(L/Math.pow(M,k-1))),(O=b([])).leaf=!1,O.height=k;var N=Math.ceil(L/M),T=N*Math.ceil(Math.sqrt(M));A(h,d,v,T,this.compareMinX);for(var F=d;F<=v;F+=T){var G=Math.min(F+T-1,v);A(h,F,G,N,this.compareMinY);for(var x=F;x<=G;x+=N){var C=Math.min(x+N-1,G);O.children.push(this._build(h,x,C,k-1))}}return a(O,this.toBBox),O},o.prototype._chooseSubtree=function(h,d,v,k){for(;k.push(d),!d.leaf&&k.length-1!==v;){for(var O=1/0,L=1/0,M=void 0,N=0;N<d.children.length;N++){var T=d.children[N],F=c(T),G=(x=h,C=T,(Math.max(C.maxX,x.maxX)-Math.min(C.minX,x.minX))*(Math.max(C.maxY,x.maxY)-Math.min(C.minY,x.minY))-F);G<L?(L=G,O=F<O?F:O,M=T):G===L&&F<O&&(O=F,M=T)}d=M||d.children[0]}var x,C;return d},o.prototype._insert=function(h,d,v){var k=v?h:this.toBBox(h),O=[],L=this._chooseSubtree(k,this.data,d,O);for(L.children.push(h),u(L,k);d>=0&&O[d].children.length>this._maxEntries;)this._split(O,d),d--;this._adjustParentBBoxes(k,O,d)},o.prototype._split=function(h,d){var v=h[d],k=v.children.length,O=this._minEntries;this._chooseSplitAxis(v,O,k);var L=this._chooseSplitIndex(v,O,k),M=b(v.children.splice(L,v.children.length-L));M.height=v.height,M.leaf=v.leaf,a(v,this.toBBox),a(M,this.toBBox),d?h[d-1].children.push(M):this._splitRoot(v,M)},o.prototype._splitRoot=function(h,d){this.data=b([h,d]),this.data.height=h.height+1,this.data.leaf=!1,a(this.data,this.toBBox)},o.prototype._chooseSplitIndex=function(h,d,v){for(var k,O,L,M,N,T,F,G=1/0,x=1/0,C=d;C<=v-d;C++){var re=l(h,0,C,this.toBBox),de=l(h,C,v,this.toBBox),be=(O=re,L=de,M=void 0,N=void 0,T=void 0,F=void 0,M=Math.max(O.minX,L.minX),N=Math.max(O.minY,L.minY),T=Math.min(O.maxX,L.maxX),F=Math.min(O.maxY,L.maxY),Math.max(0,T-M)*Math.max(0,F-N)),oe=c(re)+c(de);be<G?(G=be,k=C,x=oe<x?oe:x):be===G&&oe<x&&(x=oe,k=C)}return k||v-d},o.prototype._chooseSplitAxis=function(h,d,v){var k=h.leaf?this.compareMinX:p,O=h.leaf?this.compareMinY:g;this._allDistMargin(h,d,v,k)<this._allDistMargin(h,d,v,O)&&h.children.sort(k)},o.prototype._allDistMargin=function(h,d,v,k){h.children.sort(k);for(var O=this.toBBox,L=l(h,0,d,O),M=l(h,v-d,v,O),N=f(L)+f(M),T=d;T<v-d;T++){var F=h.children[T];u(L,h.leaf?O(F):F),N+=f(L)}for(var G=v-d-1;G>=d;G--){var x=h.children[G];u(M,h.leaf?O(x):x),N+=f(M)}return N},o.prototype._adjustParentBBoxes=function(h,d,v){for(var k=v;k>=0;k--)u(d[k],h)},o.prototype._condense=function(h){for(var d=h.length-1,v=void 0;d>=0;d--)h[d].children.length===0?d>0?(v=h[d-1].children).splice(v.indexOf(h[d]),1):this.clear():a(h[d],this.toBBox)},o})})(Yo);const qo=Cn(ai),Do=Cn(ui),$o=Cn(fi);var Me=_n,Fr=qo,Cr=Do,ot=$o.default,jo=Cr.featureEach;Cr.coordEach;Fr.polygon;var mr=Fr.featureCollection;function Tr(r){var e=new Me(r);return e.insert=function(t){if(t.type!=="Feature")throw new Error("invalid feature");return t.bbox=t.bbox?t.bbox:ot(t),Me.prototype.insert.call(this,t)},e.load=function(t){var n=[];return Array.isArray(t)?t.forEach(function(i){if(i.type!=="Feature")throw new Error("invalid features");i.bbox=i.bbox?i.bbox:ot(i),n.push(i)}):jo(t,function(i){if(i.type!=="Feature")throw new Error("invalid features");i.bbox=i.bbox?i.bbox:ot(i),n.push(i)}),Me.prototype.load.call(this,n)},e.remove=function(t,n){if(t.type!=="Feature")throw new Error("invalid feature");return t.bbox=t.bbox?t.bbox:ot(t),Me.prototype.remove.call(this,t,n)},e.clear=function(){return Me.prototype.clear.call(this)},e.search=function(t){var n=Me.prototype.search.call(this,this.toBBox(t));return mr(n)},e.collides=function(t){return Me.prototype.collides.call(this,this.toBBox(t))},e.all=function(){var t=Me.prototype.all.call(this);return mr(t)},e.toJSON=function(){return Me.prototype.toJSON.call(this)},e.fromJSON=function(t){return Me.prototype.fromJSON.call(this,t)},e.toBBox=function(t){var n;if(t.bbox)n=t.bbox;else if(Array.isArray(t)&&t.length===4)n=t;else if(Array.isArray(t)&&t.length===6)n=[t[0],t[1],t[3],t[4]];else if(t.type==="Feature")n=ot(t);else if(t.type==="FeatureCollection")n=ot(t);else throw new Error("invalid geojson");return{minX:n[0],minY:n[1],maxX:n[2],maxY:n[3]}},e}Go.exports=Tr;ht.default=Tr;function Br(r,e){var t={},n=[];if(r.type==="LineString"&&(r=Un(r)),e.type==="LineString"&&(e=Un(e)),r.type==="Feature"&&e.type==="Feature"&&r.geometry!==null&&e.geometry!==null&&r.geometry.type==="LineString"&&e.geometry.type==="LineString"&&r.geometry.coordinates.length===2&&e.geometry.coordinates.length===2){var i=vr(r,e);return i&&n.push(i),Je(n)}var o=ht();return o.load(yn(e)),Dt(yn(r),function(s){Dt(o.search(s),function(a){var l=vr(s,a);if(l){var u=Re(l).join(",");t[u]||(t[u]=!0,n.push(l))}})}),Je(n)}function vr(r,e){var t=Re(r),n=Re(e);if(t.length!==2)throw new Error("<intersects> line1 must only contain 2 coordinates");if(n.length!==2)throw new Error("<intersects> line2 must only contain 2 coordinates");var i=t[0][0],o=t[0][1],s=t[1][0],a=t[1][1],l=n[0][0],u=n[0][1],p=n[1][0],g=n[1][1],c=(g-u)*(s-i)-(p-l)*(a-o),f=(p-l)*(o-u)-(g-u)*(i-l),m=(s-i)*(o-u)-(a-o)*(i-l);if(c===0)return f===0&&m===0,null;var y=f/c,b=m/c;if(y>=0&&y<=1&&b>=0&&b<=1){var A=i+y*(s-i),h=o+y*(a-o);return ft([A,h])}return null}function Lt(r,e,t){t===void 0&&(t={});var n=ft([1/0,1/0],{dist:1/0}),i=0;return Fn(r,function(o){for(var s=Re(o),a=0;a<s.length-1;a++){var l=ft(s[a]);l.properties.dist=$e(e,l,t);var u=ft(s[a+1]);u.properties.dist=$e(e,u,t);var p=$e(l,u,t),g=Math.max(l.properties.dist,u.properties.dist),c=Nr(l,u),f=gr(e,g,c+90,t),m=gr(e,g,c-90,t),y=Br(ct([f.geometry.coordinates,m.geometry.coordinates]),ct([l.geometry.coordinates,u.geometry.coordinates])),b=null;y.features.length>0&&(b=y.features[0],b.properties.dist=$e(e,b,t),b.properties.location=i+$e(l,b,t)),l.properties.dist<n.properties.dist&&(n=l,n.properties.index=a,n.properties.location=i),u.properties.dist<n.properties.dist&&(n=u,n.properties.index=a+1,n.properties.location=i+p),b&&b.properties.dist<n.properties.dist&&(n=b,n.properties.index=a),i+=p}}),n}const st="edit-polygon-mode";var Pe,He,Rt,bn,At,wn;class Xo{constructor(e){We(this,Pe);We(this,Rt);We(this,At);fe(this,"map");fe(this,"active");fe(this,"eventListeners");fe(this,"points");fe(this,"cursor");fe(this,"hover");fe(this,"dragFrom");this.map=e,this.active=!1,this.eventListeners=[],this.points=[],this.cursor=null,this.hover=null,this.dragFrom=null,e.on("mousemove",t=>{if(this.active&&!this.dragFrom)ie(this,Rt,bn).call(this,t);else if(this.active&&this.dragFrom){if(this.hover=="polygon"){let n=this.dragFrom[0]-t.lngLat.lng,i=this.dragFrom[1]-t.lngLat.lat;for(let o of this.points)o[0]-=n,o[1]-=i}else this.points[this.hover]=t.lngLat.toArray();this.dragFrom=t.lngLat.toArray(),ie(this,Pe,He).call(this)}}),e.on("click",t=>{if(this.active&&this.cursor){let n=[];if(_r(this.points).forEach((i,o)=>{n.push([o+1,Lt(i,this.cursor).properties.dist])}),n.sort((i,o)=>i[1]-o[1]),n.length>0){let i=n[0][0];this.points.splice(i,0,this.cursor.geometry.coordinates),this.hover=i}else this.points.push(this.cursor.geometry.coordinates),this.hover=this.points.length-1;ie(this,Pe,He).call(this)}else this.active&&typeof this.hover=="number"&&(this.points.splice(this.hover,1),this.hover=null,ie(this,Pe,He).call(this),ie(this,Rt,bn).call(this,t))}),e.on("mousedown",t=>{this.active&&!this.dragFrom&&this.hover!=null&&(t.preventDefault(),this.cursor=null,this.dragFrom=t.lngLat.toArray())}),e.on("mouseup",()=>{this.active&&this.dragFrom&&(this.dragFrom=null)}),document.addEventListener("keypress",t=>{if(this.active&&t.key=="Enter"){t.preventDefault();let n=ie(this,At,wn).call(this);if(n)for(let i of this.eventListeners)i(n);this.stop()}}),Ke(e,st,{type:"geojson",data:Ae()}),me(e,{id:"edit-polygon-fill",source:st,filter:Nn,...In("red",["case",["boolean",["get","hover"],"false"],1,.5])}),me(e,{id:"edit-polygon-lines",source:st,filter:Qt,...kt("black",8,.5)}),me(e,{id:"edit-polygon-vertices",source:st,filter:Zt,...dt(_e.hovering,en,["case",["boolean",["get","hover"],"false"],1,.5])})}addEventListener(e){this.eventListeners.push(e)}tearDown(){this.map.removeLayer("edit-polygon-vertices"),this.map.removeLayer("edit-polygon-fill"),this.map.removeLayer("edit-polygon-lines"),this.map.removeSource(st)}startNew(){this.active=!0}editExisting(e){this.active=!0,this.points=e.geometry.coordinates[0],this.points.pop(),ie(this,Pe,He).call(this)}stop(){this.points=[],this.cursor=null,this.active=!1,this.hover=null,this.dragFrom=null,ie(this,Pe,He).call(this)}}Pe=new WeakSet,He=function(){let e=Ae();this.points.forEach((n,i)=>{let o=yr(n);o.properties.hover=this.hover==i,o.properties.idx=i,e.features.push(o)}),this.cursor&&e.features.push(this.cursor),e.features=e.features.concat(_r(this.points));let t=ie(this,At,wn).call(this);t&&(t.properties.hover=this.hover=="polygon",e.features.push(t)),this.map.getSource(st).setData(e)},Rt=new WeakSet,bn=function(e){this.cursor=null,this.hover=null;for(let t of this.map.queryRenderedFeatures(e.point,{layers:["edit-polygon-fill","edit-polygon-vertices"]}))if(t.geometry.type=="Polygon"){this.hover="polygon";break}else if(t.geometry.type=="Point"&&Object.hasOwn(t.properties,"idx")){this.hover=t.properties.idx;break}this.hover==null&&(this.cursor=yr(e.lngLat.toArray())),ie(this,Pe,He).call(this)},At=new WeakSet,wn=function(){if(this.points.length<3)return null;let e=[JSON.parse(JSON.stringify(this.points))];return e[0].push(JSON.parse(JSON.stringify(e[0][0]))),{type:"Feature",geometry:{type:"Polygon",coordinates:e},properties:{}}};function yr(r){return{type:"Feature",properties:{},geometry:{type:"Point",coordinates:r}}}function _r(r){let e=[];for(let t=0;t<r.length-1;t++)e.push({type:"Feature",geometry:{type:"LineString",coordinates:[r[t],r[t+1]]},properties:{}});return r.length>=3&&e.push({type:"Feature",geometry:{type:"LineString",coordinates:[r[r.length-1],r[0]]},properties:{}}),e}let B;const Gr=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});Gr.decode();let Bt=new Uint8Array;function St(){return Bt.byteLength===0&&(Bt=new Uint8Array(B.memory.buffer)),Bt}function at(r,e){return Gr.decode(St().subarray(r,r+e))}const Fe=new Array(32).fill(void 0);Fe.push(void 0,null,!0,!1);let Et=Fe.length;function se(r){Et===Fe.length&&Fe.push(Fe.length+1);const e=Et;return Et=Fe[e],Fe[e]=r,e}function D(r){return Fe[r]}function Jo(r){r<36||(Fe[r]=Et,Et=r)}function xn(r){const e=D(r);return Jo(r),e}function rn(r){return r==null}let Gt=new Float64Array;function zo(){return Gt.byteLength===0&&(Gt=new Float64Array(B.memory.buffer)),Gt}let Yt=new Int32Array;function le(){return Yt.byteLength===0&&(Yt=new Int32Array(B.memory.buffer)),Yt}let Xe=0;const qt=new TextEncoder("utf-8"),Uo=typeof qt.encodeInto=="function"?function(r,e){return qt.encodeInto(r,e)}:function(r,e){const t=qt.encode(r);return e.set(t),{read:r.length,written:t.length}};function Nt(r,e,t){if(t===void 0){const a=qt.encode(r),l=e(a.length);return St().subarray(l,l+a.length).set(a),Xe=a.length,l}let n=r.length,i=e(n);const o=St();let s=0;for(;s<n;s++){const a=r.charCodeAt(s);if(a>127)break;o[i+s]=a}if(s!==n){s!==0&&(r=r.slice(s)),i=t(i,n,n=s+r.length*3);const a=St().subarray(i+s,i+n),l=Uo(r,a);s+=l.written}return Xe=s,i}function Sn(r){const e=typeof r;if(e=="number"||e=="boolean"||r==null)return`${r}`;if(e=="string")return`"${r}"`;if(e=="symbol"){const i=r.description;return i==null?"Symbol":`Symbol(${i})`}if(e=="function"){const i=r.name;return typeof i=="string"&&i.length>0?`Function(${i})`:"Function"}if(Array.isArray(r)){const i=r.length;let o="[";i>0&&(o+=Sn(r[0]));for(let s=1;s<i;s++)o+=", "+Sn(r[s]);return o+="]",o}const t=/\[object ([^\]]+)\]/.exec(toString.call(r));let n;if(t.length>1)n=t[1];else return toString.call(r);if(n=="Object")try{return"Object("+JSON.stringify(r)+")"}catch{return"Object"}return r instanceof Error?`${r.name}: ${r.message}
${r.stack}`:n}function Wo(r,e){const t=e(r.length*1);return St().set(r,t/1),Xe=r.length,t}function on(r,e){try{return r.apply(this,e)}catch(t){B.__wbindgen_exn_store(se(t))}}class zt{static __wrap(e){const t=Object.create(zt.prototype);return t.ptr=e,t}__destroy_into_raw(){const e=this.ptr;return this.ptr=0,e}free(){const e=this.__destroy_into_raw();B.__wbg_jsroutesnapper_free(e)}constructor(e){try{const o=B.__wbindgen_add_to_stack_pointer(-16),s=Wo(e,B.__wbindgen_malloc),a=Xe;B.jsroutesnapper_new(o,s,a);var t=le()[o/4+0],n=le()[o/4+1],i=le()[o/4+2];if(i)throw xn(n);return zt.__wrap(t)}finally{B.__wbindgen_add_to_stack_pointer(16)}}setConfig(e){B.jsroutesnapper_setConfig(this.ptr,se(e))}toFinalFeature(){try{const n=B.__wbindgen_add_to_stack_pointer(-16);B.jsroutesnapper_toFinalFeature(n,this.ptr);var e=le()[n/4+0],t=le()[n/4+1];let i;return e!==0&&(i=at(e,t).slice(),B.__wbindgen_free(e,t*1)),i}finally{B.__wbindgen_add_to_stack_pointer(16)}}renderGeojson(){try{const n=B.__wbindgen_add_to_stack_pointer(-16);B.jsroutesnapper_renderGeojson(n,this.ptr);var e=le()[n/4+0],t=le()[n/4+1];return at(e,t)}finally{B.__wbindgen_add_to_stack_pointer(16),B.__wbindgen_free(e,t)}}setSnapMode(e){B.jsroutesnapper_setSnapMode(this.ptr,e)}onMouseMove(e,t,n){return B.jsroutesnapper_onMouseMove(this.ptr,e,t,n)!==0}onClick(){B.jsroutesnapper_onClick(this.ptr)}onDragStart(){return B.jsroutesnapper_onDragStart(this.ptr)!==0}onMouseUp(){return B.jsroutesnapper_onMouseUp(this.ptr)!==0}clearState(){B.jsroutesnapper_clearState(this.ptr)}editExisting(e){try{const i=B.__wbindgen_add_to_stack_pointer(-16);B.jsroutesnapper_editExisting(i,this.ptr,se(e));var t=le()[i/4+0],n=le()[i/4+1];if(n)throw xn(t)}finally{B.__wbindgen_add_to_stack_pointer(16)}}}async function Ho(r,e){if(typeof Response=="function"&&r instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(r,e)}catch(n){if(r.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",n);else throw n}const t=await r.arrayBuffer();return await WebAssembly.instantiate(t,e)}else{const t=await WebAssembly.instantiate(r,e);return t instanceof WebAssembly.Instance?{instance:t,module:r}:t}}function Vo(){const r={};return r.wbg={},r.wbg.__wbindgen_string_new=function(e,t){const n=at(e,t);return se(n)},r.wbg.__wbindgen_object_drop_ref=function(e){xn(e)},r.wbg.__wbindgen_boolean_get=function(e){const t=D(e);return typeof t=="boolean"?t?1:0:2},r.wbg.__wbindgen_error_new=function(e,t){const n=new Error(at(e,t));return se(n)},r.wbg.__wbindgen_is_object=function(e){const t=D(e);return typeof t=="object"&&t!==null},r.wbg.__wbindgen_is_undefined=function(e){return D(e)===void 0},r.wbg.__wbindgen_in=function(e,t){return D(e)in D(t)},r.wbg.__wbindgen_number_get=function(e,t){const n=D(t),i=typeof n=="number"?n:void 0;zo()[e/8+1]=rn(i)?0:i,le()[e/4+0]=!rn(i)},r.wbg.__wbindgen_jsval_loose_eq=function(e,t){return D(e)==D(t)},r.wbg.__wbindgen_string_get=function(e,t){const n=D(t),i=typeof n=="string"?n:void 0;var o=rn(i)?0:Nt(i,B.__wbindgen_malloc,B.__wbindgen_realloc),s=Xe;le()[e/4+1]=s,le()[e/4+0]=o},r.wbg.__wbg_String_91fba7ded13ba54c=function(e,t){const n=String(D(t)),i=Nt(n,B.__wbindgen_malloc,B.__wbindgen_realloc),o=Xe;le()[e/4+1]=o,le()[e/4+0]=i},r.wbg.__wbindgen_object_clone_ref=function(e){const t=D(e);return se(t)},r.wbg.__wbg_getwithrefkey_15c62c2b8546208d=function(e,t){const n=D(e)[D(t)];return se(n)},r.wbg.__wbg_log_4b5638ad60bdc54a=function(e){console.log(D(e))},r.wbg.__wbg_get_57245cc7d7c7619d=function(e,t){const n=D(e)[t>>>0];return se(n)},r.wbg.__wbg_length_6e3bbe7c8bd4dbd8=function(e){return D(e).length},r.wbg.__wbindgen_is_function=function(e){return typeof D(e)=="function"},r.wbg.__wbg_next_579e583d33566a86=function(e){const t=D(e).next;return se(t)},r.wbg.__wbg_next_aaef7c8aa5e212ac=function(){return on(function(e){const t=D(e).next();return se(t)},arguments)},r.wbg.__wbg_done_1b73b0672e15f234=function(e){return D(e).done},r.wbg.__wbg_value_1ccc36bc03462d71=function(e){const t=D(e).value;return se(t)},r.wbg.__wbg_iterator_6f9d4f28845f426c=function(){return se(Symbol.iterator)},r.wbg.__wbg_get_765201544a2b6869=function(){return on(function(e,t){const n=Reflect.get(D(e),D(t));return se(n)},arguments)},r.wbg.__wbg_call_97ae9d8645dc388b=function(){return on(function(e,t){const n=D(e).call(D(t));return se(n)},arguments)},r.wbg.__wbg_isArray_27c46c67f498e15d=function(e){return Array.isArray(D(e))},r.wbg.__wbg_instanceof_ArrayBuffer_e5e48f4762c5610b=function(e){let t;try{t=D(e)instanceof ArrayBuffer}catch{t=!1}return t},r.wbg.__wbg_buffer_3f3d764d4747d564=function(e){const t=D(e).buffer;return se(t)},r.wbg.__wbg_new_8c3f0052272a457a=function(e){const t=new Uint8Array(D(e));return se(t)},r.wbg.__wbg_set_83db9690f9353e79=function(e,t,n){D(e).set(D(t),n>>>0)},r.wbg.__wbg_length_9e1ae1900cb0fbd5=function(e){return D(e).length},r.wbg.__wbg_instanceof_Uint8Array_971eeda69eb75003=function(e){let t;try{t=D(e)instanceof Uint8Array}catch{t=!1}return t},r.wbg.__wbg_new_abda76e883ba8a5f=function(){const e=new Error;return se(e)},r.wbg.__wbg_stack_658279fe44541cf6=function(e,t){const n=D(t).stack,i=Nt(n,B.__wbindgen_malloc,B.__wbindgen_realloc),o=Xe;le()[e/4+1]=o,le()[e/4+0]=i},r.wbg.__wbg_error_f851667af71bcfc6=function(e,t){try{console.error(at(e,t))}finally{B.__wbindgen_free(e,t)}},r.wbg.__wbindgen_debug_string=function(e,t){const n=Sn(D(t)),i=Nt(n,B.__wbindgen_malloc,B.__wbindgen_realloc),o=Xe;le()[e/4+1]=o,le()[e/4+0]=i},r.wbg.__wbindgen_throw=function(e,t){throw new Error(at(e,t))},r.wbg.__wbindgen_memory=function(){const e=B.memory;return se(e)},r}function Zo(r,e){return B=r.exports,Yr.__wbindgen_wasm_module=e,Gt=new Float64Array,Yt=new Int32Array,Bt=new Uint8Array,B}async function Yr(r){typeof r>"u"&&(r="/atip/assets/route_snapper_bg.wasm");const e=Vo();(typeof r=="string"||typeof Request=="function"&&r instanceof Request||typeof URL=="function"&&r instanceof URL)&&(r=fetch(r));const{instance:t,module:n}=await Ho(await r,e);return Zo(t,n)}const Ft="route-snapper",br=10,Qo=30;var Wt,qr,Ne,Ve;class Ko{constructor(e,t){We(this,Wt);We(this,Ne);fe(this,"map");fe(this,"inner");fe(this,"active");fe(this,"eventListenersSuccess");fe(this,"eventListenersFailure");this.map=e,console.time("Deserialize and setup JsRouteSnapper"),this.inner=new zt(t),console.timeEnd("Deserialize and setup JsRouteSnapper"),this.active=!1,this.eventListenersSuccess=[],this.eventListenersFailure=[],Ke(e,Ft,{type:"geojson",data:Ae()}),me(e,{id:"route-points",source:Ft,filter:Zt,...dt(["match",["get","type"],"hovered","green","important","red","black"],["match",["get","type"],"unimportant",br/2,br])}),me(e,{id:"route-lines",source:Ft,filter:Qt,...kt("black",2.5)}),e.on("mousemove",n=>{if(!this.active)return;const i=[n.point.x-Qo,n.point.y],o=this.map.unproject(n.point).distanceTo(this.map.unproject(i));this.inner.onMouseMove(n.lngLat.lng,n.lngLat.lat,o)&&ie(this,Ne,Ve).call(this)}),e.on("click",()=>{this.active&&(this.inner.onClick(),ie(this,Ne,Ve).call(this))}),e.on("dragstart",n=>{this.active&&this.inner.onDragStart()&&this.map.dragPan.disable()}),e.on("mouseup",n=>{this.active&&this.inner.onMouseUp()&&this.map.dragPan.enable()}),document.addEventListener("keypress",n=>{this.active&&n.key=="Enter"&&(n.preventDefault(),ie(this,Wt,qr).call(this))}),document.addEventListener("keydown",n=>{this.active&&n.key=="Shift"&&(console.log("freehand"),n.preventDefault(),this.inner.setSnapMode(!1),ie(this,Ne,Ve).call(this))}),document.addEventListener("keyup",n=>{this.active&&n.key=="Shift"&&(console.log("snap mode"),n.preventDefault(),this.inner.setSnapMode(!0),ie(this,Ne,Ve).call(this))})}start(){this.active||(this.active=!0,this.map.boxZoom.disable())}stop(){this.active=!1,this.inner.clearState(),ie(this,Ne,Ve).call(this),this.map.boxZoom.enable()}editExisting(e){this.active&&window.alert("Bug: editExisting called when tool is already active"),e.properties.waypoints||(e.properties.waypoints=[{lon:e.geometry.coordinates[0][0],lat:e.geometry.coordinates[0][1],snapped:!0},{lon:e.geometry.coordinates[e.geometry.coordinates.length-1][0],lat:e.geometry.coordinates[e.geometry.coordinates.length-1][1],snapped:!0}]),this.start(),this.inner.editExisting(e.properties.waypoints),ie(this,Ne,Ve).call(this)}tearDown(){this.map.removeLayer("route-points"),this.map.removeLayer("route-lines"),this.map.removeSource("route-snapper")}addEventListenerSuccess(e){this.eventListenersSuccess.push(e)}addEventListenerFailure(e){this.eventListenersFailure.push(e)}isActive(){return this.active}}Wt=new WeakSet,qr=function(){let e=this.inner.toFinalFeature();if(e)for(let t of this.eventListenersSuccess)t(JSON.parse(e));else for(let t of this.eventListenersFailure)t();this.stop()},Ne=new WeakSet,Ve=function(){this.map.getSource(Ft).setData(JSON.parse(this.inner.renderGeojson()))};function wr(r){let e;return{c(){e=w("p"),e.textContent="Click an intervention to fill out its attributes"},m(t,n){S(t,e,n)},d(t){t&&E(e)}}}function es(r){let e,t=r[0]==ut&&wr();return{c(){t&&t.c(),e=Te()},m(n,i){t&&t.m(n,i),S(n,e,i)},p(n,[i]){n[0]==ut?t||(t=wr(),t.c(),t.m(e.parentNode,e)):t&&(t.d(1),t=null)},i:J,o:J,d(n){t&&t.d(n),n&&E(e)}}}const ut="edit-attribute";function Dr(){}function ts(r,e,t){let n,i;ee(r,Ie,l=>t(4,n=l)),ee(r,W,l=>t(5,i=l));let{mode:o}=e,{changeMode:s}=e;function a(){we.set(null)}return n.on("mousemove",l=>{var u;if(o==ut){let p=n.queryRenderedFeatures(l.point,{layers:["interventions-points","interventions-lines","interventions-polygons"]});Ce.set(((u=p[0])==null?void 0:u.id)||null)}}),n.on("mouseout",()=>{o==ut&&Ce.set(null)}),n.on("click",l=>{if(o==ut){let u=n.queryRenderedFeatures(l.point,{layers:["interventions-points","interventions-lines","interventions-polygons"]});u.length>0?we.set(u[0].id):we.set(null)}}),un.subscribe(l=>{if(l){let u=i.features.find(p=>p.id==l);u.geometry.type=="Point"?n.flyTo({center:u.geometry.coordinates,duration:500}):n.fitBounds(An(u),{padding:200,duration:500}),s(ut)}}),r.$$set=l=>{"mode"in l&&t(0,o=l.mode),"changeMode"in l&&t(1,s=l.changeMode)},[o,s,Dr,a]}class ns extends te{constructor(e){super(),ne(this,e,ts,es,Q,{mode:0,changeMode:1,start:2,stop:3})}get start(){return Dr}get stop(){return this.$$.ctx[3]}}function xr(r){let e;return{c(){e=w("p"),e.textContent="Click an intervention to edit its geometry"},m(t,n){S(t,e,n)},d(t){t&&E(e)}}}function rs(r){let e,t=r[0]==qe&&xr();return{c(){t&&t.c(),e=Te()},m(n,i){t&&t.m(n,i),S(n,e,i)},p(n,[i]){n[0]==qe?t||(t=xr(),t.c(),t.m(e.parentNode,e)):t&&(t.d(1),t=null)},i:J,o:J,d(n){t&&t.d(n),n&&E(e)}}}const qe="edit-geometry";function $r(){}function is(r,e,t){let n;ee(r,Ie,g=>t(7,n=g));let{mode:i}=e,{pointTool:o}=e,{polygonTool:s}=e,{routeTool:a}=e;function l(){u&&(o.stop(),s.stop(),a.stop(),W.update(g=>{let c=g.features.find(f=>f.id==u);return delete c.properties.hide_while_editing,g})),u=null,Ce.set(null)}let u=null;n.on("mousemove",g=>{var c;if(i==qe&&u==null){let f=n.queryRenderedFeatures(g.point,{layers:["interventions-points","interventions-lines","interventions-polygons"]});Ce.set(((c=f[0])==null?void 0:c.id)||null)}}),n.on("mouseout",()=>{i==qe&&u==null&&Ce.set(null)}),n.on("click",g=>{if(i==qe&&u==null){let c=n.queryRenderedFeatures(g.point,{layers:["interventions-points","interventions-lines","interventions-polygons"]});c.length>0&&p(c[0].id)}}),a.addEventListenerSuccess(g=>{i==qe&&(W.update(c=>{let f=c.features.find(m=>m.id==u);return f.properties.length_meters=g.properties.length_meters,f.properties.waypoints=g.properties.waypoints,delete f.properties.hide_while_editing,f.geometry=g.geometry,c}),u=null)}),a.addEventListenerFailure(()=>{i==qe&&(W.update(g=>{let c=g.features.find(f=>f.id==u);return delete c.properties.hide_while_editing,g}),u=null)});for(let g of[o,s])g.addEventListener(c=>{i==qe&&(W.update(f=>{let m=f.features.find(y=>y.id==u);return m.geometry=c.geometry,delete m.properties.hide_while_editing,f}),u=null)});function p(g){Ce.set(null);let c=null;W.update(m=>(c=m.features.find(y=>y.id==g),c.properties.hide_while_editing=!0,m));let f=c;u=g,f.geometry.type=="LineString"?a.editExisting(f):f.geometry.type=="Polygon"?s.editExisting(f):f.geometry.type=="Point"&&o.start()}return r.$$set=g=>{"mode"in g&&t(0,i=g.mode),"pointTool"in g&&t(1,o=g.pointTool),"polygonTool"in g&&t(2,s=g.polygonTool),"routeTool"in g&&t(3,a=g.routeTool)},[i,o,s,a,$r,l]}class os extends te{constructor(e){super(),ne(this,e,is,rs,Q,{mode:0,pointTool:1,polygonTool:2,routeTool:3,start:4,stop:5})}get start(){return $r}get stop(){return this.$$.ctx[5]}}async function ss(r,e){const t=await fetch(r),n=t.body.getReader(),i=t.headers.get("Content-Length");let o=0,s=[];for(;;){const{done:u,value:p}=await n.read();if(u)break;s.push(p),o+=p.length;const g=100*o/i;e.style=`background: linear-gradient(to right, red ${g}%, transparent 0);`}let a=new Uint8Array(o),l=0;for(let u of s)a.set(u,l),l+=u.length;return a}function ls(r){let e;return{c(){e=w("p"),e.textContent="Controls go here"},m(t,n){S(t,e,n)},p:J,d(t){t&&E(e)}}}function as(r){let e;return{c(){e=w("div"),e.textContent="Route tool loading..."},m(t,n){S(t,e,n),r[7](e)},p:J,d(t){t&&E(e),r[7](null)}}}function us(r){let e;function t(o,s){if(!o[0])return as;if(o[1]==En)return ls}let n=t(r),i=n&&n(r);return{c(){i&&i.c(),e=Te()},m(o,s){i&&i.m(o,s),S(o,e,s)},p(o,[s]){n===(n=t(o))&&i?i.p(o,s):(i&&i.d(1),i=n&&n(o),i&&(i.c(),i.m(e.parentNode,e)))},i:J,o:J,d(o){i&&i.d(o),o&&E(e)}}}const En="route";function fs(r,e,t){let n;ee(r,Ie,c=>t(8,n=c));let{mode:i}=e,{changeMode:o}=e,{url:s}=e,a,{routeTool:l}=e;function u(){l.isActive()||l.start()}function p(){l==null||l.stop()}On(async()=>{await Yr(),console.log(`Grabbing ${s}`);try{const c=await ss(s,a);t(0,l=new Ko(n,c))}catch(c){console.log(`Route tool broke: ${c}`),t(2,a.innerHTML="Failed to load",a)}l.addEventListenerFailure(()=>{i==En&&o("edit-attribute")}),l.addEventListenerSuccess(c=>{i==En&&(W.update(f=>(c.id=Kt(f),c.properties.intervention_type="route",f.features.push(c),f)),o("edit-attribute"),we.set(c.id))})}),Rn(()=>{l==null||l.tearDown()});function g(c){pe[c?"unshift":"push"](()=>{a=c,t(2,a)})}return r.$$set=c=>{"mode"in c&&t(1,i=c.mode),"changeMode"in c&&t(3,o=c.changeMode),"url"in c&&t(4,s=c.url),"routeTool"in c&&t(0,l=c.routeTool)},[l,i,a,o,s,u,p,g]}class cs extends te{constructor(e){super(),ne(this,e,fs,us,Q,{mode:1,changeMode:3,url:4,routeTool:0,start:5,stop:6})}get start(){return this.$$.ctx[5]}get stop(){return this.$$.ctx[6]}}function Sr(r){let e;return{c(){e=w("p"),e.textContent="Click to add a new point"},m(t,n){S(t,e,n)},d(t){t&&E(e)}}}function hs(r){let e,t=r[0]==kn&&Sr();return{c(){t&&t.c(),e=Te()},m(n,i){t&&t.m(n,i),S(n,e,i)},p(n,[i]){n[0]==kn?t||(t=Sr(),t.c(),t.m(e.parentNode,e)):t&&(t.d(1),t=null)},i:J,o:J,d(n){t&&t.d(n),n&&E(e)}}}const kn="point";function ps(r,e,t){let{mode:n}=e,{changeMode:i}=e,{pointTool:o}=e;function s(){o.start()}function a(){o.stop()}return o.addEventListener(l=>{n==kn&&(W.update(u=>(l.id=Kt(u),l.properties.intervention_type="other",u.features.push(l),u)),i("edit-attribute"),we.set(l.id))}),r.$$set=l=>{"mode"in l&&t(0,n=l.mode),"changeMode"in l&&t(1,i=l.changeMode),"pointTool"in l&&t(2,o=l.pointTool)},[n,i,o,s,a]}class ds extends te{constructor(e){super(),ne(this,e,ps,hs,Q,{mode:0,changeMode:1,pointTool:2,start:3,stop:4})}get start(){return this.$$.ctx[3]}get stop(){return this.$$.ctx[4]}}function Er(r){let e;return{c(){e=w("p"),e.innerHTML="Click the map to add a vertex, or click a vertex to delete it. Press <strong>Enter</strong> to finish. Drag a vertex or the polygon to move."},m(t,n){S(t,e,n)},d(t){t&&E(e)}}}function gs(r){let e,t=r[0]==Mn&&Er();return{c(){t&&t.c(),e=Te()},m(n,i){t&&t.m(n,i),S(n,e,i)},p(n,[i]){n[0]==Mn?t||(t=Er(),t.c(),t.m(e.parentNode,e)):t&&(t.d(1),t=null)},i:J,o:J,d(n){t&&t.d(n),n&&E(e)}}}const Mn="polygon";function ms(r,e,t){let{mode:n}=e,{changeMode:i}=e,{polygonTool:o}=e;function s(){o.startNew()}function a(){o.stop()}return o.addEventListener(l=>{n==Mn&&(W.update(u=>(l.id=Kt(u),l.properties.intervention_type="area",u.features.push(l),u)),i("edit-attribute"),we.set(l.id))}),r.$$set=l=>{"mode"in l&&t(0,n=l.mode),"changeMode"in l&&t(1,i=l.changeMode),"polygonTool"in l&&t(2,o=l.polygonTool)},[n,i,o,s,a]}class vs extends te{constructor(e){super(),ne(this,e,ms,gs,Q,{mode:0,changeMode:1,polygonTool:2,start:3,stop:4})}get start(){return this.$$.ctx[3]}get stop(){return this.$$.ctx[4]}}function ys(r){var e=r[0],t=r[1],n=r[2],i=r[3],o=$e(r.slice(0,2),[n,t]),s=$e(r.slice(0,2),[e,i]);if(o>=s){var a=(t+i)/2;return[e,a-(n-e)/2,n,a+(n-e)/2]}else{var l=(e+n)/2;return[l-(i-t)/2,t,l+(i-t)/2,i]}}function _s(r,e){e===void 0&&(e={});var t=e.precision,n=e.coordinates,i=e.mutate;if(t=t==null||isNaN(t)?6:t,n=n==null||isNaN(n)?3:n,!r)throw new Error("<geojson> is required");if(typeof t!="number")throw new Error("<precision> must be a number");if(typeof n!="number")throw new Error("<coordinates> must be a number");(i===!1||i===void 0)&&(r=JSON.parse(JSON.stringify(r)));var o=Math.pow(10,t);return ci(r,function(s){bs(s,o,n)}),r}function bs(r,e,t){r.length>t&&r.splice(t,r.length);for(var n=0;n<r.length;n++)r[n]=Math.round(r[n]*e)/e;return r}function ws(r,e){if(!r)throw new Error("line is required");if(!e)throw new Error("splitter is required");var t=mn(r),n=mn(e);if(t!=="LineString")throw new Error("line must be LineString");if(n==="FeatureCollection")throw new Error("splitter cannot be a FeatureCollection");if(n==="GeometryCollection")throw new Error("splitter cannot be a GeometryCollection");var i=_s(e,{precision:7});switch(n){case"Point":return Ln(r,i);case"MultiPoint":return kr(r,i);case"LineString":case"MultiLineString":case"Polygon":case"MultiPolygon":return kr(r,Br(r,i))}}function kr(r,e){var t=[],n=ht();return Fn(e,function(i){if(t.forEach(function(a,l){a.id=l}),!t.length)t=Ln(r,i).features,t.forEach(function(a){a.bbox||(a.bbox=ys(hi(a)))}),n.load(Je(t));else{var o=n.search(i);if(o.features.length){var s=jr(i,o);t=t.filter(function(a){return a.id!==s.id}),n.remove(s),Dt(Ln(s,i),function(a){t.push(a),n.insert(a)})}}}),Je(t)}function Ln(r,e){var t=[],n=Re(r)[0],i=Re(r)[r.geometry.coordinates.length-1];if(sn(n,ze(e))||sn(i,ze(e)))return Je([r]);var o=ht(),s=yn(r);o.load(s);var a=o.search(e);if(!a.features.length)return Je([r]);var l=jr(e,a),u=[n],p=pi(s,function(g,c,f){var m=Re(c)[1],y=ze(e);return f===l.id?(g.push(y),t.push(ct(g)),sn(y,m)?[y]:[y,m]):(g.push(m),g)},u);return p.length>1&&t.push(ct(p)),Je(t)}function jr(r,e){if(!e.features.length)throw new Error("lines must contain features");if(e.features.length===1)return e.features[0];var t,n=1/0;return Dt(e,function(i){var o=Lt(i,r),s=o.properties.dist;s<n&&(t=i,n=s)}),t}function sn(r,e){return r[0]===e[0]&&r[1]===e[1]}function xs(r,e,t){var n=Re(t);if(mn(t)!=="LineString")throw new Error("line must be a LineString");var i=Lt(t,r),o=Lt(t,e),s;i.properties.index<=o.properties.index?s=[i,o]:s=[o,i];for(var a=[s[0].geometry.coordinates],l=s[0].properties.index+1;l<s[1].properties.index+1;l++)a.push(n[l]);return a.push(s[1].geometry.coordinates),ct(a,t.properties)}function Mr(r){let e;return{c(){e=w("p"),e.textContent="Click near a route to split it, or click on the map to cancel"},m(t,n){S(t,e,n)},d(t){t&&E(e)}}}function Ss(r){let e,t=r[0]==Ut&&Mr();return{c(){t&&t.c(),e=Te()},m(n,i){t&&t.m(n,i),S(n,e,i)},p(n,[i]){n[0]==Ut?t||(t=Mr(),t.c(),t.m(e.parentNode,e)):t&&(t.d(1),t=null)},i:J,o:J,d(n){t&&t.d(n),n&&E(e)}}}const Ut="split-route",Es=10,ks=30;let ln="split-route";function Xr(){}function Lr(r,e){return{type:"Feature",properties:{snapped:e},geometry:{type:"Point",coordinates:r}}}function Ms(r,e,t){let n,i;ee(r,Ie,c=>t(5,n=c)),ee(r,W,c=>t(7,i=c));let{mode:o}=e,{changeMode:s}=e;function a(){t(4,l=null),u=null}let l=null,u=null;n.on("mousemove",c=>{if(o!=Ut)return;t(4,l=Lr(c.lngLat.toArray(),!1)),u=null;const f=[c.point.x-ks,c.point.y],m=n.unproject(c.point).distanceTo(n.unproject(f))/1e3;let y=[];for(let[b,A]of i.features.entries())if(A.geometry.type=="LineString"){let h=Lt(A.geometry,l,{units:"kilometers"});h.properties.dist!=null&&h.properties.dist<=m&&y.push([b,h.geometry.coordinates,h.properties.dist])}y.sort((b,A)=>b[2]-A[2]),y.length>0&&(t(4,l=Lr(y[0][1],!0)),u=y[0][0])}),n.on("click",()=>{if(o==Ut)if(u==null)s("edit-attribute");else{let c=ws(i.features[u],l);if(c.features.length==2){let f=c.features[0],m=c.features[1];W.update(y=>(f.id=y.features[u].id,m.id=Kt(y),f.properties=JSON.parse(JSON.stringify(y.features[u].properties)),m.properties=JSON.parse(JSON.stringify(f.properties)),p(y.features[u],f,m,l),y.features.splice(u,1,f,m),y))}a()}}),Ke(n,ln,{type:"geojson",data:Ae()}),me(n,{id:"draw-split-route",source:ln,...dt("black",Es,["case",["==",["get","snapped"],!0],1,.5])});function p(c,f,m,y){f.properties.length_meters=Tt(f,{units:"kilometers"})*1e3,m.properties.length_meters=Tt(m,{units:"kilometers"})*1e3,f.properties.waypoints=[],m.properties.waypoints=[];let b=g(c,y),A=!0,h=0;for(let d of c.properties.waypoints){let v=g(c,ft([d.lon,d.lat]));if(A)if(v<b)f.properties.waypoints.push(d);else{let k=d.snapped&&c.properties.waypoints[h-1].snapped;f.properties.waypoints.push({lon:y.geometry.coordinates[0],lat:y.geometry.coordinates[1],snapped:k}),A=!1,m.properties.waypoints.push({lon:y.geometry.coordinates[0],lat:y.geometry.coordinates[1],snapped:k}),m.properties.waypoints.push(d)}else m.properties.waypoints.push(d);h++}}function g(c,f){let m=c.geometry.coordinates[0],y=xs(m,f,c);return Tt(y,{units:"kilometers"})*1e3}return r.$$set=c=>{"mode"in c&&t(0,o=c.mode),"changeMode"in c&&t(1,s=c.changeMode)},r.$$.update=()=>{if(r.$$.dirty&48){let c=Ae();l&&c.features.push(l),n.getSource(ln).setData(c)}},[o,s,Xr,a,l,n]}class Ls extends te{constructor(e){super(),ne(this,e,Ms,Ss,Q,{mode:0,changeMode:1,start:2,stop:3})}get start(){return Xr}get stop(){return this.$$.ctx[3]}}function Or(r){let e,t,n={mode:r[2],pointTool:r[9],polygonTool:r[10],routeTool:r[1]};return e=new os({props:n}),r[15](e),{c(){H(e.$$.fragment)},m(i,o){V(e,i,o),t=!0},p(i,o){const s={};o&4&&(s.mode=i[2]),o&2&&(s.routeTool=i[1]),e.$set(s)},i(i){t||(q(e.$$.fragment,i),t=!0)},o(i){j(e.$$.fragment,i),t=!1},d(i){r[15](null),Z(e,i)}}}function Os(r){let e,t,n,i,o,s,a,l,u,p,g,c,f,m,y,b,A,h,d,v,k,O,L,M,N,T,F,G,x,C,re,de,be,oe,ye,Se,ge,U,et,Be,Ge,ae,ce,tt,Ye,mt={mode:r[2],changeMode:r[11]};a=new ns({props:mt}),r[13](a);let K=r[1]&&Or(r),he={mode:r[2],changeMode:r[11],pointTool:r[9]};v=new ds({props:he}),r[17](v);let I={mode:r[2],changeMode:r[11],polygonTool:r[10]};F=new vs({props:I}),r[19](F);function Y($){r[22]($)}let Bn={mode:r[2],changeMode:r[11],url:r[0]};r[1]!==void 0&&(Bn.routeTool=r[1]),oe=new cs({props:Bn}),r[21](oe),pe.push(()=>Ze(oe,"routeTool",Y,r[1]));let Jr={mode:r[2],changeMode:r[11]};return ae=new Ls({props:Jr}),r[24](ae),{c(){e=w("div"),t=w("div"),n=w("button"),i=z("Edit attributes"),s=P(),H(a.$$.fragment),l=P(),u=w("div"),p=w("button"),g=z("Edit geometry"),f=P(),K&&K.c(),m=P(),y=w("div"),b=w("button"),A=z("New point"),d=P(),H(v.$$.fragment),k=P(),O=w("div"),L=w("button"),M=z("New polygon"),T=P(),H(F.$$.fragment),G=P(),x=w("div"),C=w("button"),re=z("New route"),be=P(),H(oe.$$.fragment),Se=P(),ge=w("div"),U=w("button"),et=z("Split route"),Ge=P(),H(ae.$$.fragment),R(n,"type","button"),n.disabled=o=r[2]=="edit-attribute",R(n,"class","svelte-cej5os"),R(p,"type","button"),p.disabled=c=r[2]=="edit-geometry",R(p,"class","svelte-cej5os"),R(b,"type","button"),b.disabled=h=r[2]=="point",R(b,"class","svelte-cej5os"),R(L,"type","button"),L.disabled=N=r[2]=="polygon",R(L,"class","svelte-cej5os"),R(C,"type","button"),C.disabled=de=r[2]=="route",R(C,"class","svelte-cej5os"),R(U,"type","button"),U.disabled=Be=r[2]=="split-route",R(U,"class","svelte-cej5os"),R(e,"class","toolbox svelte-cej5os")},m($,ue){S($,e,ue),_(e,t),_(t,n),_(n,i),_(t,s),V(a,t,null),_(e,l),_(e,u),_(u,p),_(p,g),_(u,f),K&&K.m(u,null),_(e,m),_(e,y),_(y,b),_(b,A),_(y,d),V(v,y,null),_(e,k),_(e,O),_(O,L),_(L,M),_(O,T),V(F,O,null),_(e,G),_(e,x),_(x,C),_(C,re),_(x,be),V(oe,x,null),_(e,Se),_(e,ge),_(ge,U),_(U,et),_(ge,Ge),V(ae,ge,null),ce=!0,tt||(Ye=[X(n,"click",r[12]),X(p,"click",r[14]),X(b,"click",r[16]),X(L,"click",r[18]),X(C,"click",r[20]),X(U,"click",r[23])],tt=!0)},p($,[ue]){(!ce||ue&4&&o!==(o=$[2]=="edit-attribute"))&&(n.disabled=o);const Gn={};ue&4&&(Gn.mode=$[2]),a.$set(Gn),(!ce||ue&4&&c!==(c=$[2]=="edit-geometry"))&&(p.disabled=c),$[1]?K?(K.p($,ue),ue&2&&q(K,1)):(K=Or($),K.c(),q(K,1),K.m(u,null)):K&&(Ht(),j(K,1,1,()=>{K=null}),Vt()),(!ce||ue&4&&h!==(h=$[2]=="point"))&&(b.disabled=h);const Yn={};ue&4&&(Yn.mode=$[2]),v.$set(Yn),(!ce||ue&4&&N!==(N=$[2]=="polygon"))&&(L.disabled=N);const qn={};ue&4&&(qn.mode=$[2]),F.$set(qn),(!ce||ue&4&&de!==(de=$[2]=="route"))&&(C.disabled=de);const It={};ue&4&&(It.mode=$[2]),ue&1&&(It.url=$[0]),!ye&&ue&2&&(ye=!0,It.routeTool=$[1],Qe(()=>ye=!1)),oe.$set(It),(!ce||ue&4&&Be!==(Be=$[2]=="split-route"))&&(U.disabled=Be);const Dn={};ue&4&&(Dn.mode=$[2]),ae.$set(Dn)},i($){ce||(q(a.$$.fragment,$),q(K),q(v.$$.fragment,$),q(F.$$.fragment,$),q(oe.$$.fragment,$),q(ae.$$.fragment,$),ce=!0)},o($){j(a.$$.fragment,$),j(K),j(v.$$.fragment,$),j(F.$$.fragment,$),j(oe.$$.fragment,$),j(ae.$$.fragment,$),ce=!1},d($){$&&E(e),r[13](null),Z(a),K&&K.d(),r[17](null),Z(v),r[19](null),Z(F),r[21](null),Z(oe),r[24](null),Z(ae),tt=!1,pt(Ye)}}}function Rs(r,e,t){let n;ee(r,Ie,x=>t(25,n=x));let{routeUrl:i}=e,o,s=new Po(n),a=new Xo(n),l="edit-attribute",u,p,g,c,f,m;function y(x){let C={"edit-attribute":u,"edit-geometry":p,route:g,point:c,polygon:f,"split-route":m};if(l==x){console.log(`Mode is already ${l}, not changing`);return}console.log(`Stopping old mode ${l}`),C[l].stop(),t(2,l=x),console.log(`Starting new mode ${l}`),C[l].start()}Rn(()=>{s==null||s.tearDown(),a==null||a.tearDown()});const b=()=>y("edit-attribute");function A(x){pe[x?"unshift":"push"](()=>{u=x,t(3,u)})}const h=()=>y("edit-geometry");function d(x){pe[x?"unshift":"push"](()=>{p=x,t(4,p)})}const v=()=>y("point");function k(x){pe[x?"unshift":"push"](()=>{c=x,t(6,c)})}const O=()=>y("polygon");function L(x){pe[x?"unshift":"push"](()=>{f=x,t(7,f)})}const M=()=>y("route");function N(x){pe[x?"unshift":"push"](()=>{g=x,t(5,g)})}function T(x){o=x,t(1,o)}const F=()=>y("split-route");function G(x){pe[x?"unshift":"push"](()=>{m=x,t(8,m)})}return r.$$set=x=>{"routeUrl"in x&&t(0,i=x.routeUrl)},[i,o,l,u,p,g,c,f,m,s,a,y,b,A,h,d,v,k,O,L,M,N,T,F,G]}class As extends te{constructor(e){super(),ne(this,e,Rs,Os,Q,{routeUrl:0})}}function Is(r){let e,t,n,i,o,s,a,l;return{c(){e=w("div"),t=w("button"),t.textContent="Home",n=P(),i=w("button"),i.textContent="About",o=P(),s=w("button"),s.textContent="Instructions",R(t,"type","button"),R(i,"type","button"),R(s,"type","button"),R(e,"slot","nav")},m(u,p){S(u,e,p),_(e,t),_(e,n),_(e,i),_(e,o),_(e,s),a||(l=[X(t,"click",r[8]),X(i,"click",r[6]),X(s,"click",r[7])],a=!0)},p:J,d(u){u&&E(e),a=!1,pt(l)}}}function Ps(r){let e,t,n,i,o,s,a,l,u,p,g,c;return o=new xo({props:{boundaryGeojson:r[3]}}),a=new yo({props:{authorityName:r[4]}}),g=new ho({}),{c(){e=w("div"),t=w("h1"),n=z(r[4]),i=P(),H(o.$$.fragment),s=P(),H(a.$$.fragment),l=P(),u=w("br"),p=P(),H(g.$$.fragment),R(e,"slot","sidebar")},m(f,m){S(f,e,m),_(e,t),_(t,n),_(t,i),V(o,t,null),_(e,s),V(a,e,null),_(e,l),_(e,u),_(e,p),V(g,e,null),c=!0},p(f,m){const y={};m&8&&(y.boundaryGeojson=f[3]),o.$set(y)},i(f){c||(q(o.$$.fragment,f),q(a.$$.fragment,f),q(g.$$.fragment,f),c=!0)},o(f){j(o.$$.fragment,f),j(a.$$.fragment,f),j(g.$$.fragment,f),c=!1},d(f){f&&E(e),Z(o),Z(a),Z(g)}}}function Ns(r){let e,t,n,i,o,s,a,l,u,p,g,c;return e=new to({props:{boundaryGeojson:r[3]}}),n=new Ro({}),o=new Io({}),a=new As({props:{routeUrl:r[2]}}),u=new ko({props:{style:r[5]}}),g=new Lo({}),{c(){H(e.$$.fragment),t=P(),H(n.$$.fragment),i=P(),H(o.$$.fragment),s=P(),H(a.$$.fragment),l=P(),H(u.$$.fragment),p=P(),H(g.$$.fragment)},m(f,m){V(e,f,m),S(f,t,m),V(n,f,m),S(f,i,m),V(o,f,m),S(f,s,m),V(a,f,m),S(f,l,m),V(u,f,m),S(f,p,m),V(g,f,m),c=!0},p(f,m){const y={};m&8&&(y.boundaryGeojson=f[3]),e.$set(y);const b={};m&4&&(b.routeUrl=f[2]),a.$set(b)},i(f){c||(q(e.$$.fragment,f),q(n.$$.fragment,f),q(o.$$.fragment,f),q(a.$$.fragment,f),q(u.$$.fragment,f),q(g.$$.fragment,f),c=!0)},o(f){j(e.$$.fragment,f),j(n.$$.fragment,f),j(o.$$.fragment,f),j(a.$$.fragment,f),j(u.$$.fragment,f),j(g.$$.fragment,f),c=!1},d(f){Z(e,f),f&&E(t),Z(n,f),f&&E(i),Z(o,f),f&&E(s),Z(a,f),f&&E(l),Z(u,f),f&&E(p),Z(g,f)}}}function Fs(r){let e,t,n;return t=new xi({props:{style:r[5],$$slots:{default:[Ns]},$$scope:{ctx:r}}}),{c(){e=w("div"),H(t.$$.fragment),R(e,"slot","main")},m(i,o){S(i,e,o),V(t,e,null),n=!0},p(i,o){const s={};o&16396&&(s.$$scope={dirty:o,ctx:i}),t.$set(s)},i(i){n||(q(t.$$.fragment,i),n=!0)},o(i){j(t.$$.fragment,i),n=!1},d(i){i&&E(e),Z(t)}}}function Cs(r){let e,t,n,i,o,s,a,l;e=new Oi({props:{$$slots:{main:[Fs],sidebar:[Ps],nav:[Is]},$$scope:{ctx:r}}});function u(f){r[9](f)}let p={};r[0]!==void 0&&(p.open=r[0]),n=new di({props:p}),pe.push(()=>Ze(n,"open",u,r[0]));function g(f){r[10](f)}let c={};return r[1]!==void 0&&(c.open=r[1]),s=new _i({props:c}),pe.push(()=>Ze(s,"open",g,r[1])),{c(){H(e.$$.fragment),t=P(),H(n.$$.fragment),o=P(),H(s.$$.fragment)},m(f,m){V(e,f,m),S(f,t,m),V(n,f,m),S(f,o,m),V(s,f,m),l=!0},p(f,[m]){const y={};m&16396&&(y.$$scope={dirty:m,ctx:f}),e.$set(y);const b={};!i&&m&1&&(i=!0,b.open=f[0],Qe(()=>i=!1)),n.$set(b);const A={};!a&&m&2&&(a=!0,A.open=f[1],Qe(()=>a=!1)),s.$set(A)},i(f){l||(q(e.$$.fragment,f),q(n.$$.fragment,f),q(s.$$.fragment,f),l=!0)},o(f){j(e.$$.fragment,f),j(n.$$.fragment,f),j(s.$$.fragment,f),l=!1},d(f){Z(e,f),f&&E(t),Z(n,f),f&&E(o),Z(s,f)}}}function Ts(r,e,t){let n=!1,i=!1,o=window.location.hostname.includes("atip.uk");const s=new URLSearchParams(window.location.search);let a=s.get("authority"),l=s.get("style")||"streets";var u=`https://atip.uk/route-snappers/${a}.bin`;o||(u=`https://atip.uk/route-snappers-dev/${a}.bin`);function p(){t(0,n=!n),t(1,i=!1)}function g(){t(1,i=!i),t(0,n=!1)}let c;On(async()=>{t(3,c=await f())});async function f(){const h=await(await fetch(gi)).text(),d=JSON.parse(h);return d.features=d.features.filter(v=>{var k;return((k=v.properties)==null?void 0:k.name)==a}),d}const m=()=>window.open("index.html");function y(A){n=A,t(0,n)}function b(A){i=A,t(1,i)}return[n,i,u,c,a,l,p,g,m,y,b]}class Bs extends te{constructor(e){super(),ne(this,e,Ts,Cs,Q,{})}}new Bs({target:document.getElementById("app")});
