var jr=Object.defineProperty;var Xr=(r,e,t)=>e in r?jr(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var ge=(r,e,t)=>(Xr(r,typeof e!="symbol"?e+"":e,t),t),Jr=(r,e,t)=>{if(!e.has(r))throw TypeError("Cannot "+t)};var Ze=(r,e,t)=>{if(e.has(r))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(r):e.set(r,t)};var H=(r,e,t)=>(Jr(r,e,"access private method"),t);import{S as ne,i as re,s as K,M as zr,b as ae,a as Je,d as V,m as Q,k as ze,n as q,o as X,q as Z,e as w,c as C,g as S,x as z,p as x,y as Be,f as A,z as Wt,B as Ht,C as Ur,D as Mn,E as Zt,F as Pn,G as vt,H as yt,I as _t,J as bt,K as qn,h as b,l as J,L as $r,N as Wr,O as te,P as Hr,w as Ln,Q as ct,R as ye,T as Rn,t as $,U as Oe,j as ot,r as ht,V as On,W as jn,X as He,Y as Xn,Z as Pr,_ as Jn,$ as Vr,a0 as Qr,a1 as ke,a2 as Zr,a3 as Kr,a4 as ei,a5 as zn,a6 as ti,a7 as An,a8 as Ot,a9 as In,aa as Yt,ab as Cn,ac as sn,ad as ni,ae as at,af as Nn,ag as Ue,ah as ut,ai as ri,aj as Tn,ak as ii,al as oi,am as si,an as Un,ao as qt,ap as li,aq as ai,ar as ui,A as fi,u as ci}from"./authorities-99e7c605.js";function hi(r){let e,t,n,i,o,s,a,l,u,h,m,p,f;return{c(){e=w("p"),e.textContent="For each intervention:",t=C(),n=w("ol"),n.innerHTML=`<li>Click one of the draw icons to the top right of the map (the icons allow
      you to draw points, lines, polygons or routes)</li> 
    <li>Draw the intervention on the map, clicking the original point or &#39;Finish
      snapping&#39; for the Polygon and Route tools respectively</li> 
    <li>Fill in the details that appear (Intervention type, name, description)</li> 
    <li>Click the &quot;Save&quot; button or &quot;Delete&quot; button to save or remove the
      intervention</li>`,i=C(),o=w("p"),o.textContent=`Repeat the steps above for each substantial infrastructure intervention in
    the scheme.`,s=C(),a=w("p"),a.textContent=`To make further edits to attribute data, or to delete an intervention, click
    on its name in the left hand panel or its geometry in the map.`,l=C(),u=w("p"),u.textContent=`Click the "Export to GeoJSON" button to download the dataset representing
    the scheme, which can be made up of one or more intervention, as a GeoJSON
    file. After saving the file, you can delete the interventions, change the
    scheme name, and start a new set of interventions representing a new scheme.`,h=C(),m=w("p"),m.textContent=`To load a GeoJSON file that you have already saved from the tool, click the
    "Load from GeoJSON" button and select the file.`,p=C(),f=w("p"),f.innerHTML=`Note: the <strong>Route tool</strong> works by calculating routes between
    start and end points using the existing transport network according to
    OpenStreetMap. Use it by clicking on the location where you would like the
    route to start and then clicking on the location where you would like the
    route to end on the map. The route will be calculated and drawn on the map.
    After you click &quot;Finish snapping&quot; you can edit the route by dragging
    individual points. This can be useful for representing links that are not
    part of the existing transport network, such as a new bridge or path.
    However,
    <strong>you cannot add or remove points</strong> with the Route tool. If the
    planned route intervention you would like to sketch as part of a scheme contains
    one or more new links (for example containing new bridges or paths between cul-de-sacs),
    you may want to use the Line tool instead.`},m(d,v){S(d,e,v),S(d,t,v),S(d,n,v),S(d,i,v),S(d,o,v),S(d,s,v),S(d,a,v),S(d,l,v),S(d,u,v),S(d,h,v),S(d,m,v),S(d,p,v),S(d,f,v)},p:z,d(d){d&&x(e),d&&x(t),d&&x(n),d&&x(i),d&&x(o),d&&x(s),d&&x(a),d&&x(l),d&&x(u),d&&x(h),d&&x(m),d&&x(p),d&&x(f)}}}function pi(r){let e,t,n;function i(s){r[1](s)}let o={title:"Instructions",$$slots:{default:[hi]},$$scope:{ctx:r}};return r[0]!==void 0&&(o.open=r[0]),e=new zr({props:o}),ae.push(()=>Je(e,"open",i,r[0])),{c(){V(e.$$.fragment)},m(s,a){Q(e,s,a),n=!0},p(s,[a]){const l={};a&4&&(l.$$scope={dirty:a,ctx:s}),!t&&a&1&&(t=!0,l.open=s[0],ze(()=>t=!1)),e.$set(l)},i(s){n||(q(e.$$.fragment,s),n=!0)},o(s){X(e.$$.fragment,s),n=!1},d(s){Z(e,s)}}}function di(r,e,t){let{open:n}=e;function i(o){n=o,t(0,n)}return r.$$set=o=>{"open"in o&&t(0,n=o.open)},[n,i]}class gi extends ne{constructor(e){super(),re(this,e,di,pi,K,{open:0})}}const et=[];function pt(r,e=z){let t;const n=new Set;function i(a){if(K(r,a)&&(r=a,t)){const l=!et.length;for(const u of n)u[1](),et.push(u,r);if(l){for(let u=0;u<et.length;u+=2)et[u][0](et[u+1]);et.length=0}}}function o(a){i(a(r))}function s(a,l=z){const u=[a,l];return n.add(u),n.size===1&&(t=e(i)||z),a(r),()=>{n.delete(u),n.size===0&&(t(),t=null)}}return{set:i,update:o,subscribe:s}}const Ie=pt(null),W=pt(Be()),we=pt(null),Fe=pt(null),jt=pt(null),ln=pt(null);function Vt(r){let e=new Set;for(let n of r.features)e.add(n.id);let t=e.size+1;for(;e.has(t);)t++;return t}function Lr(r){W.update(e=>(e.features=e.features.filter(t=>t.id!=r),e)),we.set(null),Fe.set(null),jt.set(null)}function $n(r){let e;const t=r[4].default,n=vt(t,r,r[3],null);return{c(){n&&n.c()},m(i,o){n&&n.m(i,o),e=!0},p(i,o){n&&n.p&&(!e||o&8)&&yt(n,t,i,i[3],e?bt(t,i[3],o,null):_t(i[3]),null)},i(i){e||(q(n,i),e=!0)},o(i){X(n,i),e=!1},d(i){n&&n.d(i)}}}function mi(r){let e,t,n=r[1]&&$n(r);return{c(){e=w("div"),n&&n.c(),A(e,"class","map svelte-12dpf1u")},m(i,o){S(i,e,o),n&&n.m(e,null),r[5](e),t=!0},p(i,[o]){i[1]?n?(n.p(i,o),o&2&&q(n,1)):(n=$n(i),n.c(),q(n,1),n.m(e,null)):n&&(Wt(),X(n,1,1,()=>{n=null}),Ht())},i(i){t||(q(n),t=!0)},o(i){X(n),t=!1},d(i){i&&x(e),n&&n.d(),r[5](null)}}}function vi(r,e,t){let{$$slots:n={},$$scope:i}=e,{style:o}=e,s,a,l=!1;Ur("setCamera",!window.location.hash),Mn(()=>{s=new Zt.Map({container:a,style:`https://api.maptiler.com/maps/${o}/style.json?key=MZEJTanw3WpxRvt7qDfo`,hash:!0}),s.addControl(new Zt.ScaleControl({})),s.addControl(new Zt.NavigationControl({visualizePitch:!0}),"bottom-right"),s.on("load",()=>{t(1,l=!0),Ie.set(s)}),new ResizeObserver(()=>{s.resize()}).observe(a)}),Pn(()=>{s.remove()});function u(h){ae[h?"unshift":"push"](()=>{a=h,t(0,a)})}return r.$$set=h=>{"style"in h&&t(2,o=h.style),"$$scope"in h&&t(3,i=h.$$scope)},[a,l,o,i,n,u]}class yi extends ne{constructor(e){super(),re(this,e,vi,mi,K,{style:2})}}const _i=r=>({}),Wn=r=>({}),bi=r=>({}),Hn=r=>({}),wi=r=>({}),Vn=r=>({});function Si(r){let e,t,n,i,o,s,a,l,u,h,m,p;const f=r[3].nav,d=vt(f,r,r[2],Vn),v=r[3].sidebar,_=vt(v,r,r[2],Hn),R=r[3].main,c=vt(R,r,r[2],Wn);return{c(){e=w("aside"),t=w("div"),n=w("nav"),d&&d.c(),i=C(),_&&_.c(),o=C(),s=w("button"),s.textContent="â†’",l=C(),u=w("main"),c&&c.c(),A(n,"class","svelte-1u7vg8a"),A(t,"class","sidebar-content content-container svelte-1u7vg8a"),A(s,"type","button"),A(s,"class","sidebar-toggle rounded-rect svelte-1u7vg8a"),A(e,"class",a=qn(r[0]?"":"collapsed")+" svelte-1u7vg8a"),A(u,"class","svelte-1u7vg8a")},m(g,y){S(g,e,y),b(e,t),b(t,n),d&&d.m(n,null),b(t,i),_&&_.m(t,null),b(e,o),b(e,s),S(g,l,y),S(g,u,y),c&&c.m(u,null),h=!0,m||(p=J(s,"click",r[1]),m=!0)},p(g,[y]){d&&d.p&&(!h||y&4)&&yt(d,f,g,g[2],h?bt(f,g[2],y,wi):_t(g[2]),Vn),_&&_.p&&(!h||y&4)&&yt(_,v,g,g[2],h?bt(v,g[2],y,bi):_t(g[2]),Hn),(!h||y&1&&a!==(a=qn(g[0]?"":"collapsed")+" svelte-1u7vg8a"))&&A(e,"class",a),c&&c.p&&(!h||y&4)&&yt(c,R,g,g[2],h?bt(R,g[2],y,_i):_t(g[2]),Wn)},i(g){h||(q(d,g),q(_,g),q(c,g),h=!0)},o(g){X(d,g),X(_,g),X(c,g),h=!1},d(g){g&&x(e),d&&d.d(g),_&&_.d(g),g&&x(l),g&&x(u),c&&c.d(g),m=!1,p()}}}function xi(r,e,t){let{$$slots:n={},$$scope:i}=e,o=!0;function s(){t(0,o=!o)}return r.$$set=a=>{"$$scope"in a&&t(2,i=a.$$scope)},[o,s,i,n]}class Ei extends ne{constructor(e){super(),re(this,e,xi,Si,K,{})}}/**
 * splaytree v3.1.1
 * Fast Splay tree for Node and browser
 *
 * @author Alexander Milevski <info@w8r.name>
 * @license MIT
 * @preserve
 *//*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */function ki(r,e){var t={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},n,i,o,s;return s={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function a(u){return function(h){return l([u,h])}}function l(u){if(n)throw new TypeError("Generator is already executing.");for(;t;)try{if(n=1,i&&(o=u[0]&2?i.return:u[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,u[1])).done)return o;switch(i=0,o&&(u=[u[0]&2,o.value]),u[0]){case 0:case 1:o=u;break;case 4:return t.label++,{value:u[1],done:!1};case 5:t.label++,i=u[1],u=[0];continue;case 7:u=t.ops.pop(),t.trys.pop();continue;default:if(o=t.trys,!(o=o.length>0&&o[o.length-1])&&(u[0]===6||u[0]===2)){t=0;continue}if(u[0]===3&&(!o||u[1]>o[0]&&u[1]<o[3])){t.label=u[1];break}if(u[0]===6&&t.label<o[1]){t.label=o[1],o=u;break}if(o&&t.label<o[2]){t.label=o[2],t.ops.push(u);break}o[2]&&t.ops.pop(),t.trys.pop();continue}u=e.call(r,t)}catch(h){u=[6,h],i=0}finally{n=o=0}if(u[0]&5)throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}}var We=function(){function r(e,t){this.next=null,this.key=e,this.data=t,this.left=null,this.right=null}return r}();function Mi(r,e){return r>e?1:r<e?-1:0}function Ye(r,e,t){for(var n=new We(null,null),i=n,o=n;;){var s=t(r,e.key);if(s<0){if(e.left===null)break;if(t(r,e.left.key)<0){var a=e.left;if(e.left=a.right,a.right=e,e=a,e.left===null)break}o.left=e,o=e,e=e.left}else if(s>0){if(e.right===null)break;if(t(r,e.right.key)>0){var a=e.right;if(e.right=a.left,a.left=e,e=a,e.right===null)break}i.right=e,i=e,e=e.right}else break}return i.right=e.left,o.left=e.right,e.left=n.right,e.right=n.left,e}function Kt(r,e,t,n){var i=new We(r,e);if(t===null)return i.left=i.right=null,i;t=Ye(r,t,n);var o=n(r,t.key);return o<0?(i.left=t.left,i.right=t,t.left=null):o>=0&&(i.right=t.right,i.left=t,t.right=null),i}function Qn(r,e,t){var n=null,i=null;if(e){e=Ye(r,e,t);var o=t(e.key,r);o===0?(n=e.left,i=e.right):o<0?(i=e.right,e.right=null,n=e):(n=e.left,e.left=null,i=e)}return{left:n,right:i}}function Pi(r,e,t){return e===null?r:(r===null||(e=Ye(r.key,e,t),e.left=r),e)}function an(r,e,t,n,i){if(r){n(""+e+(t?"â””â”€â”€ ":"â”œâ”€â”€ ")+i(r)+`
`);var o=e+(t?"    ":"â”‚   ");r.left&&an(r.left,o,!1,n,i),r.right&&an(r.right,o,!0,n,i)}}var Fn=function(){function r(e){e===void 0&&(e=Mi),this._root=null,this._size=0,this._comparator=e}return r.prototype.insert=function(e,t){return this._size++,this._root=Kt(e,t,this._root,this._comparator)},r.prototype.add=function(e,t){var n=new We(e,t);this._root===null&&(n.left=n.right=null,this._size++,this._root=n);var i=this._comparator,o=Ye(e,this._root,i),s=i(e,o.key);return s===0?this._root=o:(s<0?(n.left=o.left,n.right=o,o.left=null):s>0&&(n.right=o.right,n.left=o,o.right=null),this._size++,this._root=n),this._root},r.prototype.remove=function(e){this._root=this._remove(e,this._root,this._comparator)},r.prototype._remove=function(e,t,n){var i;if(t===null)return null;t=Ye(e,t,n);var o=n(e,t.key);return o===0?(t.left===null?i=t.right:(i=Ye(e,t.left,n),i.right=t.right),this._size--,i):t},r.prototype.pop=function(){var e=this._root;if(e){for(;e.left;)e=e.left;return this._root=Ye(e.key,this._root,this._comparator),this._root=this._remove(e.key,this._root,this._comparator),{key:e.key,data:e.data}}return null},r.prototype.findStatic=function(e){for(var t=this._root,n=this._comparator;t;){var i=n(e,t.key);if(i===0)return t;i<0?t=t.left:t=t.right}return null},r.prototype.find=function(e){return this._root&&(this._root=Ye(e,this._root,this._comparator),this._comparator(e,this._root.key)!==0)?null:this._root},r.prototype.contains=function(e){for(var t=this._root,n=this._comparator;t;){var i=n(e,t.key);if(i===0)return!0;i<0?t=t.left:t=t.right}return!1},r.prototype.forEach=function(e,t){for(var n=this._root,i=[],o=!1;!o;)n!==null?(i.push(n),n=n.left):i.length!==0?(n=i.pop(),e.call(t,n),n=n.right):o=!0;return this},r.prototype.range=function(e,t,n,i){for(var o=[],s=this._comparator,a=this._root,l;o.length!==0||a;)if(a)o.push(a),a=a.left;else{if(a=o.pop(),l=s(a.key,t),l>0)break;if(s(a.key,e)>=0&&n.call(i,a))return this;a=a.right}return this},r.prototype.keys=function(){var e=[];return this.forEach(function(t){var n=t.key;return e.push(n)}),e},r.prototype.values=function(){var e=[];return this.forEach(function(t){var n=t.data;return e.push(n)}),e},r.prototype.min=function(){return this._root?this.minNode(this._root).key:null},r.prototype.max=function(){return this._root?this.maxNode(this._root).key:null},r.prototype.minNode=function(e){if(e===void 0&&(e=this._root),e)for(;e.left;)e=e.left;return e},r.prototype.maxNode=function(e){if(e===void 0&&(e=this._root),e)for(;e.right;)e=e.right;return e},r.prototype.at=function(e){for(var t=this._root,n=!1,i=0,o=[];!n;)if(t)o.push(t),t=t.left;else if(o.length>0){if(t=o.pop(),i===e)return t;i++,t=t.right}else n=!0;return null},r.prototype.next=function(e){var t=this._root,n=null;if(e.right){for(n=e.right;n.left;)n=n.left;return n}for(var i=this._comparator;t;){var o=i(e.key,t.key);if(o===0)break;o<0?(n=t,t=t.left):t=t.right}return n},r.prototype.prev=function(e){var t=this._root,n=null;if(e.left!==null){for(n=e.left;n.right;)n=n.right;return n}for(var i=this._comparator;t;){var o=i(e.key,t.key);if(o===0)break;o<0?t=t.left:(n=t,t=t.right)}return n},r.prototype.clear=function(){return this._root=null,this._size=0,this},r.prototype.toList=function(){return Ri(this._root)},r.prototype.load=function(e,t,n){t===void 0&&(t=[]),n===void 0&&(n=!1);var i=e.length,o=this._comparator;if(n&&cn(e,t,0,i-1,o),this._root===null)this._root=un(e,t,0,i),this._size=i;else{var s=Oi(this.toList(),Li(e,t),o);i=this._size+i,this._root=fn({head:s},0,i)}return this},r.prototype.isEmpty=function(){return this._root===null},Object.defineProperty(r.prototype,"size",{get:function(){return this._size},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"root",{get:function(){return this._root},enumerable:!0,configurable:!0}),r.prototype.toString=function(e){e===void 0&&(e=function(n){return String(n.key)});var t=[];return an(this._root,"",!0,function(n){return t.push(n)},e),t.join("")},r.prototype.update=function(e,t,n){var i=this._comparator,o=Qn(e,this._root,i),s=o.left,a=o.right;i(e,t)<0?a=Kt(t,n,a,i):s=Kt(t,n,s,i),this._root=Pi(s,a,i)},r.prototype.split=function(e){return Qn(e,this._root,this._comparator)},r.prototype[Symbol.iterator]=function(){var e;return ki(this,function(t){switch(t.label){case 0:e=this.minNode(),t.label=1;case 1:return e?[4,e]:[3,3];case 2:return t.sent(),e=this.next(e),[3,1];case 3:return[2]}})},r}();function un(r,e,t,n){var i=n-t;if(i>0){var o=t+Math.floor(i/2),s=r[o],a=e[o],l=new We(s,a);return l.left=un(r,e,t,o),l.right=un(r,e,o+1,n),l}return null}function Li(r,e){for(var t=new We(null,null),n=t,i=0;i<r.length;i++)n=n.next=new We(r[i],e[i]);return n.next=null,t.next}function Ri(r){for(var e=r,t=[],n=!1,i=new We(null,null),o=i;!n;)e?(t.push(e),e=e.left):t.length>0?(e=o=o.next=t.pop(),e=e.right):n=!0;return o.next=null,i.next}function fn(r,e,t){var n=t-e;if(n>0){var i=e+Math.floor(n/2),o=fn(r,e,i),s=r.head;return s.left=o,r.head=r.head.next,s.right=fn(r,i+1,t),s}return null}function Oi(r,e,t){for(var n=new We(null,null),i=n,o=r,s=e;o!==null&&s!==null;)t(o.key,s.key)<0?(i.next=o,o=o.next):(i.next=s,s=s.next),i=i.next;return o!==null?i.next=o:s!==null&&(i.next=s),n.next}function cn(r,e,t,n,i){if(!(t>=n)){for(var o=r[t+n>>1],s=t-1,a=n+1;;){do s++;while(i(r[s],o)<0);do a--;while(i(r[a],o)>0);if(s>=a)break;var l=r[s];r[s]=r[a],r[a]=l,l=e[s],e[s]=e[a],e[a]=l}cn(r,e,t,a,i),cn(r,e,a+1,n,i)}}function Se(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function Zn(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}function he(r,e,t){return e&&Zn(r.prototype,e),t&&Zn(r,t),r}var mt=function(e,t){return e.ll.x<=t.x&&t.x<=e.ur.x&&e.ll.y<=t.y&&t.y<=e.ur.y},hn=function(e,t){if(t.ur.x<e.ll.x||e.ur.x<t.ll.x||t.ur.y<e.ll.y||e.ur.y<t.ll.y)return null;var n=e.ll.x<t.ll.x?t.ll.x:e.ll.x,i=e.ur.x<t.ur.x?e.ur.x:t.ur.x,o=e.ll.y<t.ll.y?t.ll.y:e.ll.y,s=e.ur.y<t.ur.y?e.ur.y:t.ur.y;return{ll:{x:n,y:o},ur:{x:i,y:s}}},je=Number.EPSILON;je===void 0&&(je=Math.pow(2,-52));var Ai=je*je,pn=function(e,t){if(-je<e&&e<je&&-je<t&&t<je)return 0;var n=e-t;return n*n<Ai*e*t?0:e<t?-1:1},Ii=function(){function r(){Se(this,r),this.reset()}return he(r,[{key:"reset",value:function(){this.xRounder=new Kn,this.yRounder=new Kn}},{key:"round",value:function(t,n){return{x:this.xRounder.round(t),y:this.yRounder.round(n)}}}]),r}(),Kn=function(){function r(){Se(this,r),this.tree=new Fn,this.round(0)}return he(r,[{key:"round",value:function(t){var n=this.tree.add(t),i=this.tree.prev(n);if(i!==null&&pn(n.key,i.key)===0)return this.tree.remove(t),i.key;var o=this.tree.next(n);return o!==null&&pn(n.key,o.key)===0?(this.tree.remove(t),o.key):t}}]),r}(),Et=new Ii,wt=function(e,t){return e.x*t.y-e.y*t.x},Rr=function(e,t){return e.x*t.x+e.y*t.y},er=function(e,t,n){var i={x:t.x-e.x,y:t.y-e.y},o={x:n.x-e.x,y:n.y-e.y},s=wt(i,o);return pn(s,0)},Xt=function(e){return Math.sqrt(Rr(e,e))},Ci=function(e,t,n){var i={x:t.x-e.x,y:t.y-e.y},o={x:n.x-e.x,y:n.y-e.y};return wt(o,i)/Xt(o)/Xt(i)},Ni=function(e,t,n){var i={x:t.x-e.x,y:t.y-e.y},o={x:n.x-e.x,y:n.y-e.y};return Rr(o,i)/Xt(o)/Xt(i)},tr=function(e,t,n){return t.y===0?null:{x:e.x+t.x/t.y*(n-e.y),y:n}},nr=function(e,t,n){return t.x===0?null:{x:n,y:e.y+t.y/t.x*(n-e.x)}},Ti=function(e,t,n,i){if(t.x===0)return nr(n,i,e.x);if(i.x===0)return nr(e,t,n.x);if(t.y===0)return tr(n,i,e.y);if(i.y===0)return tr(e,t,n.y);var o=wt(t,i);if(o==0)return null;var s={x:n.x-e.x,y:n.y-e.y},a=wt(s,t)/o,l=wt(s,i)/o,u=e.x+l*t.x,h=n.x+a*i.x,m=e.y+l*t.y,p=n.y+a*i.y,f=(u+h)/2,d=(m+p)/2;return{x:f,y:d}},Le=function(){he(r,null,[{key:"compare",value:function(t,n){var i=r.comparePoints(t.point,n.point);return i!==0?i:(t.point!==n.point&&t.link(n),t.isLeft!==n.isLeft?t.isLeft?1:-1:Jt.compare(t.segment,n.segment))}},{key:"comparePoints",value:function(t,n){return t.x<n.x?-1:t.x>n.x?1:t.y<n.y?-1:t.y>n.y?1:0}}]);function r(e,t){Se(this,r),e.events===void 0?e.events=[this]:e.events.push(this),this.point=e,this.isLeft=t}return he(r,[{key:"link",value:function(t){if(t.point===this.point)throw new Error("Tried to link already linked events");for(var n=t.point.events,i=0,o=n.length;i<o;i++){var s=n[i];this.point.events.push(s),s.point=this.point}this.checkForConsuming()}},{key:"checkForConsuming",value:function(){for(var t=this.point.events.length,n=0;n<t;n++){var i=this.point.events[n];if(i.segment.consumedBy===void 0)for(var o=n+1;o<t;o++){var s=this.point.events[o];s.consumedBy===void 0&&i.otherSE.point.events===s.otherSE.point.events&&i.segment.consume(s.segment)}}}},{key:"getAvailableLinkedEvents",value:function(){for(var t=[],n=0,i=this.point.events.length;n<i;n++){var o=this.point.events[n];o!==this&&!o.segment.ringOut&&o.segment.isInResult()&&t.push(o)}return t}},{key:"getLeftmostComparator",value:function(t){var n=this,i=new Map,o=function(a){var l=a.otherSE;i.set(a,{sine:Ci(n.point,t.point,l.point),cosine:Ni(n.point,t.point,l.point)})};return function(s,a){i.has(s)||o(s),i.has(a)||o(a);var l=i.get(s),u=l.sine,h=l.cosine,m=i.get(a),p=m.sine,f=m.cosine;return u>=0&&p>=0?h<f?1:h>f?-1:0:u<0&&p<0?h<f?-1:h>f?1:0:p<u?-1:p>u?1:0}}}]),r}(),Fi=0,Jt=function(){he(r,null,[{key:"compare",value:function(t,n){var i=t.leftSE.point.x,o=n.leftSE.point.x,s=t.rightSE.point.x,a=n.rightSE.point.x;if(a<i)return 1;if(s<o)return-1;var l=t.leftSE.point.y,u=n.leftSE.point.y,h=t.rightSE.point.y,m=n.rightSE.point.y;if(i<o){if(u<l&&u<h)return 1;if(u>l&&u>h)return-1;var p=t.comparePoint(n.leftSE.point);if(p<0)return 1;if(p>0)return-1;var f=n.comparePoint(t.rightSE.point);return f!==0?f:-1}if(i>o){if(l<u&&l<m)return-1;if(l>u&&l>m)return 1;var d=n.comparePoint(t.leftSE.point);if(d!==0)return d;var v=t.comparePoint(n.rightSE.point);return v<0?1:v>0?-1:1}if(l<u)return-1;if(l>u)return 1;if(s<a){var _=n.comparePoint(t.rightSE.point);if(_!==0)return _}if(s>a){var R=t.comparePoint(n.rightSE.point);if(R<0)return 1;if(R>0)return-1}if(s!==a){var c=h-l,g=s-i,y=m-u,M=a-o;if(c>g&&y<M)return 1;if(c<g&&y>M)return-1}return s>a?1:s<a||h<m?-1:h>m?1:t.id<n.id?-1:t.id>n.id?1:0}}]);function r(e,t,n,i){Se(this,r),this.id=++Fi,this.leftSE=e,e.segment=this,e.otherSE=t,this.rightSE=t,t.segment=this,t.otherSE=e,this.rings=n,this.windings=i}return he(r,[{key:"replaceRightSE",value:function(t){this.rightSE=t,this.rightSE.segment=this,this.rightSE.otherSE=this.leftSE,this.leftSE.otherSE=this.rightSE}},{key:"bbox",value:function(){var t=this.leftSE.point.y,n=this.rightSE.point.y;return{ll:{x:this.leftSE.point.x,y:t<n?t:n},ur:{x:this.rightSE.point.x,y:t>n?t:n}}}},{key:"vector",value:function(){return{x:this.rightSE.point.x-this.leftSE.point.x,y:this.rightSE.point.y-this.leftSE.point.y}}},{key:"isAnEndpoint",value:function(t){return t.x===this.leftSE.point.x&&t.y===this.leftSE.point.y||t.x===this.rightSE.point.x&&t.y===this.rightSE.point.y}},{key:"comparePoint",value:function(t){if(this.isAnEndpoint(t))return 0;var n=this.leftSE.point,i=this.rightSE.point,o=this.vector();if(n.x===i.x)return t.x===n.x?0:t.x<n.x?1:-1;var s=(t.y-n.y)/o.y,a=n.x+s*o.x;if(t.x===a)return 0;var l=(t.x-n.x)/o.x,u=n.y+l*o.y;return t.y===u?0:t.y<u?-1:1}},{key:"getIntersection",value:function(t){var n=this.bbox(),i=t.bbox(),o=hn(n,i);if(o===null)return null;var s=this.leftSE.point,a=this.rightSE.point,l=t.leftSE.point,u=t.rightSE.point,h=mt(n,l)&&this.comparePoint(l)===0,m=mt(i,s)&&t.comparePoint(s)===0,p=mt(n,u)&&this.comparePoint(u)===0,f=mt(i,a)&&t.comparePoint(a)===0;if(m&&h)return f&&!p?a:!f&&p?u:null;if(m)return p&&s.x===u.x&&s.y===u.y?null:s;if(h)return f&&a.x===l.x&&a.y===l.y?null:l;if(f&&p)return null;if(f)return a;if(p)return u;var d=Ti(s,this.vector(),l,t.vector());return d===null||!mt(o,d)?null:Et.round(d.x,d.y)}},{key:"split",value:function(t){var n=[],i=t.events!==void 0,o=new Le(t,!0),s=new Le(t,!1),a=this.rightSE;this.replaceRightSE(s),n.push(s),n.push(o);var l=new r(o,a,this.rings.slice(),this.windings.slice());return Le.comparePoints(l.leftSE.point,l.rightSE.point)>0&&l.swapEvents(),Le.comparePoints(this.leftSE.point,this.rightSE.point)>0&&this.swapEvents(),i&&(o.checkForConsuming(),s.checkForConsuming()),n}},{key:"swapEvents",value:function(){var t=this.rightSE;this.rightSE=this.leftSE,this.leftSE=t,this.leftSE.isLeft=!0,this.rightSE.isLeft=!1;for(var n=0,i=this.windings.length;n<i;n++)this.windings[n]*=-1}},{key:"consume",value:function(t){for(var n=this,i=t;n.consumedBy;)n=n.consumedBy;for(;i.consumedBy;)i=i.consumedBy;var o=r.compare(n,i);if(o!==0){if(o>0){var s=n;n=i,i=s}if(n.prev===i){var a=n;n=i,i=a}for(var l=0,u=i.rings.length;l<u;l++){var h=i.rings[l],m=i.windings[l],p=n.rings.indexOf(h);p===-1?(n.rings.push(h),n.windings.push(m)):n.windings[p]+=m}i.rings=null,i.windings=null,i.consumedBy=n,i.leftSE.consumedBy=n.leftSE,i.rightSE.consumedBy=n.rightSE}}},{key:"prevInResult",value:function(){return this._prevInResult!==void 0?this._prevInResult:(this.prev?this.prev.isInResult()?this._prevInResult=this.prev:this._prevInResult=this.prev.prevInResult():this._prevInResult=null,this._prevInResult)}},{key:"beforeState",value:function(){if(this._beforeState!==void 0)return this._beforeState;if(!this.prev)this._beforeState={rings:[],windings:[],multiPolys:[]};else{var t=this.prev.consumedBy||this.prev;this._beforeState=t.afterState()}return this._beforeState}},{key:"afterState",value:function(){if(this._afterState!==void 0)return this._afterState;var t=this.beforeState();this._afterState={rings:t.rings.slice(0),windings:t.windings.slice(0),multiPolys:[]};for(var n=this._afterState.rings,i=this._afterState.windings,o=this._afterState.multiPolys,s=0,a=this.rings.length;s<a;s++){var l=this.rings[s],u=this.windings[s],h=n.indexOf(l);h===-1?(n.push(l),i.push(u)):i[h]+=u}for(var m=[],p=[],f=0,d=n.length;f<d;f++)if(i[f]!==0){var v=n[f],_=v.poly;if(p.indexOf(_)===-1)if(v.isExterior)m.push(_);else{p.indexOf(_)===-1&&p.push(_);var R=m.indexOf(v.poly);R!==-1&&m.splice(R,1)}}for(var c=0,g=m.length;c<g;c++){var y=m[c].multiPoly;o.indexOf(y)===-1&&o.push(y)}return this._afterState}},{key:"isInResult",value:function(){if(this.consumedBy)return!1;if(this._isInResult!==void 0)return this._isInResult;var t=this.beforeState().multiPolys,n=this.afterState().multiPolys;switch(Me.type){case"union":{var i=t.length===0,o=n.length===0;this._isInResult=i!==o;break}case"intersection":{var s,a;t.length<n.length?(s=t.length,a=n.length):(s=n.length,a=t.length),this._isInResult=a===Me.numMultiPolys&&s<a;break}case"xor":{var l=Math.abs(t.length-n.length);this._isInResult=l%2===1;break}case"difference":{var u=function(m){return m.length===1&&m[0].isSubject};this._isInResult=u(t)!==u(n);break}default:throw new Error("Unrecognized operation type found ".concat(Me.type))}return this._isInResult}}],[{key:"fromRing",value:function(t,n,i){var o,s,a,l=Le.comparePoints(t,n);if(l<0)o=t,s=n,a=1;else if(l>0)o=n,s=t,a=-1;else throw new Error("Tried to create degenerate segment at [".concat(t.x,", ").concat(t.y,"]"));var u=new Le(o,!0),h=new Le(s,!1);return new r(u,h,[i],[a])}}]),r}(),rr=function(){function r(e,t,n){if(Se(this,r),!Array.isArray(e)||e.length===0)throw new Error("Input geometry is not a valid Polygon or MultiPolygon");if(this.poly=t,this.isExterior=n,this.segments=[],typeof e[0][0]!="number"||typeof e[0][1]!="number")throw new Error("Input geometry is not a valid Polygon or MultiPolygon");var i=Et.round(e[0][0],e[0][1]);this.bbox={ll:{x:i.x,y:i.y},ur:{x:i.x,y:i.y}};for(var o=i,s=1,a=e.length;s<a;s++){if(typeof e[s][0]!="number"||typeof e[s][1]!="number")throw new Error("Input geometry is not a valid Polygon or MultiPolygon");var l=Et.round(e[s][0],e[s][1]);l.x===o.x&&l.y===o.y||(this.segments.push(Jt.fromRing(o,l,this)),l.x<this.bbox.ll.x&&(this.bbox.ll.x=l.x),l.y<this.bbox.ll.y&&(this.bbox.ll.y=l.y),l.x>this.bbox.ur.x&&(this.bbox.ur.x=l.x),l.y>this.bbox.ur.y&&(this.bbox.ur.y=l.y),o=l)}(i.x!==o.x||i.y!==o.y)&&this.segments.push(Jt.fromRing(o,i,this))}return he(r,[{key:"getSweepEvents",value:function(){for(var t=[],n=0,i=this.segments.length;n<i;n++){var o=this.segments[n];t.push(o.leftSE),t.push(o.rightSE)}return t}}]),r}(),Bi=function(){function r(e,t){if(Se(this,r),!Array.isArray(e))throw new Error("Input geometry is not a valid Polygon or MultiPolygon");this.exteriorRing=new rr(e[0],this,!0),this.bbox={ll:{x:this.exteriorRing.bbox.ll.x,y:this.exteriorRing.bbox.ll.y},ur:{x:this.exteriorRing.bbox.ur.x,y:this.exteriorRing.bbox.ur.y}},this.interiorRings=[];for(var n=1,i=e.length;n<i;n++){var o=new rr(e[n],this,!1);o.bbox.ll.x<this.bbox.ll.x&&(this.bbox.ll.x=o.bbox.ll.x),o.bbox.ll.y<this.bbox.ll.y&&(this.bbox.ll.y=o.bbox.ll.y),o.bbox.ur.x>this.bbox.ur.x&&(this.bbox.ur.x=o.bbox.ur.x),o.bbox.ur.y>this.bbox.ur.y&&(this.bbox.ur.y=o.bbox.ur.y),this.interiorRings.push(o)}this.multiPoly=t}return he(r,[{key:"getSweepEvents",value:function(){for(var t=this.exteriorRing.getSweepEvents(),n=0,i=this.interiorRings.length;n<i;n++)for(var o=this.interiorRings[n].getSweepEvents(),s=0,a=o.length;s<a;s++)t.push(o[s]);return t}}]),r}(),ir=function(){function r(e,t){if(Se(this,r),!Array.isArray(e))throw new Error("Input geometry is not a valid Polygon or MultiPolygon");try{typeof e[0][0][0]=="number"&&(e=[e])}catch{}this.polys=[],this.bbox={ll:{x:Number.POSITIVE_INFINITY,y:Number.POSITIVE_INFINITY},ur:{x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY}};for(var n=0,i=e.length;n<i;n++){var o=new Bi(e[n],this);o.bbox.ll.x<this.bbox.ll.x&&(this.bbox.ll.x=o.bbox.ll.x),o.bbox.ll.y<this.bbox.ll.y&&(this.bbox.ll.y=o.bbox.ll.y),o.bbox.ur.x>this.bbox.ur.x&&(this.bbox.ur.x=o.bbox.ur.x),o.bbox.ur.y>this.bbox.ur.y&&(this.bbox.ur.y=o.bbox.ur.y),this.polys.push(o)}this.isSubject=t}return he(r,[{key:"getSweepEvents",value:function(){for(var t=[],n=0,i=this.polys.length;n<i;n++)for(var o=this.polys[n].getSweepEvents(),s=0,a=o.length;s<a;s++)t.push(o[s]);return t}}]),r}(),Di=function(){he(r,null,[{key:"factory",value:function(t){for(var n=[],i=0,o=t.length;i<o;i++){var s=t[i];if(!(!s.isInResult()||s.ringOut)){for(var a=null,l=s.leftSE,u=s.rightSE,h=[l],m=l.point,p=[];a=l,l=u,h.push(l),l.point!==m;)for(;;){var f=l.getAvailableLinkedEvents();if(f.length===0){var d=h[0].point,v=h[h.length-1].point;throw new Error("Unable to complete output ring starting at [".concat(d.x,",")+" ".concat(d.y,"]. Last matching segment found ends at")+" [".concat(v.x,", ").concat(v.y,"]."))}if(f.length===1){u=f[0].otherSE;break}for(var _=null,R=0,c=p.length;R<c;R++)if(p[R].point===l.point){_=R;break}if(_!==null){var g=p.splice(_)[0],y=h.splice(g.index);y.unshift(y[0].otherSE),n.push(new r(y.reverse()));continue}p.push({index:h.length,point:l.point});var M=l.getLeftmostComparator(a);u=f.sort(M)[0].otherSE;break}n.push(new r(h))}}return n}}]);function r(e){Se(this,r),this.events=e;for(var t=0,n=e.length;t<n;t++)e[t].segment.ringOut=this;this.poly=null}return he(r,[{key:"getGeom",value:function(){for(var t=this.events[0].point,n=[t],i=1,o=this.events.length-1;i<o;i++){var s=this.events[i].point,a=this.events[i+1].point;er(s,t,a)!==0&&(n.push(s),t=s)}if(n.length===1)return null;var l=n[0],u=n[1];er(l,t,u)===0&&n.shift(),n.push(n[0]);for(var h=this.isExteriorRing()?1:-1,m=this.isExteriorRing()?0:n.length-1,p=this.isExteriorRing()?n.length:-1,f=[],d=m;d!=p;d+=h)f.push([n[d].x,n[d].y]);return f}},{key:"isExteriorRing",value:function(){if(this._isExteriorRing===void 0){var t=this.enclosingRing();this._isExteriorRing=t?!t.isExteriorRing():!0}return this._isExteriorRing}},{key:"enclosingRing",value:function(){return this._enclosingRing===void 0&&(this._enclosingRing=this._calcEnclosingRing()),this._enclosingRing}},{key:"_calcEnclosingRing",value:function(){for(var t=this.events[0],n=1,i=this.events.length;n<i;n++){var o=this.events[n];Le.compare(t,o)>0&&(t=o)}for(var s=t.segment.prevInResult(),a=s?s.prevInResult():null;;){if(!s)return null;if(!a)return s.ringOut;if(a.ringOut!==s.ringOut)return a.ringOut.enclosingRing()!==s.ringOut?s.ringOut:s.ringOut.enclosingRing();s=a.prevInResult(),a=s?s.prevInResult():null}}}]),r}(),or=function(){function r(e){Se(this,r),this.exteriorRing=e,e.poly=this,this.interiorRings=[]}return he(r,[{key:"addInterior",value:function(t){this.interiorRings.push(t),t.poly=this}},{key:"getGeom",value:function(){var t=[this.exteriorRing.getGeom()];if(t[0]===null)return null;for(var n=0,i=this.interiorRings.length;n<i;n++){var o=this.interiorRings[n].getGeom();o!==null&&t.push(o)}return t}}]),r}(),Gi=function(){function r(e){Se(this,r),this.rings=e,this.polys=this._composePolys(e)}return he(r,[{key:"getGeom",value:function(){for(var t=[],n=0,i=this.polys.length;n<i;n++){var o=this.polys[n].getGeom();o!==null&&t.push(o)}return t}},{key:"_composePolys",value:function(t){for(var n=[],i=0,o=t.length;i<o;i++){var s=t[i];if(!s.poly)if(s.isExteriorRing())n.push(new or(s));else{var a=s.enclosingRing();a.poly||n.push(new or(a)),a.poly.addInterior(s)}}return n}}]),r}(),Yi=function(){function r(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Jt.compare;Se(this,r),this.queue=e,this.tree=new Fn(t),this.segments=[]}return he(r,[{key:"process",value:function(t){var n=t.segment,i=[];if(t.consumedBy)return t.isLeft?this.queue.remove(t.otherSE):this.tree.remove(n),i;var o=t.isLeft?this.tree.insert(n):this.tree.find(n);if(!o)throw new Error("Unable to find segment #".concat(n.id," ")+"[".concat(n.leftSE.point.x,", ").concat(n.leftSE.point.y,"] -> ")+"[".concat(n.rightSE.point.x,", ").concat(n.rightSE.point.y,"] ")+"in SweepLine tree. Please submit a bug report.");for(var s=o,a=o,l=void 0,u=void 0;l===void 0;)s=this.tree.prev(s),s===null?l=null:s.key.consumedBy===void 0&&(l=s.key);for(;u===void 0;)a=this.tree.next(a),a===null?u=null:a.key.consumedBy===void 0&&(u=a.key);if(t.isLeft){var h=null;if(l){var m=l.getIntersection(n);if(m!==null&&(n.isAnEndpoint(m)||(h=m),!l.isAnEndpoint(m)))for(var p=this._splitSafely(l,m),f=0,d=p.length;f<d;f++)i.push(p[f])}var v=null;if(u){var _=u.getIntersection(n);if(_!==null&&(n.isAnEndpoint(_)||(v=_),!u.isAnEndpoint(_)))for(var R=this._splitSafely(u,_),c=0,g=R.length;c<g;c++)i.push(R[c])}if(h!==null||v!==null){var y=null;if(h===null)y=v;else if(v===null)y=h;else{var M=Le.comparePoints(h,v);y=M<=0?h:v}this.queue.remove(n.rightSE),i.push(n.rightSE);for(var L=n.split(y),k=0,E=L.length;k<E;k++)i.push(L[k])}i.length>0?(this.tree.remove(n),i.push(t)):(this.segments.push(n),n.prev=l)}else{if(l&&u){var N=l.getIntersection(u);if(N!==null){if(!l.isAnEndpoint(N))for(var F=this._splitSafely(l,N),T=0,D=F.length;T<D;T++)i.push(F[T]);if(!u.isAnEndpoint(N))for(var I=this._splitSafely(u,N),P=0,U=I.length;P<U;P++)i.push(I[P])}}this.tree.remove(n)}return i}},{key:"_splitSafely",value:function(t,n){this.tree.remove(t);var i=t.rightSE;this.queue.remove(i);var o=t.split(n);return o.push(i),t.consumedBy===void 0&&this.tree.insert(t),o}}]),r}(),sr=typeof process<"u"&&{}.POLYGON_CLIPPING_MAX_QUEUE_SIZE||1e6,qi=typeof process<"u"&&{}.POLYGON_CLIPPING_MAX_SWEEPLINE_SEGMENTS||1e6,ji=function(){function r(){Se(this,r)}return he(r,[{key:"run",value:function(t,n,i){Me.type=t,Et.reset();for(var o=[new ir(n,!0)],s=0,a=i.length;s<a;s++)o.push(new ir(i[s],!1));if(Me.numMultiPolys=o.length,Me.type==="difference")for(var l=o[0],u=1;u<o.length;)hn(o[u].bbox,l.bbox)!==null?u++:o.splice(u,1);if(Me.type==="intersection"){for(var h=0,m=o.length;h<m;h++)for(var p=o[h],f=h+1,d=o.length;f<d;f++)if(hn(p.bbox,o[f].bbox)===null)return[]}for(var v=new Fn(Le.compare),_=0,R=o.length;_<R;_++)for(var c=o[_].getSweepEvents(),g=0,y=c.length;g<y;g++)if(v.insert(c[g]),v.size>sr)throw new Error("Infinite loop when putting segment endpoints in a priority queue (queue size too big). Please file a bug report.");for(var M=new Yi(v),L=v.size,k=v.pop();k;){var E=k.key;if(v.size===L){var N=E.segment;throw new Error("Unable to pop() ".concat(E.isLeft?"left":"right"," SweepEvent ")+"[".concat(E.point.x,", ").concat(E.point.y,"] from segment #").concat(N.id," ")+"[".concat(N.leftSE.point.x,", ").concat(N.leftSE.point.y,"] -> ")+"[".concat(N.rightSE.point.x,", ").concat(N.rightSE.point.y,"] from queue. ")+"Please file a bug report.")}if(v.size>sr)throw new Error("Infinite loop when passing sweep line over endpoints (queue size too big). Please file a bug report.");if(M.segments.length>qi)throw new Error("Infinite loop when passing sweep line over endpoints (too many sweep line segments). Please file a bug report.");for(var F=M.process(E),T=0,D=F.length;T<D;T++){var I=F[T];I.consumedBy===void 0&&v.insert(I)}L=v.size,k=v.pop()}Et.reset();var P=Di.factory(M.segments),U=new Gi(P);return U.getGeom()}}]),r}(),Me=new ji,Xi=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return Me.run("union",e,n)},Ji=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return Me.run("intersection",e,n)},zi=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return Me.run("xor",e,n)},Ui=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return Me.run("difference",e,n)},Nt={union:Xi,intersection:Ji,xor:zi,difference:Ui};function $i(r,e){var t=Hi(e),n=null;return r.type==="FeatureCollection"?n=Wi(r):n=Or(Nt.union(r.geometry.coordinates)),n.geometry.coordinates.forEach(function(i){t.geometry.coordinates.push(i[0])}),t}function Wi(r){var e=r.features.length===2?Nt.union(r.features[0].geometry.coordinates,r.features[1].geometry.coordinates):Nt.union.apply(Nt,r.features.map(function(t){return t.geometry.coordinates}));return Or(e)}function Or(r){return $r(r)}function Hi(r){var e=[[[180,90],[-180,90],[-180,-90],[180,-90],[180,90]]],t=r&&r.geometry.coordinates||e;return Wr(t)}function Vi(r,e,t){let n;te(r,Ie,s=>t(1,n=s));let{boundaryGeojson:i}=e;return Hr("setCamera")&&n.fitBounds(Ln(i),{padding:20,animate:!1}),ct(n,"boundary",{type:"geojson",data:$i(i)}),ye(n,{id:"boundary",source:"boundary",...Rn("black",.5)}),r.$$set=s=>{"boundaryGeojson"in s&&t(0,i=s.boundaryGeojson)},[i]}class Qi extends ne{constructor(e){super(),re(this,e,Vi,null,K,{boundaryGeojson:0})}}function lr(r){let e,t=ar(r[4])+"",n,i,o,s,a;return{c(){e=$("Length: "),n=$(t),i=C(),o=w("br"),s=C(),a=w("br")},m(l,u){S(l,e,u),S(l,n,u),S(l,i,u),S(l,o,u),S(l,s,u),S(l,a,u)},p(l,u){u&16&&t!==(t=ar(l[4])+"")&&On(n,t)},d(l){l&&x(e),l&&x(n),l&&x(i),l&&x(o),l&&x(s),l&&x(a)}}}function Zi(r){let e,t,n,i,o,s,a,l,u,h,m,p,f,d,v,_,R,c,g,y,M,L,k,E,N,F,T,D,I,P,U,pe,_e,ce,ie,xe,de,oe,be,ve,Ce,Ee,Ve,ee,Qe,dt,At,fe=r[4]&&lr(r);return{c(){e=w("label"),t=$("Name:"),n=w("br"),i=C(),o=w("input"),s=C(),a=w("br"),l=C(),u=w("br"),h=C(),m=w("label"),p=w("input"),f=$(`
  Area`),d=C(),v=w("label"),_=w("input"),R=$(`
  Route`),c=C(),g=w("label"),y=w("input"),M=$(`
  Crossing`),L=C(),k=w("label"),E=w("input"),N=$(`
  Other`),F=C(),T=w("br"),D=C(),I=w("br"),P=C(),U=w("label"),pe=$("Description:"),_e=w("br"),ce=C(),ie=w("textarea"),xe=C(),de=w("br"),oe=C(),be=w("br"),ve=C(),fe&&fe.c(),Ce=C(),Ee=w("div"),Ve=w("button"),Ve.textContent="Delete",ee=C(),Qe=w("button"),Qe.textContent="Save",A(o,"type","text"),Oe(o,"width","100%"),A(p,"type","radio"),p.__value="area",p.value=p.__value,r[7][0].push(p),A(_,"type","radio"),_.__value="route",_.value=_.__value,r[7][0].push(_),A(y,"type","radio"),y.__value="crossing",y.value=y.__value,r[7][0].push(y),A(E,"type","radio"),E.__value="other",E.value=E.__value,r[7][0].push(E),Oe(ie,"width","100%"),A(ie,"rows","5"),A(ie,"class","svelte-15lna0i"),A(Ve,"type","button"),A(Qe,"type","button"),Oe(Ee,"display","flex"),Oe(Ee,"justify-content","space-between")},m(O,G){S(O,e,G),b(e,t),b(e,n),b(e,i),b(e,o),ot(o,r[0]),S(O,s,G),S(O,a,G),S(O,l,G),S(O,u,G),S(O,h,G),S(O,m,G),b(m,p),p.checked=p.__value===r[1],b(m,f),S(O,d,G),S(O,v,G),b(v,_),_.checked=_.__value===r[1],b(v,R),S(O,c,G),S(O,g,G),b(g,y),y.checked=y.__value===r[1],b(g,M),S(O,L,G),S(O,k,G),b(k,E),E.checked=E.__value===r[1],b(k,N),S(O,F,G),S(O,T,G),S(O,D,G),S(O,I,G),S(O,P,G),S(O,U,G),b(U,pe),b(U,_e),b(U,ce),b(U,ie),ot(ie,r[2]),S(O,xe,G),S(O,de,G),S(O,oe,G),S(O,be,G),S(O,ve,G),fe&&fe.m(O,G),S(O,Ce,G),S(O,Ee,G),b(Ee,Ve),b(Ee,ee),b(Ee,Qe),dt||(At=[J(o,"input",r[5]),J(p,"change",r[6]),J(_,"change",r[8]),J(y,"change",r[9]),J(E,"change",r[10]),J(ie,"input",r[11]),J(Ve,"click",r[12]),J(Qe,"click",r[13])],dt=!0)},p(O,[G]){G&1&&o.value!==O[0]&&ot(o,O[0]),G&2&&(p.checked=p.__value===O[1]),G&2&&(_.checked=_.__value===O[1]),G&2&&(y.checked=y.__value===O[1]),G&2&&(E.checked=E.__value===O[1]),G&4&&ot(ie,O[2]),O[4]?fe?fe.p(O,G):(fe=lr(O),fe.c(),fe.m(Ce.parentNode,Ce)):fe&&(fe.d(1),fe=null)},i:z,o:z,d(O){O&&x(e),O&&x(s),O&&x(a),O&&x(l),O&&x(u),O&&x(h),O&&x(m),r[7][0].splice(r[7][0].indexOf(p),1),O&&x(d),O&&x(v),r[7][0].splice(r[7][0].indexOf(_),1),O&&x(c),O&&x(g),r[7][0].splice(r[7][0].indexOf(y),1),O&&x(L),O&&x(k),r[7][0].splice(r[7][0].indexOf(E),1),O&&x(F),O&&x(T),O&&x(D),O&&x(I),O&&x(P),O&&x(U),O&&x(xe),O&&x(de),O&&x(oe),O&&x(be),O&&x(ve),fe&&fe.d(O),O&&x(Ce),O&&x(Ee),dt=!1,ht(At)}}}function ar(r){return r<1e3?Math.round(r)+" m":(r/1e3).toFixed(1)+"km"}function Ki(r,e,t){let{id:n}=e,{name:i}=e,{intervention_type:o}=e,{description:s}=e,{length_meters:a}=e;const l=[[]];function u(){i=this.value,t(0,i)}function h(){o=this.__value,t(1,o)}function m(){o=this.__value,t(1,o)}function p(){o=this.__value,t(1,o)}function f(){o=this.__value,t(1,o)}function d(){s=this.value,t(2,s)}const v=()=>Lr(n),_=()=>we.set(null);return r.$$set=R=>{"id"in R&&t(3,n=R.id),"name"in R&&t(0,i=R.name),"intervention_type"in R&&t(1,o=R.intervention_type),"description"in R&&t(2,s=R.description),"length_meters"in R&&t(4,a=R.length_meters)},[i,o,s,n,a,u,h,l,m,p,f,d,v,_]}class eo extends ne{constructor(e){super(),re(this,e,Ki,Zi,K,{id:3,name:0,intervention_type:1,description:2,length_meters:4})}}function to(r){const e=r-1;return e*e*e+1}function ur(r,{delay:e=0,duration:t=400,easing:n=to}={}){const i=getComputedStyle(r),o=+i.opacity,s=parseFloat(i.height),a=parseFloat(i.paddingTop),l=parseFloat(i.paddingBottom),u=parseFloat(i.marginTop),h=parseFloat(i.marginBottom),m=parseFloat(i.borderTopWidth),p=parseFloat(i.borderBottomWidth);return{delay:e,duration:t,easing:n,css:f=>`overflow: hidden;opacity: ${Math.min(f*20,1)*o};height: ${f*s}px;padding-top: ${f*a}px;padding-bottom: ${f*l}px;margin-top: ${f*u}px;margin-bottom: ${f*h}px;border-top-width: ${f*m}px;border-bottom-width: ${f*p}px;`}}function fr(r){let e,t,n,i,o;const s=r[10].default,a=vt(s,r,r[9],null);return{c(){e=w("div"),a&&a.c(),Oe(e,"border","solid 1px black"),Oe(e,"padding","10px")},m(l,u){S(l,e,u),a&&a.m(e,null),r[13](e),n=!0,i||(o=J(e,"introend",r[14]),i=!0)},p(l,u){a&&a.p&&(!n||u&512)&&yt(a,s,l,l[9],n?bt(s,l[9],u,null):_t(l[9]),null)},i(l){n||(q(a,l),Pr(()=>{t||(t=Jn(e,ur,{duration:100},!0)),t.run(1)}),n=!0)},o(l){X(a,l),t||(t=Jn(e,ur,{duration:100},!1)),t.run(0),n=!1},d(l){l&&x(e),a&&a.d(l),r[13](null),l&&t&&t.end(),i=!1,o()}}}function no(r){let e,t,n,i,o,s,a,l,u,h,m=r[4]&&fr(r);return{c(){e=w("button"),t=jn("svg"),n=jn("path"),i=C(),o=$(r[1]),s=C(),m&&m.c(),a=He(),A(n,"d","M9 5l7 7-7 7"),A(t,"style","tran"),A(t,"width","20"),A(t,"height","20"),A(t,"fill","none"),A(t,"stroke-linecap","round"),A(t,"stroke-linejoin","round"),A(t,"stroke-width","2"),A(t,"viewBox","0 0 24 24"),A(t,"stroke","currentColor"),A(t,"class","svelte-t7fpgu"),A(e,"aria-expanded",r[4]),A(e,"class","svelte-t7fpgu"),Xn(e,"underlined",r[3])},m(p,f){S(p,e,f),b(e,t),b(t,n),b(e,i),b(e,o),S(p,s,f),m&&m.m(p,f),S(p,a,f),l=!0,u||(h=[J(e,"click",r[5]),J(e,"mouseenter",r[11]),J(e,"mouseleave",r[12])],u=!0)},p(p,[f]){(!l||f&2)&&On(o,p[1]),(!l||f&16)&&A(e,"aria-expanded",p[4]),(!l||f&8)&&Xn(e,"underlined",p[3]),p[4]?m?(m.p(p,f),f&16&&q(m,1)):(m=fr(p),m.c(),q(m,1),m.m(a.parentNode,a)):m&&(Wt(),X(m,1,1,()=>{m=null}),Ht())},i(p){l||(q(m),l=!0)},o(p){X(m),l=!1},d(p){p&&x(e),p&&x(s),m&&m.d(p),p&&x(a),u=!1,ht(h)}}}function ro(r,e,t){let n,i,o,s;te(r,Fe,c=>t(7,o=c)),te(r,we,c=>t(8,s=c));let{$$slots:a={},$$scope:l}=e,{id:u}=e,{label:h}=e;const m=()=>{we.update(c=>c==u?null:u),s==u&&(ln.set(null),ln.set(u))};let p;function f(){p==null||p.scrollIntoView({behavior:"smooth"})}const d=()=>jt.set(u),v=()=>jt.set(null);function _(c){ae[c?"unshift":"push"](()=>{p=c,t(2,p)})}const R=()=>f();return r.$$set=c=>{"id"in c&&t(0,u=c.id),"label"in c&&t(1,h=c.label),"$$scope"in c&&t(9,l=c.$$scope)},r.$$.update=()=>{r.$$.dirty&257&&t(4,n=s==u),r.$$.dirty&129&&t(3,i=o==u)},[u,h,p,i,n,m,f,o,s,l,a,d,v,_,R]}class io extends ne{constructor(e){super(),re(this,e,ro,no,K,{id:0,label:1})}}function cr(r,e,t){const n=r.slice();return n[6]=e[t],n[7]=e,n[8]=t,n}function oo(r){let e,t,n,i,o,s;function a(m){r[2](m,r[6])}function l(m){r[3](m,r[6])}function u(m){r[4](m,r[6])}let h={id:r[6].id,length_meters:r[6].properties.length_meters};return r[6].properties.name!==void 0&&(h.name=r[6].properties.name),r[6].properties.intervention_type!==void 0&&(h.intervention_type=r[6].properties.intervention_type),r[6].properties.description!==void 0&&(h.description=r[6].properties.description),e=new eo({props:h}),ae.push(()=>Je(e,"name",a,r[6].properties.name)),ae.push(()=>Je(e,"intervention_type",l,r[6].properties.intervention_type)),ae.push(()=>Je(e,"description",u,r[6].properties.description)),{c(){V(e.$$.fragment),o=C()},m(m,p){Q(e,m,p),S(m,o,p),s=!0},p(m,p){r=m;const f={};p&1&&(f.id=r[6].id),p&1&&(f.length_meters=r[6].properties.length_meters),!t&&p&1&&(t=!0,f.name=r[6].properties.name,ze(()=>t=!1)),!n&&p&1&&(n=!0,f.intervention_type=r[6].properties.intervention_type,ze(()=>n=!1)),!i&&p&1&&(i=!0,f.description=r[6].properties.description,ze(()=>i=!1)),e.$set(f)},i(m){s||(q(e.$$.fragment,m),s=!0)},o(m){X(e.$$.fragment,m),s=!1},d(m){Z(e,m),m&&x(o)}}}function hr(r,e){let t,n,i;return n=new io({props:{id:e[6].id,label:e[8]+1+") "+pr(e[6]),$$slots:{default:[oo]},$$scope:{ctx:e}}}),{key:r,first:null,c(){t=He(),V(n.$$.fragment),this.first=t},m(o,s){S(o,t,s),Q(n,o,s),i=!0},p(o,s){e=o;const a={};s&1&&(a.id=e[6].id),s&1&&(a.label=e[8]+1+") "+pr(e[6])),s&513&&(a.$$scope={dirty:s,ctx:e}),n.$set(a)},i(o){i||(q(n.$$.fragment,o),i=!0)},o(o){X(n.$$.fragment,o),i=!1},d(o){o&&x(t),Z(n,o)}}}function so(r){let e=[],t=new Map,n,i,o,s,a=r[0].features;const l=u=>u[6].id;for(let u=0;u<a.length;u+=1){let h=cr(r,a,u),m=l(h);t.set(m,e[u]=hr(m,h))}return{c(){for(let u=0;u<e.length;u+=1)e[u].c();n=He()},m(u,h){for(let m=0;m<e.length;m+=1)e[m].m(u,h);S(u,n,h),i=!0,o||(s=J(window,"keydown",r[1]),o=!0)},p(u,[h]){h&1&&(a=u[0].features,Wt(),e=Vr(e,h,l,1,u,a,t,n.parentNode,Qr,hr,n,cr),Ht())},i(u){if(!i){for(let h=0;h<a.length;h+=1)q(e[h]);i=!0}},o(u){for(let h=0;h<e.length;h+=1)X(e[h]);i=!1},d(u){for(let h=0;h<e.length;h+=1)e[h].d(u);u&&x(n),o=!1,s()}}}function pr(r){if(r.properties.name)return r.properties.name;var e=r.properties.intervention_type;return e=="other"&&(r.geometry.type=="Point"?e="point":r.geometry.type=="LineString"?e="line":e="polygon"),`Untitled ${e}`}function lo(r,e,t){let n,i;te(r,we,u=>t(5,n=u)),te(r,W,u=>t(0,i=u));function o(u){if(u.key=="Delete"){const h=u.target.tagName;if(h=="INPUT"||h=="TEXTAREA")return;u.preventDefault();const m=n;m&&Lr(m)}}function s(u,h){r.$$.not_equal(h.properties.name,u)&&(h.properties.name=u,W.set(i))}function a(u,h){r.$$.not_equal(h.properties.intervention_type,u)&&(h.properties.intervention_type=u,W.set(i))}function l(u,h){r.$$.not_equal(h.properties.description,u)&&(h.properties.description=u,W.set(i))}return[i,o,s,a,l]}class ao extends ne{constructor(e){super(),re(this,e,lo,so,K,{})}}function $e(r){if(!r)throw new Error("coord is required");if(!Array.isArray(r)){if(r.type==="Feature"&&r.geometry!==null&&r.geometry.type==="Point")return r.geometry.coordinates;if(r.type==="Point")return r.coordinates}if(Array.isArray(r)&&r.length>=2&&!Array.isArray(r[0])&&!Array.isArray(r[1]))return r;throw new Error("coord must be GeoJSON Point or an Array of numbers")}function Ae(r){if(Array.isArray(r))return r;if(r.type==="Feature"){if(r.geometry!==null)return r.geometry.coordinates}else if(r.coordinates)return r.coordinates;throw new Error("coords must be GeoJSON Feature, Geometry Object or an Array")}function dn(r,e){return r.type==="FeatureCollection"?"FeatureCollection":r.type==="GeometryCollection"?"GeometryCollection":r.type==="Feature"&&r.geometry!==null?r.geometry.type:r.type}function qe(r,e,t){t===void 0&&(t={});var n=$e(r),i=$e(e),o=ke(i[1]-n[1]),s=ke(i[0]-n[0]),a=ke(n[1]),l=ke(i[1]),u=Math.pow(Math.sin(o/2),2)+Math.pow(Math.sin(s/2),2)*Math.cos(a)*Math.cos(l);return Zr(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)),t.units)}function Tt(r,e){return e===void 0&&(e={}),Kr(r,function(t,n){var i=n.geometry.coordinates;return t+qe(i[0],i[1],e)},0)}function uo(r){let e,t,n,i,o,s,a,l,u,h,m,p,f,d,v,_,R,c,g,y=r[0].features.length+"",M,L,k,E,N,F,T,D;return{c(){e=w("div"),t=w("label"),n=$(`Scheme name:
    `),i=w("input"),o=C(),s=w("br"),a=C(),l=w("div"),u=w("label"),h=w("input"),m=C(),p=w("button"),p.textContent="Load from GeoJSON",f=C(),d=w("button"),d.textContent="Export to GeoJSON",v=C(),_=w("br"),R=C(),c=w("div"),g=w("span"),M=$(y),L=$(" interventions"),k=C(),E=w("button"),N=$("Clear all"),A(i,"type","text"),A(h,"type","file"),A(h,"id","load_geojson"),A(h,"class","svelte-lhyd1e"),A(p,"type","button"),A(d,"type","button"),A(d,"class","align-right svelte-lhyd1e"),A(E,"type","button"),A(E,"class","align-right svelte-lhyd1e"),E.disabled=F=r[0].features.length==0},m(I,P){S(I,e,P),b(e,t),b(t,n),b(t,i),ot(i,r[0].scheme_name),S(I,o,P),S(I,s,P),S(I,a,P),S(I,l,P),b(l,u),b(u,h),b(u,m),b(u,p),b(l,f),b(l,d),S(I,v,P),S(I,_,P),S(I,R,P),S(I,c,P),b(c,g),b(g,M),b(g,L),b(c,k),b(c,E),b(E,N),T||(D=[J(i,"input",r[5]),J(h,"change",r[3]),J(p,"click",r[6]),J(d,"click",r[2]),J(E,"click",r[1])],T=!0)},p(I,[P]){P&1&&i.value!==I[0].scheme_name&&ot(i,I[0].scheme_name),P&1&&y!==(y=I[0].features.length+"")&&On(M,y),P&1&&F!==(F=I[0].features.length==0)&&(E.disabled=F)},i:z,o:z,d(I){I&&x(e),I&&x(o),I&&x(s),I&&x(a),I&&x(l),I&&x(v),I&&x(_),I&&x(R),I&&x(c),T=!1,ht(D)}}}function fo(r,e){var t=document.createElement("a");t.setAttribute("href","data:text/plain;charset=utf-8, "+encodeURIComponent(e)),t.setAttribute("download",r),document.body.appendChild(t),t.click(),document.body.removeChild(t)}function co(r,e,t){let n;te(r,W,f=>t(0,n=f));let{authorityName:i}=e,o=window.localStorage.getItem(i);if(o)try{W.set(h(JSON.parse(o)))}catch(f){console.log(`Failed to load from local storage: ${f}`)}function s(){confirm("Do you want to clear the current scheme? (You should save it first!)")&&W.update(f=>(delete f.scheme_name,f.features=[],f))}function a(){const f=JSON.parse(JSON.stringify(n));for(let d of f.features)delete d.properties.hide_while_editing;return f}function l(){let f=a();var d=i;f.authority=i,f.origin="atip-v1",f.scheme_name&&(d+="_"+f.scheme_name),d+=".txt",fo(d,JSON.stringify(f,null,"  "))}function u(f){const d=new FileReader;d.onload=v=>{try{W.set(h(JSON.parse(v.target.result)))}catch(_){window.alert(`Couldn't load scheme from a file: ${_}`)}},d.readAsText(f.target.files[0])}function h(f){let d=1;for(let v of f.features)v.geometry.type=="LineString"&&!v.properties.length_meters&&(v.properties.length_meters=Tt(v,{units:"kilometers"})*1e3),v.id=d++;return f}function m(){n.scheme_name=this.value,W.set(n)}const p=()=>document.getElementById("load_geojson").click();return r.$$set=f=>{"authorityName"in f&&t(4,i=f.authorityName)},r.$$.update=()=>{r.$$.dirty&17&&n&&(console.log("GJ changed, saving to local storage"),window.localStorage.setItem(i,JSON.stringify(a())))},[n,s,l,u,i,m,p]}class ho extends ne{constructor(e){super(),re(this,e,co,uo,K,{authorityName:4})}}const po="/atip/assets/zoom_out_map-b2e1091a.svg";function go(r){let e,t,n,i,o;return{c(){e=w("button"),t=w("img"),ei(t.src,n=po)||A(t,"src",n),A(t,"alt","Zoom to show entire boundary"),A(e,"type","button"),A(e,"title","Zoom to show entire boundary"),A(e,"class","svelte-qzjsqo")},m(s,a){S(s,e,a),b(e,t),i||(o=J(e,"click",r[0]),i=!0)},p:z,i:z,o:z,d(s){s&&x(e),i=!1,o()}}}function mo(r,e,t){let n;te(r,Ie,s=>t(2,n=s));let{boundaryGeojson:i}=e;function o(){n.fitBounds(Ln(i),{padding:20,animate:!0,duration:500})}return r.$$set=s=>{"boundaryGeojson"in s&&t(1,i=s.boundaryGeojson)},[o,i]}class vo extends ne{constructor(e){super(),re(this,e,mo,go,K,{boundaryGeojson:1})}}function yo(r){let e,t,n,i,o,s,a;return{c(){e=w("div"),t=$(`Basemap:
  `),n=w("select"),i=w("option"),i.textContent="Streets",o=w("option"),o.textContent="Satellite",i.__value="streets",i.value=i.__value,o.__value="hybrid",o.value=o.__value,r[0]===void 0&&Pr(()=>r[2].call(n)),A(e,"class","svelte-1tbnm6i")},m(l,u){S(l,e,u),b(e,t),b(e,n),b(n,i),b(n,o),zn(n,r[0]),s||(a=[J(n,"change",r[2]),J(n,"change",r[1])],s=!0)},p(l,[u]){u&1&&zn(n,l[0])},i:z,o:z,d(l){l&&x(e),s=!1,ht(a)}}}function _o(r,e,t){let{style:n}=e;function i(){let s=new URLSearchParams(window.location.search);s.set("style",n);let a=`${window.location.pathname}?${s.toString()}${window.location.hash}`;window.location.href=a}function o(){n=ti(this),t(0,n)}return r.$$set=s=>{"style"in s&&t(0,n=s.style)},[n,i,o]}class bo extends ne{constructor(e){super(),re(this,e,_o,yo,K,{style:0})}}const me={area:"#e41a1c",route:"#377eb8",crossing:"#4daf4a",other:"#984ea3",hovering:"black",lineEndpointColor:"black"},Qt=10,zt=10;function wo(r){let e,t,n,i,o,s,a,l,u,h,m,p,f,d,v,_,R,c,g;return{c(){e=w("div"),t=w("h1"),t.textContent="Interventions",n=C(),i=w("ul"),o=w("li"),s=w("span"),a=$("Areas"),l=C(),u=w("li"),h=w("span"),m=$("Routes"),p=C(),f=w("li"),d=w("span"),v=$("Crossings"),_=C(),R=w("li"),c=w("span"),g=$("Other"),A(t,"class","svelte-p551i1"),A(s,"class","svelte-p551i1"),Oe(s,"background",me.area),A(h,"class","svelte-p551i1"),Oe(h,"background",me.route),A(d,"class","svelte-p551i1"),Oe(d,"background",me.crossing),A(c,"class","svelte-p551i1"),Oe(c,"background",me.other),A(e,"class","svelte-p551i1")},m(y,M){S(y,e,M),b(e,t),b(e,n),b(e,i),b(i,o),b(o,s),b(o,a),b(i,l),b(i,u),b(u,h),b(u,m),b(i,p),b(i,f),b(f,d),b(f,v),b(i,_),b(i,R),b(R,c),b(R,g)},p:z,i:z,o:z,d(y){y&&x(e)}}}class So extends ne{constructor(e){super(),re(this,e,null,wo,K,{})}}let tt="interventions";function xo(r,e,t){let n,i;te(r,Ie,l=>t(0,n=l)),te(r,W,l=>t(1,i=l)),ct(n,tt,{type:"geojson",data:i});const o=["match",["get","intervention_type"],"area",me.area,"route",me.route,"crossing",me.crossing,"other",me.other,"white"],s=["!=","hide_while_editing",!0];return ye(n,{id:"interventions-points",source:tt,filter:["all",An,s,["!=","endpoint",!0]],...Ot(o,Qt)}),ye(n,{id:"interventions-lines",source:tt,filter:["all",In,s],...Yt(o,zt)},"route-lines"),ye(n,{id:"interventions-lines-endpoints",source:tt,filter:["==","endpoint",!0],type:"circle",paint:{"circle-radius":.5*zt,"circle-opacity":0,"circle-stroke-color":me.lineEndpointColor,"circle-stroke-width":2}}),ye(n,{id:"interventions-polygons",source:tt,filter:["all",Cn,s],...Rn(o,.5)},"hover-polygons"),r.$$.update=()=>{if(r.$$.dirty&3){let l=JSON.parse(JSON.stringify(i)),u=[];for(let h of l.features)if(h.geometry.type=="LineString")for(let m of[h.geometry.coordinates[0],h.geometry.coordinates[h.geometry.coordinates.length-1]])u.push({type:"Feature",properties:{endpoint:!0},geometry:{type:"Point",coordinates:m}});l.features=l.features.concat(u),n.getSource(tt).setData(l)}},[n,i]}class Eo extends ne{constructor(e){super(),re(this,e,xo,null,K,{})}}let nt="hover";function ko(r,e,t){let n,i,o,s,a;return te(r,Ie,l=>t(0,n=l)),te(r,W,l=>t(1,i=l)),te(r,jt,l=>t(2,o=l)),te(r,Fe,l=>t(3,s=l)),te(r,we,l=>t(4,a=l)),ct(n,nt,{type:"geojson",data:Be()}),ye(n,{id:"hover-polygons",source:nt,filter:Cn,...Yt(me.hovering,.5*zt,1)}),ye(n,{id:"hover-lines",source:nt,filter:In,...Yt(me.hovering,1.5*zt,1)},"interventions-lines"),ye(n,{id:"hover-points",source:nt,filter:An,...Ot(me.hovering,1.5*Qt,1)},"interventions-points"),r.$$.update=()=>{if(r.$$.dirty&31){let l=a||s||o;l!=null?n.getSource(nt).setData(i.features.find(u=>u.id==l)):n.getSource(nt).setData(Be())}},[n,i,o,s,a]}class Mo extends ne{constructor(e){super(),re(this,e,ko,null,K,{})}}const It="edit-point-mode";var Mt,gn;class Po{constructor(e){Ze(this,Mt);ge(this,"map");ge(this,"active");ge(this,"eventListeners");ge(this,"cursor");this.map=e,this.active=!1,this.eventListeners=[],this.cursor=null,e.on("mousemove",t=>{this.active&&(this.cursor=Lo(t.lngLat.toArray()),H(this,Mt,gn).call(this))}),e.on("click",()=>{if(this.active&&this.cursor){for(let t of this.eventListeners)t(this.cursor);this.stop()}}),ct(e,It,{type:"geojson",data:Be()}),ye(e,{id:"edit-point-mode",source:It,...Ot(me.hovering,Qt,1)})}addEventListener(e){this.eventListeners.push(e)}tearDown(){this.map.removeLayer("edit-point-mode"),this.map.removeSource(It)}start(){this.active=!0}stop(){this.cursor=null,this.active=!1,H(this,Mt,gn).call(this)}}Mt=new WeakSet,gn=function(){let e=Be();this.cursor&&e.features.push(this.cursor),this.map.getSource(It).setData(e)};function Lo(r){return{type:"Feature",properties:{},geometry:{type:"Point",coordinates:r}}}function Ar(r,e,t){if(t===void 0&&(t={}),t.final===!0)return Ro(r,e);var n=$e(r),i=$e(e),o=ke(n[0]),s=ke(i[0]),a=ke(n[1]),l=ke(i[1]),u=Math.sin(s-o)*Math.cos(l),h=Math.cos(a)*Math.sin(l)-Math.sin(a)*Math.cos(l)*Math.cos(s-o);return sn(Math.atan2(u,h))}function Ro(r,e){var t=Ar(e,r);return t=(t+180)%360,t}function dr(r,e,t,n){n===void 0&&(n={});var i=$e(r),o=ke(i[0]),s=ke(i[1]),a=ke(t),l=ni(e,n.units),u=Math.asin(Math.sin(s)*Math.cos(l)+Math.cos(s)*Math.sin(l)*Math.cos(a)),h=o+Math.atan2(Math.sin(a)*Math.sin(l)*Math.cos(s),Math.cos(l)-Math.sin(s)*Math.sin(u)),m=sn(h),p=sn(u);return at([m,p],n.properties)}function mn(r){if(!r)throw new Error("geojson is required");var e=[];return Nn(r,function(t){Oo(t,e)}),Ue(e)}function Oo(r,e){var t=[],n=r.geometry;if(n!==null){switch(n.type){case"Polygon":t=Ae(n);break;case"LineString":t=[Ae(n)]}t.forEach(function(i){var o=Ao(i,r.properties);o.forEach(function(s){s.id=e.length,e.push(s)})})}}function Ao(r,e){var t=[];return r.reduce(function(n,i){var o=ut([n,i],e);return o.bbox=Io(n,i),t.push(o),i}),t}function Io(r,e){var t=r[0],n=r[1],i=e[0],o=e[1],s=t<i?t:i,a=n<o?n:o,l=t>i?t:i,u=n>o?n:o;return[s,a,l,u]}var ft={},Co={get exports(){return ft},set exports(r){ft=r}},vn={},No={get exports(){return vn},set exports(r){vn=r}};(function(r,e){(function(t,n){r.exports=n()})(ri,function(){function t(c,g,y,M,L){(function k(E,N,F,T,D){for(;T>F;){if(T-F>600){var I=T-F+1,P=N-F+1,U=Math.log(I),pe=.5*Math.exp(2*U/3),_e=.5*Math.sqrt(U*pe*(I-pe)/I)*(P-I/2<0?-1:1),ce=Math.max(F,Math.floor(N-P*pe/I+_e)),ie=Math.min(T,Math.floor(N+(I-P)*pe/I+_e));k(E,N,ce,ie,D)}var xe=E[N],de=F,oe=T;for(n(E,F,N),D(E[T],xe)>0&&n(E,F,T);de<oe;){for(n(E,de,oe),de++,oe--;D(E[de],xe)<0;)de++;for(;D(E[oe],xe)>0;)oe--}D(E[F],xe)===0?n(E,F,oe):n(E,++oe,T),oe<=N&&(F=oe+1),N<=oe&&(T=oe-1)}})(c,g,y||0,M||c.length-1,L||i)}function n(c,g,y){var M=c[g];c[g]=c[y],c[y]=M}function i(c,g){return c<g?-1:c>g?1:0}var o=function(c){c===void 0&&(c=9),this._maxEntries=Math.max(4,c),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()};function s(c,g,y){if(!y)return g.indexOf(c);for(var M=0;M<g.length;M++)if(y(c,g[M]))return M;return-1}function a(c,g){l(c,0,c.children.length,g,c)}function l(c,g,y,M,L){L||(L=_(null)),L.minX=1/0,L.minY=1/0,L.maxX=-1/0,L.maxY=-1/0;for(var k=g;k<y;k++){var E=c.children[k];u(L,c.leaf?M(E):E)}return L}function u(c,g){return c.minX=Math.min(c.minX,g.minX),c.minY=Math.min(c.minY,g.minY),c.maxX=Math.max(c.maxX,g.maxX),c.maxY=Math.max(c.maxY,g.maxY),c}function h(c,g){return c.minX-g.minX}function m(c,g){return c.minY-g.minY}function p(c){return(c.maxX-c.minX)*(c.maxY-c.minY)}function f(c){return c.maxX-c.minX+(c.maxY-c.minY)}function d(c,g){return c.minX<=g.minX&&c.minY<=g.minY&&g.maxX<=c.maxX&&g.maxY<=c.maxY}function v(c,g){return g.minX<=c.maxX&&g.minY<=c.maxY&&g.maxX>=c.minX&&g.maxY>=c.minY}function _(c){return{children:c,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function R(c,g,y,M,L){for(var k=[g,y];k.length;)if(!((y=k.pop())-(g=k.pop())<=M)){var E=g+Math.ceil((y-g)/M/2)*M;t(c,E,g,y,L),k.push(g,E,E,y)}}return o.prototype.all=function(){return this._all(this.data,[])},o.prototype.search=function(c){var g=this.data,y=[];if(!v(c,g))return y;for(var M=this.toBBox,L=[];g;){for(var k=0;k<g.children.length;k++){var E=g.children[k],N=g.leaf?M(E):E;v(c,N)&&(g.leaf?y.push(E):d(c,N)?this._all(E,y):L.push(E))}g=L.pop()}return y},o.prototype.collides=function(c){var g=this.data;if(!v(c,g))return!1;for(var y=[];g;){for(var M=0;M<g.children.length;M++){var L=g.children[M],k=g.leaf?this.toBBox(L):L;if(v(c,k)){if(g.leaf||d(c,k))return!0;y.push(L)}}g=y.pop()}return!1},o.prototype.load=function(c){if(!c||!c.length)return this;if(c.length<this._minEntries){for(var g=0;g<c.length;g++)this.insert(c[g]);return this}var y=this._build(c.slice(),0,c.length-1,0);if(this.data.children.length)if(this.data.height===y.height)this._splitRoot(this.data,y);else{if(this.data.height<y.height){var M=this.data;this.data=y,y=M}this._insert(y,this.data.height-y.height-1,!0)}else this.data=y;return this},o.prototype.insert=function(c){return c&&this._insert(c,this.data.height-1),this},o.prototype.clear=function(){return this.data=_([]),this},o.prototype.remove=function(c,g){if(!c)return this;for(var y,M,L,k=this.data,E=this.toBBox(c),N=[],F=[];k||N.length;){if(k||(k=N.pop(),M=N[N.length-1],y=F.pop(),L=!0),k.leaf){var T=s(c,k.children,g);if(T!==-1)return k.children.splice(T,1),N.push(k),this._condense(N),this}L||k.leaf||!d(k,E)?M?(y++,k=M.children[y],L=!1):k=null:(N.push(k),F.push(y),y=0,M=k,k=k.children[0])}return this},o.prototype.toBBox=function(c){return c},o.prototype.compareMinX=function(c,g){return c.minX-g.minX},o.prototype.compareMinY=function(c,g){return c.minY-g.minY},o.prototype.toJSON=function(){return this.data},o.prototype.fromJSON=function(c){return this.data=c,this},o.prototype._all=function(c,g){for(var y=[];c;)c.leaf?g.push.apply(g,c.children):y.push.apply(y,c.children),c=y.pop();return g},o.prototype._build=function(c,g,y,M){var L,k=y-g+1,E=this._maxEntries;if(k<=E)return a(L=_(c.slice(g,y+1)),this.toBBox),L;M||(M=Math.ceil(Math.log(k)/Math.log(E)),E=Math.ceil(k/Math.pow(E,M-1))),(L=_([])).leaf=!1,L.height=M;var N=Math.ceil(k/E),F=N*Math.ceil(Math.sqrt(E));R(c,g,y,F,this.compareMinX);for(var T=g;T<=y;T+=F){var D=Math.min(T+F-1,y);R(c,T,D,N,this.compareMinY);for(var I=T;I<=D;I+=N){var P=Math.min(I+N-1,D);L.children.push(this._build(c,I,P,M-1))}}return a(L,this.toBBox),L},o.prototype._chooseSubtree=function(c,g,y,M){for(;M.push(g),!g.leaf&&M.length-1!==y;){for(var L=1/0,k=1/0,E=void 0,N=0;N<g.children.length;N++){var F=g.children[N],T=p(F),D=(I=c,P=F,(Math.max(P.maxX,I.maxX)-Math.min(P.minX,I.minX))*(Math.max(P.maxY,I.maxY)-Math.min(P.minY,I.minY))-T);D<k?(k=D,L=T<L?T:L,E=F):D===k&&T<L&&(L=T,E=F)}g=E||g.children[0]}var I,P;return g},o.prototype._insert=function(c,g,y){var M=y?c:this.toBBox(c),L=[],k=this._chooseSubtree(M,this.data,g,L);for(k.children.push(c),u(k,M);g>=0&&L[g].children.length>this._maxEntries;)this._split(L,g),g--;this._adjustParentBBoxes(M,L,g)},o.prototype._split=function(c,g){var y=c[g],M=y.children.length,L=this._minEntries;this._chooseSplitAxis(y,L,M);var k=this._chooseSplitIndex(y,L,M),E=_(y.children.splice(k,y.children.length-k));E.height=y.height,E.leaf=y.leaf,a(y,this.toBBox),a(E,this.toBBox),g?c[g-1].children.push(E):this._splitRoot(y,E)},o.prototype._splitRoot=function(c,g){this.data=_([c,g]),this.data.height=c.height+1,this.data.leaf=!1,a(this.data,this.toBBox)},o.prototype._chooseSplitIndex=function(c,g,y){for(var M,L,k,E,N,F,T,D=1/0,I=1/0,P=g;P<=y-g;P++){var U=l(c,0,P,this.toBBox),pe=l(c,P,y,this.toBBox),_e=(L=U,k=pe,E=void 0,N=void 0,F=void 0,T=void 0,E=Math.max(L.minX,k.minX),N=Math.max(L.minY,k.minY),F=Math.min(L.maxX,k.maxX),T=Math.min(L.maxY,k.maxY),Math.max(0,F-E)*Math.max(0,T-N)),ce=p(U)+p(pe);_e<D?(D=_e,M=P,I=ce<I?ce:I):_e===D&&ce<I&&(I=ce,M=P)}return M||y-g},o.prototype._chooseSplitAxis=function(c,g,y){var M=c.leaf?this.compareMinX:h,L=c.leaf?this.compareMinY:m;this._allDistMargin(c,g,y,M)<this._allDistMargin(c,g,y,L)&&c.children.sort(M)},o.prototype._allDistMargin=function(c,g,y,M){c.children.sort(M);for(var L=this.toBBox,k=l(c,0,g,L),E=l(c,y-g,y,L),N=f(k)+f(E),F=g;F<y-g;F++){var T=c.children[F];u(k,c.leaf?L(T):T),N+=f(k)}for(var D=y-g-1;D>=g;D--){var I=c.children[D];u(E,c.leaf?L(I):I),N+=f(E)}return N},o.prototype._adjustParentBBoxes=function(c,g,y){for(var M=y;M>=0;M--)u(g[M],c)},o.prototype._condense=function(c){for(var g=c.length-1,y=void 0;g>=0;g--)c[g].children.length===0?g>0?(y=c[g-1].children).splice(y.indexOf(c[g]),1):this.clear():a(c[g],this.toBBox)},o})})(No);const To=Tn(ii),Fo=Tn(oi),Bo=Tn(si);var Pe=vn,Ir=To,Cr=Fo,rt=Bo.default,Do=Cr.featureEach;Cr.coordEach;Ir.polygon;var gr=Ir.featureCollection;function Nr(r){var e=new Pe(r);return e.insert=function(t){if(t.type!=="Feature")throw new Error("invalid feature");return t.bbox=t.bbox?t.bbox:rt(t),Pe.prototype.insert.call(this,t)},e.load=function(t){var n=[];return Array.isArray(t)?t.forEach(function(i){if(i.type!=="Feature")throw new Error("invalid features");i.bbox=i.bbox?i.bbox:rt(i),n.push(i)}):Do(t,function(i){if(i.type!=="Feature")throw new Error("invalid features");i.bbox=i.bbox?i.bbox:rt(i),n.push(i)}),Pe.prototype.load.call(this,n)},e.remove=function(t,n){if(t.type!=="Feature")throw new Error("invalid feature");return t.bbox=t.bbox?t.bbox:rt(t),Pe.prototype.remove.call(this,t,n)},e.clear=function(){return Pe.prototype.clear.call(this)},e.search=function(t){var n=Pe.prototype.search.call(this,this.toBBox(t));return gr(n)},e.collides=function(t){return Pe.prototype.collides.call(this,this.toBBox(t))},e.all=function(){var t=Pe.prototype.all.call(this);return gr(t)},e.toJSON=function(){return Pe.prototype.toJSON.call(this)},e.fromJSON=function(t){return Pe.prototype.fromJSON.call(this,t)},e.toBBox=function(t){var n;if(t.bbox)n=t.bbox;else if(Array.isArray(t)&&t.length===4)n=t;else if(Array.isArray(t)&&t.length===6)n=[t[0],t[1],t[3],t[4]];else if(t.type==="Feature")n=rt(t);else if(t.type==="FeatureCollection")n=rt(t);else throw new Error("invalid geojson");return{minX:n[0],minY:n[1],maxX:n[2],maxY:n[3]}},e}Co.exports=Nr;ft.default=Nr;function Tr(r,e){var t={},n=[];if(r.type==="LineString"&&(r=Un(r)),e.type==="LineString"&&(e=Un(e)),r.type==="Feature"&&e.type==="Feature"&&r.geometry!==null&&e.geometry!==null&&r.geometry.type==="LineString"&&e.geometry.type==="LineString"&&r.geometry.coordinates.length===2&&e.geometry.coordinates.length===2){var i=mr(r,e);return i&&n.push(i),Ue(n)}var o=ft();return o.load(mn(e)),qt(mn(r),function(s){qt(o.search(s),function(a){var l=mr(s,a);if(l){var u=Ae(l).join(",");t[u]||(t[u]=!0,n.push(l))}})}),Ue(n)}function mr(r,e){var t=Ae(r),n=Ae(e);if(t.length!==2)throw new Error("<intersects> line1 must only contain 2 coordinates");if(n.length!==2)throw new Error("<intersects> line2 must only contain 2 coordinates");var i=t[0][0],o=t[0][1],s=t[1][0],a=t[1][1],l=n[0][0],u=n[0][1],h=n[1][0],m=n[1][1],p=(m-u)*(s-i)-(h-l)*(a-o),f=(h-l)*(o-u)-(m-u)*(i-l),d=(s-i)*(o-u)-(a-o)*(i-l);if(p===0)return f===0&&d===0,null;var v=f/p,_=d/p;if(v>=0&&v<=1&&_>=0&&_<=1){var R=i+v*(s-i),c=o+v*(a-o);return at([R,c])}return null}function kt(r,e,t){t===void 0&&(t={});var n=at([1/0,1/0],{dist:1/0}),i=0;return Nn(r,function(o){for(var s=Ae(o),a=0;a<s.length-1;a++){var l=at(s[a]);l.properties.dist=qe(e,l,t);var u=at(s[a+1]);u.properties.dist=qe(e,u,t);var h=qe(l,u,t),m=Math.max(l.properties.dist,u.properties.dist),p=Ar(l,u),f=dr(e,m,p+90,t),d=dr(e,m,p-90,t),v=Tr(ut([f.geometry.coordinates,d.geometry.coordinates]),ut([l.geometry.coordinates,u.geometry.coordinates])),_=null;v.features.length>0&&(_=v.features[0],_.properties.dist=qe(e,_,t),_.properties.location=i+qe(l,_,t)),l.properties.dist<n.properties.dist&&(n=l,n.properties.index=a,n.properties.location=i),u.properties.dist<n.properties.dist&&(n=u,n.properties.index=a+1,n.properties.location=i+h),_&&_.properties.dist<n.properties.dist&&(n=_,n.properties.index=a),i+=h}}),n}const it="edit-polygon-mode";var Ne,Ke,Pt,yn,Lt,_n;class Go{constructor(e){Ze(this,Ne);Ze(this,Pt);Ze(this,Lt);ge(this,"map");ge(this,"active");ge(this,"eventListeners");ge(this,"points");ge(this,"cursor");ge(this,"hoverPolyon");ge(this,"hoverPoint");ge(this,"dragging");ge(this,"dragFrom");this.map=e,this.active=!1,this.eventListeners=[],this.points=[],this.cursor=null,this.hoverPolyon=!1,this.hoverPoint=null,this.dragging=!1,this.dragFrom=null,e.on("mousemove",t=>{if(this.active&&!this.dragging)H(this,Pt,yn).call(this,t);else if(this.active&&this.dragging){if(this.hoverPolyon){let n=this.dragFrom[0]-t.lngLat.lng,i=this.dragFrom[1]-t.lngLat.lat;for(let o of this.points)o[0]-=n,o[1]-=i}else this.points[this.hoverPoint]=t.lngLat.toArray();this.dragFrom=t.lngLat.toArray(),H(this,Ne,Ke).call(this)}}),e.on("click",t=>{if(this.active&&this.cursor){let n=[];if(yr(this.points).forEach((i,o)=>{n.push([o+1,kt(i,this.cursor).properties.dist])}),n.sort((i,o)=>i[1]-o[1]),n.length>0){let i=n[0][0];this.points.splice(i,0,this.cursor.geometry.coordinates),this.hoverPoint=i}else this.points.push(this.cursor.geometry.coordinates),this.hoverPoint=this.points.length-1;H(this,Ne,Ke).call(this)}else this.active&&this.hoverPoint!=null&&(this.points.splice(this.hoverPoint,1),this.hoverPoint=null,H(this,Ne,Ke).call(this),H(this,Pt,yn).call(this,t))}),e.on("mousedown",t=>{this.active&&!this.dragging&&(this.hoverPolyon||this.hoverPoint!=null)&&(t.preventDefault(),this.cursor=null,this.dragging=!0,this.dragFrom=t.lngLat.toArray())}),e.on("mouseup",()=>{this.active&&this.dragging&&(this.dragging=!1,this.dragFrom=null)}),document.addEventListener("keypress",t=>{if(this.active&&t.key=="Enter"){t.preventDefault();let n=H(this,Lt,_n).call(this);if(n)for(let i of this.eventListeners)i(n);this.stop()}}),ct(e,it,{type:"geojson",data:Be()}),ye(e,{id:"edit-polygon-fill",source:it,filter:Cn,...Rn("red",["case",["boolean",["get","hover"],"false"],1,.5])}),ye(e,{id:"edit-polygon-lines",source:it,filter:In,...Yt("black",8,.5)}),ye(e,{id:"edit-polygon-vertices",source:it,filter:An,...Ot(me.hovering,Qt,["case",["boolean",["get","hover"],"false"],1,.5])})}addEventListener(e){this.eventListeners.push(e)}tearDown(){this.map.removeLayer("edit-polygon-vertices"),this.map.removeLayer("edit-polygon-fill"),this.map.removeLayer("edit-polygon-lines"),this.map.removeSource(it)}startNew(){this.active=!0}editExisting(e){this.active=!0,this.points=e.geometry.coordinates[0],this.points.pop(),H(this,Ne,Ke).call(this)}stop(){this.points=[],this.cursor=null,this.active=!1,this.hoverPolyon=!1,this.hoverPoint=null,this.dragging=!1,this.dragFrom=null,H(this,Ne,Ke).call(this)}}Ne=new WeakSet,Ke=function(){let e=Be();this.points.forEach((n,i)=>{let o=vr(n);o.properties.hover=this.hoverPoint==i,o.properties.idx=i,e.features.push(o)}),this.cursor&&e.features.push(this.cursor),e.features=e.features.concat(yr(this.points));let t=H(this,Lt,_n).call(this);t&&(t.properties.hover=this.hoverPolyon,e.features.push(t)),this.map.getSource(it).setData(e)},Pt=new WeakSet,yn=function(e){this.cursor=null,this.hoverPolyon=!1,this.hoverPoint=null;for(let t of this.map.queryRenderedFeatures(e.point,{layers:["edit-polygon-fill","edit-polygon-vertices"]}))if(t.geometry.type=="Polygon"){this.hoverPolyon=!0;break}else if(t.geometry.type=="Point"&&Object.hasOwn(t.properties,"idx")){this.hoverPoint=t.properties.idx;break}!this.hoverPolyon&&this.hoverPoint==null&&(this.cursor=vr(e.lngLat.toArray())),H(this,Ne,Ke).call(this)},Lt=new WeakSet,_n=function(){if(this.points.length<3)return null;let e=[JSON.parse(JSON.stringify(this.points))];return e[0].push(JSON.parse(JSON.stringify(e[0][0]))),{type:"Feature",geometry:{type:"Polygon",coordinates:e},properties:{}}};function vr(r){return{type:"Feature",properties:{},geometry:{type:"Point",coordinates:r}}}function yr(r){let e=[];for(let t=0;t<r.length-1;t++)e.push({type:"Feature",geometry:{type:"LineString",coordinates:[r[t],r[t+1]]}});return r.length>=3&&e.push({type:"Feature",geometry:{type:"LineString",coordinates:[r[r.length-1],r[0]]}}),e}function _r(r){let e;return{c(){e=w("p"),e.textContent="Click an intervention to fill out its attributes"},m(t,n){S(t,e,n)},d(t){t&&x(e)}}}function Yo(r){let e,t=r[0]==st&&_r();return{c(){t&&t.c(),e=He()},m(n,i){t&&t.m(n,i),S(n,e,i)},p(n,[i]){n[0]==st?t||(t=_r(),t.c(),t.m(e.parentNode,e)):t&&(t.d(1),t=null)},i:z,o:z,d(n){t&&t.d(n),n&&x(e)}}}const st="edit-attribute";function Fr(){}function qo(r,e,t){let n,i;te(r,Ie,l=>t(4,n=l)),te(r,W,l=>t(5,i=l));let{mode:o}=e,{changeMode:s}=e;function a(){we.set(null)}return n.on("mousemove",l=>{var u;if(o==st){let h=n.queryRenderedFeatures(l.point,{layers:["interventions-points","interventions-lines","interventions-polygons"]});Fe.set(((u=h[0])==null?void 0:u.id)||null)}}),n.on("mouseout",()=>{o==st&&Fe.set(null)}),n.on("click",l=>{if(o==st){let u=n.queryRenderedFeatures(l.point,{layers:["interventions-points","interventions-lines","interventions-polygons"]});u.length>0?we.set(u[0].id):we.set(null)}}),ln.subscribe(l=>{if(l){let u=i.features.find(h=>h.id==l);u.geometry.type=="Point"?n.flyTo({center:u.geometry.coordinates,duration:500}):n.fitBounds(Ln(u),{padding:200,duration:500}),s(st)}}),r.$$set=l=>{"mode"in l&&t(0,o=l.mode),"changeMode"in l&&t(1,s=l.changeMode)},[o,s,Fr,a]}class jo extends ne{constructor(e){super(),re(this,e,qo,Yo,K,{mode:0,changeMode:1,start:2,stop:3})}get start(){return Fr}get stop(){return this.$$.ctx[3]}}function br(r){let e;return{c(){e=w("p"),e.textContent="Click an intervention to edit its geometry"},m(t,n){S(t,e,n)},d(t){t&&x(e)}}}function Xo(r){let e,t=r[0]==Ge&&br();return{c(){t&&t.c(),e=He()},m(n,i){t&&t.m(n,i),S(n,e,i)},p(n,[i]){n[0]==Ge?t||(t=br(),t.c(),t.m(e.parentNode,e)):t&&(t.d(1),t=null)},i:z,o:z,d(n){t&&t.d(n),n&&x(e)}}}const Ge="edit-geometry";function Br(){}function Jo(r,e,t){let n;te(r,Ie,p=>t(8,n=p));let{mode:i}=e,{routeSnapper:o}=e,{snapTool:s}=e,{pointTool:a}=e,{polygonTool:l}=e;function u(){h&&(o.stop(),a.stop(),l.stop(),W.update(p=>{let f=p.features.find(d=>d.id==h);return delete f.properties.hide_while_editing,p})),h=null,Fe.set(null)}let h=null;n.on("mousemove",p=>{var f;if(i==Ge&&h==null){let d=n.queryRenderedFeatures(p.point,{layers:["interventions-points","interventions-lines","interventions-polygons"]});Fe.set(((f=d[0])==null?void 0:f.id)||null)}}),n.on("mouseout",()=>{i==Ge&&h==null&&Fe.set(null)}),n.on("click",p=>{if(i==Ge&&h==null){let f=n.queryRenderedFeatures(p.point,{layers:["interventions-points","interventions-lines","interventions-polygons"]});f.length>0&&m(f[0].id)}}),s.addEventListener("new-route",p=>{if(i==Ge){const f=p.detail;W.update(d=>{let v=d.features.find(_=>_.id==h);return v.properties.length_meters=f.properties.length_meters,v.properties.waypoints=f.properties.waypoints,delete v.properties.hide_while_editing,v.geometry=f.geometry,d}),h=null}}),s.addEventListener("no-new-route",()=>{i==Ge&&(W.update(p=>{let f=p.features.find(d=>d.id==h);return delete f.properties.hide_while_editing,p}),h=null)});for(let p of[a,l])p.addEventListener(f=>{i==Ge&&(W.update(d=>{let v=d.features.find(_=>_.id==h);return v.geometry=f.geometry,delete v.properties.hide_while_editing,d}),h=null)});function m(p){Fe.set(null);let f=null;W.update(v=>(f=v.features.find(_=>_.id==p),f.properties.hide_while_editing=!0,v));let d=f;h=p,d.geometry.type=="LineString"?o.editExisting(d):d.geometry.type=="Polygon"?l.editExisting(d):d.geometry.type=="Point"&&a.start()}return r.$$set=p=>{"mode"in p&&t(0,i=p.mode),"routeSnapper"in p&&t(1,o=p.routeSnapper),"snapTool"in p&&t(2,s=p.snapTool),"pointTool"in p&&t(3,a=p.pointTool),"polygonTool"in p&&t(4,l=p.polygonTool)},[i,o,s,a,l,Br,u]}class zo extends ne{constructor(e){super(),re(this,e,Jo,Xo,K,{mode:0,routeSnapper:1,snapTool:2,pointTool:3,polygonTool:4,start:5,stop:6})}get start(){return Br}get stop(){return this.$$.ctx[6]}}let B;const Dr=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});Dr.decode();let Ft=new Uint8Array;function St(){return Ft.byteLength===0&&(Ft=new Uint8Array(B.memory.buffer)),Ft}function lt(r,e){return Dr.decode(St().subarray(r,r+e))}const Te=new Array(32).fill(void 0);Te.push(void 0,null,!0,!1);let xt=Te.length;function se(r){xt===Te.length&&Te.push(Te.length+1);const e=xt;return xt=Te[e],Te[e]=r,e}function j(r){return Te[r]}function Uo(r){r<36||(Te[r]=xt,xt=r)}function bn(r){const e=j(r);return Uo(r),e}function en(r){return r==null}let Bt=new Float64Array;function $o(){return Bt.byteLength===0&&(Bt=new Float64Array(B.memory.buffer)),Bt}let Dt=new Int32Array;function le(){return Dt.byteLength===0&&(Dt=new Int32Array(B.memory.buffer)),Dt}let Xe=0;const Gt=new TextEncoder("utf-8"),Wo=typeof Gt.encodeInto=="function"?function(r,e){return Gt.encodeInto(r,e)}:function(r,e){const t=Gt.encode(r);return e.set(t),{read:r.length,written:t.length}};function Ct(r,e,t){if(t===void 0){const a=Gt.encode(r),l=e(a.length);return St().subarray(l,l+a.length).set(a),Xe=a.length,l}let n=r.length,i=e(n);const o=St();let s=0;for(;s<n;s++){const a=r.charCodeAt(s);if(a>127)break;o[i+s]=a}if(s!==n){s!==0&&(r=r.slice(s)),i=t(i,n,n=s+r.length*3);const a=St().subarray(i+s,i+n),l=Wo(r,a);s+=l.written}return Xe=s,i}function wn(r){const e=typeof r;if(e=="number"||e=="boolean"||r==null)return`${r}`;if(e=="string")return`"${r}"`;if(e=="symbol"){const i=r.description;return i==null?"Symbol":`Symbol(${i})`}if(e=="function"){const i=r.name;return typeof i=="string"&&i.length>0?`Function(${i})`:"Function"}if(Array.isArray(r)){const i=r.length;let o="[";i>0&&(o+=wn(r[0]));for(let s=1;s<i;s++)o+=", "+wn(r[s]);return o+="]",o}const t=/\[object ([^\]]+)\]/.exec(toString.call(r));let n;if(t.length>1)n=t[1];else return toString.call(r);if(n=="Object")try{return"Object("+JSON.stringify(r)+")"}catch{return"Object"}return r instanceof Error?`${r.name}: ${r.message}
${r.stack}`:n}function Ho(r,e){const t=e(r.length*1);return St().set(r,t/1),Xe=r.length,t}function tn(r,e){try{return r.apply(this,e)}catch(t){B.__wbindgen_exn_store(se(t))}}class Ut{static __wrap(e){const t=Object.create(Ut.prototype);return t.ptr=e,t}__destroy_into_raw(){const e=this.ptr;return this.ptr=0,e}free(){const e=this.__destroy_into_raw();B.__wbg_jsroutesnapper_free(e)}constructor(e){try{const o=B.__wbindgen_add_to_stack_pointer(-16),s=Ho(e,B.__wbindgen_malloc),a=Xe;B.jsroutesnapper_new(o,s,a);var t=le()[o/4+0],n=le()[o/4+1],i=le()[o/4+2];if(i)throw bn(n);return Ut.__wrap(t)}finally{B.__wbindgen_add_to_stack_pointer(16)}}setConfig(e){B.jsroutesnapper_setConfig(this.ptr,se(e))}toFinalFeature(){try{const n=B.__wbindgen_add_to_stack_pointer(-16);B.jsroutesnapper_toFinalFeature(n,this.ptr);var e=le()[n/4+0],t=le()[n/4+1];let i;return e!==0&&(i=lt(e,t).slice(),B.__wbindgen_free(e,t*1)),i}finally{B.__wbindgen_add_to_stack_pointer(16)}}renderGeojson(){try{const n=B.__wbindgen_add_to_stack_pointer(-16);B.jsroutesnapper_renderGeojson(n,this.ptr);var e=le()[n/4+0],t=le()[n/4+1];return lt(e,t)}finally{B.__wbindgen_add_to_stack_pointer(16),B.__wbindgen_free(e,t)}}setSnapMode(e){B.jsroutesnapper_setSnapMode(this.ptr,e)}onMouseMove(e,t,n){return B.jsroutesnapper_onMouseMove(this.ptr,e,t,n)!==0}onClick(){B.jsroutesnapper_onClick(this.ptr)}onDragStart(){return B.jsroutesnapper_onDragStart(this.ptr)!==0}onMouseUp(){return B.jsroutesnapper_onMouseUp(this.ptr)!==0}clearState(){B.jsroutesnapper_clearState(this.ptr)}editExisting(e){try{const i=B.__wbindgen_add_to_stack_pointer(-16);B.jsroutesnapper_editExisting(i,this.ptr,se(e));var t=le()[i/4+0],n=le()[i/4+1];if(n)throw bn(t)}finally{B.__wbindgen_add_to_stack_pointer(16)}}}async function Vo(r,e){if(typeof Response=="function"&&r instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(r,e)}catch(n){if(r.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",n);else throw n}const t=await r.arrayBuffer();return await WebAssembly.instantiate(t,e)}else{const t=await WebAssembly.instantiate(r,e);return t instanceof WebAssembly.Instance?{instance:t,module:r}:t}}function Qo(){const r={};return r.wbg={},r.wbg.__wbindgen_string_new=function(e,t){const n=lt(e,t);return se(n)},r.wbg.__wbindgen_object_drop_ref=function(e){bn(e)},r.wbg.__wbindgen_boolean_get=function(e){const t=j(e);return typeof t=="boolean"?t?1:0:2},r.wbg.__wbindgen_error_new=function(e,t){const n=new Error(lt(e,t));return se(n)},r.wbg.__wbindgen_is_object=function(e){const t=j(e);return typeof t=="object"&&t!==null},r.wbg.__wbindgen_is_undefined=function(e){return j(e)===void 0},r.wbg.__wbindgen_in=function(e,t){return j(e)in j(t)},r.wbg.__wbindgen_number_get=function(e,t){const n=j(t),i=typeof n=="number"?n:void 0;$o()[e/8+1]=en(i)?0:i,le()[e/4+0]=!en(i)},r.wbg.__wbindgen_jsval_loose_eq=function(e,t){return j(e)==j(t)},r.wbg.__wbindgen_string_get=function(e,t){const n=j(t),i=typeof n=="string"?n:void 0;var o=en(i)?0:Ct(i,B.__wbindgen_malloc,B.__wbindgen_realloc),s=Xe;le()[e/4+1]=s,le()[e/4+0]=o},r.wbg.__wbg_String_91fba7ded13ba54c=function(e,t){const n=String(j(t)),i=Ct(n,B.__wbindgen_malloc,B.__wbindgen_realloc),o=Xe;le()[e/4+1]=o,le()[e/4+0]=i},r.wbg.__wbindgen_object_clone_ref=function(e){const t=j(e);return se(t)},r.wbg.__wbg_getwithrefkey_15c62c2b8546208d=function(e,t){const n=j(e)[j(t)];return se(n)},r.wbg.__wbg_log_4b5638ad60bdc54a=function(e){console.log(j(e))},r.wbg.__wbg_get_57245cc7d7c7619d=function(e,t){const n=j(e)[t>>>0];return se(n)},r.wbg.__wbg_length_6e3bbe7c8bd4dbd8=function(e){return j(e).length},r.wbg.__wbindgen_is_function=function(e){return typeof j(e)=="function"},r.wbg.__wbg_next_579e583d33566a86=function(e){const t=j(e).next;return se(t)},r.wbg.__wbg_next_aaef7c8aa5e212ac=function(){return tn(function(e){const t=j(e).next();return se(t)},arguments)},r.wbg.__wbg_done_1b73b0672e15f234=function(e){return j(e).done},r.wbg.__wbg_value_1ccc36bc03462d71=function(e){const t=j(e).value;return se(t)},r.wbg.__wbg_iterator_6f9d4f28845f426c=function(){return se(Symbol.iterator)},r.wbg.__wbg_get_765201544a2b6869=function(){return tn(function(e,t){const n=Reflect.get(j(e),j(t));return se(n)},arguments)},r.wbg.__wbg_call_97ae9d8645dc388b=function(){return tn(function(e,t){const n=j(e).call(j(t));return se(n)},arguments)},r.wbg.__wbg_isArray_27c46c67f498e15d=function(e){return Array.isArray(j(e))},r.wbg.__wbg_instanceof_ArrayBuffer_e5e48f4762c5610b=function(e){let t;try{t=j(e)instanceof ArrayBuffer}catch{t=!1}return t},r.wbg.__wbg_buffer_3f3d764d4747d564=function(e){const t=j(e).buffer;return se(t)},r.wbg.__wbg_new_8c3f0052272a457a=function(e){const t=new Uint8Array(j(e));return se(t)},r.wbg.__wbg_set_83db9690f9353e79=function(e,t,n){j(e).set(j(t),n>>>0)},r.wbg.__wbg_length_9e1ae1900cb0fbd5=function(e){return j(e).length},r.wbg.__wbg_instanceof_Uint8Array_971eeda69eb75003=function(e){let t;try{t=j(e)instanceof Uint8Array}catch{t=!1}return t},r.wbg.__wbg_new_abda76e883ba8a5f=function(){const e=new Error;return se(e)},r.wbg.__wbg_stack_658279fe44541cf6=function(e,t){const n=j(t).stack,i=Ct(n,B.__wbindgen_malloc,B.__wbindgen_realloc),o=Xe;le()[e/4+1]=o,le()[e/4+0]=i},r.wbg.__wbg_error_f851667af71bcfc6=function(e,t){try{console.error(lt(e,t))}finally{B.__wbindgen_free(e,t)}},r.wbg.__wbindgen_debug_string=function(e,t){const n=wn(j(t)),i=Ct(n,B.__wbindgen_malloc,B.__wbindgen_realloc),o=Xe;le()[e/4+1]=o,le()[e/4+0]=i},r.wbg.__wbindgen_throw=function(e,t){throw new Error(lt(e,t))},r.wbg.__wbindgen_memory=function(){const e=B.memory;return se(e)},r}function Zo(r,e){return B=r.exports,Gr.__wbindgen_wasm_module=e,Bt=new Float64Array,Dt=new Int32Array,Ft=new Uint8Array,B}async function Gr(r){typeof r>"u"&&(r="/atip/assets/route_snapper_bg.wasm");const e=Qo();(typeof r=="string"||typeof Request=="function"&&r instanceof Request||typeof URL=="function"&&r instanceof URL)&&(r=fetch(r));const{instance:t,module:n}=await Vo(await r,e);return Zo(t,n)}var Rt,Sn,Re,De;class Ko{constructor(e,t,n){Ze(this,Rt);Ze(this,Re);this.controlDiv=n,this.map=e,console.time("Deserialize and setup JsRouteSnapper"),this.inner=new Ut(t),console.timeEnd("Deserialize and setup JsRouteSnapper"),console.log("JsRouteSnapper ready, waiting for idle event"),this.active=!1,this.loaded=!1,this.map.once("idle",()=>{console.log("JsRouteSnapper now usable"),this.map.addSource("route-snapper",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),this.map.addLayer({id:"route-points",type:"circle",source:"route-snapper",paint:{"circle-radius":["match",["get","type"],"unimportant",10/2,10],"circle-color":["match",["get","type"],"hovered","green","important","red","black"]},filter:["in","$type","Point"]}),this.map.addLayer({id:"route-lines",type:"line",source:"route-snapper",layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"black","line-width":2.5},filter:["in","$type","LineString"]}),this.loaded=!0,this.map.on("mousemove",s=>{if(!this.active)return;const a={x:s.point.x-30,y:s.point.y},l=this.map.unproject(s.point).distanceTo(this.map.unproject(a));this.inner.onMouseMove(s.lngLat.lng,s.lngLat.lat,l)&&H(this,Re,De).call(this)}),this.map.on("click",()=>{this.active&&(this.inner.onClick(),H(this,Re,De).call(this))}),this.map.on("dragstart",s=>{this.active&&this.inner.onDragStart()&&this.map.dragPan.disable()}),this.map.on("mouseup",s=>{this.active&&this.inner.onMouseUp()&&this.map.dragPan.enable()}),document.addEventListener("keypress",s=>{this.active&&s.key=="Enter"&&(s.preventDefault(),H(this,Rt,Sn).call(this))}),document.addEventListener("keydown",s=>{this.active&&s.key=="Shift"&&(s.preventDefault(),this.inner.setSnapMode(!1),H(this,Re,De).call(this))}),document.addEventListener("keyup",s=>{this.active&&s.key=="Shift"&&(s.preventDefault(),this.inner.setSnapMode(!0),H(this,Re,De).call(this))}),this.stop()})}isActive(){return this.active}tearDown(){this.loaded&&(this.map.removeLayer("route-points"),this.map.removeLayer("route-lines"),this.map.removeSource("route-snapper"))}editExisting(e){if(!this.loaded){console.error("editExisting called before the map idle event received. Not starting tool.");return}e.properties.waypoints||(e.properties.waypoints=[{lon:e.geometry.coordinates[0][0],lat:e.geometry.coordinates[0][1],snapped:!0},{lon:e.geometry.coordinates[e.geometry.coordinates.length-1][0],lat:e.geometry.coordinates[e.geometry.coordinates.length-1][1],snapped:!0}]),this.start(),this.inner.editExisting(e.properties.waypoints),H(this,Re,De).call(this)}stop(){if(!this.loaded)return;this.active=!1,this.inner.clearState(),H(this,Re,De).call(this),this.controlDiv.innerHTML="";let e=document.createElement("button");e.innerText="Route tool",e.type="button",e.onclick=()=>{this.controlDiv.dispatchEvent(new CustomEvent("activate")),this.start()},this.controlDiv.appendChild(e)}start(){if(this.active)return;this.active=!0;let e=document.createElement("button");e.type="button",e.innerText="Finish route",e.onclick=()=>{H(this,Rt,Sn).call(this)};let t=document.createElement("button");t.type="button",t.innerText="Cancel",t.onclick=()=>{this.controlDiv.dispatchEvent(new CustomEvent("no-new-route")),this.stop()},this.controlDiv.innerHTML="";let n=document.createElement("div");n.style="display: flex; justify-content: space-evenly;",n.appendChild(e),n.appendChild(t),this.controlDiv.appendChild(n);let i=document.createElement("input");i.type="checkbox",i.id="avoidDoublingBack",i.onclick=()=>{this.inner.setConfig({avoid_doubling_back:i.checked}),H(this,Re,De).call(this)};let o=document.createElement("label");o.innerText="Avoid doubling back",o.for=i.id;let s=document.createElement("div");s.appendChild(i),s.appendChild(o),this.controlDiv.append(s);const a=document.createElement("ul");a.innerHTML="<li><b>Click</b> green points on the transport network</br>to create snapped routes</li><li>Hold <b>Shift</b> to draw a point anywhere</li><li><b>Click and drag</b> any point to move it</li><li><b>Click</b> a red waypoint to delete it</li><li>Press <b>Enter</b> to finish route</li>",this.controlDiv.appendChild(a)}}Rt=new WeakSet,Sn=function(){const e=this.inner.toFinalFeature();e?this.controlDiv.dispatchEvent(new CustomEvent("new-route",{detail:JSON.parse(e)})):this.controlDiv.dispatchEvent(new CustomEvent("no-new-route")),this.stop()},Re=new WeakSet,De=function(){this.loaded&&this.map.getSource("route-snapper").setData(JSON.parse(this.inner.renderGeojson()))};async function es(r,e){const t=await fetch(r),n=t.body.getReader(),i=t.headers.get("Content-Length");let o=0,s=[];for(;;){const{done:u,value:h}=await n.read();if(u)break;s.push(h),o+=h.length;const m=100*o/i;e.style=`background: linear-gradient(to right, red ${m}%, transparent 0);`}let a=new Uint8Array(o),l=0;for(let u of s)a.set(u,l),l+=u.length;return a}function ts(r){let e,t;return{c(){e=w("div"),t=w("div"),t.textContent="Route tool loading..."},m(n,i){S(n,e,i),b(e,t),r[8](t),r[9](e)},p:z,i:z,o:z,d(n){n&&x(e),r[8](null),r[9](null)}}}const nn="route";function ns(r,e,t){let n;te(r,Ie,d=>t(10,n=d));let{mode:i}=e,{changeMode:o}=e,{url:s}=e,{snapTool:a}=e,l,{routeSnapper:u}=e;function h(){u.isActive()||u.start()}function m(){u==null||u.stop()}Mn(async()=>{await Gr(),console.log(`Grabbing ${s}`);try{const d=await es(s,l);t(2,u=new Ko(n,d,a))}catch(d){console.log(`Route tool broke: ${d}`),t(0,a.innerHTML="Failed to load",a)}a.addEventListener("activate",()=>{o(nn)}),a.addEventListener("no-new-route",()=>{i==nn&&o("edit-attribute")}),a.addEventListener("new-route",d=>{if(i==nn){const v=d.detail;W.update(_=>(v.id=Vt(_),v.properties.intervention_type="route",_.features.push(v),_)),o("edit-attribute"),we.set(v.id)}})}),Pn(()=>{u==null||u.tearDown()});function p(d){ae[d?"unshift":"push"](()=>{l=d,t(1,l)})}function f(d){ae[d?"unshift":"push"](()=>{a=d,t(0,a)})}return r.$$set=d=>{"mode"in d&&t(3,i=d.mode),"changeMode"in d&&t(4,o=d.changeMode),"url"in d&&t(5,s=d.url),"snapTool"in d&&t(0,a=d.snapTool),"routeSnapper"in d&&t(2,u=d.routeSnapper)},[a,l,u,i,o,s,h,m,p,f]}class rs extends ne{constructor(e){super(),re(this,e,ns,ts,K,{mode:3,changeMode:4,url:5,snapTool:0,routeSnapper:2,start:6,stop:7})}get start(){return this.$$.ctx[6]}get stop(){return this.$$.ctx[7]}}function wr(r){let e;return{c(){e=w("p"),e.textContent="Click to add a new point"},m(t,n){S(t,e,n)},d(t){t&&x(e)}}}function is(r){let e,t=r[0]==xn&&wr();return{c(){t&&t.c(),e=He()},m(n,i){t&&t.m(n,i),S(n,e,i)},p(n,[i]){n[0]==xn?t||(t=wr(),t.c(),t.m(e.parentNode,e)):t&&(t.d(1),t=null)},i:z,o:z,d(n){t&&t.d(n),n&&x(e)}}}const xn="point";function os(r,e,t){let{mode:n}=e,{changeMode:i}=e,{pointTool:o}=e;function s(){o.start()}function a(){o.stop()}return o.addEventListener(l=>{n==xn&&(W.update(u=>(l.id=Vt(u),l.properties.intervention_type="other",u.features.push(l),u)),i("edit-attribute"),we.set(l.id))}),r.$$set=l=>{"mode"in l&&t(0,n=l.mode),"changeMode"in l&&t(1,i=l.changeMode),"pointTool"in l&&t(2,o=l.pointTool)},[n,i,o,s,a]}class ss extends ne{constructor(e){super(),re(this,e,os,is,K,{mode:0,changeMode:1,pointTool:2,start:3,stop:4})}get start(){return this.$$.ctx[3]}get stop(){return this.$$.ctx[4]}}function Sr(r){let e;return{c(){e=w("p"),e.innerHTML="Click the map to add a vertex, or click a vertex to delete it. Press <strong>Enter</strong> to finish. Drag a vertex or the polygon to move."},m(t,n){S(t,e,n)},d(t){t&&x(e)}}}function ls(r){let e,t=r[0]==En&&Sr();return{c(){t&&t.c(),e=He()},m(n,i){t&&t.m(n,i),S(n,e,i)},p(n,[i]){n[0]==En?t||(t=Sr(),t.c(),t.m(e.parentNode,e)):t&&(t.d(1),t=null)},i:z,o:z,d(n){t&&t.d(n),n&&x(e)}}}const En="polygon";function as(r,e,t){let{mode:n}=e,{changeMode:i}=e,{polygonTool:o}=e;function s(){o.startNew()}function a(){o.stop()}return o.addEventListener(l=>{n==En&&(W.update(u=>(l.id=Vt(u),l.properties.intervention_type="area",u.features.push(l),u)),i("edit-attribute"),we.set(l.id))}),r.$$set=l=>{"mode"in l&&t(0,n=l.mode),"changeMode"in l&&t(1,i=l.changeMode),"polygonTool"in l&&t(2,o=l.polygonTool)},[n,i,o,s,a]}class us extends ne{constructor(e){super(),re(this,e,as,ls,K,{mode:0,changeMode:1,polygonTool:2,start:3,stop:4})}get start(){return this.$$.ctx[3]}get stop(){return this.$$.ctx[4]}}function fs(r){var e=r[0],t=r[1],n=r[2],i=r[3],o=qe(r.slice(0,2),[n,t]),s=qe(r.slice(0,2),[e,i]);if(o>=s){var a=(t+i)/2;return[e,a-(n-e)/2,n,a+(n-e)/2]}else{var l=(e+n)/2;return[l-(i-t)/2,t,l+(i-t)/2,i]}}function cs(r,e){e===void 0&&(e={});var t=e.precision,n=e.coordinates,i=e.mutate;if(t=t==null||isNaN(t)?6:t,n=n==null||isNaN(n)?3:n,!r)throw new Error("<geojson> is required");if(typeof t!="number")throw new Error("<precision> must be a number");if(typeof n!="number")throw new Error("<coordinates> must be a number");(i===!1||i===void 0)&&(r=JSON.parse(JSON.stringify(r)));var o=Math.pow(10,t);return li(r,function(s){hs(s,o,n)}),r}function hs(r,e,t){r.length>t&&r.splice(t,r.length);for(var n=0;n<r.length;n++)r[n]=Math.round(r[n]*e)/e;return r}function ps(r,e){if(!r)throw new Error("line is required");if(!e)throw new Error("splitter is required");var t=dn(r),n=dn(e);if(t!=="LineString")throw new Error("line must be LineString");if(n==="FeatureCollection")throw new Error("splitter cannot be a FeatureCollection");if(n==="GeometryCollection")throw new Error("splitter cannot be a GeometryCollection");var i=cs(e,{precision:7});switch(n){case"Point":return kn(r,i);case"MultiPoint":return xr(r,i);case"LineString":case"MultiLineString":case"Polygon":case"MultiPolygon":return xr(r,Tr(r,i))}}function xr(r,e){var t=[],n=ft();return Nn(e,function(i){if(t.forEach(function(a,l){a.id=l}),!t.length)t=kn(r,i).features,t.forEach(function(a){a.bbox||(a.bbox=fs(ai(a)))}),n.load(Ue(t));else{var o=n.search(i);if(o.features.length){var s=Yr(i,o);t=t.filter(function(a){return a.id!==s.id}),n.remove(s),qt(kn(s,i),function(a){t.push(a),n.insert(a)})}}}),Ue(t)}function kn(r,e){var t=[],n=Ae(r)[0],i=Ae(r)[r.geometry.coordinates.length-1];if(rn(n,$e(e))||rn(i,$e(e)))return Ue([r]);var o=ft(),s=mn(r);o.load(s);var a=o.search(e);if(!a.features.length)return Ue([r]);var l=Yr(e,a),u=[n],h=ui(s,function(m,p,f){var d=Ae(p)[1],v=$e(e);return f===l.id?(m.push(v),t.push(ut(m)),rn(v,d)?[v]:[v,d]):(m.push(d),m)},u);return h.length>1&&t.push(ut(h)),Ue(t)}function Yr(r,e){if(!e.features.length)throw new Error("lines must contain features");if(e.features.length===1)return e.features[0];var t,n=1/0;return qt(e,function(i){var o=kt(i,r),s=o.properties.dist;s<n&&(t=i,n=s)}),t}function rn(r,e){return r[0]===e[0]&&r[1]===e[1]}function ds(r,e,t){var n=Ae(t);if(dn(t)!=="LineString")throw new Error("line must be a LineString");var i=kt(t,r),o=kt(t,e),s;i.properties.index<=o.properties.index?s=[i,o]:s=[o,i];for(var a=[s[0].geometry.coordinates],l=s[0].properties.index+1;l<s[1].properties.index+1;l++)a.push(n[l]);return a.push(s[1].geometry.coordinates),ut(a,t.properties)}function Er(r){let e;return{c(){e=w("p"),e.textContent="Click near a route to split it, or click on the map to cancel"},m(t,n){S(t,e,n)},d(t){t&&x(e)}}}function gs(r){let e,t=r[0]==$t&&Er();return{c(){t&&t.c(),e=He()},m(n,i){t&&t.m(n,i),S(n,e,i)},p(n,[i]){n[0]==$t?t||(t=Er(),t.c(),t.m(e.parentNode,e)):t&&(t.d(1),t=null)},i:z,o:z,d(n){t&&t.d(n),n&&x(e)}}}const $t="split-route",ms=10,vs=30;let on="split-route";function qr(){}function kr(r,e){return{type:"Feature",properties:{snapped:e},geometry:{type:"Point",coordinates:r}}}function ys(r,e,t){let n,i;te(r,Ie,p=>t(5,n=p)),te(r,W,p=>t(7,i=p));let{mode:o}=e,{changeMode:s}=e;function a(){t(4,l=null),u=null}let l=null,u=null;n.on("mousemove",p=>{if(o!=$t)return;t(4,l=kr(p.lngLat.toArray(),!1)),u=null;const f=[p.point.x-vs,p.point.y],d=n.unproject(p.point).distanceTo(n.unproject(f))/1e3;let v=[];for(let[_,R]of i.features.entries())if(R.geometry.type=="LineString"){let c=kt(R.geometry,l,{units:"kilometers"});c.properties.dist!=null&&c.properties.dist<=d&&v.push([_,c.geometry.coordinates,c.properties.dist])}v.sort((_,R)=>_[2]-R[2]),v.length>0&&(t(4,l=kr(v[0][1],!0)),u=v[0][0])}),n.on("click",()=>{if(o==$t)if(u==null)s("edit-attribute");else{let p=ps(i.features[u],l);if(p.features.length==2){let f=p.features[0],d=p.features[1];W.update(v=>(f.id=v.features[u].id,d.id=Vt(v),f.properties=JSON.parse(JSON.stringify(v.features[u].properties)),d.properties=JSON.parse(JSON.stringify(f.properties)),h(v.features[u],f,d,l),v.features.splice(u,1,f,d),v))}a()}}),ct(n,on,{type:"geojson",data:Be()}),ye(n,{id:"draw-split-route",source:on,...Ot("black",ms,["case",["==",["get","snapped"],!0],1,.5])});function h(p,f,d,v){f.properties.length_meters=Tt(f,{units:"kilometers"})*1e3,d.properties.length_meters=Tt(d,{units:"kilometers"})*1e3,f.properties.waypoints=[],d.properties.waypoints=[];let _=m(p,v),R=!0,c=0;for(let g of p.properties.waypoints){let y=m(p,at([g.lon,g.lat]));if(R)if(y<_)f.properties.waypoints.push(g);else{let M=g.snapped&&p.properties.waypoints[c-1].snapped;f.properties.waypoints.push({lon:v.geometry.coordinates[0],lat:v.geometry.coordinates[1],snapped:M}),R=!1,d.properties.waypoints.push({lon:v.geometry.coordinates[0],lat:v.geometry.coordinates[1],snapped:M}),d.properties.waypoints.push(g)}else d.properties.waypoints.push(g);c++}}function m(p,f){let d=p.geometry.coordinates[0],v=ds(d,f,p);return Tt(v,{units:"kilometers"})*1e3}return r.$$set=p=>{"mode"in p&&t(0,o=p.mode),"changeMode"in p&&t(1,s=p.changeMode)},r.$$.update=()=>{if(r.$$.dirty&48){let p=Be();l&&p.features.push(l),n.getSource(on).setData(p)}},[o,s,qr,a,l,n]}class _s extends ne{constructor(e){super(),re(this,e,ys,gs,K,{mode:0,changeMode:1,start:2,stop:3})}get start(){return qr}get stop(){return this.$$.ctx[3]}}function Mr(r){let e,t,n={mode:r[3],routeSnapper:r[1],snapTool:r[2],pointTool:r[10],polygonTool:r[11]};return e=new zo({props:n}),r[16](e),{c(){V(e.$$.fragment)},m(i,o){Q(e,i,o),t=!0},p(i,o){const s={};o&8&&(s.mode=i[3]),o&2&&(s.routeSnapper=i[1]),o&4&&(s.snapTool=i[2]),e.$set(s)},i(i){t||(q(e.$$.fragment,i),t=!0)},o(i){X(e.$$.fragment,i),t=!1},d(i){r[16](null),Z(e,i)}}}function bs(r){let e,t,n,i,o,s,a,l,u,h,m,p,f,d,v,_,R,c,g,y,M,L,k,E,N,F,T,D,I,P,U,pe,_e,ce,ie,xe,de,oe,be,ve,Ce,Ee,Ve={mode:r[3],changeMode:r[12]};a=new jo({props:Ve}),r[14](a);let ee=r[1]&&r[2]&&Mr(r),Qe={mode:r[3],changeMode:r[12],pointTool:r[10]};y=new ss({props:Qe}),r[18](y);let dt={mode:r[3],changeMode:r[12],polygonTool:r[11]};T=new us({props:dt}),r[20](T);function At(Y){r[22](Y)}function fe(Y){r[23](Y)}let O={mode:r[3],changeMode:r[12],url:r[0]};r[1]!==void 0&&(O.routeSnapper=r[1]),r[2]!==void 0&&(O.snapTool=r[2]),P=new rs({props:O}),r[21](P),ae.push(()=>Je(P,"routeSnapper",At,r[1])),ae.push(()=>Je(P,"snapTool",fe,r[2]));let G={mode:r[3],changeMode:r[12]};return be=new _s({props:G}),r[25](be),{c(){e=w("div"),t=w("div"),n=w("button"),i=$("Edit attributes"),s=C(),V(a.$$.fragment),l=C(),u=w("div"),h=w("button"),m=$("Edit geometry"),f=C(),ee&&ee.c(),d=C(),v=w("div"),_=w("button"),R=$("New point"),g=C(),V(y.$$.fragment),M=C(),L=w("div"),k=w("button"),E=$("New polygon"),F=C(),V(T.$$.fragment),D=C(),I=w("div"),V(P.$$.fragment),_e=C(),ce=w("div"),ie=w("button"),xe=$("Split route"),oe=C(),V(be.$$.fragment),A(n,"type","button"),n.disabled=o=r[3]=="edit-attribute",A(n,"class","svelte-cej5os"),A(h,"type","button"),h.disabled=p=r[3]=="edit-geometry",A(h,"class","svelte-cej5os"),A(_,"type","button"),_.disabled=c=r[3]=="point",A(_,"class","svelte-cej5os"),A(k,"type","button"),k.disabled=N=r[3]=="polygon",A(k,"class","svelte-cej5os"),A(ie,"type","button"),ie.disabled=de=r[3]=="split-route",A(ie,"class","svelte-cej5os"),A(e,"class","toolbox svelte-cej5os")},m(Y,ue){S(Y,e,ue),b(e,t),b(t,n),b(n,i),b(t,s),Q(a,t,null),b(e,l),b(e,u),b(u,h),b(h,m),b(u,f),ee&&ee.m(u,null),b(e,d),b(e,v),b(v,_),b(_,R),b(v,g),Q(y,v,null),b(e,M),b(e,L),b(L,k),b(k,E),b(L,F),Q(T,L,null),b(e,D),b(e,I),Q(P,I,null),b(e,_e),b(e,ce),b(ce,ie),b(ie,xe),b(ce,oe),Q(be,ce,null),ve=!0,Ce||(Ee=[J(n,"click",r[13]),J(h,"click",r[15]),J(_,"click",r[17]),J(k,"click",r[19]),J(ie,"click",r[24])],Ce=!0)},p(Y,[ue]){(!ve||ue&8&&o!==(o=Y[3]=="edit-attribute"))&&(n.disabled=o);const Bn={};ue&8&&(Bn.mode=Y[3]),a.$set(Bn),(!ve||ue&8&&p!==(p=Y[3]=="edit-geometry"))&&(h.disabled=p),Y[1]&&Y[2]?ee?(ee.p(Y,ue),ue&6&&q(ee,1)):(ee=Mr(Y),ee.c(),q(ee,1),ee.m(u,null)):ee&&(Wt(),X(ee,1,1,()=>{ee=null}),Ht()),(!ve||ue&8&&c!==(c=Y[3]=="point"))&&(_.disabled=c);const Dn={};ue&8&&(Dn.mode=Y[3]),y.$set(Dn),(!ve||ue&8&&N!==(N=Y[3]=="polygon"))&&(k.disabled=N);const Gn={};ue&8&&(Gn.mode=Y[3]),T.$set(Gn);const gt={};ue&8&&(gt.mode=Y[3]),ue&1&&(gt.url=Y[0]),!U&&ue&2&&(U=!0,gt.routeSnapper=Y[1],ze(()=>U=!1)),!pe&&ue&4&&(pe=!0,gt.snapTool=Y[2],ze(()=>pe=!1)),P.$set(gt),(!ve||ue&8&&de!==(de=Y[3]=="split-route"))&&(ie.disabled=de);const Yn={};ue&8&&(Yn.mode=Y[3]),be.$set(Yn)},i(Y){ve||(q(a.$$.fragment,Y),q(ee),q(y.$$.fragment,Y),q(T.$$.fragment,Y),q(P.$$.fragment,Y),q(be.$$.fragment,Y),ve=!0)},o(Y){X(a.$$.fragment,Y),X(ee),X(y.$$.fragment,Y),X(T.$$.fragment,Y),X(P.$$.fragment,Y),X(be.$$.fragment,Y),ve=!1},d(Y){Y&&x(e),r[14](null),Z(a),ee&&ee.d(),r[18](null),Z(y),r[20](null),Z(T),r[21](null),Z(P),r[25](null),Z(be),Ce=!1,ht(Ee)}}}function ws(r,e,t){let n;te(r,Ie,P=>t(26,n=P));let{routeUrl:i}=e,o,s,a=new Po(n),l=new Go(n),u="edit-attribute",h,m,p,f,d,v;function _(P){let U={"edit-attribute":h,"edit-geometry":m,route:p,point:f,polygon:d,"split-route":v};if(u==P){console.log(`Mode is already ${u}, not changing`);return}console.log(`Stopping old mode ${u}`),U[u].stop(),t(3,u=P),console.log(`Starting new mode ${u}`),U[u].start()}Pn(()=>{a==null||a.tearDown(),l==null||l.tearDown()});const R=()=>_("edit-attribute");function c(P){ae[P?"unshift":"push"](()=>{h=P,t(4,h)})}const g=()=>_("edit-geometry");function y(P){ae[P?"unshift":"push"](()=>{m=P,t(5,m)})}const M=()=>_("point");function L(P){ae[P?"unshift":"push"](()=>{f=P,t(7,f)})}const k=()=>_("polygon");function E(P){ae[P?"unshift":"push"](()=>{d=P,t(8,d)})}function N(P){ae[P?"unshift":"push"](()=>{p=P,t(6,p)})}function F(P){o=P,t(1,o)}function T(P){s=P,t(2,s)}const D=()=>_("split-route");function I(P){ae[P?"unshift":"push"](()=>{v=P,t(9,v)})}return r.$$set=P=>{"routeUrl"in P&&t(0,i=P.routeUrl)},[i,o,s,u,h,m,p,f,d,v,a,l,_,R,c,g,y,M,L,k,E,N,F,T,D,I]}class Ss extends ne{constructor(e){super(),re(this,e,ws,bs,K,{routeUrl:0})}}function xs(r){let e,t,n,i,o,s,a,l;return{c(){e=w("div"),t=w("button"),t.textContent="Home",n=C(),i=w("button"),i.textContent="About",o=C(),s=w("button"),s.textContent="Instructions",A(t,"type","button"),A(i,"type","button"),A(s,"type","button"),A(e,"slot","nav")},m(u,h){S(u,e,h),b(e,t),b(e,n),b(e,i),b(e,o),b(e,s),a||(l=[J(t,"click",r[8]),J(i,"click",r[6]),J(s,"click",r[7])],a=!0)},p:z,d(u){u&&x(e),a=!1,ht(l)}}}function Es(r){let e,t,n,i,o,s,a,l,u,h,m,p;return o=new vo({props:{boundaryGeojson:r[3]}}),a=new ho({props:{authorityName:r[4]}}),m=new ao({}),{c(){e=w("div"),t=w("h1"),n=$(r[4]),i=C(),V(o.$$.fragment),s=C(),V(a.$$.fragment),l=C(),u=w("br"),h=C(),V(m.$$.fragment),A(e,"slot","sidebar")},m(f,d){S(f,e,d),b(e,t),b(t,n),b(t,i),Q(o,t,null),b(e,s),Q(a,e,null),b(e,l),b(e,u),b(e,h),Q(m,e,null),p=!0},p(f,d){const v={};d&8&&(v.boundaryGeojson=f[3]),o.$set(v)},i(f){p||(q(o.$$.fragment,f),q(a.$$.fragment,f),q(m.$$.fragment,f),p=!0)},o(f){X(o.$$.fragment,f),X(a.$$.fragment,f),X(m.$$.fragment,f),p=!1},d(f){f&&x(e),Z(o),Z(a),Z(m)}}}function ks(r){let e,t,n,i,o,s,a,l,u,h,m,p;return e=new Qi({props:{boundaryGeojson:r[3]}}),n=new Eo({}),o=new Mo({}),a=new Ss({props:{routeUrl:r[2]}}),u=new bo({props:{style:r[5]}}),m=new So({}),{c(){V(e.$$.fragment),t=C(),V(n.$$.fragment),i=C(),V(o.$$.fragment),s=C(),V(a.$$.fragment),l=C(),V(u.$$.fragment),h=C(),V(m.$$.fragment)},m(f,d){Q(e,f,d),S(f,t,d),Q(n,f,d),S(f,i,d),Q(o,f,d),S(f,s,d),Q(a,f,d),S(f,l,d),Q(u,f,d),S(f,h,d),Q(m,f,d),p=!0},p(f,d){const v={};d&8&&(v.boundaryGeojson=f[3]),e.$set(v);const _={};d&4&&(_.routeUrl=f[2]),a.$set(_)},i(f){p||(q(e.$$.fragment,f),q(n.$$.fragment,f),q(o.$$.fragment,f),q(a.$$.fragment,f),q(u.$$.fragment,f),q(m.$$.fragment,f),p=!0)},o(f){X(e.$$.fragment,f),X(n.$$.fragment,f),X(o.$$.fragment,f),X(a.$$.fragment,f),X(u.$$.fragment,f),X(m.$$.fragment,f),p=!1},d(f){Z(e,f),f&&x(t),Z(n,f),f&&x(i),Z(o,f),f&&x(s),Z(a,f),f&&x(l),Z(u,f),f&&x(h),Z(m,f)}}}function Ms(r){let e,t,n;return t=new yi({props:{style:r[5],$$slots:{default:[ks]},$$scope:{ctx:r}}}),{c(){e=w("div"),V(t.$$.fragment),A(e,"slot","main")},m(i,o){S(i,e,o),Q(t,e,null),n=!0},p(i,o){const s={};o&16396&&(s.$$scope={dirty:o,ctx:i}),t.$set(s)},i(i){n||(q(t.$$.fragment,i),n=!0)},o(i){X(t.$$.fragment,i),n=!1},d(i){i&&x(e),Z(t)}}}function Ps(r){let e,t,n,i,o,s,a,l;e=new Ei({props:{$$slots:{main:[Ms],sidebar:[Es],nav:[xs]},$$scope:{ctx:r}}});function u(f){r[9](f)}let h={};r[0]!==void 0&&(h.open=r[0]),n=new fi({props:h}),ae.push(()=>Je(n,"open",u,r[0]));function m(f){r[10](f)}let p={};return r[1]!==void 0&&(p.open=r[1]),s=new gi({props:p}),ae.push(()=>Je(s,"open",m,r[1])),{c(){V(e.$$.fragment),t=C(),V(n.$$.fragment),o=C(),V(s.$$.fragment)},m(f,d){Q(e,f,d),S(f,t,d),Q(n,f,d),S(f,o,d),Q(s,f,d),l=!0},p(f,[d]){const v={};d&16396&&(v.$$scope={dirty:d,ctx:f}),e.$set(v);const _={};!i&&d&1&&(i=!0,_.open=f[0],ze(()=>i=!1)),n.$set(_);const R={};!a&&d&2&&(a=!0,R.open=f[1],ze(()=>a=!1)),s.$set(R)},i(f){l||(q(e.$$.fragment,f),q(n.$$.fragment,f),q(s.$$.fragment,f),l=!0)},o(f){X(e.$$.fragment,f),X(n.$$.fragment,f),X(s.$$.fragment,f),l=!1},d(f){Z(e,f),f&&x(t),Z(n,f),f&&x(o),Z(s,f)}}}function Ls(r,e,t){let n=!1,i=!1,o=window.location.hostname.includes("atip.uk");const s=new URLSearchParams(window.location.search);let a=s.get("authority"),l=s.get("style")||"streets";var u=`https://atip.uk/route-snappers/${a}.bin`;o||(u=`https://atip.uk/route-snappers-dev/${a}.bin`);function h(){t(0,n=!n),t(1,i=!1)}function m(){t(1,i=!i),t(0,n=!1)}let p;Mn(async()=>{t(3,p=await f())});async function f(){const c=await(await fetch(ci)).text(),g=JSON.parse(c);return g.features=g.features.filter(y=>y.properties.name==a),g}const d=()=>window.open("index.html");function v(R){n=R,t(0,n)}function _(R){i=R,t(1,i)}return[n,i,u,p,a,l,h,m,d,v,_]}class Rs extends ne{constructor(e){super(),re(this,e,Ls,Ps,K,{})}}new Rs({target:document.getElementById("app")});
