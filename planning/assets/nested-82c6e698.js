var fi=Object.defineProperty;var ci=(r,e,t)=>e in r?fi(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var oe=(r,e,t)=>(ci(r,typeof e!="symbol"?e+"":e,t),t);import{S as se,i as le,s as ie,M as pi,b as ve,a as it,d as Q,m as ee,k as ot,n as B,o as j,q as te,e as k,c as L,g as b,x as W,p as w,y as $e,f as A,z as qe,B as ze,C as hi,D as Bn,E as gn,F as Lt,G as Rt,H as Nt,I as It,J as Bt,K as Kn,h as S,l as Y,L as di,N as mi,O as ce,P as gi,w as Dn,Q as at,R as ke,T as Gn,t as V,U as ge,j as Oe,r as We,V as jn,W as wt,X as De,Y as Ur,Z as Ht,_ as Tt,$ as Vn,a0 as Ie,a1 as Zn,a2 as Qn,a3 as _i,a4 as vi,a5 as Re,a6 as yi,a7 as bi,a8 as wi,a9 as fn,aa as Pt,ab as cn,ac as qt,ad as $n,ae as kn,af as ki,ag as Et,ah as qn,ai as st,aj as xt,ak as Si,al as zn,am as Ei,an as xi,ao as Mi,ap as er,aq as tn,ar as Li,as as Pi,at as Ci,A as Oi,u as Ai}from"./authorities-6c4051a7.js";function Fi(r){let e,t,n,i,o,s,u,l,a,p,g,h,f;return{c(){e=k("p"),e.textContent="For each intervention:",t=L(),n=k("ol"),n.innerHTML=`<li>Click one of the draw icons to the top right of the map (the icons allow
      you to draw points, lines, polygons or routes)</li> 
    <li>Draw the intervention on the map, clicking the original point or &#39;Finish
      snapping&#39; for the Polygon and Route tools respectively</li> 
    <li>Fill in the details that appear (Intervention type, name, description)</li> 
    <li>Click the &quot;Save&quot; button or &quot;Delete&quot; button to save or remove the
      intervention</li>`,i=L(),o=k("p"),o.textContent=`Repeat the steps above for each substantial infrastructure intervention in
    the scheme.`,s=L(),u=k("p"),u.textContent=`To make further edits to attribute data, or to delete an intervention, click
    on its name in the left hand panel or its geometry in the map.`,l=L(),a=k("p"),a.textContent=`Click the "Export to GeoJSON" button to download the dataset representing
    the scheme, which can be made up of one or more intervention, as a GeoJSON
    file. After saving the file, you can delete the interventions, change the
    scheme name, and start a new set of interventions representing a new scheme.`,p=L(),g=k("p"),g.textContent=`To load a GeoJSON file that you have already saved from the tool, click the
    "Load from GeoJSON" button and select the file.`,h=L(),f=k("p"),f.innerHTML=`Note: the <strong>Route tool</strong> works by calculating routes between
    start and end points using the existing transport network according to
    OpenStreetMap. Use it by clicking on the location where you would like the
    route to start and then clicking on the location where you would like the
    route to end on the map. The route will be calculated and drawn on the map.
    After you click &quot;Finish snapping&quot; you can edit the route by dragging
    individual points. This can be useful for representing links that are not
    part of the existing transport network, such as a new bridge or path.
    However,
    <strong>you cannot add or remove points</strong> with the Route tool. If the
    planned route intervention you would like to sketch as part of a scheme contains
    one or more new links (for example containing new bridges or paths between cul-de-sacs),
    you may want to use the Line tool instead.`},m(m,_){b(m,e,_),b(m,t,_),b(m,n,_),b(m,i,_),b(m,o,_),b(m,s,_),b(m,u,_),b(m,l,_),b(m,a,_),b(m,p,_),b(m,g,_),b(m,h,_),b(m,f,_)},p:W,d(m){m&&w(e),m&&w(t),m&&w(n),m&&w(i),m&&w(o),m&&w(s),m&&w(u),m&&w(l),m&&w(a),m&&w(p),m&&w(g),m&&w(h),m&&w(f)}}}function Ti(r){let e,t,n;function i(s){r[1](s)}let o={title:"Instructions",$$slots:{default:[Fi]},$$scope:{ctx:r}};return r[0]!==void 0&&(o.open=r[0]),e=new pi({props:o}),ve.push(()=>it(e,"open",i,r[0])),{c(){Q(e.$$.fragment)},m(s,u){ee(e,s,u),n=!0},p(s,[u]){const l={};u&4&&(l.$$scope={dirty:u,ctx:s}),!t&&u&1&&(t=!0,l.open=s[0],ot(()=>t=!1)),e.$set(l)},i(s){n||(B(e.$$.fragment,s),n=!0)},o(s){j(e.$$.fragment,s),n=!1},d(s){te(e,s)}}}function Ri(r,e,t){let{open:n}=e;function i(o){n=o,t(0,n)}return r.$$set=o=>{"open"in o&&t(0,n=o.open)},[n,i]}class Ni extends se{constructor(e){super(),le(this,e,Ri,Ti,ie,{open:0})}}const gt=[];function Ct(r,e=W){let t;const n=new Set;function i(u){if(ie(r,u)&&(r=u,t)){const l=!gt.length;for(const a of n)a[1](),gt.push(a,r);if(l){for(let a=0;a<gt.length;a+=2)gt[a][0](gt[a+1]);gt.length=0}}}function o(u){i(u(r))}function s(u,l=W){const a=[u,l];return n.add(a),n.size===1&&(t=e(i)||W),u(r),()=>{n.delete(a),n.size===0&&(t(),t=null)}}return{set:i,update:o,subscribe:s}}const Ye=Ct(null),fe=Ct($e()),Ce=Ct(null),Je=Ct(null),nn=Ct(null),Sn=Ct(null);function pn(r){let e=new Set;for(let n of r.features)e.add(n.id);let t=e.size+1;for(;e.has(t);)t++;return t}function Yn(r){fe.update(e=>(e.features=e.features.filter(t=>t.id!=r),e)),Ce.set(null),Je.set(null),nn.set(null)}function tr(r){let e;const t=r[4].default,n=Rt(t,r,r[3],null);return{c(){n&&n.c()},m(i,o){n&&n.m(i,o),e=!0},p(i,o){n&&n.p&&(!e||o&8)&&Nt(n,t,i,i[3],e?Bt(t,i[3],o,null):It(i[3]),null)},i(i){e||(B(n,i),e=!0)},o(i){j(n,i),e=!1},d(i){n&&n.d(i)}}}function Ii(r){let e,t,n=r[1]&&tr(r);return{c(){e=k("div"),n&&n.c(),A(e,"class","map svelte-12dpf1u")},m(i,o){b(i,e,o),n&&n.m(e,null),r[5](e),t=!0},p(i,[o]){i[1]?n?(n.p(i,o),o&2&&B(n,1)):(n=tr(i),n.c(),B(n,1),n.m(e,null)):n&&(qe(),j(n,1,1,()=>{n=null}),ze())},i(i){t||(B(n),t=!0)},o(i){j(n),t=!1},d(i){i&&w(e),n&&n.d(),r[5](null)}}}function Bi(r,e,t){let{$$slots:n={},$$scope:i}=e,{style:o}=e,s,u,l=!1;hi("setCamera",!window.location.hash),Bn(()=>{s=new gn.Map({container:u,style:`https://api.maptiler.com/maps/${o}/style.json?key=MZEJTanw3WpxRvt7qDfo`,hash:!0}),s.addControl(new gn.ScaleControl({})),s.addControl(new gn.NavigationControl({visualizePitch:!0}),"bottom-right"),s.on("load",()=>{t(1,l=!0),Ye.set(s)}),new ResizeObserver(()=>{s.resize()}).observe(u)}),Lt(()=>{s.remove()});function a(p){ve[p?"unshift":"push"](()=>{u=p,t(0,u)})}return r.$$set=p=>{"style"in p&&t(2,o=p.style),"$$scope"in p&&t(3,i=p.$$scope)},[u,l,o,i,n,a]}class Di extends se{constructor(e){super(),le(this,e,Bi,Ii,ie,{style:2})}}const Gi=r=>({}),nr=r=>({}),ji=r=>({}),rr=r=>({}),$i=r=>({}),ir=r=>({});function qi(r){let e,t,n,i,o,s,u,l,a,p,g,h;const f=r[3].nav,m=Rt(f,r,r[2],ir),_=r[3].sidebar,v=Rt(_,r,r[2],rr),x=r[3].main,c=Rt(x,r,r[2],nr);return{c(){e=k("aside"),t=k("div"),n=k("nav"),m&&m.c(),i=L(),v&&v.c(),o=L(),s=k("button"),s.textContent="→",l=L(),a=k("main"),c&&c.c(),A(n,"class","svelte-1u7vg8a"),A(t,"class","sidebar-content content-container svelte-1u7vg8a"),A(s,"type","button"),A(s,"class","sidebar-toggle rounded-rect svelte-1u7vg8a"),A(e,"class",u=Kn(r[0]?"":"collapsed")+" svelte-1u7vg8a"),A(a,"class","svelte-1u7vg8a")},m(d,y){b(d,e,y),S(e,t),S(t,n),m&&m.m(n,null),S(t,i),v&&v.m(t,null),S(e,o),S(e,s),b(d,l,y),b(d,a,y),c&&c.m(a,null),p=!0,g||(h=Y(s,"click",r[1]),g=!0)},p(d,[y]){m&&m.p&&(!p||y&4)&&Nt(m,f,d,d[2],p?Bt(f,d[2],y,$i):It(d[2]),ir),v&&v.p&&(!p||y&4)&&Nt(v,_,d,d[2],p?Bt(_,d[2],y,ji):It(d[2]),rr),(!p||y&1&&u!==(u=Kn(d[0]?"":"collapsed")+" svelte-1u7vg8a"))&&A(e,"class",u),c&&c.p&&(!p||y&4)&&Nt(c,x,d,d[2],p?Bt(x,d[2],y,Gi):It(d[2]),nr)},i(d){p||(B(m,d),B(v,d),B(c,d),p=!0)},o(d){j(m,d),j(v,d),j(c,d),p=!1},d(d){d&&w(e),m&&m.d(d),v&&v.d(d),d&&w(l),d&&w(a),c&&c.d(d),g=!1,h()}}}function zi(r,e,t){let{$$slots:n={},$$scope:i}=e,o=!0;function s(){t(0,o=!o)}return r.$$set=u=>{"$$scope"in u&&t(2,i=u.$$scope)},[o,s,i,n]}class Yi extends se{constructor(e){super(),le(this,e,zi,qi,ie,{})}}/**
 * splaytree v3.1.1
 * Fast Splay tree for Node and browser
 *
 * @author Alexander Milevski <info@w8r.name>
 * @license MIT
 * @preserve
 *//*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */function Hi(r,e){var t={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},n,i,o,s;return s={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function u(a){return function(p){return l([a,p])}}function l(a){if(n)throw new TypeError("Generator is already executing.");for(;t;)try{if(n=1,i&&(o=a[0]&2?i.return:a[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,a[1])).done)return o;switch(i=0,o&&(a=[a[0]&2,o.value]),a[0]){case 0:case 1:o=a;break;case 4:return t.label++,{value:a[1],done:!1};case 5:t.label++,i=a[1],a=[0];continue;case 7:a=t.ops.pop(),t.trys.pop();continue;default:if(o=t.trys,!(o=o.length>0&&o[o.length-1])&&(a[0]===6||a[0]===2)){t=0;continue}if(a[0]===3&&(!o||a[1]>o[0]&&a[1]<o[3])){t.label=a[1];break}if(a[0]===6&&t.label<o[1]){t.label=o[1],o=a;break}if(o&&t.label<o[2]){t.label=o[2],t.ops.push(a);break}o[2]&&t.ops.pop(),t.trys.pop();continue}a=e.call(r,t)}catch(p){a=[6,p],i=0}finally{n=o=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}}var ut=function(){function r(e,t){this.next=null,this.key=e,this.data=t,this.left=null,this.right=null}return r}();function Xi(r,e){return r>e?1:r<e?-1:0}function et(r,e,t){for(var n=new ut(null,null),i=n,o=n;;){var s=t(r,e.key);if(s<0){if(e.left===null)break;if(t(r,e.left.key)<0){var u=e.left;if(e.left=u.right,u.right=e,e=u,e.left===null)break}o.left=e,o=e,e=e.left}else if(s>0){if(e.right===null)break;if(t(r,e.right.key)>0){var u=e.right;if(e.right=u.left,u.left=e,e=u,e.right===null)break}i.right=e,i=e,e=e.right}else break}return i.right=e.left,o.left=e.right,e.left=n.right,e.right=n.left,e}function _n(r,e,t,n){var i=new ut(r,e);if(t===null)return i.left=i.right=null,i;t=et(r,t,n);var o=n(r,t.key);return o<0?(i.left=t.left,i.right=t,t.left=null):o>=0&&(i.right=t.right,i.left=t,t.right=null),i}function or(r,e,t){var n=null,i=null;if(e){e=et(r,e,t);var o=t(e.key,r);o===0?(n=e.left,i=e.right):o<0?(i=e.right,e.right=null,n=e):(n=e.left,e.left=null,i=e)}return{left:n,right:i}}function Ui(r,e,t){return e===null?r:(r===null||(e=et(r.key,e,t),e.left=r),e)}function En(r,e,t,n,i){if(r){n(""+e+(t?"└── ":"├── ")+i(r)+`
`);var o=e+(t?"    ":"│   ");r.left&&En(r.left,o,!1,n,i),r.right&&En(r.right,o,!0,n,i)}}var Hn=function(){function r(e){e===void 0&&(e=Xi),this._root=null,this._size=0,this._comparator=e}return r.prototype.insert=function(e,t){return this._size++,this._root=_n(e,t,this._root,this._comparator)},r.prototype.add=function(e,t){var n=new ut(e,t);this._root===null&&(n.left=n.right=null,this._size++,this._root=n);var i=this._comparator,o=et(e,this._root,i),s=i(e,o.key);return s===0?this._root=o:(s<0?(n.left=o.left,n.right=o,o.left=null):s>0&&(n.right=o.right,n.left=o,o.right=null),this._size++,this._root=n),this._root},r.prototype.remove=function(e){this._root=this._remove(e,this._root,this._comparator)},r.prototype._remove=function(e,t,n){var i;if(t===null)return null;t=et(e,t,n);var o=n(e,t.key);return o===0?(t.left===null?i=t.right:(i=et(e,t.left,n),i.right=t.right),this._size--,i):t},r.prototype.pop=function(){var e=this._root;if(e){for(;e.left;)e=e.left;return this._root=et(e.key,this._root,this._comparator),this._root=this._remove(e.key,this._root,this._comparator),{key:e.key,data:e.data}}return null},r.prototype.findStatic=function(e){for(var t=this._root,n=this._comparator;t;){var i=n(e,t.key);if(i===0)return t;i<0?t=t.left:t=t.right}return null},r.prototype.find=function(e){return this._root&&(this._root=et(e,this._root,this._comparator),this._comparator(e,this._root.key)!==0)?null:this._root},r.prototype.contains=function(e){for(var t=this._root,n=this._comparator;t;){var i=n(e,t.key);if(i===0)return!0;i<0?t=t.left:t=t.right}return!1},r.prototype.forEach=function(e,t){for(var n=this._root,i=[],o=!1;!o;)n!==null?(i.push(n),n=n.left):i.length!==0?(n=i.pop(),e.call(t,n),n=n.right):o=!0;return this},r.prototype.range=function(e,t,n,i){for(var o=[],s=this._comparator,u=this._root,l;o.length!==0||u;)if(u)o.push(u),u=u.left;else{if(u=o.pop(),l=s(u.key,t),l>0)break;if(s(u.key,e)>=0&&n.call(i,u))return this;u=u.right}return this},r.prototype.keys=function(){var e=[];return this.forEach(function(t){var n=t.key;return e.push(n)}),e},r.prototype.values=function(){var e=[];return this.forEach(function(t){var n=t.data;return e.push(n)}),e},r.prototype.min=function(){return this._root?this.minNode(this._root).key:null},r.prototype.max=function(){return this._root?this.maxNode(this._root).key:null},r.prototype.minNode=function(e){if(e===void 0&&(e=this._root),e)for(;e.left;)e=e.left;return e},r.prototype.maxNode=function(e){if(e===void 0&&(e=this._root),e)for(;e.right;)e=e.right;return e},r.prototype.at=function(e){for(var t=this._root,n=!1,i=0,o=[];!n;)if(t)o.push(t),t=t.left;else if(o.length>0){if(t=o.pop(),i===e)return t;i++,t=t.right}else n=!0;return null},r.prototype.next=function(e){var t=this._root,n=null;if(e.right){for(n=e.right;n.left;)n=n.left;return n}for(var i=this._comparator;t;){var o=i(e.key,t.key);if(o===0)break;o<0?(n=t,t=t.left):t=t.right}return n},r.prototype.prev=function(e){var t=this._root,n=null;if(e.left!==null){for(n=e.left;n.right;)n=n.right;return n}for(var i=this._comparator;t;){var o=i(e.key,t.key);if(o===0)break;o<0?t=t.left:(n=t,t=t.right)}return n},r.prototype.clear=function(){return this._root=null,this._size=0,this},r.prototype.toList=function(){return Wi(this._root)},r.prototype.load=function(e,t,n){t===void 0&&(t=[]),n===void 0&&(n=!1);var i=e.length,o=this._comparator;if(n&&Ln(e,t,0,i-1,o),this._root===null)this._root=xn(e,t,0,i),this._size=i;else{var s=Ki(this.toList(),Ji(e,t),o);i=this._size+i,this._root=Mn({head:s},0,i)}return this},r.prototype.isEmpty=function(){return this._root===null},Object.defineProperty(r.prototype,"size",{get:function(){return this._size},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"root",{get:function(){return this._root},enumerable:!0,configurable:!0}),r.prototype.toString=function(e){e===void 0&&(e=function(n){return String(n.key)});var t=[];return En(this._root,"",!0,function(n){return t.push(n)},e),t.join("")},r.prototype.update=function(e,t,n){var i=this._comparator,o=or(e,this._root,i),s=o.left,u=o.right;i(e,t)<0?u=_n(t,n,u,i):s=_n(t,n,s,i),this._root=Ui(s,u,i)},r.prototype.split=function(e){return or(e,this._root,this._comparator)},r.prototype[Symbol.iterator]=function(){var e;return Hi(this,function(t){switch(t.label){case 0:e=this.minNode(),t.label=1;case 1:return e?[4,e]:[3,3];case 2:return t.sent(),e=this.next(e),[3,1];case 3:return[2]}})},r}();function xn(r,e,t,n){var i=n-t;if(i>0){var o=t+Math.floor(i/2),s=r[o],u=e[o],l=new ut(s,u);return l.left=xn(r,e,t,o),l.right=xn(r,e,o+1,n),l}return null}function Ji(r,e){for(var t=new ut(null,null),n=t,i=0;i<r.length;i++)n=n.next=new ut(r[i],e[i]);return n.next=null,t.next}function Wi(r){for(var e=r,t=[],n=!1,i=new ut(null,null),o=i;!n;)e?(t.push(e),e=e.left):t.length>0?(e=o=o.next=t.pop(),e=e.right):n=!0;return o.next=null,i.next}function Mn(r,e,t){var n=t-e;if(n>0){var i=e+Math.floor(n/2),o=Mn(r,e,i),s=r.head;return s.left=o,r.head=r.head.next,s.right=Mn(r,i+1,t),s}return null}function Ki(r,e,t){for(var n=new ut(null,null),i=n,o=r,s=e;o!==null&&s!==null;)t(o.key,s.key)<0?(i.next=o,o=o.next):(i.next=s,s=s.next),i=i.next;return o!==null?i.next=o:s!==null&&(i.next=s),n.next}function Ln(r,e,t,n,i){if(!(t>=n)){for(var o=r[t+n>>1],s=t-1,u=n+1;;){do s++;while(i(r[s],o)<0);do u--;while(i(r[u],o)>0);if(s>=u)break;var l=r[s];r[s]=r[u],r[u]=l,l=e[s],e[s]=e[u],e[u]=l}Ln(r,e,t,u,i),Ln(r,e,u+1,n,i)}}function Ae(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function sr(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}function Se(r,e,t){return e&&sr(r.prototype,e),t&&sr(r,t),r}var Ft=function(e,t){return e.ll.x<=t.x&&t.x<=e.ur.x&&e.ll.y<=t.y&&t.y<=e.ur.y},Pn=function(e,t){if(t.ur.x<e.ll.x||e.ur.x<t.ll.x||t.ur.y<e.ll.y||e.ur.y<t.ll.y)return null;var n=e.ll.x<t.ll.x?t.ll.x:e.ll.x,i=e.ur.x<t.ur.x?e.ur.x:t.ur.x,o=e.ll.y<t.ll.y?t.ll.y:e.ll.y,s=e.ur.y<t.ur.y?e.ur.y:t.ur.y;return{ll:{x:n,y:o},ur:{x:i,y:s}}},nt=Number.EPSILON;nt===void 0&&(nt=Math.pow(2,-52));var Vi=nt*nt,Cn=function(e,t){if(-nt<e&&e<nt&&-nt<t&&t<nt)return 0;var n=e-t;return n*n<Vi*e*t?0:e<t?-1:1},Zi=function(){function r(){Ae(this,r),this.reset()}return Se(r,[{key:"reset",value:function(){this.xRounder=new lr,this.yRounder=new lr}},{key:"round",value:function(t,n){return{x:this.xRounder.round(t),y:this.yRounder.round(n)}}}]),r}(),lr=function(){function r(){Ae(this,r),this.tree=new Hn,this.round(0)}return Se(r,[{key:"round",value:function(t){var n=this.tree.add(t),i=this.tree.prev(n);if(i!==null&&Cn(n.key,i.key)===0)return this.tree.remove(t),i.key;var o=this.tree.next(n);return o!==null&&Cn(n.key,o.key)===0?(this.tree.remove(t),o.key):t}}]),r}(),zt=new Zi,Dt=function(e,t){return e.x*t.y-e.y*t.x},Jr=function(e,t){return e.x*t.x+e.y*t.y},ur=function(e,t,n){var i={x:t.x-e.x,y:t.y-e.y},o={x:n.x-e.x,y:n.y-e.y},s=Dt(i,o);return Cn(s,0)},rn=function(e){return Math.sqrt(Jr(e,e))},Qi=function(e,t,n){var i={x:t.x-e.x,y:t.y-e.y},o={x:n.x-e.x,y:n.y-e.y};return Dt(o,i)/rn(o)/rn(i)},eo=function(e,t,n){var i={x:t.x-e.x,y:t.y-e.y},o={x:n.x-e.x,y:n.y-e.y};return Jr(o,i)/rn(o)/rn(i)},ar=function(e,t,n){return t.y===0?null:{x:e.x+t.x/t.y*(n-e.y),y:n}},fr=function(e,t,n){return t.x===0?null:{x:n,y:e.y+t.y/t.x*(n-e.x)}},to=function(e,t,n,i){if(t.x===0)return fr(n,i,e.x);if(i.x===0)return fr(e,t,n.x);if(t.y===0)return ar(n,i,e.y);if(i.y===0)return ar(e,t,n.y);var o=Dt(t,i);if(o==0)return null;var s={x:n.x-e.x,y:n.y-e.y},u=Dt(s,t)/o,l=Dt(s,i)/o,a=e.x+l*t.x,p=n.x+u*i.x,g=e.y+l*t.y,h=n.y+u*i.y,f=(a+p)/2,m=(g+h)/2;return{x:f,y:m}},Ge=function(){Se(r,null,[{key:"compare",value:function(t,n){var i=r.comparePoints(t.point,n.point);return i!==0?i:(t.point!==n.point&&t.link(n),t.isLeft!==n.isLeft?t.isLeft?1:-1:on.compare(t.segment,n.segment))}},{key:"comparePoints",value:function(t,n){return t.x<n.x?-1:t.x>n.x?1:t.y<n.y?-1:t.y>n.y?1:0}}]);function r(e,t){Ae(this,r),e.events===void 0?e.events=[this]:e.events.push(this),this.point=e,this.isLeft=t}return Se(r,[{key:"link",value:function(t){if(t.point===this.point)throw new Error("Tried to link already linked events");for(var n=t.point.events,i=0,o=n.length;i<o;i++){var s=n[i];this.point.events.push(s),s.point=this.point}this.checkForConsuming()}},{key:"checkForConsuming",value:function(){for(var t=this.point.events.length,n=0;n<t;n++){var i=this.point.events[n];if(i.segment.consumedBy===void 0)for(var o=n+1;o<t;o++){var s=this.point.events[o];s.consumedBy===void 0&&i.otherSE.point.events===s.otherSE.point.events&&i.segment.consume(s.segment)}}}},{key:"getAvailableLinkedEvents",value:function(){for(var t=[],n=0,i=this.point.events.length;n<i;n++){var o=this.point.events[n];o!==this&&!o.segment.ringOut&&o.segment.isInResult()&&t.push(o)}return t}},{key:"getLeftmostComparator",value:function(t){var n=this,i=new Map,o=function(u){var l=u.otherSE;i.set(u,{sine:Qi(n.point,t.point,l.point),cosine:eo(n.point,t.point,l.point)})};return function(s,u){i.has(s)||o(s),i.has(u)||o(u);var l=i.get(s),a=l.sine,p=l.cosine,g=i.get(u),h=g.sine,f=g.cosine;return a>=0&&h>=0?p<f?1:p>f?-1:0:a<0&&h<0?p<f?-1:p>f?1:0:h<a?-1:h>a?1:0}}}]),r}(),no=0,on=function(){Se(r,null,[{key:"compare",value:function(t,n){var i=t.leftSE.point.x,o=n.leftSE.point.x,s=t.rightSE.point.x,u=n.rightSE.point.x;if(u<i)return 1;if(s<o)return-1;var l=t.leftSE.point.y,a=n.leftSE.point.y,p=t.rightSE.point.y,g=n.rightSE.point.y;if(i<o){if(a<l&&a<p)return 1;if(a>l&&a>p)return-1;var h=t.comparePoint(n.leftSE.point);if(h<0)return 1;if(h>0)return-1;var f=n.comparePoint(t.rightSE.point);return f!==0?f:-1}if(i>o){if(l<a&&l<g)return-1;if(l>a&&l>g)return 1;var m=n.comparePoint(t.leftSE.point);if(m!==0)return m;var _=t.comparePoint(n.rightSE.point);return _<0?1:_>0?-1:1}if(l<a)return-1;if(l>a)return 1;if(s<u){var v=n.comparePoint(t.rightSE.point);if(v!==0)return v}if(s>u){var x=t.comparePoint(n.rightSE.point);if(x<0)return 1;if(x>0)return-1}if(s!==u){var c=p-l,d=s-i,y=g-a,P=u-o;if(c>d&&y<P)return 1;if(c<d&&y>P)return-1}return s>u?1:s<u||p<g?-1:p>g?1:t.id<n.id?-1:t.id>n.id?1:0}}]);function r(e,t,n,i){Ae(this,r),this.id=++no,this.leftSE=e,e.segment=this,e.otherSE=t,this.rightSE=t,t.segment=this,t.otherSE=e,this.rings=n,this.windings=i}return Se(r,[{key:"replaceRightSE",value:function(t){this.rightSE=t,this.rightSE.segment=this,this.rightSE.otherSE=this.leftSE,this.leftSE.otherSE=this.rightSE}},{key:"bbox",value:function(){var t=this.leftSE.point.y,n=this.rightSE.point.y;return{ll:{x:this.leftSE.point.x,y:t<n?t:n},ur:{x:this.rightSE.point.x,y:t>n?t:n}}}},{key:"vector",value:function(){return{x:this.rightSE.point.x-this.leftSE.point.x,y:this.rightSE.point.y-this.leftSE.point.y}}},{key:"isAnEndpoint",value:function(t){return t.x===this.leftSE.point.x&&t.y===this.leftSE.point.y||t.x===this.rightSE.point.x&&t.y===this.rightSE.point.y}},{key:"comparePoint",value:function(t){if(this.isAnEndpoint(t))return 0;var n=this.leftSE.point,i=this.rightSE.point,o=this.vector();if(n.x===i.x)return t.x===n.x?0:t.x<n.x?1:-1;var s=(t.y-n.y)/o.y,u=n.x+s*o.x;if(t.x===u)return 0;var l=(t.x-n.x)/o.x,a=n.y+l*o.y;return t.y===a?0:t.y<a?-1:1}},{key:"getIntersection",value:function(t){var n=this.bbox(),i=t.bbox(),o=Pn(n,i);if(o===null)return null;var s=this.leftSE.point,u=this.rightSE.point,l=t.leftSE.point,a=t.rightSE.point,p=Ft(n,l)&&this.comparePoint(l)===0,g=Ft(i,s)&&t.comparePoint(s)===0,h=Ft(n,a)&&this.comparePoint(a)===0,f=Ft(i,u)&&t.comparePoint(u)===0;if(g&&p)return f&&!h?u:!f&&h?a:null;if(g)return h&&s.x===a.x&&s.y===a.y?null:s;if(p)return f&&u.x===l.x&&u.y===l.y?null:l;if(f&&h)return null;if(f)return u;if(h)return a;var m=to(s,this.vector(),l,t.vector());return m===null||!Ft(o,m)?null:zt.round(m.x,m.y)}},{key:"split",value:function(t){var n=[],i=t.events!==void 0,o=new Ge(t,!0),s=new Ge(t,!1),u=this.rightSE;this.replaceRightSE(s),n.push(s),n.push(o);var l=new r(o,u,this.rings.slice(),this.windings.slice());return Ge.comparePoints(l.leftSE.point,l.rightSE.point)>0&&l.swapEvents(),Ge.comparePoints(this.leftSE.point,this.rightSE.point)>0&&this.swapEvents(),i&&(o.checkForConsuming(),s.checkForConsuming()),n}},{key:"swapEvents",value:function(){var t=this.rightSE;this.rightSE=this.leftSE,this.leftSE=t,this.leftSE.isLeft=!0,this.rightSE.isLeft=!1;for(var n=0,i=this.windings.length;n<i;n++)this.windings[n]*=-1}},{key:"consume",value:function(t){for(var n=this,i=t;n.consumedBy;)n=n.consumedBy;for(;i.consumedBy;)i=i.consumedBy;var o=r.compare(n,i);if(o!==0){if(o>0){var s=n;n=i,i=s}if(n.prev===i){var u=n;n=i,i=u}for(var l=0,a=i.rings.length;l<a;l++){var p=i.rings[l],g=i.windings[l],h=n.rings.indexOf(p);h===-1?(n.rings.push(p),n.windings.push(g)):n.windings[h]+=g}i.rings=null,i.windings=null,i.consumedBy=n,i.leftSE.consumedBy=n.leftSE,i.rightSE.consumedBy=n.rightSE}}},{key:"prevInResult",value:function(){return this._prevInResult!==void 0?this._prevInResult:(this.prev?this.prev.isInResult()?this._prevInResult=this.prev:this._prevInResult=this.prev.prevInResult():this._prevInResult=null,this._prevInResult)}},{key:"beforeState",value:function(){if(this._beforeState!==void 0)return this._beforeState;if(!this.prev)this._beforeState={rings:[],windings:[],multiPolys:[]};else{var t=this.prev.consumedBy||this.prev;this._beforeState=t.afterState()}return this._beforeState}},{key:"afterState",value:function(){if(this._afterState!==void 0)return this._afterState;var t=this.beforeState();this._afterState={rings:t.rings.slice(0),windings:t.windings.slice(0),multiPolys:[]};for(var n=this._afterState.rings,i=this._afterState.windings,o=this._afterState.multiPolys,s=0,u=this.rings.length;s<u;s++){var l=this.rings[s],a=this.windings[s],p=n.indexOf(l);p===-1?(n.push(l),i.push(a)):i[p]+=a}for(var g=[],h=[],f=0,m=n.length;f<m;f++)if(i[f]!==0){var _=n[f],v=_.poly;if(h.indexOf(v)===-1)if(_.isExterior)g.push(v);else{h.indexOf(v)===-1&&h.push(v);var x=g.indexOf(_.poly);x!==-1&&g.splice(x,1)}}for(var c=0,d=g.length;c<d;c++){var y=g[c].multiPoly;o.indexOf(y)===-1&&o.push(y)}return this._afterState}},{key:"isInResult",value:function(){if(this.consumedBy)return!1;if(this._isInResult!==void 0)return this._isInResult;var t=this.beforeState().multiPolys,n=this.afterState().multiPolys;switch(Ne.type){case"union":{var i=t.length===0,o=n.length===0;this._isInResult=i!==o;break}case"intersection":{var s,u;t.length<n.length?(s=t.length,u=n.length):(s=n.length,u=t.length),this._isInResult=u===Ne.numMultiPolys&&s<u;break}case"xor":{var l=Math.abs(t.length-n.length);this._isInResult=l%2===1;break}case"difference":{var a=function(g){return g.length===1&&g[0].isSubject};this._isInResult=a(t)!==a(n);break}default:throw new Error("Unrecognized operation type found ".concat(Ne.type))}return this._isInResult}}],[{key:"fromRing",value:function(t,n,i){var o,s,u,l=Ge.comparePoints(t,n);if(l<0)o=t,s=n,u=1;else if(l>0)o=n,s=t,u=-1;else throw new Error("Tried to create degenerate segment at [".concat(t.x,", ").concat(t.y,"]"));var a=new Ge(o,!0),p=new Ge(s,!1);return new r(a,p,[i],[u])}}]),r}(),cr=function(){function r(e,t,n){if(Ae(this,r),!Array.isArray(e)||e.length===0)throw new Error("Input geometry is not a valid Polygon or MultiPolygon");if(this.poly=t,this.isExterior=n,this.segments=[],typeof e[0][0]!="number"||typeof e[0][1]!="number")throw new Error("Input geometry is not a valid Polygon or MultiPolygon");var i=zt.round(e[0][0],e[0][1]);this.bbox={ll:{x:i.x,y:i.y},ur:{x:i.x,y:i.y}};for(var o=i,s=1,u=e.length;s<u;s++){if(typeof e[s][0]!="number"||typeof e[s][1]!="number")throw new Error("Input geometry is not a valid Polygon or MultiPolygon");var l=zt.round(e[s][0],e[s][1]);l.x===o.x&&l.y===o.y||(this.segments.push(on.fromRing(o,l,this)),l.x<this.bbox.ll.x&&(this.bbox.ll.x=l.x),l.y<this.bbox.ll.y&&(this.bbox.ll.y=l.y),l.x>this.bbox.ur.x&&(this.bbox.ur.x=l.x),l.y>this.bbox.ur.y&&(this.bbox.ur.y=l.y),o=l)}(i.x!==o.x||i.y!==o.y)&&this.segments.push(on.fromRing(o,i,this))}return Se(r,[{key:"getSweepEvents",value:function(){for(var t=[],n=0,i=this.segments.length;n<i;n++){var o=this.segments[n];t.push(o.leftSE),t.push(o.rightSE)}return t}}]),r}(),ro=function(){function r(e,t){if(Ae(this,r),!Array.isArray(e))throw new Error("Input geometry is not a valid Polygon or MultiPolygon");this.exteriorRing=new cr(e[0],this,!0),this.bbox={ll:{x:this.exteriorRing.bbox.ll.x,y:this.exteriorRing.bbox.ll.y},ur:{x:this.exteriorRing.bbox.ur.x,y:this.exteriorRing.bbox.ur.y}},this.interiorRings=[];for(var n=1,i=e.length;n<i;n++){var o=new cr(e[n],this,!1);o.bbox.ll.x<this.bbox.ll.x&&(this.bbox.ll.x=o.bbox.ll.x),o.bbox.ll.y<this.bbox.ll.y&&(this.bbox.ll.y=o.bbox.ll.y),o.bbox.ur.x>this.bbox.ur.x&&(this.bbox.ur.x=o.bbox.ur.x),o.bbox.ur.y>this.bbox.ur.y&&(this.bbox.ur.y=o.bbox.ur.y),this.interiorRings.push(o)}this.multiPoly=t}return Se(r,[{key:"getSweepEvents",value:function(){for(var t=this.exteriorRing.getSweepEvents(),n=0,i=this.interiorRings.length;n<i;n++)for(var o=this.interiorRings[n].getSweepEvents(),s=0,u=o.length;s<u;s++)t.push(o[s]);return t}}]),r}(),pr=function(){function r(e,t){if(Ae(this,r),!Array.isArray(e))throw new Error("Input geometry is not a valid Polygon or MultiPolygon");try{typeof e[0][0][0]=="number"&&(e=[e])}catch{}this.polys=[],this.bbox={ll:{x:Number.POSITIVE_INFINITY,y:Number.POSITIVE_INFINITY},ur:{x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY}};for(var n=0,i=e.length;n<i;n++){var o=new ro(e[n],this);o.bbox.ll.x<this.bbox.ll.x&&(this.bbox.ll.x=o.bbox.ll.x),o.bbox.ll.y<this.bbox.ll.y&&(this.bbox.ll.y=o.bbox.ll.y),o.bbox.ur.x>this.bbox.ur.x&&(this.bbox.ur.x=o.bbox.ur.x),o.bbox.ur.y>this.bbox.ur.y&&(this.bbox.ur.y=o.bbox.ur.y),this.polys.push(o)}this.isSubject=t}return Se(r,[{key:"getSweepEvents",value:function(){for(var t=[],n=0,i=this.polys.length;n<i;n++)for(var o=this.polys[n].getSweepEvents(),s=0,u=o.length;s<u;s++)t.push(o[s]);return t}}]),r}(),io=function(){Se(r,null,[{key:"factory",value:function(t){for(var n=[],i=0,o=t.length;i<o;i++){var s=t[i];if(!(!s.isInResult()||s.ringOut)){for(var u=null,l=s.leftSE,a=s.rightSE,p=[l],g=l.point,h=[];u=l,l=a,p.push(l),l.point!==g;)for(;;){var f=l.getAvailableLinkedEvents();if(f.length===0){var m=p[0].point,_=p[p.length-1].point;throw new Error("Unable to complete output ring starting at [".concat(m.x,",")+" ".concat(m.y,"]. Last matching segment found ends at")+" [".concat(_.x,", ").concat(_.y,"]."))}if(f.length===1){a=f[0].otherSE;break}for(var v=null,x=0,c=h.length;x<c;x++)if(h[x].point===l.point){v=x;break}if(v!==null){var d=h.splice(v)[0],y=p.splice(d.index);y.unshift(y[0].otherSE),n.push(new r(y.reverse()));continue}h.push({index:p.length,point:l.point});var P=l.getLeftmostComparator(u);a=f.sort(P)[0].otherSE;break}n.push(new r(p))}}return n}}]);function r(e){Ae(this,r),this.events=e;for(var t=0,n=e.length;t<n;t++)e[t].segment.ringOut=this;this.poly=null}return Se(r,[{key:"getGeom",value:function(){for(var t=this.events[0].point,n=[t],i=1,o=this.events.length-1;i<o;i++){var s=this.events[i].point,u=this.events[i+1].point;ur(s,t,u)!==0&&(n.push(s),t=s)}if(n.length===1)return null;var l=n[0],a=n[1];ur(l,t,a)===0&&n.shift(),n.push(n[0]);for(var p=this.isExteriorRing()?1:-1,g=this.isExteriorRing()?0:n.length-1,h=this.isExteriorRing()?n.length:-1,f=[],m=g;m!=h;m+=p)f.push([n[m].x,n[m].y]);return f}},{key:"isExteriorRing",value:function(){if(this._isExteriorRing===void 0){var t=this.enclosingRing();this._isExteriorRing=t?!t.isExteriorRing():!0}return this._isExteriorRing}},{key:"enclosingRing",value:function(){return this._enclosingRing===void 0&&(this._enclosingRing=this._calcEnclosingRing()),this._enclosingRing}},{key:"_calcEnclosingRing",value:function(){for(var t=this.events[0],n=1,i=this.events.length;n<i;n++){var o=this.events[n];Ge.compare(t,o)>0&&(t=o)}for(var s=t.segment.prevInResult(),u=s?s.prevInResult():null;;){if(!s)return null;if(!u)return s.ringOut;if(u.ringOut!==s.ringOut)return u.ringOut.enclosingRing()!==s.ringOut?s.ringOut:s.ringOut.enclosingRing();s=u.prevInResult(),u=s?s.prevInResult():null}}}]),r}(),hr=function(){function r(e){Ae(this,r),this.exteriorRing=e,e.poly=this,this.interiorRings=[]}return Se(r,[{key:"addInterior",value:function(t){this.interiorRings.push(t),t.poly=this}},{key:"getGeom",value:function(){var t=[this.exteriorRing.getGeom()];if(t[0]===null)return null;for(var n=0,i=this.interiorRings.length;n<i;n++){var o=this.interiorRings[n].getGeom();o!==null&&t.push(o)}return t}}]),r}(),oo=function(){function r(e){Ae(this,r),this.rings=e,this.polys=this._composePolys(e)}return Se(r,[{key:"getGeom",value:function(){for(var t=[],n=0,i=this.polys.length;n<i;n++){var o=this.polys[n].getGeom();o!==null&&t.push(o)}return t}},{key:"_composePolys",value:function(t){for(var n=[],i=0,o=t.length;i<o;i++){var s=t[i];if(!s.poly)if(s.isExteriorRing())n.push(new hr(s));else{var u=s.enclosingRing();u.poly||n.push(new hr(u)),u.poly.addInterior(s)}}return n}}]),r}(),so=function(){function r(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:on.compare;Ae(this,r),this.queue=e,this.tree=new Hn(t),this.segments=[]}return Se(r,[{key:"process",value:function(t){var n=t.segment,i=[];if(t.consumedBy)return t.isLeft?this.queue.remove(t.otherSE):this.tree.remove(n),i;var o=t.isLeft?this.tree.insert(n):this.tree.find(n);if(!o)throw new Error("Unable to find segment #".concat(n.id," ")+"[".concat(n.leftSE.point.x,", ").concat(n.leftSE.point.y,"] -> ")+"[".concat(n.rightSE.point.x,", ").concat(n.rightSE.point.y,"] ")+"in SweepLine tree. Please submit a bug report.");for(var s=o,u=o,l=void 0,a=void 0;l===void 0;)s=this.tree.prev(s),s===null?l=null:s.key.consumedBy===void 0&&(l=s.key);for(;a===void 0;)u=this.tree.next(u),u===null?a=null:u.key.consumedBy===void 0&&(a=u.key);if(t.isLeft){var p=null;if(l){var g=l.getIntersection(n);if(g!==null&&(n.isAnEndpoint(g)||(p=g),!l.isAnEndpoint(g)))for(var h=this._splitSafely(l,g),f=0,m=h.length;f<m;f++)i.push(h[f])}var _=null;if(a){var v=a.getIntersection(n);if(v!==null&&(n.isAnEndpoint(v)||(_=v),!a.isAnEndpoint(v)))for(var x=this._splitSafely(a,v),c=0,d=x.length;c<d;c++)i.push(x[c])}if(p!==null||_!==null){var y=null;if(p===null)y=_;else if(_===null)y=p;else{var P=Ge.comparePoints(p,_);y=P<=0?p:_}this.queue.remove(n.rightSE),i.push(n.rightSE);for(var C=n.split(y),O=0,M=C.length;O<M;O++)i.push(C[O])}i.length>0?(this.tree.remove(n),i.push(t)):(this.segments.push(n),n.prev=l)}else{if(l&&a){var I=l.getIntersection(a);if(I!==null){if(!l.isAnEndpoint(I))for(var D=this._splitSafely(l,I),G=0,z=D.length;G<z;G++)i.push(D[G]);if(!a.isAnEndpoint(I))for(var R=this._splitSafely(a,I),F=0,J=R.length;F<J;F++)i.push(R[F])}}this.tree.remove(n)}return i}},{key:"_splitSafely",value:function(t,n){this.tree.remove(t);var i=t.rightSE;this.queue.remove(i);var o=t.split(n);return o.push(i),t.consumedBy===void 0&&this.tree.insert(t),o}}]),r}(),dr=typeof process<"u"&&{}.POLYGON_CLIPPING_MAX_QUEUE_SIZE||1e6,lo=typeof process<"u"&&{}.POLYGON_CLIPPING_MAX_SWEEPLINE_SEGMENTS||1e6,uo=function(){function r(){Ae(this,r)}return Se(r,[{key:"run",value:function(t,n,i){Ne.type=t,zt.reset();for(var o=[new pr(n,!0)],s=0,u=i.length;s<u;s++)o.push(new pr(i[s],!1));if(Ne.numMultiPolys=o.length,Ne.type==="difference")for(var l=o[0],a=1;a<o.length;)Pn(o[a].bbox,l.bbox)!==null?a++:o.splice(a,1);if(Ne.type==="intersection"){for(var p=0,g=o.length;p<g;p++)for(var h=o[p],f=p+1,m=o.length;f<m;f++)if(Pn(h.bbox,o[f].bbox)===null)return[]}for(var _=new Hn(Ge.compare),v=0,x=o.length;v<x;v++)for(var c=o[v].getSweepEvents(),d=0,y=c.length;d<y;d++)if(_.insert(c[d]),_.size>dr)throw new Error("Infinite loop when putting segment endpoints in a priority queue (queue size too big). Please file a bug report.");for(var P=new so(_),C=_.size,O=_.pop();O;){var M=O.key;if(_.size===C){var I=M.segment;throw new Error("Unable to pop() ".concat(M.isLeft?"left":"right"," SweepEvent ")+"[".concat(M.point.x,", ").concat(M.point.y,"] from segment #").concat(I.id," ")+"[".concat(I.leftSE.point.x,", ").concat(I.leftSE.point.y,"] -> ")+"[".concat(I.rightSE.point.x,", ").concat(I.rightSE.point.y,"] from queue. ")+"Please file a bug report.")}if(_.size>dr)throw new Error("Infinite loop when passing sweep line over endpoints (queue size too big). Please file a bug report.");if(P.segments.length>lo)throw new Error("Infinite loop when passing sweep line over endpoints (too many sweep line segments). Please file a bug report.");for(var D=P.process(M),G=0,z=D.length;G<z;G++){var R=D[G];R.consumedBy===void 0&&_.insert(R)}C=_.size,O=_.pop()}zt.reset();var F=io.factory(P.segments),J=new oo(F);return J.getGeom()}}]),r}(),Ne=new uo,ao=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return Ne.run("union",e,n)},fo=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return Ne.run("intersection",e,n)},co=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return Ne.run("xor",e,n)},po=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return Ne.run("difference",e,n)},Wt={union:ao,intersection:fo,xor:co,difference:po};function ho(r,e){var t=go(e),n=null;return r.type==="FeatureCollection"?n=mo(r):n=Wr(Wt.union(r.geometry.coordinates)),n.geometry.coordinates.forEach(function(i){t.geometry.coordinates.push(i[0])}),t}function mo(r){var e=r.features.length===2?Wt.union(r.features[0].geometry.coordinates,r.features[1].geometry.coordinates):Wt.union.apply(Wt,r.features.map(function(t){return t.geometry.coordinates}));return Wr(e)}function Wr(r){return di(r)}function go(r){var e=[[[180,90],[-180,90],[-180,-90],[180,-90],[180,90]]],t=r&&r.geometry.coordinates||e;return mi(t)}function _o(r,e,t){let n;ce(r,Ye,s=>t(1,n=s));let{boundaryGeojson:i}=e;return gi("setCamera")&&n.fitBounds(Dn(i),{padding:20,animate:!1}),at(n,"boundary",{type:"geojson",data:ho(i)}),ke(n,{id:"boundary",source:"boundary",...Gn("black",.5)}),r.$$set=s=>{"boundaryGeojson"in s&&t(0,i=s.boundaryGeojson)},[i]}class vo extends se{constructor(e){super(),le(this,e,_o,null,ie,{boundaryGeojson:0})}}function mr(r){let e,t=gr(r[4])+"",n,i,o,s,u;return{c(){e=V("Length: "),n=V(t),i=L(),o=k("br"),s=L(),u=k("br")},m(l,a){b(l,e,a),b(l,n,a),b(l,i,a),b(l,o,a),b(l,s,a),b(l,u,a)},p(l,a){a&16&&t!==(t=gr(l[4])+"")&&jn(n,t)},d(l){l&&w(e),l&&w(n),l&&w(i),l&&w(o),l&&w(s),l&&w(u)}}}function yo(r){let e,t,n,i,o,s,u,l,a,p,g,h,f,m,_,v,x,c,d,y,P,C,O,M,I,D,G,z,R,F,J,_e,ne,pe,he,be,we,U,ue,Ke,ye,re,Fe,He,ae,Xe,q,Z=r[4]&&mr(r);return{c(){e=k("label"),t=V("Name:"),n=k("br"),i=L(),o=k("input"),s=L(),u=k("br"),l=L(),a=k("br"),p=L(),g=k("label"),h=k("input"),f=V(`
  Area`),m=L(),_=k("label"),v=k("input"),x=V(`
  Route`),c=L(),d=k("label"),y=k("input"),P=V(`
  Crossing`),C=L(),O=k("label"),M=k("input"),I=V(`
  Other`),D=L(),G=k("br"),z=L(),R=k("br"),F=L(),J=k("label"),_e=V("Description:"),ne=k("br"),pe=L(),he=k("textarea"),be=L(),we=k("br"),U=L(),ue=k("br"),Ke=L(),Z&&Z.c(),ye=L(),re=k("div"),Fe=k("button"),Fe.textContent="Delete",He=L(),ae=k("button"),ae.textContent="Save",A(o,"type","text"),ge(o,"width","100%"),A(h,"type","radio"),h.__value="area",h.value=h.__value,r[7][0].push(h),A(v,"type","radio"),v.__value="route",v.value=v.__value,r[7][0].push(v),A(y,"type","radio"),y.__value="crossing",y.value=y.__value,r[7][0].push(y),A(M,"type","radio"),M.__value="other",M.value=M.__value,r[7][0].push(M),ge(he,"width","100%"),A(he,"rows","5"),A(he,"class","svelte-15lna0i"),A(Fe,"type","button"),A(ae,"type","button"),ge(re,"display","flex"),ge(re,"justify-content","space-between")},m(T,H){b(T,e,H),S(e,t),S(e,n),S(e,i),S(e,o),Oe(o,r[0]),b(T,s,H),b(T,u,H),b(T,l,H),b(T,a,H),b(T,p,H),b(T,g,H),S(g,h),h.checked=h.__value===r[1],S(g,f),b(T,m,H),b(T,_,H),S(_,v),v.checked=v.__value===r[1],S(_,x),b(T,c,H),b(T,d,H),S(d,y),y.checked=y.__value===r[1],S(d,P),b(T,C,H),b(T,O,H),S(O,M),M.checked=M.__value===r[1],S(O,I),b(T,D,H),b(T,G,H),b(T,z,H),b(T,R,H),b(T,F,H),b(T,J,H),S(J,_e),S(J,ne),S(J,pe),S(J,he),Oe(he,r[2]),b(T,be,H),b(T,we,H),b(T,U,H),b(T,ue,H),b(T,Ke,H),Z&&Z.m(T,H),b(T,ye,H),b(T,re,H),S(re,Fe),S(re,He),S(re,ae),Xe||(q=[Y(o,"input",r[5]),Y(h,"change",r[6]),Y(v,"change",r[8]),Y(y,"change",r[9]),Y(M,"change",r[10]),Y(he,"input",r[11]),Y(Fe,"click",r[12]),Y(ae,"click",r[13])],Xe=!0)},p(T,[H]){H&1&&o.value!==T[0]&&Oe(o,T[0]),H&2&&(h.checked=h.__value===T[1]),H&2&&(v.checked=v.__value===T[1]),H&2&&(y.checked=y.__value===T[1]),H&2&&(M.checked=M.__value===T[1]),H&4&&Oe(he,T[2]),T[4]?Z?Z.p(T,H):(Z=mr(T),Z.c(),Z.m(ye.parentNode,ye)):Z&&(Z.d(1),Z=null)},i:W,o:W,d(T){T&&w(e),T&&w(s),T&&w(u),T&&w(l),T&&w(a),T&&w(p),T&&w(g),r[7][0].splice(r[7][0].indexOf(h),1),T&&w(m),T&&w(_),r[7][0].splice(r[7][0].indexOf(v),1),T&&w(c),T&&w(d),r[7][0].splice(r[7][0].indexOf(y),1),T&&w(C),T&&w(O),r[7][0].splice(r[7][0].indexOf(M),1),T&&w(D),T&&w(G),T&&w(z),T&&w(R),T&&w(F),T&&w(J),T&&w(be),T&&w(we),T&&w(U),T&&w(ue),T&&w(Ke),Z&&Z.d(T),T&&w(ye),T&&w(re),Xe=!1,We(q)}}}function gr(r){return r<1e3?Math.round(r)+" m":(r/1e3).toFixed(1)+"km"}function bo(r,e,t){let{id:n}=e,{name:i}=e,{intervention_type:o}=e,{description:s}=e,{length_meters:u}=e;const l=[[]];function a(){i=this.value,t(0,i)}function p(){o=this.__value,t(1,o)}function g(){o=this.__value,t(1,o)}function h(){o=this.__value,t(1,o)}function f(){o=this.__value,t(1,o)}function m(){s=this.value,t(2,s)}const _=()=>Yn(n),v=()=>Ce.set(null);return r.$$set=x=>{"id"in x&&t(3,n=x.id),"name"in x&&t(0,i=x.name),"intervention_type"in x&&t(1,o=x.intervention_type),"description"in x&&t(2,s=x.description),"length_meters"in x&&t(4,u=x.length_meters)},[i,o,s,n,u,a,p,l,g,h,f,m,_,v]}class wo extends se{constructor(e){super(),le(this,e,bo,yo,ie,{id:3,name:0,intervention_type:1,description:2,length_meters:4})}}function _r(r,e,t){const n=r.slice();return n[16]=e[t],n}function vr(r,e,t){const n=r.slice();return n[16]=e[t],n}function yr(r,e,t){const n=r.slice();return n[16]=e[t],n}function br(r,e,t){const n=r.slice();return n[16]=e[t],n}function wr(r){let e,t=r[16]+"",n;return{c(){e=k("option"),n=V(t),e.__value=r[16],e.value=e.__value},m(i,o){b(i,e,o),S(e,n)},p:W,d(i){i&&w(e)}}}function kr(r){let e,t=r[16]+"",n;return{c(){e=k("option"),n=V(t),e.__value=r[16],e.value=e.__value},m(i,o){b(i,e,o),S(e,n)},p:W,d(i){i&&w(e)}}}function Sr(r){let e,t=r[16]+"",n;return{c(){e=k("option"),n=V(t),e.__value=r[16],e.value=e.__value},m(i,o){b(i,e,o),S(e,n)},p:W,d(i){i&&w(e)}}}function Er(r){let e,t=r[16]+"",n;return{c(){e=k("option"),n=V(t),e.__value=r[16],e.value=e.__value},m(i,o){b(i,e,o),S(e,n)},p:W,d(i){i&&w(e)}}}function ko(r){let e,t,n,i,o,s,u,l,a,p,g,h,f,m,_,v,x,c,d,y,P,C,O,M,I,D,G,z,R,F,J,_e,ne,pe,he,be,we,U,ue,Ke,ye,re,Fe,He,ae,Xe,q,Z,T,H,ft,Ve,ct,dn,Ze,Ot,Jn,At,mn,Wn,pt=r[2],Ee=[];for(let E=0;E<pt.length;E+=1)Ee[E]=wr(br(r,pt,E));let ht=r[3],xe=[];for(let E=0;E<ht.length;E+=1)xe[E]=kr(yr(r,ht,E));let dt=r[4],Me=[];for(let E=0;E<dt.length;E+=1)Me[E]=Sr(vr(r,dt,E));let mt=r[5],Le=[];for(let E=0;E<mt.length;E+=1)Le[E]=Er(_r(r,mt,E));return{c(){e=k("label"),t=V("Name:"),n=k("br"),i=L(),o=k("input"),s=L(),u=k("br"),l=L(),a=k("br"),p=L(),g=k("label"),h=V(`Reference type:
  `),f=k("select");for(let E=0;E<Ee.length;E+=1)Ee[E].c();m=L(),_=k("br"),v=L(),x=k("br"),c=L(),d=k("label"),y=V("Notes:"),P=k("br"),C=L(),O=k("textarea"),M=L(),I=k("br"),D=L(),G=k("br"),z=L(),R=k("label"),F=V(`Size:
  `),J=k("input"),_e=L(),ne=k("select");for(let E=0;E<xe.length;E+=1)xe[E].c();pe=L(),he=k("br"),be=L(),we=k("br"),U=L(),ue=k("label"),Ke=V(`ATE Triage:
  `),ye=k("select");for(let E=0;E<Me.length;E+=1)Me[E].c();re=L(),Fe=k("br"),He=L(),ae=k("br"),Xe=L(),q=k("label"),Z=V(`ATE Recommendation:
  `),T=k("select");for(let E=0;E<Le.length;E+=1)Le[E].c();H=L(),ft=k("br"),Ve=L(),ct=k("br"),dn=L(),Ze=k("div"),Ot=k("button"),Ot.textContent="Delete",Jn=L(),At=k("button"),At.textContent="Save",A(o,"type","text"),ge(o,"width","100%"),r[1].reference_type===void 0&&wt(()=>r[8].call(f)),ge(O,"width","100%"),A(O,"rows","5"),A(O,"class","svelte-15lna0i"),A(J,"type","number"),A(J,"min","0"),A(J,"max","1000"),r[1].size_units===void 0&&wt(()=>r[11].call(ne)),r[1].triage===void 0&&wt(()=>r[12].call(ye)),r[1].recommendation===void 0&&wt(()=>r[13].call(T)),A(Ot,"type","button"),A(At,"type","button"),ge(Ze,"display","flex"),ge(Ze,"justify-content","space-between")},m(E,$){b(E,e,$),S(e,t),S(e,n),S(e,i),S(e,o),Oe(o,r[1].name),b(E,s,$),b(E,u,$),b(E,l,$),b(E,a,$),b(E,p,$),b(E,g,$),S(g,h),S(g,f);for(let N=0;N<Ee.length;N+=1)Ee[N].m(f,null);De(f,r[1].reference_type),b(E,m,$),b(E,_,$),b(E,v,$),b(E,x,$),b(E,c,$),b(E,d,$),S(d,y),S(d,P),S(d,C),S(d,O),Oe(O,r[1].notes),b(E,M,$),b(E,I,$),b(E,D,$),b(E,G,$),b(E,z,$),b(E,R,$),S(R,F),S(R,J),Oe(J,r[1].size),S(R,_e),S(R,ne);for(let N=0;N<xe.length;N+=1)xe[N].m(ne,null);De(ne,r[1].size_units),b(E,pe,$),b(E,he,$),b(E,be,$),b(E,we,$),b(E,U,$),b(E,ue,$),S(ue,Ke),S(ue,ye);for(let N=0;N<Me.length;N+=1)Me[N].m(ye,null);De(ye,r[1].triage),b(E,re,$),b(E,Fe,$),b(E,He,$),b(E,ae,$),b(E,Xe,$),b(E,q,$),S(q,Z),S(q,T);for(let N=0;N<Le.length;N+=1)Le[N].m(T,null);De(T,r[1].recommendation),b(E,H,$),b(E,ft,$),b(E,Ve,$),b(E,ct,$),b(E,dn,$),b(E,Ze,$),S(Ze,Ot),S(Ze,Jn),S(Ze,At),mn||(Wn=[Y(o,"input",r[7]),Y(f,"change",r[8]),Y(O,"input",r[9]),Y(J,"input",r[10]),Y(ne,"change",r[11]),Y(ye,"change",r[12]),Y(T,"change",r[13]),Y(Ot,"click",r[14]),Y(At,"click",r[15])],mn=!0)},p(E,[$]){if($&6&&o.value!==E[1].name&&Oe(o,E[1].name),$&4){pt=E[2];let N;for(N=0;N<pt.length;N+=1){const Te=br(E,pt,N);Ee[N]?Ee[N].p(Te,$):(Ee[N]=wr(Te),Ee[N].c(),Ee[N].m(f,null))}for(;N<Ee.length;N+=1)Ee[N].d(1);Ee.length=pt.length}if($&6&&De(f,E[1].reference_type),$&6&&Oe(O,E[1].notes),$&6&&Ur(J.value)!==E[1].size&&Oe(J,E[1].size),$&8){ht=E[3];let N;for(N=0;N<ht.length;N+=1){const Te=yr(E,ht,N);xe[N]?xe[N].p(Te,$):(xe[N]=kr(Te),xe[N].c(),xe[N].m(ne,null))}for(;N<xe.length;N+=1)xe[N].d(1);xe.length=ht.length}if($&6&&De(ne,E[1].size_units),$&16){dt=E[4];let N;for(N=0;N<dt.length;N+=1){const Te=vr(E,dt,N);Me[N]?Me[N].p(Te,$):(Me[N]=Sr(Te),Me[N].c(),Me[N].m(ye,null))}for(;N<Me.length;N+=1)Me[N].d(1);Me.length=dt.length}if($&6&&De(ye,E[1].triage),$&32){mt=E[5];let N;for(N=0;N<mt.length;N+=1){const Te=_r(E,mt,N);Le[N]?Le[N].p(Te,$):(Le[N]=Er(Te),Le[N].c(),Le[N].m(T,null))}for(;N<Le.length;N+=1)Le[N].d(1);Le.length=mt.length}$&6&&De(T,E[1].recommendation)},i:W,o:W,d(E){E&&w(e),E&&w(s),E&&w(u),E&&w(l),E&&w(a),E&&w(p),E&&w(g),Ht(Ee,E),E&&w(m),E&&w(_),E&&w(v),E&&w(x),E&&w(c),E&&w(d),E&&w(M),E&&w(I),E&&w(D),E&&w(G),E&&w(z),E&&w(R),Ht(xe,E),E&&w(pe),E&&w(he),E&&w(be),E&&w(we),E&&w(U),E&&w(ue),Ht(Me,E),E&&w(re),E&&w(Fe),E&&w(He),E&&w(ae),E&&w(Xe),E&&w(q),Ht(Le,E),E&&w(H),E&&w(ft),E&&w(Ve),E&&w(ct),E&&w(dn),E&&w(Ze),mn=!1,We(Wn)}}}function So(r,e,t){let{id:n}=e,{allProperties:i}=e;i.planning||(i.planning={name:"",notes:"",reference_type:"preapp",size:0,size_units:"number of units",triage:"No Comment",recommendation:"No Comment"});let o=i.planning;const s=["preapp","outline","reserved matters","local plan"],u=["number of units","floorspace (Gross Floor Area)","area (Hectare)"],l=["No Comment","Standing Advice","Toolkit Assessment"],a=["No Comment","No Objection","Standing Advice","Deferral","Approve subject to conditions and/or obligations","Refusal"];function p(){o.name=this.value,t(1,o),t(2,s)}function g(){o.reference_type=Tt(this),t(1,o),t(2,s)}function h(){o.notes=this.value,t(1,o),t(2,s)}function f(){o.size=Ur(this.value),t(1,o),t(2,s)}function m(){o.size_units=Tt(this),t(1,o),t(2,s)}function _(){o.triage=Tt(this),t(1,o),t(2,s)}function v(){o.recommendation=Tt(this),t(1,o),t(2,s)}const x=()=>Yn(n),c=()=>Ce.set(null);return r.$$set=d=>{"id"in d&&t(0,n=d.id),"allProperties"in d&&t(6,i=d.allProperties)},[n,o,s,u,l,a,i,p,g,h,f,m,_,v,x,c]}class Eo extends se{constructor(e){super(),le(this,e,So,ko,ie,{id:0,allProperties:6})}}function xo(r){const e=r-1;return e*e*e+1}function xr(r,{delay:e=0,duration:t=400,easing:n=xo}={}){const i=getComputedStyle(r),o=+i.opacity,s=parseFloat(i.height),u=parseFloat(i.paddingTop),l=parseFloat(i.paddingBottom),a=parseFloat(i.marginTop),p=parseFloat(i.marginBottom),g=parseFloat(i.borderTopWidth),h=parseFloat(i.borderBottomWidth);return{delay:e,duration:t,easing:n,css:f=>`overflow: hidden;opacity: ${Math.min(f*20,1)*o};height: ${f*s}px;padding-top: ${f*u}px;padding-bottom: ${f*l}px;margin-top: ${f*a}px;margin-bottom: ${f*p}px;border-top-width: ${f*g}px;border-bottom-width: ${f*h}px;`}}function Mr(r){let e,t,n,i,o;const s=r[10].default,u=Rt(s,r,r[9],null);return{c(){e=k("div"),u&&u.c(),ge(e,"border","solid 1px black"),ge(e,"padding","10px")},m(l,a){b(l,e,a),u&&u.m(e,null),r[13](e),n=!0,i||(o=Y(e,"introend",r[14]),i=!0)},p(l,a){u&&u.p&&(!n||a&512)&&Nt(u,s,l,l[9],n?Bt(s,l[9],a,null):It(l[9]),null)},i(l){n||(B(u,l),wt(()=>{t||(t=Qn(e,xr,{duration:100},!0)),t.run(1)}),n=!0)},o(l){j(u,l),t||(t=Qn(e,xr,{duration:100},!1)),t.run(0),n=!1},d(l){l&&w(e),u&&u.d(l),r[13](null),l&&t&&t.end(),i=!1,o()}}}function Mo(r){let e,t,n,i,o,s,u,l,a,p,g=r[4]&&Mr(r);return{c(){e=k("button"),t=Vn("svg"),n=Vn("path"),i=L(),o=V(r[1]),s=L(),g&&g.c(),u=Ie(),A(n,"d","M9 5l7 7-7 7"),A(t,"style","tran"),A(t,"width","20"),A(t,"height","20"),A(t,"fill","none"),A(t,"stroke-linecap","round"),A(t,"stroke-linejoin","round"),A(t,"stroke-width","2"),A(t,"viewBox","0 0 24 24"),A(t,"stroke","currentColor"),A(t,"class","svelte-t7fpgu"),A(e,"aria-expanded",r[4]),A(e,"class","svelte-t7fpgu"),Zn(e,"underlined",r[3])},m(h,f){b(h,e,f),S(e,t),S(t,n),S(e,i),S(e,o),b(h,s,f),g&&g.m(h,f),b(h,u,f),l=!0,a||(p=[Y(e,"click",r[5]),Y(e,"mouseenter",r[11]),Y(e,"mouseleave",r[12])],a=!0)},p(h,[f]){(!l||f&2)&&jn(o,h[1]),(!l||f&16)&&A(e,"aria-expanded",h[4]),(!l||f&8)&&Zn(e,"underlined",h[3]),h[4]?g?(g.p(h,f),f&16&&B(g,1)):(g=Mr(h),g.c(),B(g,1),g.m(u.parentNode,u)):g&&(qe(),j(g,1,1,()=>{g=null}),ze())},i(h){l||(B(g),l=!0)},o(h){j(g),l=!1},d(h){h&&w(e),h&&w(s),g&&g.d(h),h&&w(u),a=!1,We(p)}}}function Lo(r,e,t){let n,i,o,s;ce(r,Je,c=>t(7,o=c)),ce(r,Ce,c=>t(8,s=c));let{$$slots:u={},$$scope:l}=e,{id:a}=e,{label:p}=e;const g=()=>{Ce.update(c=>c==a?null:a),s==a&&(Sn.set(null),Sn.set(a))};let h;function f(){h==null||h.scrollIntoView({behavior:"smooth"})}const m=()=>nn.set(a),_=()=>nn.set(null);function v(c){ve[c?"unshift":"push"](()=>{h=c,t(2,h)})}const x=()=>f();return r.$$set=c=>{"id"in c&&t(0,a=c.id),"label"in c&&t(1,p=c.label),"$$scope"in c&&t(9,l=c.$$scope)},r.$$.update=()=>{r.$$.dirty&257&&t(4,n=s==a),r.$$.dirty&129&&t(3,i=o==a)},[a,p,h,i,n,g,f,o,s,l,u,m,_,v,x]}class Po extends se{constructor(e){super(),le(this,e,Lo,Mo,ie,{id:0,label:1})}}function Lr(r,e,t){const n=r.slice();return n[8]=e[t],n[9]=e,n[10]=t,n}function Co(r){let e,t,n,i,o;function s(p){r[4](p,r[8])}function u(p){r[5](p,r[8])}function l(p){r[6](p,r[8])}let a={id:r[8].id,length_meters:r[8].properties.length_meters};return r[8].properties.name!==void 0&&(a.name=r[8].properties.name),r[8].properties.intervention_type!==void 0&&(a.intervention_type=r[8].properties.intervention_type),r[8].properties.description!==void 0&&(a.description=r[8].properties.description),e=new wo({props:a}),ve.push(()=>it(e,"name",s,r[8].properties.name)),ve.push(()=>it(e,"intervention_type",u,r[8].properties.intervention_type)),ve.push(()=>it(e,"description",l,r[8].properties.description)),{c(){Q(e.$$.fragment)},m(p,g){ee(e,p,g),o=!0},p(p,g){r=p;const h={};g&2&&(h.id=r[8].id),g&2&&(h.length_meters=r[8].properties.length_meters),!t&&g&2&&(t=!0,h.name=r[8].properties.name,ot(()=>t=!1)),!n&&g&2&&(n=!0,h.intervention_type=r[8].properties.intervention_type,ot(()=>n=!1)),!i&&g&2&&(i=!0,h.description=r[8].properties.description,ot(()=>i=!1)),e.$set(h)},i(p){o||(B(e.$$.fragment,p),o=!0)},o(p){j(e.$$.fragment,p),o=!1},d(p){te(e,p)}}}function Oo(r){let e,t,n;function i(s){r[3](s,r[8])}let o={id:r[8].id};return r[8].properties!==void 0&&(o.allProperties=r[8].properties),e=new Eo({props:o}),ve.push(()=>it(e,"allProperties",i,r[8].properties)),{c(){Q(e.$$.fragment)},m(s,u){ee(e,s,u),n=!0},p(s,u){r=s;const l={};u&2&&(l.id=r[8].id),!t&&u&2&&(t=!0,l.allProperties=r[8].properties,ot(()=>t=!1)),e.$set(l)},i(s){n||(B(e.$$.fragment,s),n=!0)},o(s){j(e.$$.fragment,s),n=!1},d(s){te(e,s)}}}function Ao(r){let e,t,n,i;const o=[Oo,Co],s=[];function u(l,a){return l[0]?0:1}return e=u(r),t=s[e]=o[e](r),{c(){t.c(),n=L()},m(l,a){s[e].m(l,a),b(l,n,a),i=!0},p(l,a){let p=e;e=u(l),e===p?s[e].p(l,a):(qe(),j(s[p],1,1,()=>{s[p]=null}),ze(),t=s[e],t?t.p(l,a):(t=s[e]=o[e](l),t.c()),B(t,1),t.m(n.parentNode,n))},i(l){i||(B(t),i=!0)},o(l){j(t),i=!1},d(l){s[e].d(l),l&&w(n)}}}function Pr(r,e){let t,n,i;return n=new Po({props:{id:e[8].id,label:e[10]+1+") "+Cr(e[8]),$$slots:{default:[Ao]},$$scope:{ctx:e}}}),{key:r,first:null,c(){t=Ie(),Q(n.$$.fragment),this.first=t},m(o,s){b(o,t,s),ee(n,o,s),i=!0},p(o,s){e=o;const u={};s&2&&(u.id=e[8].id),s&2&&(u.label=e[10]+1+") "+Cr(e[8])),s&2051&&(u.$$scope={dirty:s,ctx:e}),n.$set(u)},i(o){i||(B(n.$$.fragment,o),i=!0)},o(o){j(n.$$.fragment,o),i=!1},d(o){o&&w(t),te(n,o)}}}function Fo(r){let e=[],t=new Map,n,i,o,s,u=r[1].features;const l=a=>a[8].id;for(let a=0;a<u.length;a+=1){let p=Lr(r,u,a),g=l(p);t.set(g,e[a]=Pr(g,p))}return{c(){for(let a=0;a<e.length;a+=1)e[a].c();n=Ie()},m(a,p){for(let g=0;g<e.length;g+=1)e[g].m(a,p);b(a,n,p),i=!0,o||(s=Y(window,"keydown",r[2]),o=!0)},p(a,[p]){p&3&&(u=a[1].features,qe(),e=_i(e,p,l,1,a,u,t,n.parentNode,vi,Pr,n,Lr),ze())},i(a){if(!i){for(let p=0;p<u.length;p+=1)B(e[p]);i=!0}},o(a){for(let p=0;p<e.length;p+=1)j(e[p]);i=!1},d(a){for(let p=0;p<e.length;p+=1)e[p].d(a);a&&w(n),o=!1,s()}}}function Cr(r){if(r.properties.name)return r.properties.name;var e=r.properties.intervention_type;return e=="other"&&(r.geometry.type=="Point"?e="point":r.geometry.type=="LineString"?e="line":e="polygon"),`Untitled ${e}`}function To(r,e,t){let n,i;ce(r,Ce,g=>t(7,n=g)),ce(r,fe,g=>t(1,i=g));let{planningMode:o}=e;function s(g){if(g.key=="Delete"){const h=g.target.tagName;if(h=="INPUT"||h=="TEXTAREA")return;g.preventDefault();const f=n;f&&Yn(f)}}function u(g,h){r.$$.not_equal(h.properties,g)&&(h.properties=g,fe.set(i))}function l(g,h){r.$$.not_equal(h.properties.name,g)&&(h.properties.name=g,fe.set(i))}function a(g,h){r.$$.not_equal(h.properties.intervention_type,g)&&(h.properties.intervention_type=g,fe.set(i))}function p(g,h){r.$$.not_equal(h.properties.description,g)&&(h.properties.description=g,fe.set(i))}return r.$$set=g=>{"planningMode"in g&&t(0,o=g.planningMode)},[o,i,s,u,l,a,p]}class Ro extends se{constructor(e){super(),le(this,e,To,Fo,ie,{planningMode:0})}}function lt(r){if(!r)throw new Error("coord is required");if(!Array.isArray(r)){if(r.type==="Feature"&&r.geometry!==null&&r.geometry.type==="Point")return r.geometry.coordinates;if(r.type==="Point")return r.coordinates}if(Array.isArray(r)&&r.length>=2&&!Array.isArray(r[0])&&!Array.isArray(r[1]))return r;throw new Error("coord must be GeoJSON Point or an Array of numbers")}function je(r){if(Array.isArray(r))return r;if(r.type==="Feature"){if(r.geometry!==null)return r.geometry.coordinates}else if(r.coordinates)return r.coordinates;throw new Error("coords must be GeoJSON Feature, Geometry Object or an Array")}function On(r,e){return r.type==="FeatureCollection"?"FeatureCollection":r.type==="GeometryCollection"?"GeometryCollection":r.type==="Feature"&&r.geometry!==null?r.geometry.type:r.type}function tt(r,e,t){t===void 0&&(t={});var n=lt(r),i=lt(e),o=Re(i[1]-n[1]),s=Re(i[0]-n[0]),u=Re(n[1]),l=Re(i[1]),a=Math.pow(Math.sin(o/2),2)+Math.pow(Math.sin(s/2),2)*Math.cos(u)*Math.cos(l);return yi(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)),t.units)}function Kt(r,e){return e===void 0&&(e={}),bi(r,function(t,n){var i=n.geometry.coordinates;return t+tt(i[0],i[1],e)},0)}function No(r){let e,t,n,i,o,s,u,l,a,p,g,h,f,m,_,v,x,c,d,y=r[0].features.length+"",P,C,O,M,I,D,G,z;return{c(){e=k("div"),t=k("label"),n=V(`Scheme name:
    `),i=k("input"),o=L(),s=k("br"),u=L(),l=k("div"),a=k("label"),p=k("input"),g=L(),h=k("button"),h.textContent="Load from GeoJSON",f=L(),m=k("button"),m.textContent="Export to GeoJSON",_=L(),v=k("br"),x=L(),c=k("div"),d=k("span"),P=V(y),C=V(" interventions"),O=L(),M=k("button"),I=V("Clear all"),A(i,"type","text"),A(p,"type","file"),A(p,"id","load_geojson"),A(p,"class","svelte-lhyd1e"),A(h,"type","button"),A(m,"type","button"),A(m,"class","align-right svelte-lhyd1e"),A(M,"type","button"),A(M,"class","align-right svelte-lhyd1e"),M.disabled=D=r[0].features.length==0},m(R,F){b(R,e,F),S(e,t),S(t,n),S(t,i),Oe(i,r[0].scheme_name),b(R,o,F),b(R,s,F),b(R,u,F),b(R,l,F),S(l,a),S(a,p),S(a,g),S(a,h),S(l,f),S(l,m),b(R,_,F),b(R,v,F),b(R,x,F),b(R,c,F),S(c,d),S(d,P),S(d,C),S(c,O),S(c,M),S(M,I),G||(z=[Y(i,"input",r[7]),Y(p,"change",r[3]),Y(h,"click",Bo),Y(m,"click",r[2]),Y(M,"click",r[1])],G=!0)},p(R,[F]){F&1&&i.value!==R[0].scheme_name&&Oe(i,R[0].scheme_name),F&1&&y!==(y=R[0].features.length+"")&&jn(P,y),F&1&&D!==(D=R[0].features.length==0)&&(M.disabled=D)},i:W,o:W,d(R){R&&w(e),R&&w(o),R&&w(s),R&&w(u),R&&w(l),R&&w(_),R&&w(v),R&&w(x),R&&w(c),G=!1,We(z)}}}function Io(r,e){var t=document.createElement("a");t.setAttribute("href","data:text/plain;charset=utf-8, "+encodeURIComponent(e)),t.setAttribute("download",r),document.body.appendChild(t),t.click(),document.body.removeChild(t)}function Bo(){document.getElementById("load_geojson").click()}function Do(r,e,t){let n;ce(r,fe,m=>t(0,n=m));let{authorityName:i}=e,{planningMode:o}=e,s=i;o&&(s+="_planning");let u=window.localStorage.getItem(s);if(u)try{fe.set(h(JSON.parse(u)))}catch(m){console.log(`Failed to load from local storage: ${m}`)}function l(){confirm("Do you want to clear the current scheme? (You should save it first!)")&&fe.update(m=>(delete m.scheme_name,m.features=[],m))}function a(){const m=JSON.parse(JSON.stringify(n));for(let _ of m.features)delete _.properties.hide_while_editing;return m}function p(){let m=a();var _=s;m.authority=i,m.origin="atip-v1",m.scheme_name&&(_+="_"+m.scheme_name),_+=".txt",Io(_,JSON.stringify(m,null,"  "))}function g(m){const _=new FileReader;_.onload=x=>{try{fe.set(h(JSON.parse(x.target.result)))}catch(c){window.alert(`Couldn't load scheme from a file: ${c}`)}};let v=m.target.files;_.readAsText(v[0])}function h(m){let _=1;for(let v of m.features)v.properties||(v.properties={name:"",description:"",intervention_type:"other"}),v.geometry.type=="LineString"&&!v.properties.length_meters&&(v.properties.length_meters=Kt(v,{units:"kilometers"})*1e3),v.id=_++;return m}function f(){n.scheme_name=this.value,fe.set(n)}return r.$$set=m=>{"authorityName"in m&&t(4,i=m.authorityName),"planningMode"in m&&t(5,o=m.planningMode)},r.$$.update=()=>{r.$$.dirty&65&&n&&(console.log("GJ changed, saving to local storage"),window.localStorage.setItem(s,JSON.stringify(a())))},[n,l,p,g,i,o,s,f]}class Go extends se{constructor(e){super(),le(this,e,Do,No,ie,{authorityName:4,planningMode:5})}}const jo="/atip/planning/assets/zoom_out_map-b2e1091a.svg";function $o(r){let e,t,n,i,o;return{c(){e=k("button"),t=k("img"),wi(t.src,n=jo)||A(t,"src",n),A(t,"alt","Zoom to show entire boundary"),A(e,"type","button"),A(e,"title","Zoom to show entire boundary"),A(e,"class","svelte-qzjsqo")},m(s,u){b(s,e,u),S(e,t),i||(o=Y(e,"click",r[0]),i=!0)},p:W,i:W,o:W,d(s){s&&w(e),i=!1,o()}}}function qo(r,e,t){let n;ce(r,Ye,s=>t(2,n=s));let{boundaryGeojson:i}=e;function o(){n.fitBounds(Dn(i),{padding:20,animate:!0,duration:500})}return r.$$set=s=>{"boundaryGeojson"in s&&t(1,i=s.boundaryGeojson)},[o,i]}class zo extends se{constructor(e){super(),le(this,e,qo,$o,ie,{boundaryGeojson:1})}}function Yo(r){let e,t,n,i,o,s,u;return{c(){e=k("div"),t=V(`Basemap:
  `),n=k("select"),i=k("option"),i.textContent="Streets",o=k("option"),o.textContent="Satellite",i.__value="streets",i.value=i.__value,o.__value="hybrid",o.value=o.__value,r[0]===void 0&&wt(()=>r[2].call(n)),A(e,"class","svelte-1tbnm6i")},m(l,a){b(l,e,a),S(e,t),S(e,n),S(n,i),S(n,o),De(n,r[0]),s||(u=[Y(n,"change",r[2]),Y(n,"change",r[1])],s=!0)},p(l,[a]){a&1&&De(n,l[0])},i:W,o:W,d(l){l&&w(e),s=!1,We(u)}}}function Ho(r,e,t){let{style:n}=e;function i(){let s=new URLSearchParams(window.location.search);s.set("style",n);let u=`${window.location.pathname}?${s.toString()}${window.location.hash}`;window.location.href=u}function o(){n=Tt(this),t(0,n)}return r.$$set=s=>{"style"in s&&t(0,n=s.style)},[n,i,o]}class Xo extends se{constructor(e){super(),le(this,e,Ho,Yo,ie,{style:0})}}const Pe={area:"#e41a1c",route:"#377eb8",crossing:"#4daf4a",other:"#984ea3",hovering:"black",lineEndpointColor:"black"},hn=10,sn=10;function Uo(r){let e,t,n,i,o,s,u,l,a,p,g,h,f,m,_,v,x,c,d;return{c(){e=k("div"),t=k("h1"),t.textContent="Interventions",n=L(),i=k("ul"),o=k("li"),s=k("span"),u=V("Areas"),l=L(),a=k("li"),p=k("span"),g=V("Routes"),h=L(),f=k("li"),m=k("span"),_=V("Crossings"),v=L(),x=k("li"),c=k("span"),d=V("Other"),A(t,"class","svelte-p551i1"),A(s,"class","svelte-p551i1"),ge(s,"background",Pe.area),A(p,"class","svelte-p551i1"),ge(p,"background",Pe.route),A(m,"class","svelte-p551i1"),ge(m,"background",Pe.crossing),A(c,"class","svelte-p551i1"),ge(c,"background",Pe.other),A(e,"class","svelte-p551i1")},m(y,P){b(y,e,P),S(e,t),S(e,n),S(e,i),S(i,o),S(o,s),S(o,u),S(i,l),S(i,a),S(a,p),S(a,g),S(i,h),S(i,f),S(f,m),S(f,_),S(i,v),S(i,x),S(x,c),S(x,d)},p:W,i:W,o:W,d(y){y&&w(e)}}}class Jo extends se{constructor(e){super(),le(this,e,null,Uo,ie,{})}}let _t="interventions";function Wo(r,e,t){let n,i;ce(r,Ye,l=>t(0,n=l)),ce(r,fe,l=>t(1,i=l)),at(n,_t,{type:"geojson",data:i});const o=["match",["get","intervention_type"],"area",Pe.area,"route",Pe.route,"crossing",Pe.crossing,"other",Pe.other,"white"],s=["!=","hide_while_editing",!0];return ke(n,{id:"interventions-points",source:_t,filter:["all",fn,s,["!=","endpoint",!0]],...Pt(o,hn)}),ke(n,{id:"interventions-lines",source:_t,filter:["all",cn,s],...qt(o,sn)},"route-lines"),ke(n,{id:"interventions-lines-endpoints",source:_t,filter:["==","endpoint",!0],type:"circle",paint:{"circle-radius":.5*sn,"circle-opacity":0,"circle-stroke-color":Pe.lineEndpointColor,"circle-stroke-width":2}}),ke(n,{id:"interventions-polygons",source:_t,filter:["all",$n,s],...Gn(o,.5)},"hover-polygons"),r.$$.update=()=>{if(r.$$.dirty&3){let l=JSON.parse(JSON.stringify(i)),a=[];for(let p of l.features)if(p.geometry.type=="LineString")for(let g of[p.geometry.coordinates[0],p.geometry.coordinates[p.geometry.coordinates.length-1]])a.push({type:"Feature",properties:{endpoint:!0},geometry:{type:"Point",coordinates:g}});l.features=l.features.concat(a),n.getSource(_t).setData(l)}},[n,i]}class Ko extends se{constructor(e){super(),le(this,e,Wo,null,ie,{})}}let vt="hover";function Vo(r,e,t){let n,i,o,s,u;return ce(r,Ye,l=>t(0,n=l)),ce(r,fe,l=>t(1,i=l)),ce(r,nn,l=>t(2,o=l)),ce(r,Je,l=>t(3,s=l)),ce(r,Ce,l=>t(4,u=l)),at(n,vt,{type:"geojson",data:$e()}),ke(n,{id:"hover-polygons",source:vt,filter:$n,...qt(Pe.hovering,.5*sn,1)}),ke(n,{id:"hover-lines",source:vt,filter:cn,...qt(Pe.hovering,1.5*sn,1)},"interventions-lines"),ke(n,{id:"hover-points",source:vt,filter:fn,...Pt(Pe.hovering,1.5*hn,1)},"interventions-points"),r.$$.update=()=>{if(r.$$.dirty&31){let l=u||s||o;l!=null?n.getSource(vt).setData(i.features.find(a=>a.id==l)):n.getSource(vt).setData($e())}},[n,i,o,s,u]}class Zo extends se{constructor(e){super(),le(this,e,Vo,null,ie,{})}}class Xn{constructor(e,t){oe(this,"owner");oe(this,"map");oe(this,"mapHandlers",{});oe(this,"documentHandlers",{});this.owner=e,this.map=t,this.mapHandlers={},this.documentHandlers={}}mapHandler(e,t){let n=t.bind(this.owner);this.mapHandlers[e]=n,this.map.on(e,n)}documentHandler(e,t){let n=t.bind(this.owner);this.documentHandlers[e]=n,document.addEventListener(e,n)}tearDown(){for(let[e,t]of Object.entries(this.mapHandlers))this.map.off(e,t);this.mapHandlers={};for(let[e,t]of Object.entries(this.documentHandlers))document.removeEventListener(e,t);this.documentHandlers={}}}const Xt="edit-point-mode";class Qo{constructor(e){oe(this,"map");oe(this,"active");oe(this,"eventListenersSuccess");oe(this,"eventListenersFailure");oe(this,"cursor");oe(this,"events");this.map=e,this.active=!1,this.eventListenersSuccess=[],this.eventListenersFailure=[],this.cursor=null,this.events=new Xn(this,e),this.events.mapHandler("click",this.onClick),this.events.mapHandler("mousemove",this.onMouseMove),at(e,Xt,{type:"geojson",data:$e()}),ke(e,{id:"edit-point-mode",source:Xt,...Pt(Pe.hovering,hn,1)})}cancel(){for(let e of this.eventListenersFailure)e();this.stop()}onMouseMove(e){this.active&&(this.cursor=es(e.lngLat.toArray()),this.redraw())}onClick(){if(this.active&&this.cursor){for(let e of this.eventListenersSuccess)e(this.cursor);this.stop()}}addEventListenerSuccess(e){this.eventListenersSuccess.push(e)}addEventListenerFailure(e){this.eventListenersFailure.push(e)}tearDown(){this.map.removeLayer("edit-point-mode"),this.map.removeSource(Xt),this.events.tearDown()}start(){this.active=!0}stop(){this.cursor=null,this.active=!1,this.redraw()}redraw(){let e=$e();this.cursor&&e.features.push(this.cursor),this.map.getSource(Xt).setData(e)}}function es(r){return{type:"Feature",properties:{},geometry:{type:"Point",coordinates:r}}}function Kr(r,e,t){if(t===void 0&&(t={}),t.final===!0)return ts(r,e);var n=lt(r),i=lt(e),o=Re(n[0]),s=Re(i[0]),u=Re(n[1]),l=Re(i[1]),a=Math.sin(s-o)*Math.cos(l),p=Math.cos(u)*Math.sin(l)-Math.sin(u)*Math.cos(l)*Math.cos(s-o);return kn(Math.atan2(a,p))}function ts(r,e){var t=Kr(e,r);return t=(t+180)%360,t}function Or(r,e,t,n){n===void 0&&(n={});var i=lt(r),o=Re(i[0]),s=Re(i[1]),u=Re(t),l=ki(e,n.units),a=Math.asin(Math.sin(s)*Math.cos(l)+Math.cos(s)*Math.sin(l)*Math.cos(u)),p=o+Math.atan2(Math.sin(u)*Math.sin(l)*Math.cos(s),Math.cos(l)-Math.sin(s)*Math.sin(a)),g=kn(p),h=kn(a);return Et([g,h],n.properties)}function An(r){if(!r)throw new Error("geojson is required");var e=[];return qn(r,function(t){ns(t,e)}),st(e)}function ns(r,e){var t=[],n=r.geometry;if(n!==null){switch(n.type){case"Polygon":t=je(n);break;case"LineString":t=[je(n)]}t.forEach(function(i){var o=rs(i,r.properties);o.forEach(function(s){s.id=e.length,e.push(s)})})}}function rs(r,e){var t=[];return r.reduce(function(n,i){var o=xt([n,i],e);return o.bbox=is(n,i),t.push(o),i}),t}function is(r,e){var t=r[0],n=r[1],i=e[0],o=e[1],s=t<i?t:i,u=n<o?n:o,l=t>i?t:i,a=n>o?n:o;return[s,u,l,a]}var Mt={},os={get exports(){return Mt},set exports(r){Mt=r}},Fn={},ss={get exports(){return Fn},set exports(r){Fn=r}};(function(r,e){(function(t,n){r.exports=n()})(Si,function(){function t(c,d,y,P,C){(function O(M,I,D,G,z){for(;G>D;){if(G-D>600){var R=G-D+1,F=I-D+1,J=Math.log(R),_e=.5*Math.exp(2*J/3),ne=.5*Math.sqrt(J*_e*(R-_e)/R)*(F-R/2<0?-1:1),pe=Math.max(D,Math.floor(I-F*_e/R+ne)),he=Math.min(G,Math.floor(I+(R-F)*_e/R+ne));O(M,I,pe,he,z)}var be=M[I],we=D,U=G;for(n(M,D,I),z(M[G],be)>0&&n(M,D,G);we<U;){for(n(M,we,U),we++,U--;z(M[we],be)<0;)we++;for(;z(M[U],be)>0;)U--}z(M[D],be)===0?n(M,D,U):n(M,++U,G),U<=I&&(D=U+1),I<=U&&(G=U-1)}})(c,d,y||0,P||c.length-1,C||i)}function n(c,d,y){var P=c[d];c[d]=c[y],c[y]=P}function i(c,d){return c<d?-1:c>d?1:0}var o=function(c){c===void 0&&(c=9),this._maxEntries=Math.max(4,c),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()};function s(c,d,y){if(!y)return d.indexOf(c);for(var P=0;P<d.length;P++)if(y(c,d[P]))return P;return-1}function u(c,d){l(c,0,c.children.length,d,c)}function l(c,d,y,P,C){C||(C=v(null)),C.minX=1/0,C.minY=1/0,C.maxX=-1/0,C.maxY=-1/0;for(var O=d;O<y;O++){var M=c.children[O];a(C,c.leaf?P(M):M)}return C}function a(c,d){return c.minX=Math.min(c.minX,d.minX),c.minY=Math.min(c.minY,d.minY),c.maxX=Math.max(c.maxX,d.maxX),c.maxY=Math.max(c.maxY,d.maxY),c}function p(c,d){return c.minX-d.minX}function g(c,d){return c.minY-d.minY}function h(c){return(c.maxX-c.minX)*(c.maxY-c.minY)}function f(c){return c.maxX-c.minX+(c.maxY-c.minY)}function m(c,d){return c.minX<=d.minX&&c.minY<=d.minY&&d.maxX<=c.maxX&&d.maxY<=c.maxY}function _(c,d){return d.minX<=c.maxX&&d.minY<=c.maxY&&d.maxX>=c.minX&&d.maxY>=c.minY}function v(c){return{children:c,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function x(c,d,y,P,C){for(var O=[d,y];O.length;)if(!((y=O.pop())-(d=O.pop())<=P)){var M=d+Math.ceil((y-d)/P/2)*P;t(c,M,d,y,C),O.push(d,M,M,y)}}return o.prototype.all=function(){return this._all(this.data,[])},o.prototype.search=function(c){var d=this.data,y=[];if(!_(c,d))return y;for(var P=this.toBBox,C=[];d;){for(var O=0;O<d.children.length;O++){var M=d.children[O],I=d.leaf?P(M):M;_(c,I)&&(d.leaf?y.push(M):m(c,I)?this._all(M,y):C.push(M))}d=C.pop()}return y},o.prototype.collides=function(c){var d=this.data;if(!_(c,d))return!1;for(var y=[];d;){for(var P=0;P<d.children.length;P++){var C=d.children[P],O=d.leaf?this.toBBox(C):C;if(_(c,O)){if(d.leaf||m(c,O))return!0;y.push(C)}}d=y.pop()}return!1},o.prototype.load=function(c){if(!c||!c.length)return this;if(c.length<this._minEntries){for(var d=0;d<c.length;d++)this.insert(c[d]);return this}var y=this._build(c.slice(),0,c.length-1,0);if(this.data.children.length)if(this.data.height===y.height)this._splitRoot(this.data,y);else{if(this.data.height<y.height){var P=this.data;this.data=y,y=P}this._insert(y,this.data.height-y.height-1,!0)}else this.data=y;return this},o.prototype.insert=function(c){return c&&this._insert(c,this.data.height-1),this},o.prototype.clear=function(){return this.data=v([]),this},o.prototype.remove=function(c,d){if(!c)return this;for(var y,P,C,O=this.data,M=this.toBBox(c),I=[],D=[];O||I.length;){if(O||(O=I.pop(),P=I[I.length-1],y=D.pop(),C=!0),O.leaf){var G=s(c,O.children,d);if(G!==-1)return O.children.splice(G,1),I.push(O),this._condense(I),this}C||O.leaf||!m(O,M)?P?(y++,O=P.children[y],C=!1):O=null:(I.push(O),D.push(y),y=0,P=O,O=O.children[0])}return this},o.prototype.toBBox=function(c){return c},o.prototype.compareMinX=function(c,d){return c.minX-d.minX},o.prototype.compareMinY=function(c,d){return c.minY-d.minY},o.prototype.toJSON=function(){return this.data},o.prototype.fromJSON=function(c){return this.data=c,this},o.prototype._all=function(c,d){for(var y=[];c;)c.leaf?d.push.apply(d,c.children):y.push.apply(y,c.children),c=y.pop();return d},o.prototype._build=function(c,d,y,P){var C,O=y-d+1,M=this._maxEntries;if(O<=M)return u(C=v(c.slice(d,y+1)),this.toBBox),C;P||(P=Math.ceil(Math.log(O)/Math.log(M)),M=Math.ceil(O/Math.pow(M,P-1))),(C=v([])).leaf=!1,C.height=P;var I=Math.ceil(O/M),D=I*Math.ceil(Math.sqrt(M));x(c,d,y,D,this.compareMinX);for(var G=d;G<=y;G+=D){var z=Math.min(G+D-1,y);x(c,G,z,I,this.compareMinY);for(var R=G;R<=z;R+=I){var F=Math.min(R+I-1,z);C.children.push(this._build(c,R,F,P-1))}}return u(C,this.toBBox),C},o.prototype._chooseSubtree=function(c,d,y,P){for(;P.push(d),!d.leaf&&P.length-1!==y;){for(var C=1/0,O=1/0,M=void 0,I=0;I<d.children.length;I++){var D=d.children[I],G=h(D),z=(R=c,F=D,(Math.max(F.maxX,R.maxX)-Math.min(F.minX,R.minX))*(Math.max(F.maxY,R.maxY)-Math.min(F.minY,R.minY))-G);z<O?(O=z,C=G<C?G:C,M=D):z===O&&G<C&&(C=G,M=D)}d=M||d.children[0]}var R,F;return d},o.prototype._insert=function(c,d,y){var P=y?c:this.toBBox(c),C=[],O=this._chooseSubtree(P,this.data,d,C);for(O.children.push(c),a(O,P);d>=0&&C[d].children.length>this._maxEntries;)this._split(C,d),d--;this._adjustParentBBoxes(P,C,d)},o.prototype._split=function(c,d){var y=c[d],P=y.children.length,C=this._minEntries;this._chooseSplitAxis(y,C,P);var O=this._chooseSplitIndex(y,C,P),M=v(y.children.splice(O,y.children.length-O));M.height=y.height,M.leaf=y.leaf,u(y,this.toBBox),u(M,this.toBBox),d?c[d-1].children.push(M):this._splitRoot(y,M)},o.prototype._splitRoot=function(c,d){this.data=v([c,d]),this.data.height=c.height+1,this.data.leaf=!1,u(this.data,this.toBBox)},o.prototype._chooseSplitIndex=function(c,d,y){for(var P,C,O,M,I,D,G,z=1/0,R=1/0,F=d;F<=y-d;F++){var J=l(c,0,F,this.toBBox),_e=l(c,F,y,this.toBBox),ne=(C=J,O=_e,M=void 0,I=void 0,D=void 0,G=void 0,M=Math.max(C.minX,O.minX),I=Math.max(C.minY,O.minY),D=Math.min(C.maxX,O.maxX),G=Math.min(C.maxY,O.maxY),Math.max(0,D-M)*Math.max(0,G-I)),pe=h(J)+h(_e);ne<z?(z=ne,P=F,R=pe<R?pe:R):ne===z&&pe<R&&(R=pe,P=F)}return P||y-d},o.prototype._chooseSplitAxis=function(c,d,y){var P=c.leaf?this.compareMinX:p,C=c.leaf?this.compareMinY:g;this._allDistMargin(c,d,y,P)<this._allDistMargin(c,d,y,C)&&c.children.sort(P)},o.prototype._allDistMargin=function(c,d,y,P){c.children.sort(P);for(var C=this.toBBox,O=l(c,0,d,C),M=l(c,y-d,y,C),I=f(O)+f(M),D=d;D<y-d;D++){var G=c.children[D];a(O,c.leaf?C(G):G),I+=f(O)}for(var z=y-d-1;z>=d;z--){var R=c.children[z];a(M,c.leaf?C(R):R),I+=f(M)}return I},o.prototype._adjustParentBBoxes=function(c,d,y){for(var P=y;P>=0;P--)a(d[P],c)},o.prototype._condense=function(c){for(var d=c.length-1,y=void 0;d>=0;d--)c[d].children.length===0?d>0?(y=c[d-1].children).splice(y.indexOf(c[d]),1):this.clear():u(c[d],this.toBBox)},o})})(ss);const ls=zn(Ei),us=zn(xi),as=zn(Mi);var Be=Fn,Vr=ls,Zr=us,yt=as.default,fs=Zr.featureEach;Zr.coordEach;Vr.polygon;var Ar=Vr.featureCollection;function Qr(r){var e=new Be(r);return e.insert=function(t){if(t.type!=="Feature")throw new Error("invalid feature");return t.bbox=t.bbox?t.bbox:yt(t),Be.prototype.insert.call(this,t)},e.load=function(t){var n=[];return Array.isArray(t)?t.forEach(function(i){if(i.type!=="Feature")throw new Error("invalid features");i.bbox=i.bbox?i.bbox:yt(i),n.push(i)}):fs(t,function(i){if(i.type!=="Feature")throw new Error("invalid features");i.bbox=i.bbox?i.bbox:yt(i),n.push(i)}),Be.prototype.load.call(this,n)},e.remove=function(t,n){if(t.type!=="Feature")throw new Error("invalid feature");return t.bbox=t.bbox?t.bbox:yt(t),Be.prototype.remove.call(this,t,n)},e.clear=function(){return Be.prototype.clear.call(this)},e.search=function(t){var n=Be.prototype.search.call(this,this.toBBox(t));return Ar(n)},e.collides=function(t){return Be.prototype.collides.call(this,this.toBBox(t))},e.all=function(){var t=Be.prototype.all.call(this);return Ar(t)},e.toJSON=function(){return Be.prototype.toJSON.call(this)},e.fromJSON=function(t){return Be.prototype.fromJSON.call(this,t)},e.toBBox=function(t){var n;if(t.bbox)n=t.bbox;else if(Array.isArray(t)&&t.length===4)n=t;else if(Array.isArray(t)&&t.length===6)n=[t[0],t[1],t[3],t[4]];else if(t.type==="Feature")n=yt(t);else if(t.type==="FeatureCollection")n=yt(t);else throw new Error("invalid geojson");return{minX:n[0],minY:n[1],maxX:n[2],maxY:n[3]}},e}os.exports=Qr;Mt.default=Qr;function ei(r,e){var t={},n=[];if(r.type==="LineString"&&(r=er(r)),e.type==="LineString"&&(e=er(e)),r.type==="Feature"&&e.type==="Feature"&&r.geometry!==null&&e.geometry!==null&&r.geometry.type==="LineString"&&e.geometry.type==="LineString"&&r.geometry.coordinates.length===2&&e.geometry.coordinates.length===2){var i=Fr(r,e);return i&&n.push(i),st(n)}var o=Mt();return o.load(An(e)),tn(An(r),function(s){tn(o.search(s),function(u){var l=Fr(s,u);if(l){var a=je(l).join(",");t[a]||(t[a]=!0,n.push(l))}})}),st(n)}function Fr(r,e){var t=je(r),n=je(e);if(t.length!==2)throw new Error("<intersects> line1 must only contain 2 coordinates");if(n.length!==2)throw new Error("<intersects> line2 must only contain 2 coordinates");var i=t[0][0],o=t[0][1],s=t[1][0],u=t[1][1],l=n[0][0],a=n[0][1],p=n[1][0],g=n[1][1],h=(g-a)*(s-i)-(p-l)*(u-o),f=(p-l)*(o-a)-(g-a)*(i-l),m=(s-i)*(o-a)-(u-o)*(i-l);if(h===0)return f===0&&m===0,null;var _=f/h,v=m/h;if(_>=0&&_<=1&&v>=0&&v<=1){var x=i+_*(s-i),c=o+_*(u-o);return Et([x,c])}return null}function Yt(r,e,t){t===void 0&&(t={});var n=Et([1/0,1/0],{dist:1/0}),i=0;return qn(r,function(o){for(var s=je(o),u=0;u<s.length-1;u++){var l=Et(s[u]);l.properties.dist=tt(e,l,t);var a=Et(s[u+1]);a.properties.dist=tt(e,a,t);var p=tt(l,a,t),g=Math.max(l.properties.dist,a.properties.dist),h=Kr(l,a),f=Or(e,g,h+90,t),m=Or(e,g,h-90,t),_=ei(xt([f.geometry.coordinates,m.geometry.coordinates]),xt([l.geometry.coordinates,a.geometry.coordinates])),v=null;_.features.length>0&&(v=_.features[0],v.properties.dist=tt(e,v,t),v.properties.location=i+tt(l,v,t)),l.properties.dist<n.properties.dist&&(n=l,n.properties.index=u,n.properties.location=i),a.properties.dist<n.properties.dist&&(n=a,n.properties.index=u+1,n.properties.location=i+p),v&&v.properties.dist<n.properties.dist&&(n=v,n.properties.index=u),i+=p}}),n}const bt="edit-polygon-mode";class cs{constructor(e){oe(this,"map");oe(this,"active");oe(this,"eventListenersSuccess");oe(this,"eventListenersFailure");oe(this,"points");oe(this,"cursor");oe(this,"hover");oe(this,"dragFrom");oe(this,"events");this.map=e,this.active=!1,this.eventListenersSuccess=[],this.eventListenersFailure=[],this.points=[],this.cursor=null,this.hover=null,this.dragFrom=null,this.events=new Xn(this,e),this.events.mapHandler("mousemove",this.onMouseMove),this.events.mapHandler("click",this.onClick),this.events.mapHandler("mousedown",this.onMouseDown),this.events.mapHandler("mouseup",this.onMouseUp),this.events.documentHandler("keypress",this.onKeypress),at(e,bt,{type:"geojson",data:$e()}),ke(e,{id:"edit-polygon-fill",source:bt,filter:$n,...Gn("red",["case",["boolean",["get","hover"],"false"],1,.5])}),ke(e,{id:"edit-polygon-lines",source:bt,filter:cn,...qt("black",8,.5)}),ke(e,{id:"edit-polygon-vertices",source:bt,filter:fn,...Pt(Pe.hovering,hn,["case",["boolean",["get","hover"],"false"],1,.5])})}finish(){let e=this.polygonFeature();if(e)for(let t of this.eventListenersSuccess)t(e);else for(let t of this.eventListenersFailure)t();this.stop()}cancel(){for(let e of this.eventListenersFailure)e();this.stop()}onMouseMove(e){if(this.active&&!this.dragFrom)this.recalculateHovering(e);else if(this.active&&this.dragFrom){if(this.hover=="polygon"){let t=this.dragFrom[0]-e.lngLat.lng,n=this.dragFrom[1]-e.lngLat.lat;for(let i of this.points)i[0]-=t,i[1]-=n}else this.points[this.hover]=e.lngLat.toArray();this.dragFrom=e.lngLat.toArray(),this.redraw()}}onClick(e){if(this.active&&this.cursor){let t=[];if(Rr(this.points).forEach((n,i)=>{t.push([i+1,Yt(n,this.cursor).properties.dist])}),t.sort((n,i)=>n[1]-i[1]),t.length>0){let n=t[0][0];this.points.splice(n,0,this.cursor.geometry.coordinates),this.hover=n}else this.points.push(this.cursor.geometry.coordinates),this.hover=this.points.length-1;this.redraw()}else this.active&&typeof this.hover=="number"&&(this.points.splice(this.hover,1),this.hover=null,this.redraw(),this.recalculateHovering(e))}onMouseDown(e){this.active&&!this.dragFrom&&this.hover!=null&&(e.preventDefault(),this.cursor=null,this.dragFrom=e.lngLat.toArray())}onMouseUp(){this.active&&this.dragFrom&&(this.dragFrom=null)}onKeypress(e){this.active&&e.key=="Enter"&&(e.preventDefault(),this.finish())}addEventListenerSuccess(e){this.eventListenersSuccess.push(e)}addEventListenerFailure(e){this.eventListenersFailure.push(e)}tearDown(){this.map.removeLayer("edit-polygon-vertices"),this.map.removeLayer("edit-polygon-fill"),this.map.removeLayer("edit-polygon-lines"),this.map.removeSource(bt),this.events.tearDown()}startNew(){this.active=!0}editExisting(e){this.active=!0,this.points=JSON.parse(JSON.stringify(e.geometry.coordinates[0])),this.points.pop(),this.redraw()}stop(){this.points=[],this.cursor=null,this.active=!1,this.hover=null,this.dragFrom=null,this.redraw()}redraw(){let e=$e();this.points.forEach((n,i)=>{let o=Tr(n);o.properties.hover=this.hover==i,o.properties.idx=i,e.features.push(o)}),this.cursor&&e.features.push(this.cursor),e.features=e.features.concat(Rr(this.points));let t=this.polygonFeature();t&&(t.properties.hover=this.hover=="polygon",e.features.push(t)),this.map.getSource(bt).setData(e)}recalculateHovering(e){this.cursor=null,this.hover=null;for(let t of this.map.queryRenderedFeatures(e.point,{layers:["edit-polygon-fill","edit-polygon-vertices"]}))if(t.geometry.type=="Polygon"){this.hover="polygon";break}else if(t.geometry.type=="Point"&&Object.hasOwn(t.properties,"idx")){this.hover=t.properties.idx;break}this.hover==null&&(this.cursor=Tr(e.lngLat.toArray())),this.redraw()}polygonFeature(){if(this.points.length<3)return null;let e=[JSON.parse(JSON.stringify(this.points))];return e[0].push(JSON.parse(JSON.stringify(e[0][0]))),{type:"Feature",geometry:{type:"Polygon",coordinates:e},properties:{}}}}function Tr(r){return{type:"Feature",properties:{},geometry:{type:"Point",coordinates:r}}}function Rr(r){let e=[];for(let t=0;t<r.length-1;t++)e.push({type:"Feature",geometry:{type:"LineString",coordinates:[r[t],r[t+1]]},properties:{}});return r.length>=3&&e.push({type:"Feature",geometry:{type:"LineString",coordinates:[r[r.length-1],r[0]]},properties:{}}),e}let X;const ti=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});ti.decode();let Vt=new Uint8Array;function Gt(){return Vt.byteLength===0&&(Vt=new Uint8Array(X.memory.buffer)),Vt}function kt(r,e){return ti.decode(Gt().subarray(r,r+e))}const Ue=new Array(32).fill(void 0);Ue.push(void 0,null,!0,!1);let jt=Ue.length;function de(r){jt===Ue.length&&Ue.push(Ue.length+1);const e=jt;return jt=Ue[e],Ue[e]=r,e}function K(r){return Ue[r]}function ps(r){r<36||(Ue[r]=jt,jt=r)}function Tn(r){const e=K(r);return ps(r),e}function vn(r){return r==null}let Zt=new Float64Array;function hs(){return Zt.byteLength===0&&(Zt=new Float64Array(X.memory.buffer)),Zt}let Qt=new Int32Array;function me(){return Qt.byteLength===0&&(Qt=new Int32Array(X.memory.buffer)),Qt}let rt=0;const en=new TextEncoder("utf-8"),ds=typeof en.encodeInto=="function"?function(r,e){return en.encodeInto(r,e)}:function(r,e){const t=en.encode(r);return e.set(t),{read:r.length,written:t.length}};function Ut(r,e,t){if(t===void 0){const u=en.encode(r),l=e(u.length);return Gt().subarray(l,l+u.length).set(u),rt=u.length,l}let n=r.length,i=e(n);const o=Gt();let s=0;for(;s<n;s++){const u=r.charCodeAt(s);if(u>127)break;o[i+s]=u}if(s!==n){s!==0&&(r=r.slice(s)),i=t(i,n,n=s+r.length*3);const u=Gt().subarray(i+s,i+n),l=ds(r,u);s+=l.written}return rt=s,i}function Rn(r){const e=typeof r;if(e=="number"||e=="boolean"||r==null)return`${r}`;if(e=="string")return`"${r}"`;if(e=="symbol"){const i=r.description;return i==null?"Symbol":`Symbol(${i})`}if(e=="function"){const i=r.name;return typeof i=="string"&&i.length>0?`Function(${i})`:"Function"}if(Array.isArray(r)){const i=r.length;let o="[";i>0&&(o+=Rn(r[0]));for(let s=1;s<i;s++)o+=", "+Rn(r[s]);return o+="]",o}const t=/\[object ([^\]]+)\]/.exec(toString.call(r));let n;if(t.length>1)n=t[1];else return toString.call(r);if(n=="Object")try{return"Object("+JSON.stringify(r)+")"}catch{return"Object"}return r instanceof Error?`${r.name}: ${r.message}
${r.stack}`:n}function ms(r,e){const t=e(r.length*1);return Gt().set(r,t/1),rt=r.length,t}function yn(r,e){try{return r.apply(this,e)}catch(t){X.__wbindgen_exn_store(de(t))}}class ln{static __wrap(e){const t=Object.create(ln.prototype);return t.ptr=e,t}__destroy_into_raw(){const e=this.ptr;return this.ptr=0,e}free(){const e=this.__destroy_into_raw();X.__wbg_jsroutesnapper_free(e)}constructor(e){try{const o=X.__wbindgen_add_to_stack_pointer(-16),s=ms(e,X.__wbindgen_malloc),u=rt;X.jsroutesnapper_new(o,s,u);var t=me()[o/4+0],n=me()[o/4+1],i=me()[o/4+2];if(i)throw Tn(n);return ln.__wrap(t)}finally{X.__wbindgen_add_to_stack_pointer(16)}}setConfig(e){X.jsroutesnapper_setConfig(this.ptr,de(e))}toFinalFeature(){try{const n=X.__wbindgen_add_to_stack_pointer(-16);X.jsroutesnapper_toFinalFeature(n,this.ptr);var e=me()[n/4+0],t=me()[n/4+1];let i;return e!==0&&(i=kt(e,t).slice(),X.__wbindgen_free(e,t*1)),i}finally{X.__wbindgen_add_to_stack_pointer(16)}}renderGeojson(){try{const n=X.__wbindgen_add_to_stack_pointer(-16);X.jsroutesnapper_renderGeojson(n,this.ptr);var e=me()[n/4+0],t=me()[n/4+1];return kt(e,t)}finally{X.__wbindgen_add_to_stack_pointer(16),X.__wbindgen_free(e,t)}}setSnapMode(e){X.jsroutesnapper_setSnapMode(this.ptr,e)}onMouseMove(e,t,n){return X.jsroutesnapper_onMouseMove(this.ptr,e,t,n)!==0}onClick(){X.jsroutesnapper_onClick(this.ptr)}onDragStart(){return X.jsroutesnapper_onDragStart(this.ptr)!==0}onMouseUp(){return X.jsroutesnapper_onMouseUp(this.ptr)!==0}clearState(){X.jsroutesnapper_clearState(this.ptr)}editExisting(e){try{const i=X.__wbindgen_add_to_stack_pointer(-16);X.jsroutesnapper_editExisting(i,this.ptr,de(e));var t=me()[i/4+0],n=me()[i/4+1];if(n)throw Tn(t)}finally{X.__wbindgen_add_to_stack_pointer(16)}}}async function gs(r,e){if(typeof Response=="function"&&r instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(r,e)}catch(n){if(r.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",n);else throw n}const t=await r.arrayBuffer();return await WebAssembly.instantiate(t,e)}else{const t=await WebAssembly.instantiate(r,e);return t instanceof WebAssembly.Instance?{instance:t,module:r}:t}}function _s(){const r={};return r.wbg={},r.wbg.__wbindgen_string_new=function(e,t){const n=kt(e,t);return de(n)},r.wbg.__wbindgen_object_drop_ref=function(e){Tn(e)},r.wbg.__wbindgen_boolean_get=function(e){const t=K(e);return typeof t=="boolean"?t?1:0:2},r.wbg.__wbindgen_error_new=function(e,t){const n=new Error(kt(e,t));return de(n)},r.wbg.__wbindgen_is_object=function(e){const t=K(e);return typeof t=="object"&&t!==null},r.wbg.__wbindgen_is_undefined=function(e){return K(e)===void 0},r.wbg.__wbindgen_in=function(e,t){return K(e)in K(t)},r.wbg.__wbindgen_number_get=function(e,t){const n=K(t),i=typeof n=="number"?n:void 0;hs()[e/8+1]=vn(i)?0:i,me()[e/4+0]=!vn(i)},r.wbg.__wbindgen_jsval_loose_eq=function(e,t){return K(e)==K(t)},r.wbg.__wbindgen_string_get=function(e,t){const n=K(t),i=typeof n=="string"?n:void 0;var o=vn(i)?0:Ut(i,X.__wbindgen_malloc,X.__wbindgen_realloc),s=rt;me()[e/4+1]=s,me()[e/4+0]=o},r.wbg.__wbg_String_91fba7ded13ba54c=function(e,t){const n=String(K(t)),i=Ut(n,X.__wbindgen_malloc,X.__wbindgen_realloc),o=rt;me()[e/4+1]=o,me()[e/4+0]=i},r.wbg.__wbindgen_object_clone_ref=function(e){const t=K(e);return de(t)},r.wbg.__wbg_getwithrefkey_15c62c2b8546208d=function(e,t){const n=K(e)[K(t)];return de(n)},r.wbg.__wbg_log_4b5638ad60bdc54a=function(e){console.log(K(e))},r.wbg.__wbg_get_57245cc7d7c7619d=function(e,t){const n=K(e)[t>>>0];return de(n)},r.wbg.__wbg_length_6e3bbe7c8bd4dbd8=function(e){return K(e).length},r.wbg.__wbindgen_is_function=function(e){return typeof K(e)=="function"},r.wbg.__wbg_next_579e583d33566a86=function(e){const t=K(e).next;return de(t)},r.wbg.__wbg_next_aaef7c8aa5e212ac=function(){return yn(function(e){const t=K(e).next();return de(t)},arguments)},r.wbg.__wbg_done_1b73b0672e15f234=function(e){return K(e).done},r.wbg.__wbg_value_1ccc36bc03462d71=function(e){const t=K(e).value;return de(t)},r.wbg.__wbg_iterator_6f9d4f28845f426c=function(){return de(Symbol.iterator)},r.wbg.__wbg_get_765201544a2b6869=function(){return yn(function(e,t){const n=Reflect.get(K(e),K(t));return de(n)},arguments)},r.wbg.__wbg_call_97ae9d8645dc388b=function(){return yn(function(e,t){const n=K(e).call(K(t));return de(n)},arguments)},r.wbg.__wbg_isArray_27c46c67f498e15d=function(e){return Array.isArray(K(e))},r.wbg.__wbg_instanceof_ArrayBuffer_e5e48f4762c5610b=function(e){let t;try{t=K(e)instanceof ArrayBuffer}catch{t=!1}return t},r.wbg.__wbg_buffer_3f3d764d4747d564=function(e){const t=K(e).buffer;return de(t)},r.wbg.__wbg_new_8c3f0052272a457a=function(e){const t=new Uint8Array(K(e));return de(t)},r.wbg.__wbg_set_83db9690f9353e79=function(e,t,n){K(e).set(K(t),n>>>0)},r.wbg.__wbg_length_9e1ae1900cb0fbd5=function(e){return K(e).length},r.wbg.__wbg_instanceof_Uint8Array_971eeda69eb75003=function(e){let t;try{t=K(e)instanceof Uint8Array}catch{t=!1}return t},r.wbg.__wbg_new_abda76e883ba8a5f=function(){const e=new Error;return de(e)},r.wbg.__wbg_stack_658279fe44541cf6=function(e,t){const n=K(t).stack,i=Ut(n,X.__wbindgen_malloc,X.__wbindgen_realloc),o=rt;me()[e/4+1]=o,me()[e/4+0]=i},r.wbg.__wbg_error_f851667af71bcfc6=function(e,t){try{console.error(kt(e,t))}finally{X.__wbindgen_free(e,t)}},r.wbg.__wbindgen_debug_string=function(e,t){const n=Rn(K(t)),i=Ut(n,X.__wbindgen_malloc,X.__wbindgen_realloc),o=rt;me()[e/4+1]=o,me()[e/4+0]=i},r.wbg.__wbindgen_throw=function(e,t){throw new Error(kt(e,t))},r.wbg.__wbindgen_memory=function(){const e=X.memory;return de(e)},r}function vs(r,e){return X=r.exports,ni.__wbindgen_wasm_module=e,Zt=new Float64Array,Qt=new Int32Array,Vt=new Uint8Array,X}async function ni(r){typeof r>"u"&&(r="/atip/planning/assets/route_snapper_bg.wasm");const e=_s();(typeof r=="string"||typeof Request=="function"&&r instanceof Request||typeof URL=="function"&&r instanceof URL)&&(r=fetch(r));const{instance:t,module:n}=await gs(await r,e);return vs(t,n)}const Jt="route-snapper",Nr=10,ys=30;class bs{constructor(e,t){oe(this,"map");oe(this,"inner");oe(this,"active");oe(this,"eventListenersSuccess");oe(this,"eventListenersFailure");oe(this,"events");this.map=e,console.time("Deserialize and setup JsRouteSnapper"),this.inner=new ln(t),console.timeEnd("Deserialize and setup JsRouteSnapper"),this.active=!1,this.eventListenersSuccess=[],this.eventListenersFailure=[],at(e,Jt,{type:"geojson",data:$e()}),ke(e,{id:"route-points",source:Jt,filter:fn,...Pt(["match",["get","type"],"hovered","green","important","red","black"],["match",["get","type"],"unimportant",Nr/2,Nr])}),ke(e,{id:"route-lines",source:Jt,filter:cn,...qt("black",2.5)}),this.events=new Xn(this,e),this.events.mapHandler("mousemove",this.onMouseMove),this.events.mapHandler("click",this.onClick),this.events.mapHandler("dragstart",this.onDragStart),this.events.mapHandler("mouseup",this.onMouseUp),this.events.documentHandler("keypress",this.onKeyPress),this.events.documentHandler("keydown",this.onKeyDown),this.events.documentHandler("keyup",this.onKeyUp)}onMouseMove(e){if(!this.active)return;const t=[e.point.x-ys,e.point.y],n=this.map.unproject(e.point).distanceTo(this.map.unproject(t));this.inner.onMouseMove(e.lngLat.lng,e.lngLat.lat,n)&&this.redraw()}onClick(){this.active&&(this.inner.onClick(),this.redraw())}onDragStart(){this.active&&this.inner.onDragStart()&&this.map.dragPan.disable()}onMouseUp(){this.active&&this.inner.onMouseUp()&&this.map.dragPan.enable()}onKeyPress(e){this.active&&e.key=="Enter"&&(e.preventDefault(),this.finish())}onKeyDown(e){this.active&&e.key=="Shift"&&(e.preventDefault(),this.inner.setSnapMode(!1),this.redraw())}onKeyUp(e){this.active&&e.key=="Shift"&&(e.preventDefault(),this.inner.setSnapMode(!0),this.redraw())}start(){this.active||(this.active=!0,this.map.boxZoom.disable())}stop(){this.active=!1,this.inner.clearState(),this.redraw(),this.map.boxZoom.enable()}editExisting(e){this.active&&window.alert("Bug: editExisting called when tool is already active"),e.properties.waypoints||(e.properties.waypoints=[{lon:e.geometry.coordinates[0][0],lat:e.geometry.coordinates[0][1],snapped:!0},{lon:e.geometry.coordinates[e.geometry.coordinates.length-1][0],lat:e.geometry.coordinates[e.geometry.coordinates.length-1][1],snapped:!0}]),this.start(),this.inner.editExisting(e.properties.waypoints),this.redraw()}tearDown(){this.map.removeLayer("route-points"),this.map.removeLayer("route-lines"),this.map.removeSource("route-snapper"),this.events.tearDown()}addEventListenerSuccess(e){this.eventListenersSuccess.push(e)}addEventListenerFailure(e){this.eventListenersFailure.push(e)}isActive(){return this.active}finish(){let e=this.inner.toFinalFeature();if(e)for(let t of this.eventListenersSuccess)t(JSON.parse(e));else for(let t of this.eventListenersFailure)t();this.stop()}cancel(){this.inner.clearState(),this.finish()}setConfig(e){this.inner.setConfig(e),this.redraw()}redraw(){this.map.getSource(Jt).setData(JSON.parse(this.inner.renderGeojson()))}}function Ir(r){let e;function t(o,s){return o[1]?ks:ws}let n=t(r),i=n(r);return{c(){i.c(),e=Ie()},m(o,s){i.m(o,s),b(o,e,s)},p(o,s){n!==(n=t(o))&&(i.d(1),i=n(o),i&&(i.c(),i.m(e.parentNode,e)))},d(o){i.d(o),o&&w(e)}}}function ws(r){let e;return{c(){e=k("p"),e.textContent="Click an intervention to fill out its attributes"},m(t,n){b(t,e,n)},d(t){t&&w(e)}}}function ks(r){let e;return{c(){e=k("p"),e.textContent="Edit attributes to the left, or click another intervention"},m(t,n){b(t,e,n)},d(t){t&&w(e)}}}function Ss(r){let e,t=r[0]==St&&Ir(r);return{c(){t&&t.c(),e=Ie()},m(n,i){t&&t.m(n,i),b(n,e,i)},p(n,[i]){n[0]==St?t?t.p(n,i):(t=Ir(n),t.c(),t.m(e.parentNode,e)):t&&(t.d(1),t=null)},i:W,o:W,d(n){t&&t.d(n),n&&w(e)}}}const St="edit-attribute";function ri(){}function Es(r,e,t){let n,i,o,s;ce(r,Ye,f=>t(5,n=f)),ce(r,fe,f=>t(6,i=f)),ce(r,Sn,f=>t(7,o=f)),ce(r,Ce,f=>t(1,s=f));let{mode:u}=e,{changeMode:l}=e;function a(){Ce.set(null)}n.on("mousemove",p),n.on("mouseout",g),n.on("click",h),Lt(()=>{n.off("mousemove",p),n.off("mouseout",g),n.off("click",h)});function p(f){var m;if(u==St){let _=n.queryRenderedFeatures(f.point,{layers:["interventions-points","interventions-lines","interventions-polygons"]});Je.set(((m=_[0])==null?void 0:m.id)||null)}}function g(){u==St&&Je.set(null)}function h(f){if(u==St){let m=n.queryRenderedFeatures(f.point,{layers:["interventions-points","interventions-lines","interventions-polygons"]});m.length>0?Ce.set(m[0].id):Ce.set(null)}}return r.$$set=f=>{"mode"in f&&t(0,u=f.mode),"changeMode"in f&&t(2,l=f.changeMode)},r.$$.update=()=>{if(r.$$.dirty&228){let f=o;if(f){let m=i.features.find(_=>_.id==f);m.geometry.type=="Point"?n.flyTo({center:m.geometry.coordinates,duration:500}):n.fitBounds(Dn(m),{padding:200,duration:500}),l(St)}}},[u,s,l,ri,a,n,i,o]}class xs extends se{constructor(e){super(),le(this,e,Es,Ss,ie,{mode:0,changeMode:2,start:3,stop:4})}get start(){return ri}get stop(){return this.$$.ctx[4]}}function Ms(r){let e,t;return{c:W,m(n,i){e||(t=Y(window,"keydown",r[0]),e=!0)},p:W,i:W,o:W,d(n){e=!1,t()}}}function Ls(r,e,t){let{tool:n}=e;function i(o){o.key=="Escape"&&(n.cancel(),o.preventDefault())}return r.$$set=o=>{"tool"in o&&t(1,n=o.tool)},[i,n]}class Un extends se{constructor(e){super(),le(this,e,Ls,Ms,ie,{tool:1})}}function Ps(r){let e;return{c(){e=k("p"),e.textContent="Click to add a new point"},m(t,n){b(t,e,n)},d(t){t&&w(e)}}}function Cs(r){let e;return{c(){e=k("p"),e.textContent="Click to move the point here"},m(t,n){b(t,e,n)},d(t){t&&w(e)}}}function Os(r){let e,t,n,i,o,s,u,l,a;function p(f,m){return f[1]?Cs:Ps}let g=p(r),h=g(r);return s=new Un({props:{tool:r[0]}}),{c(){h.c(),e=L(),t=k("p"),t.innerHTML="Press <b>Escape</b> to cancel",n=L(),i=k("button"),i.textContent="Cancel",o=L(),Q(s.$$.fragment),A(i,"type","button")},m(f,m){h.m(f,m),b(f,e,m),b(f,t,m),b(f,n,m),b(f,i,m),b(f,o,m),ee(s,f,m),u=!0,l||(a=Y(i,"click",r[2]),l=!0)},p(f,[m]){g!==(g=p(f))&&(h.d(1),h=g(f),h&&(h.c(),h.m(e.parentNode,e)));const _={};m&1&&(_.tool=f[0]),s.$set(_)},i(f){u||(B(s.$$.fragment,f),u=!0)},o(f){j(s.$$.fragment,f),u=!1},d(f){h.d(f),f&&w(e),f&&w(t),f&&w(n),f&&w(i),f&&w(o),te(s,f),l=!1,a()}}}function As(r,e,t){let{pointTool:n}=e,{editingExisting:i}=e;const o=()=>n.cancel();return r.$$set=s=>{"pointTool"in s&&t(0,n=s.pointTool),"editingExisting"in s&&t(1,i=s.editingExisting)},[n,i,o]}class ii extends se{constructor(e){super(),le(this,e,As,Os,ie,{pointTool:0,editingExisting:1})}}function Fs(r){let e,t,n,i,o,s,u,l,a,p,g;return l=new Un({props:{tool:r[0]}}),{c(){e=k("ul"),e.innerHTML=`<li><b>Click</b> the map to add a vertex</li> 
  <li><b>Click</b> a vertex to delete it</li> 
  <li><b>Drag</b> a vertex or the polygon to move it</li> 
  <li>Press <b>Enter</b> to finish</li> 
  <li>Press <b>Escape</b> to cancel</li>`,t=L(),n=k("div"),i=k("button"),i.textContent="Finish",o=L(),s=k("button"),s.textContent="Cancel",u=L(),Q(l.$$.fragment),A(i,"type","button"),A(s,"type","button"),ge(n,"display","flex"),ge(n,"justify-content","space-between")},m(h,f){b(h,e,f),b(h,t,f),b(h,n,f),S(n,i),S(n,o),S(n,s),b(h,u,f),ee(l,h,f),a=!0,p||(g=[Y(i,"click",r[1]),Y(s,"click",r[2])],p=!0)},p(h,[f]){const m={};f&1&&(m.tool=h[0]),l.$set(m)},i(h){a||(B(l.$$.fragment,h),a=!0)},o(h){j(l.$$.fragment,h),a=!1},d(h){h&&w(e),h&&w(t),h&&w(n),h&&w(u),te(l,h),p=!1,We(g)}}}function Ts(r,e,t){let{polygonTool:n}=e;const i=()=>n.finish(),o=()=>n.cancel();return r.$$set=s=>{"polygonTool"in s&&t(0,n=s.polygonTool)},[n,i,o]}class oi extends se{constructor(e){super(),le(this,e,Ts,Fs,ie,{polygonTool:0})}}function Rs(r){let e,t,n,i,o,s,u,l,a,p,g,h,f,m,_;return h=new Un({props:{tool:r[0]}}),{c(){e=k("ul"),e.innerHTML=`<li><b>Click</b> green points on the transport network to create snapped routes</li> 
  <li>Hold <b>Shift</b> to draw a point anywhere</li> 
  <li><b>Click and drag</b> any point to move it</li> 
  <li><b>Click</b> a red waypoint to delete it</li> 
  <li>Press <b>Enter</b> to finish route</li> 
  <li>Press <b>Escape</b> to cancel</li>`,t=L(),n=k("label"),i=k("input"),o=V(`
  Avoid doubling back`),s=L(),u=k("div"),l=k("button"),l.textContent="Finish",a=L(),p=k("button"),p.textContent="Cancel",g=L(),Q(h.$$.fragment),A(i,"type","checkbox"),A(l,"type","button"),A(p,"type","button"),ge(u,"display","flex"),ge(u,"justify-content","space-between")},m(v,x){b(v,e,x),b(v,t,x),b(v,n,x),S(n,i),i.checked=r[1],S(n,o),b(v,s,x),b(v,u,x),S(u,l),S(u,a),S(u,p),b(v,g,x),ee(h,v,x),f=!0,m||(_=[Y(i,"change",r[2]),Y(l,"click",r[3]),Y(p,"click",r[4])],m=!0)},p(v,[x]){x&2&&(i.checked=v[1]);const c={};x&1&&(c.tool=v[0]),h.$set(c)},i(v){f||(B(h.$$.fragment,v),f=!0)},o(v){j(h.$$.fragment,v),f=!1},d(v){v&&w(e),v&&w(t),v&&w(n),v&&w(s),v&&w(u),v&&w(g),te(h,v),m=!1,We(_)}}}function Ns(r,e,t){let{routeTool:n}=e,i=!1;function o(){i=this.checked,t(1,i)}const s=()=>n.finish(),u=()=>n.cancel();return r.$$set=l=>{"routeTool"in l&&t(0,n=l.routeTool)},r.$$.update=()=>{r.$$.dirty&3&&n.setConfig({avoid_doubling_back:i})},[n,i,o,s,u]}class si extends se{constructor(e){super(),le(this,e,Ns,Rs,ie,{routeTool:0})}}function Br(r){let e,t,n,i;const o=[Gs,Ds,Bs,Is],s=[];function u(l,a){return l[4]=="point"?0:l[4]=="polygon"?1:l[4]=="route"?2:3}return e=u(r),t=s[e]=o[e](r),{c(){t.c(),n=Ie()},m(l,a){s[e].m(l,a),b(l,n,a),i=!0},p(l,a){let p=e;e=u(l),e===p?s[e].p(l,a):(qe(),j(s[p],1,1,()=>{s[p]=null}),ze(),t=s[e],t?t.p(l,a):(t=s[e]=o[e](l),t.c()),B(t,1),t.m(n.parentNode,n))},i(l){i||(B(t),i=!0)},o(l){j(t),i=!1},d(l){s[e].d(l),l&&w(n)}}}function Is(r){let e;return{c(){e=k("p"),e.textContent="Click an intervention to edit its geometry"},m(t,n){b(t,e,n)},p:W,i:W,o:W,d(t){t&&w(e)}}}function Bs(r){let e,t;return e=new si({props:{routeTool:r[3]}}),{c(){Q(e.$$.fragment)},m(n,i){ee(e,n,i),t=!0},p(n,i){const o={};i&8&&(o.routeTool=n[3]),e.$set(o)},i(n){t||(B(e.$$.fragment,n),t=!0)},o(n){j(e.$$.fragment,n),t=!1},d(n){te(e,n)}}}function Ds(r){let e,t;return e=new oi({props:{polygonTool:r[2]}}),{c(){Q(e.$$.fragment)},m(n,i){ee(e,n,i),t=!0},p(n,i){const o={};i&4&&(o.polygonTool=n[2]),e.$set(o)},i(n){t||(B(e.$$.fragment,n),t=!0)},o(n){j(e.$$.fragment,n),t=!1},d(n){te(e,n)}}}function Gs(r){let e,t;return e=new ii({props:{pointTool:r[1],editingExisting:!0}}),{c(){Q(e.$$.fragment)},m(n,i){ee(e,n,i),t=!0},p(n,i){const o={};i&2&&(o.pointTool=n[1]),e.$set(o)},i(n){t||(B(e.$$.fragment,n),t=!0)},o(n){j(e.$$.fragment,n),t=!1},d(n){te(e,n)}}}function js(r){let e,t,n=r[0]==Qe&&Br(r);return{c(){n&&n.c(),e=Ie()},m(i,o){n&&n.m(i,o),b(i,e,o),t=!0},p(i,[o]){i[0]==Qe?n?(n.p(i,o),o&1&&B(n,1)):(n=Br(i),n.c(),B(n,1),n.m(e.parentNode,e)):n&&(qe(),j(n,1,1,()=>{n=null}),ze())},i(i){t||(B(n),t=!0)},o(i){j(n),t=!1},d(i){n&&n.d(i),i&&w(e)}}}const Qe="edit-geometry";function li(){}function $s(r,e,t){let n;ce(r,Ye,_=>t(8,n=_));let{mode:i}=e,{pointTool:o}=e,{polygonTool:s}=e,{routeTool:u}=e,l=null,a=null;function p(){l&&(o.stop(),s.stop(),u.stop(),fe.update(_=>{let v=_.features.find(x=>x.id==l);return delete v.properties.hide_while_editing,_})),l=null,t(4,a=null),Je.set(null)}n.on("mousemove",g),n.on("mouseout",h),n.on("click",f),Lt(()=>{n.off("mousemove",g),n.off("mouseout",h),n.off("click",f)}),u.addEventListenerSuccess(_=>{i==Qe&&(fe.update(v=>{let x=v.features.find(c=>c.id==l);return x.properties.length_meters=_.properties.length_meters,x.properties.waypoints=_.properties.waypoints,delete x.properties.hide_while_editing,x.geometry=_.geometry,v}),l=null,t(4,a=null))});for(let _ of[o,s])_.addEventListenerSuccess(v=>{i==Qe&&(fe.update(x=>{let c=x.features.find(d=>d.id==l);return c.geometry=v.geometry,delete c.properties.hide_while_editing,x}),l=null,t(4,a=null))});for(let _ of[o,s,u])_.addEventListenerFailure(()=>{i==Qe&&(fe.update(v=>{let x=v.features.find(c=>c.id==l);return delete x.properties.hide_while_editing,v}),l=null,t(4,a=null))});function g(_){var v;if(i==Qe&&l==null){let x=n.queryRenderedFeatures(_.point,{layers:["interventions-points","interventions-lines","interventions-polygons"]});Je.set(((v=x[0])==null?void 0:v.id)||null)}}function h(){i==Qe&&l==null&&Je.set(null)}function f(_){if(i==Qe&&l==null){let v=n.queryRenderedFeatures(_.point,{layers:["interventions-points","interventions-lines","interventions-polygons"]});v.length>0&&m(v[0].id)}}function m(_){Je.set(null);let v=null;fe.update(c=>(v=c.features.find(d=>d.id==_),v.properties.hide_while_editing=!0,c));let x=v;l=_,x.geometry.type=="LineString"?(u.editExisting(x),t(4,a="route")):x.geometry.type=="Polygon"?(s.editExisting(x),t(4,a="polygon")):x.geometry.type=="Point"&&(o.start(),t(4,a="point"))}return r.$$set=_=>{"mode"in _&&t(0,i=_.mode),"pointTool"in _&&t(1,o=_.pointTool),"polygonTool"in _&&t(2,s=_.polygonTool),"routeTool"in _&&t(3,u=_.routeTool)},[i,o,s,u,a,li,p]}class qs extends se{constructor(e){super(),le(this,e,$s,js,ie,{mode:0,pointTool:1,polygonTool:2,routeTool:3,start:5,stop:6})}get start(){return li}get stop(){return this.$$.ctx[6]}}async function zs(r,e){const t=await fetch(r),n=t.body.getReader(),i=t.headers.get("Content-Length");let o=0,s=[];for(;;){const{done:a,value:p}=await n.read();if(a)break;s.push(p),o+=p.length;const g=100*o/i;e.style=`background: linear-gradient(to right, red ${g}%, transparent 0);`}let u=new Uint8Array(o),l=0;for(let a of s)u.set(a,l),l+=a.length;return u}function Ys(r){let e,t;return e=new si({props:{routeTool:r[0]}}),{c(){Q(e.$$.fragment)},m(n,i){ee(e,n,i),t=!0},p(n,i){const o={};i&1&&(o.routeTool=n[0]),e.$set(o)},i(n){t||(B(e.$$.fragment,n),t=!0)},o(n){j(e.$$.fragment,n),t=!1},d(n){te(e,n)}}}function Hs(r){let e;return{c(){e=k("div"),e.textContent="Route tool loading..."},m(t,n){b(t,e,n),r[7](e)},p:W,i:W,o:W,d(t){t&&w(e),r[7](null)}}}function Xs(r){let e,t,n,i;const o=[Hs,Ys],s=[];function u(l,a){return l[0]?l[1]==Nn?1:-1:0}return~(e=u(r))&&(t=s[e]=o[e](r)),{c(){t&&t.c(),n=Ie()},m(l,a){~e&&s[e].m(l,a),b(l,n,a),i=!0},p(l,[a]){let p=e;e=u(l),e===p?~e&&s[e].p(l,a):(t&&(qe(),j(s[p],1,1,()=>{s[p]=null}),ze()),~e?(t=s[e],t?t.p(l,a):(t=s[e]=o[e](l),t.c()),B(t,1),t.m(n.parentNode,n)):t=null)},i(l){i||(B(t),i=!0)},o(l){j(t),i=!1},d(l){~e&&s[e].d(l),l&&w(n)}}}const Nn="route";function Us(r,e,t){let n;ce(r,Ye,h=>t(8,n=h));let{mode:i}=e,{changeMode:o}=e,{url:s}=e,u,{routeTool:l}=e;function a(){l.isActive()||l.start()}function p(){l==null||l.stop()}Bn(async()=>{await ni(),console.log(`Grabbing ${s}`);try{const h=await zs(s,u);t(0,l=new bs(n,h))}catch(h){console.log(`Route tool broke: ${h}`),t(2,u.innerHTML="Failed to load",u);return}l.addEventListenerFailure(()=>{i==Nn&&o("edit-attribute")}),l.addEventListenerSuccess(h=>{i==Nn&&(fe.update(f=>(h.id=pn(f),h.properties.intervention_type="route",f.features.push(h),f)),o("edit-attribute"),Ce.set(h.id))})}),Lt(()=>{l==null||l.tearDown()});function g(h){ve[h?"unshift":"push"](()=>{u=h,t(2,u)})}return r.$$set=h=>{"mode"in h&&t(1,i=h.mode),"changeMode"in h&&t(3,o=h.changeMode),"url"in h&&t(4,s=h.url),"routeTool"in h&&t(0,l=h.routeTool)},[l,i,u,o,s,a,p,g]}class Js extends se{constructor(e){super(),le(this,e,Us,Xs,ie,{mode:1,changeMode:3,url:4,routeTool:0,start:5,stop:6})}get start(){return this.$$.ctx[5]}get stop(){return this.$$.ctx[6]}}function Dr(r){let e,t;return e=new ii({props:{pointTool:r[1],editingExisting:!1}}),{c(){Q(e.$$.fragment)},m(n,i){ee(e,n,i),t=!0},p(n,i){const o={};i&2&&(o.pointTool=n[1]),e.$set(o)},i(n){t||(B(e.$$.fragment,n),t=!0)},o(n){j(e.$$.fragment,n),t=!1},d(n){te(e,n)}}}function Ws(r){let e,t,n=r[0]==un&&Dr(r);return{c(){n&&n.c(),e=Ie()},m(i,o){n&&n.m(i,o),b(i,e,o),t=!0},p(i,[o]){i[0]==un?n?(n.p(i,o),o&1&&B(n,1)):(n=Dr(i),n.c(),B(n,1),n.m(e.parentNode,e)):n&&(qe(),j(n,1,1,()=>{n=null}),ze())},i(i){t||(B(n),t=!0)},o(i){j(n),t=!1},d(i){n&&n.d(i),i&&w(e)}}}const un="point";function Ks(r,e,t){let{mode:n}=e,{changeMode:i}=e,{pointTool:o}=e;function s(){o.start()}function u(){o.stop()}return o.addEventListenerSuccess(l=>{n==un&&(fe.update(a=>(l.id=pn(a),l.properties.intervention_type="other",a.features.push(l),a)),i("edit-attribute"),Ce.set(l.id))}),o.addEventListenerFailure(()=>{n==un&&i("edit-attribute")}),r.$$set=l=>{"mode"in l&&t(0,n=l.mode),"changeMode"in l&&t(2,i=l.changeMode),"pointTool"in l&&t(1,o=l.pointTool)},[n,o,i,s,u]}class Vs extends se{constructor(e){super(),le(this,e,Ks,Ws,ie,{mode:0,changeMode:2,pointTool:1,start:3,stop:4})}get start(){return this.$$.ctx[3]}get stop(){return this.$$.ctx[4]}}function Gr(r){let e,t;return e=new oi({props:{polygonTool:r[1]}}),{c(){Q(e.$$.fragment)},m(n,i){ee(e,n,i),t=!0},p(n,i){const o={};i&2&&(o.polygonTool=n[1]),e.$set(o)},i(n){t||(B(e.$$.fragment,n),t=!0)},o(n){j(e.$$.fragment,n),t=!1},d(n){te(e,n)}}}function Zs(r){let e,t,n=r[0]==an&&Gr(r);return{c(){n&&n.c(),e=Ie()},m(i,o){n&&n.m(i,o),b(i,e,o),t=!0},p(i,[o]){i[0]==an?n?(n.p(i,o),o&1&&B(n,1)):(n=Gr(i),n.c(),B(n,1),n.m(e.parentNode,e)):n&&(qe(),j(n,1,1,()=>{n=null}),ze())},i(i){t||(B(n),t=!0)},o(i){j(n),t=!1},d(i){n&&n.d(i),i&&w(e)}}}const an="polygon";function Qs(r,e,t){let{mode:n}=e,{changeMode:i}=e,{polygonTool:o}=e;function s(){o.startNew()}function u(){o.stop()}return o.addEventListenerSuccess(l=>{n==an&&(fe.update(a=>(l.id=pn(a),l.properties.intervention_type="area",a.features.push(l),a)),i("edit-attribute"),Ce.set(l.id))}),o.addEventListenerFailure(()=>{n==an&&i("edit-attribute")}),r.$$set=l=>{"mode"in l&&t(0,n=l.mode),"changeMode"in l&&t(2,i=l.changeMode),"polygonTool"in l&&t(1,o=l.polygonTool)},[n,o,i,s,u]}class el extends se{constructor(e){super(),le(this,e,Qs,Zs,ie,{mode:0,changeMode:2,polygonTool:1,start:3,stop:4})}get start(){return this.$$.ctx[3]}get stop(){return this.$$.ctx[4]}}function tl(r){var e=r[0],t=r[1],n=r[2],i=r[3],o=tt(r.slice(0,2),[n,t]),s=tt(r.slice(0,2),[e,i]);if(o>=s){var u=(t+i)/2;return[e,u-(n-e)/2,n,u+(n-e)/2]}else{var l=(e+n)/2;return[l-(i-t)/2,t,l+(i-t)/2,i]}}function nl(r,e){e===void 0&&(e={});var t=e.precision,n=e.coordinates,i=e.mutate;if(t=t==null||isNaN(t)?6:t,n=n==null||isNaN(n)?3:n,!r)throw new Error("<geojson> is required");if(typeof t!="number")throw new Error("<precision> must be a number");if(typeof n!="number")throw new Error("<coordinates> must be a number");(i===!1||i===void 0)&&(r=JSON.parse(JSON.stringify(r)));var o=Math.pow(10,t);return Li(r,function(s){rl(s,o,n)}),r}function rl(r,e,t){r.length>t&&r.splice(t,r.length);for(var n=0;n<r.length;n++)r[n]=Math.round(r[n]*e)/e;return r}function il(r,e){if(!r)throw new Error("line is required");if(!e)throw new Error("splitter is required");var t=On(r),n=On(e);if(t!=="LineString")throw new Error("line must be LineString");if(n==="FeatureCollection")throw new Error("splitter cannot be a FeatureCollection");if(n==="GeometryCollection")throw new Error("splitter cannot be a GeometryCollection");var i=nl(e,{precision:7});switch(n){case"Point":return In(r,i);case"MultiPoint":return jr(r,i);case"LineString":case"MultiLineString":case"Polygon":case"MultiPolygon":return jr(r,ei(r,i))}}function jr(r,e){var t=[],n=Mt();return qn(e,function(i){if(t.forEach(function(u,l){u.id=l}),!t.length)t=In(r,i).features,t.forEach(function(u){u.bbox||(u.bbox=tl(Pi(u)))}),n.load(st(t));else{var o=n.search(i);if(o.features.length){var s=ui(i,o);t=t.filter(function(u){return u.id!==s.id}),n.remove(s),tn(In(s,i),function(u){t.push(u),n.insert(u)})}}}),st(t)}function In(r,e){var t=[],n=je(r)[0],i=je(r)[r.geometry.coordinates.length-1];if(bn(n,lt(e))||bn(i,lt(e)))return st([r]);var o=Mt(),s=An(r);o.load(s);var u=o.search(e);if(!u.features.length)return st([r]);var l=ui(e,u),a=[n],p=Ci(s,function(g,h,f){var m=je(h)[1],_=lt(e);return f===l.id?(g.push(_),t.push(xt(g)),bn(_,m)?[_]:[_,m]):(g.push(m),g)},a);return p.length>1&&t.push(xt(p)),st(t)}function ui(r,e){if(!e.features.length)throw new Error("lines must contain features");if(e.features.length===1)return e.features[0];var t,n=1/0;return tn(e,function(i){var o=Yt(i,r),s=o.properties.dist;s<n&&(t=i,n=s)}),t}function bn(r,e){return r[0]===e[0]&&r[1]===e[1]}function ol(r,e,t){var n=je(t);if(On(t)!=="LineString")throw new Error("line must be a LineString");var i=Yt(t,r),o=Yt(t,e),s;i.properties.index<=o.properties.index?s=[i,o]:s=[o,i];for(var u=[s[0].geometry.coordinates],l=s[0].properties.index+1;l<s[1].properties.index+1;l++)u.push(n[l]);return u.push(s[1].geometry.coordinates),xt(u,t.properties)}function $r(r){let e;return{c(){e=k("ul"),e.innerHTML=`<li><b>Click</b> near a route to split it</li> 
    <li><b>Click</b> on the map or press <b>Escape</b> to cancel</li>`},m(t,n){b(t,e,n)},d(t){t&&w(e)}}}function sl(r){let e,t,n,i=r[0]==$t&&$r();return{c(){i&&i.c(),e=Ie()},m(o,s){i&&i.m(o,s),b(o,e,s),t||(n=Y(window,"keydown",r[1]),t=!0)},p(o,[s]){o[0]==$t?i||(i=$r(),i.c(),i.m(e.parentNode,e)):i&&(i.d(1),i=null)},i:W,o:W,d(o){i&&i.d(o),o&&w(e),t=!1,n()}}}const $t="split-route",ll=10,ul=30;let wn="split-route";function ai(){}function qr(r,e){return{type:"Feature",properties:{snapped:e},geometry:{type:"Point",coordinates:r}}}function al(r,e,t){let n,i;ce(r,fe,_=>t(8,n=_)),ce(r,Ye,_=>t(6,i=_));let{mode:o}=e,{changeMode:s}=e;function u(){t(5,l=null),a=null}let l=null,a=null;i.on("mousemove",p),i.on("click",g),Lt(()=>{i.off("mousemove",p),i.off("click",g)}),at(i,wn,{type:"geojson",data:$e()}),ke(i,{id:"draw-split-route",source:wn,...Pt("black",ll,["case",["==",["get","snapped"],!0],1,.5])});function p(_){if(o!=$t)return;t(5,l=qr(_.lngLat.toArray(),!1)),a=null;const v=[_.point.x-ul,_.point.y],x=i.unproject(_.point).distanceTo(i.unproject(v))/1e3;let c=[];for(let[d,y]of n.features.entries())if(y.geometry.type=="LineString"){let P=Yt(y.geometry,l,{units:"kilometers"});P.properties.dist!=null&&P.properties.dist<=x&&c.push([d,P.geometry.coordinates,P.properties.dist])}c.sort((d,y)=>d[2]-y[2]),c.length>0&&(t(5,l=qr(c[0][1],!0)),a=c[0][0])}function g(){if(o==$t)if(a==null)s("edit-attribute");else{let _=il(n.features[a],l);if(_.features.length==2){let v=_.features[0],x=_.features[1];fe.update(c=>(v.id=c.features[a].id,x.id=pn(c),v.properties=JSON.parse(JSON.stringify(c.features[a].properties)),x.properties=JSON.parse(JSON.stringify(v.properties)),h(c.features[a],v,x,l),c.features.splice(a,1,v,x),c))}u()}}function h(_,v,x,c){v.properties.length_meters=Kt(v,{units:"kilometers"})*1e3,x.properties.length_meters=Kt(x,{units:"kilometers"})*1e3,v.properties.waypoints=[],x.properties.waypoints=[];let d=f(_,c),y=!0,P=0;for(let C of _.properties.waypoints){let O=f(_,Et([C.lon,C.lat]));if(y)if(O<d)v.properties.waypoints.push(C);else{let M=C.snapped&&_.properties.waypoints[P-1].snapped;v.properties.waypoints.push({lon:c.geometry.coordinates[0],lat:c.geometry.coordinates[1],snapped:M}),y=!1,x.properties.waypoints.push({lon:c.geometry.coordinates[0],lat:c.geometry.coordinates[1],snapped:M}),x.properties.waypoints.push(C)}else x.properties.waypoints.push(C);P++}}function f(_,v){let x=_.geometry.coordinates[0],c=ol(x,v,_);return Kt(c,{units:"kilometers"})*1e3}function m(_){o==$t&&_.key=="Escape"&&(s("edit-attribute"),_.preventDefault())}return r.$$set=_=>{"mode"in _&&t(0,o=_.mode),"changeMode"in _&&t(2,s=_.changeMode)},r.$$.update=()=>{if(r.$$.dirty&96){let _=$e();l&&_.features.push(l),i.getSource(wn).setData(_)}},[o,m,s,ai,u,l,i]}class fl extends se{constructor(e){super(),le(this,e,al,sl,ie,{mode:0,changeMode:2,start:3,stop:4})}get start(){return ai}get stop(){return this.$$.ctx[4]}}function zr(r){let e,t,n={mode:r[3],pointTool:r[10],polygonTool:r[11],routeTool:r[2]};return e=new qs({props:n}),r[16](e),{c(){Q(e.$$.fragment)},m(i,o){ee(e,i,o),t=!0},p(i,o){const s={};o&8&&(s.mode=i[3]),o&4&&(s.routeTool=i[2]),e.$set(s)},i(i){t||(B(e.$$.fragment,i),t=!0)},o(i){j(e.$$.fragment,i),t=!1},d(i){r[16](null),te(e,i)}}}function Yr(r){let e,t,n,i,o;return{c(){e=k("button"),t=V("New point"),A(e,"type","button"),e.disabled=n=r[3]=="point",A(e,"class","svelte-cej5os")},m(s,u){b(s,e,u),S(e,t),i||(o=Y(e,"click",r[17]),i=!0)},p(s,u){u&8&&n!==(n=s[3]=="point")&&(e.disabled=n)},d(s){s&&w(e),i=!1,o()}}}function Hr(r){let e,t,n,i,o;return{c(){e=k("button"),t=V("New route"),A(e,"type","button"),e.disabled=n=r[3]=="route",A(e,"class","svelte-cej5os")},m(s,u){b(s,e,u),S(e,t),i||(o=Y(e,"click",r[21]),i=!0)},p(s,u){u&8&&n!==(n=s[3]=="route")&&(e.disabled=n)},d(s){s&&w(e),i=!1,o()}}}function Xr(r){let e,t,n,i,o;return{c(){e=k("button"),t=V("Split route"),A(e,"type","button"),e.disabled=n=r[3]=="split-route",A(e,"class","svelte-cej5os")},m(s,u){b(s,e,u),S(e,t),i||(o=Y(e,"click",r[24]),i=!0)},p(s,u){u&8&&n!==(n=s[3]=="split-route")&&(e.disabled=n)},d(s){s&&w(e),i=!1,o()}}}function cl(r){let e,t,n,i,o,s,u,l,a,p,g,h,f,m,_,v,x,c,d,y,P,C,O,M,I,D,G,z,R,F,J,_e,ne,pe,he,be,we={mode:r[3],changeMode:r[12]};u=new xs({props:we}),r[14](u);let U=r[2]&&zr(r),ue=!r[1]&&Yr(r),Ke={mode:r[3],changeMode:r[12],pointTool:r[10]};x=new Vs({props:Ke}),r[18](x);let ye={mode:r[3],changeMode:r[12],polygonTool:r[11]};M=new el({props:ye}),r[20](M);let re=!r[1]&&Hr(r);function Fe(q){r[23](q)}let He={mode:r[3],changeMode:r[12],url:r[0]};r[2]!==void 0&&(He.routeTool=r[2]),z=new Js({props:He}),r[22](z),ve.push(()=>it(z,"routeTool",Fe,r[2]));let ae=!r[1]&&Xr(r),Xe={mode:r[3],changeMode:r[12]};return ne=new fl({props:Xe}),r[25](ne),{c(){e=k("div"),t=k("div"),n=k("button"),i=V("Edit attributes"),s=L(),Q(u.$$.fragment),l=L(),a=k("div"),p=k("button"),g=V("Edit geometry"),f=L(),U&&U.c(),m=L(),_=k("div"),ue&&ue.c(),v=L(),Q(x.$$.fragment),c=L(),d=k("div"),y=k("button"),P=V("New polygon"),O=L(),Q(M.$$.fragment),I=L(),D=k("div"),re&&re.c(),G=L(),Q(z.$$.fragment),F=L(),J=k("div"),ae&&ae.c(),_e=L(),Q(ne.$$.fragment),A(n,"type","button"),n.disabled=o=r[3]=="edit-attribute",A(n,"class","svelte-cej5os"),A(p,"type","button"),p.disabled=h=r[3]=="edit-geometry",A(p,"class","svelte-cej5os"),A(y,"type","button"),y.disabled=C=r[3]=="polygon",A(y,"class","svelte-cej5os"),A(e,"class","toolbox svelte-cej5os")},m(q,Z){b(q,e,Z),S(e,t),S(t,n),S(n,i),S(t,s),ee(u,t,null),S(e,l),S(e,a),S(a,p),S(p,g),S(a,f),U&&U.m(a,null),S(e,m),S(e,_),ue&&ue.m(_,null),S(_,v),ee(x,_,null),S(e,c),S(e,d),S(d,y),S(y,P),S(d,O),ee(M,d,null),S(e,I),S(e,D),re&&re.m(D,null),S(D,G),ee(z,D,null),S(e,F),S(e,J),ae&&ae.m(J,null),S(J,_e),ee(ne,J,null),pe=!0,he||(be=[Y(n,"click",r[13]),Y(p,"click",r[15]),Y(y,"click",r[19])],he=!0)},p(q,[Z]){(!pe||Z&8&&o!==(o=q[3]=="edit-attribute"))&&(n.disabled=o);const T={};Z&8&&(T.mode=q[3]),u.$set(T),(!pe||Z&8&&h!==(h=q[3]=="edit-geometry"))&&(p.disabled=h),q[2]?U?(U.p(q,Z),Z&4&&B(U,1)):(U=zr(q),U.c(),B(U,1),U.m(a,null)):U&&(qe(),j(U,1,1,()=>{U=null}),ze()),q[1]?ue&&(ue.d(1),ue=null):ue?ue.p(q,Z):(ue=Yr(q),ue.c(),ue.m(_,v));const H={};Z&8&&(H.mode=q[3]),x.$set(H),(!pe||Z&8&&C!==(C=q[3]=="polygon"))&&(y.disabled=C);const ft={};Z&8&&(ft.mode=q[3]),M.$set(ft),q[1]?re&&(re.d(1),re=null):re?re.p(q,Z):(re=Hr(q),re.c(),re.m(D,G));const Ve={};Z&8&&(Ve.mode=q[3]),Z&1&&(Ve.url=q[0]),!R&&Z&4&&(R=!0,Ve.routeTool=q[2],ot(()=>R=!1)),z.$set(Ve),q[1]?ae&&(ae.d(1),ae=null):ae?ae.p(q,Z):(ae=Xr(q),ae.c(),ae.m(J,_e));const ct={};Z&8&&(ct.mode=q[3]),ne.$set(ct)},i(q){pe||(B(u.$$.fragment,q),B(U),B(x.$$.fragment,q),B(M.$$.fragment,q),B(z.$$.fragment,q),B(ne.$$.fragment,q),pe=!0)},o(q){j(u.$$.fragment,q),j(U),j(x.$$.fragment,q),j(M.$$.fragment,q),j(z.$$.fragment,q),j(ne.$$.fragment,q),pe=!1},d(q){q&&w(e),r[14](null),te(u),U&&U.d(),ue&&ue.d(),r[18](null),te(x),r[20](null),te(M),re&&re.d(),r[22](null),te(z),ae&&ae.d(),r[25](null),te(ne),he=!1,We(be)}}}function pl(r,e,t){let n;ce(r,Ye,F=>t(26,n=F));let{routeUrl:i}=e,{planningMode:o}=e,s,u=new Qo(n),l=new cs(n),a="edit-attribute",p,g,h,f,m,_;function v(F){let J={"edit-attribute":p,"edit-geometry":g,route:h,point:f,polygon:m,"split-route":_};if(a==F){console.log(`Mode is already ${a}, not changing`);return}console.log(`Stopping old mode ${a}`),J[a].stop(),t(3,a=F),console.log(`Starting new mode ${a}`),J[a].start()}Lt(()=>{u==null||u.tearDown(),l==null||l.tearDown()});const x=()=>v("edit-attribute");function c(F){ve[F?"unshift":"push"](()=>{p=F,t(4,p)})}const d=()=>v("edit-geometry");function y(F){ve[F?"unshift":"push"](()=>{g=F,t(5,g)})}const P=()=>v("point");function C(F){ve[F?"unshift":"push"](()=>{f=F,t(7,f)})}const O=()=>v("polygon");function M(F){ve[F?"unshift":"push"](()=>{m=F,t(8,m)})}const I=()=>v("route");function D(F){ve[F?"unshift":"push"](()=>{h=F,t(6,h)})}function G(F){s=F,t(2,s)}const z=()=>v("split-route");function R(F){ve[F?"unshift":"push"](()=>{_=F,t(9,_)})}return r.$$set=F=>{"routeUrl"in F&&t(0,i=F.routeUrl),"planningMode"in F&&t(1,o=F.planningMode)},[i,o,s,a,p,g,h,f,m,_,u,l,v,x,c,d,y,P,C,O,M,I,D,G,z,R]}class hl extends se{constructor(e){super(),le(this,e,pl,cl,ie,{routeUrl:0,planningMode:1})}}function dl(r){let e,t,n,i,o,s,u,l;return{c(){e=k("div"),t=k("button"),t.textContent="Home",n=L(),i=k("button"),i.textContent="About",o=L(),s=k("button"),s.textContent="Instructions",A(t,"type","button"),A(i,"type","button"),A(s,"type","button"),A(e,"slot","nav")},m(a,p){b(a,e,p),S(e,t),S(e,n),S(e,i),S(e,o),S(e,s),u||(l=[Y(t,"click",r[9]),Y(i,"click",r[7]),Y(s,"click",r[8])],u=!0)},p:W,d(a){a&&w(e),u=!1,We(l)}}}function ml(r){let e,t,n,i,o,s,u,l,a,p,g,h;return o=new zo({props:{boundaryGeojson:r[3]}}),u=new Go({props:{authorityName:r[4],planningMode:r[6]}}),g=new Ro({props:{planningMode:r[6]}}),{c(){e=k("div"),t=k("h1"),n=V(r[4]),i=L(),Q(o.$$.fragment),s=L(),Q(u.$$.fragment),l=L(),a=k("br"),p=L(),Q(g.$$.fragment),A(e,"slot","sidebar")},m(f,m){b(f,e,m),S(e,t),S(t,n),S(t,i),ee(o,t,null),S(e,s),ee(u,e,null),S(e,l),S(e,a),S(e,p),ee(g,e,null),h=!0},p(f,m){const _={};m&8&&(_.boundaryGeojson=f[3]),o.$set(_)},i(f){h||(B(o.$$.fragment,f),B(u.$$.fragment,f),B(g.$$.fragment,f),h=!0)},o(f){j(o.$$.fragment,f),j(u.$$.fragment,f),j(g.$$.fragment,f),h=!1},d(f){f&&w(e),te(o),te(u),te(g)}}}function gl(r){let e,t,n,i,o,s,u,l,a,p,g,h;return e=new vo({props:{boundaryGeojson:r[3]}}),n=new Ko({}),o=new Zo({}),u=new hl({props:{routeUrl:r[2],planningMode:r[6]}}),a=new Xo({props:{style:r[5]}}),g=new Jo({}),{c(){Q(e.$$.fragment),t=L(),Q(n.$$.fragment),i=L(),Q(o.$$.fragment),s=L(),Q(u.$$.fragment),l=L(),Q(a.$$.fragment),p=L(),Q(g.$$.fragment)},m(f,m){ee(e,f,m),b(f,t,m),ee(n,f,m),b(f,i,m),ee(o,f,m),b(f,s,m),ee(u,f,m),b(f,l,m),ee(a,f,m),b(f,p,m),ee(g,f,m),h=!0},p(f,m){const _={};m&8&&(_.boundaryGeojson=f[3]),e.$set(_);const v={};m&4&&(v.routeUrl=f[2]),u.$set(v)},i(f){h||(B(e.$$.fragment,f),B(n.$$.fragment,f),B(o.$$.fragment,f),B(u.$$.fragment,f),B(a.$$.fragment,f),B(g.$$.fragment,f),h=!0)},o(f){j(e.$$.fragment,f),j(n.$$.fragment,f),j(o.$$.fragment,f),j(u.$$.fragment,f),j(a.$$.fragment,f),j(g.$$.fragment,f),h=!1},d(f){te(e,f),f&&w(t),te(n,f),f&&w(i),te(o,f),f&&w(s),te(u,f),f&&w(l),te(a,f),f&&w(p),te(g,f)}}}function _l(r){let e,t,n;return t=new Di({props:{style:r[5],$$slots:{default:[gl]},$$scope:{ctx:r}}}),{c(){e=k("div"),Q(t.$$.fragment),A(e,"slot","main")},m(i,o){b(i,e,o),ee(t,e,null),n=!0},p(i,o){const s={};o&32780&&(s.$$scope={dirty:o,ctx:i}),t.$set(s)},i(i){n||(B(t.$$.fragment,i),n=!0)},o(i){j(t.$$.fragment,i),n=!1},d(i){i&&w(e),te(t)}}}function vl(r){let e,t,n,i,o,s,u,l;e=new Yi({props:{$$slots:{main:[_l],sidebar:[ml],nav:[dl]},$$scope:{ctx:r}}});function a(f){r[10](f)}let p={};r[0]!==void 0&&(p.open=r[0]),n=new Oi({props:p}),ve.push(()=>it(n,"open",a,r[0]));function g(f){r[11](f)}let h={};return r[1]!==void 0&&(h.open=r[1]),s=new Ni({props:h}),ve.push(()=>it(s,"open",g,r[1])),{c(){Q(e.$$.fragment),t=L(),Q(n.$$.fragment),o=L(),Q(s.$$.fragment)},m(f,m){ee(e,f,m),b(f,t,m),ee(n,f,m),b(f,o,m),ee(s,f,m),l=!0},p(f,[m]){const _={};m&32780&&(_.$$scope={dirty:m,ctx:f}),e.$set(_);const v={};!i&&m&1&&(i=!0,v.open=f[0],ot(()=>i=!1)),n.$set(v);const x={};!u&&m&2&&(u=!0,x.open=f[1],ot(()=>u=!1)),s.$set(x)},i(f){l||(B(e.$$.fragment,f),B(n.$$.fragment,f),B(s.$$.fragment,f),l=!0)},o(f){j(e.$$.fragment,f),j(n.$$.fragment,f),j(s.$$.fragment,f),l=!1},d(f){te(e,f),f&&w(t),te(n,f),f&&w(o),te(s,f)}}}function yl(r,e,t){let n=!1,i=!1,o=window.location.hostname.includes("atip.uk");const s=new URLSearchParams(window.location.search);let u=s.get("authority"),l=s.get("style")||"streets",a=s.has("planning");var p=`https://atip.uk/route-snappers/${u}.bin`;o||(p=`https://atip.uk/route-snappers-dev/${u}.bin`);function g(){t(0,n=!n),t(1,i=!1)}function h(){t(1,i=!i),t(0,n=!1)}let f;Bn(async()=>{t(3,f=await m())});async function m(){const d=await(await fetch(Ai)).text(),y=JSON.parse(d);return y.features=y.features.filter(P=>{var C;return((C=P.properties)==null?void 0:C.name)==u}),y}const _=()=>window.open("index.html");function v(c){n=c,t(0,n)}function x(c){i=c,t(1,i)}return[n,i,p,f,u,l,a,g,h,_,v,x]}class bl extends se{constructor(e){super(),le(this,e,yl,vl,ie,{})}}new bl({target:document.getElementById("app")});
