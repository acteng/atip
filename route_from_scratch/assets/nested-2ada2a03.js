var Xr=Object.defineProperty;var Jr=(r,e,t)=>e in r?Xr(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var fe=(r,e,t)=>(Jr(r,typeof e!="symbol"?e+"":e,t),t),zr=(r,e,t)=>{if(!e.has(r))throw TypeError("Cannot "+t)};var nt=(r,e,t)=>{if(e.has(r))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(r):e.set(r,t)};var ie=(r,e,t)=>(zr(r,e,"access private method"),t);import{S as K,i as ee,s as Q,M as Ur,b as pe,a as Ve,d as W,m as H,k as Ze,n as B,o as q,q as V,e as w,c as I,g as S,x as J,p as k,y as Pe,f as R,z as Pt,B as It,C as Wr,D as Ln,E as en,F as On,G as yt,H as _t,I as bt,J as wt,K as qn,h as _,l as X,L as Hr,N as Vr,O as ne,P as Zr,w as Rn,Q as Qe,R as me,T as An,t as z,U as we,j as at,r as Ke,V as Pn,W as Dn,X as Te,Y as jn,Z as Or,_ as Xn,$ as Qr,a0 as Kr,a1 as Ee,a2 as ei,a3 as ti,a4 as ni,a5 as Jn,a6 as ri,a7 as Vt,a8 as dt,a9 as Zt,aa as Et,ab as In,ac as ln,ad as ii,ae as ct,af as Nn,ag as ze,ah as ht,ai as oi,aj as Cn,ak as si,al as li,am as ai,an as zn,ao as jt,ap as ui,aq as fi,ar as ci,A as hi,u as pi}from"./authorities-c38267ac.js";function di(r){let e,t,n,i,o,s,a,l,u,p,d,c,f;return{c(){e=w("p"),e.textContent="For each intervention:",t=I(),n=w("ol"),n.innerHTML=`<li>Click one of the draw icons to the top right of the map (the icons allow
      you to draw points, lines, polygons or routes)</li> 
    <li>Draw the intervention on the map, clicking the original point or &#39;Finish
      snapping&#39; for the Polygon and Route tools respectively</li> 
    <li>Fill in the details that appear (Intervention type, name, description)</li> 
    <li>Click the &quot;Save&quot; button or &quot;Delete&quot; button to save or remove the
      intervention</li>`,i=I(),o=w("p"),o.textContent=`Repeat the steps above for each substantial infrastructure intervention in
    the scheme.`,s=I(),a=w("p"),a.textContent=`To make further edits to attribute data, or to delete an intervention, click
    on its name in the left hand panel or its geometry in the map.`,l=I(),u=w("p"),u.textContent=`Click the "Export to GeoJSON" button to download the dataset representing
    the scheme, which can be made up of one or more intervention, as a GeoJSON
    file. After saving the file, you can delete the interventions, change the
    scheme name, and start a new set of interventions representing a new scheme.`,p=I(),d=w("p"),d.textContent=`To load a GeoJSON file that you have already saved from the tool, click the
    "Load from GeoJSON" button and select the file.`,c=I(),f=w("p"),f.innerHTML=`Note: the <strong>Route tool</strong> works by calculating routes between
    start and end points using the existing transport network according to
    OpenStreetMap. Use it by clicking on the location where you would like the
    route to start and then clicking on the location where you would like the
    route to end on the map. The route will be calculated and drawn on the map.
    After you click &quot;Finish snapping&quot; you can edit the route by dragging
    individual points. This can be useful for representing links that are not
    part of the existing transport network, such as a new bridge or path.
    However,
    <strong>you cannot add or remove points</strong> with the Route tool. If the
    planned route intervention you would like to sketch as part of a scheme contains
    one or more new links (for example containing new bridges or paths between cul-de-sacs),
    you may want to use the Line tool instead.`},m(m,y){S(m,e,y),S(m,t,y),S(m,n,y),S(m,i,y),S(m,o,y),S(m,s,y),S(m,a,y),S(m,l,y),S(m,u,y),S(m,p,y),S(m,d,y),S(m,c,y),S(m,f,y)},p:J,d(m){m&&k(e),m&&k(t),m&&k(n),m&&k(i),m&&k(o),m&&k(s),m&&k(a),m&&k(l),m&&k(u),m&&k(p),m&&k(d),m&&k(c),m&&k(f)}}}function gi(r){let e,t,n;function i(s){r[1](s)}let o={title:"Instructions",$$slots:{default:[di]},$$scope:{ctx:r}};return r[0]!==void 0&&(o.open=r[0]),e=new Ur({props:o}),pe.push(()=>Ve(e,"open",i,r[0])),{c(){W(e.$$.fragment)},m(s,a){H(e,s,a),n=!0},p(s,[a]){const l={};a&4&&(l.$$scope={dirty:a,ctx:s}),!t&&a&1&&(t=!0,l.open=s[0],Ze(()=>t=!1)),e.$set(l)},i(s){n||(B(e.$$.fragment,s),n=!0)},o(s){q(e.$$.fragment,s),n=!1},d(s){V(e,s)}}}function mi(r,e,t){let{open:n}=e;function i(o){n=o,t(0,n)}return r.$$set=o=>{"open"in o&&t(0,n=o.open)},[n,i]}class vi extends K{constructor(e){super(),ee(this,e,mi,gi,Q,{open:0})}}const rt=[];function gt(r,e=J){let t;const n=new Set;function i(a){if(Q(r,a)&&(r=a,t)){const l=!rt.length;for(const u of n)u[1](),rt.push(u,r);if(l){for(let u=0;u<rt.length;u+=2)rt[u][0](rt[u+1]);rt.length=0}}}function o(a){i(a(r))}function s(a,l=J){const u=[a,l];return n.add(u),n.size===1&&(t=e(i)||J),a(r),()=>{n.delete(u),n.size===0&&(t(),t=null)}}return{set:i,update:o,subscribe:s}}const Ie=gt(null),Z=gt(Pe()),xe=gt(null),Fe=gt(null),Xt=gt(null),an=gt(null);function Qt(r){let e=new Set;for(let n of r.features)e.add(n.id);let t=e.size+1;for(;e.has(t);)t++;return t}function Rr(r){Z.update(e=>(e.features=e.features.filter(t=>t.id!=r),e)),xe.set(null),Fe.set(null),Xt.set(null)}function Un(r){let e;const t=r[4].default,n=yt(t,r,r[3],null);return{c(){n&&n.c()},m(i,o){n&&n.m(i,o),e=!0},p(i,o){n&&n.p&&(!e||o&8)&&_t(n,t,i,i[3],e?wt(t,i[3],o,null):bt(i[3]),null)},i(i){e||(B(n,i),e=!0)},o(i){q(n,i),e=!1},d(i){n&&n.d(i)}}}function yi(r){let e,t,n=r[1]&&Un(r);return{c(){e=w("div"),n&&n.c(),R(e,"class","map svelte-12dpf1u")},m(i,o){S(i,e,o),n&&n.m(e,null),r[5](e),t=!0},p(i,[o]){i[1]?n?(n.p(i,o),o&2&&B(n,1)):(n=Un(i),n.c(),B(n,1),n.m(e,null)):n&&(Pt(),q(n,1,1,()=>{n=null}),It())},i(i){t||(B(n),t=!0)},o(i){q(n),t=!1},d(i){i&&k(e),n&&n.d(),r[5](null)}}}function _i(r,e,t){let{$$slots:n={},$$scope:i}=e,{style:o}=e,s,a,l=!1;Wr("setCamera",!window.location.hash),Ln(()=>{s=new en.Map({container:a,style:`https://api.maptiler.com/maps/${o}/style.json?key=MZEJTanw3WpxRvt7qDfo`,hash:!0}),s.addControl(new en.ScaleControl({})),s.addControl(new en.NavigationControl({visualizePitch:!0}),"bottom-right"),s.on("load",()=>{t(1,l=!0),Ie.set(s)}),new ResizeObserver(()=>{s.resize()}).observe(a)}),On(()=>{s.remove()});function u(p){pe[p?"unshift":"push"](()=>{a=p,t(0,a)})}return r.$$set=p=>{"style"in p&&t(2,o=p.style),"$$scope"in p&&t(3,i=p.$$scope)},[a,l,o,i,n,u]}class bi extends K{constructor(e){super(),ee(this,e,_i,yi,Q,{style:2})}}const wi=r=>({}),Wn=r=>({}),xi=r=>({}),Hn=r=>({}),Si=r=>({}),Vn=r=>({});function ki(r){let e,t,n,i,o,s,a,l,u,p,d,c;const f=r[3].nav,m=yt(f,r,r[2],Vn),y=r[3].sidebar,b=yt(y,r,r[2],Hn),A=r[3].main,h=yt(A,r,r[2],Wn);return{c(){e=w("aside"),t=w("div"),n=w("nav"),m&&m.c(),i=I(),b&&b.c(),o=I(),s=w("button"),s.textContent="â†’",l=I(),u=w("main"),h&&h.c(),R(n,"class","svelte-1u7vg8a"),R(t,"class","sidebar-content content-container svelte-1u7vg8a"),R(s,"type","button"),R(s,"class","sidebar-toggle rounded-rect svelte-1u7vg8a"),R(e,"class",a=qn(r[0]?"":"collapsed")+" svelte-1u7vg8a"),R(u,"class","svelte-1u7vg8a")},m(g,v){S(g,e,v),_(e,t),_(t,n),m&&m.m(n,null),_(t,i),b&&b.m(t,null),_(e,o),_(e,s),S(g,l,v),S(g,u,v),h&&h.m(u,null),p=!0,d||(c=X(s,"click",r[1]),d=!0)},p(g,[v]){m&&m.p&&(!p||v&4)&&_t(m,f,g,g[2],p?wt(f,g[2],v,Si):bt(g[2]),Vn),b&&b.p&&(!p||v&4)&&_t(b,y,g,g[2],p?wt(y,g[2],v,xi):bt(g[2]),Hn),(!p||v&1&&a!==(a=qn(g[0]?"":"collapsed")+" svelte-1u7vg8a"))&&R(e,"class",a),h&&h.p&&(!p||v&4)&&_t(h,A,g,g[2],p?wt(A,g[2],v,wi):bt(g[2]),Wn)},i(g){p||(B(m,g),B(b,g),B(h,g),p=!0)},o(g){q(m,g),q(b,g),q(h,g),p=!1},d(g){g&&k(e),m&&m.d(g),b&&b.d(g),g&&k(l),g&&k(u),h&&h.d(g),d=!1,c()}}}function Ei(r,e,t){let{$$slots:n={},$$scope:i}=e,o=!0;function s(){t(0,o=!o)}return r.$$set=a=>{"$$scope"in a&&t(2,i=a.$$scope)},[o,s,i,n]}class Mi extends K{constructor(e){super(),ee(this,e,Ei,ki,Q,{})}}/**
 * splaytree v3.1.1
 * Fast Splay tree for Node and browser
 *
 * @author Alexander Milevski <info@w8r.name>
 * @license MIT
 * @preserve
 *//*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */function Li(r,e){var t={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},n,i,o,s;return s={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function a(u){return function(p){return l([u,p])}}function l(u){if(n)throw new TypeError("Generator is already executing.");for(;t;)try{if(n=1,i&&(o=u[0]&2?i.return:u[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,u[1])).done)return o;switch(i=0,o&&(u=[u[0]&2,o.value]),u[0]){case 0:case 1:o=u;break;case 4:return t.label++,{value:u[1],done:!1};case 5:t.label++,i=u[1],u=[0];continue;case 7:u=t.ops.pop(),t.trys.pop();continue;default:if(o=t.trys,!(o=o.length>0&&o[o.length-1])&&(u[0]===6||u[0]===2)){t=0;continue}if(u[0]===3&&(!o||u[1]>o[0]&&u[1]<o[3])){t.label=u[1];break}if(u[0]===6&&t.label<o[1]){t.label=o[1],o=u;break}if(o&&t.label<o[2]){t.label=o[2],t.ops.push(u);break}o[2]&&t.ops.pop(),t.trys.pop();continue}u=e.call(r,t)}catch(p){u=[6,p],i=0}finally{n=o=0}if(u[0]&5)throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}}var We=function(){function r(e,t){this.next=null,this.key=e,this.data=t,this.left=null,this.right=null}return r}();function Oi(r,e){return r>e?1:r<e?-1:0}function De(r,e,t){for(var n=new We(null,null),i=n,o=n;;){var s=t(r,e.key);if(s<0){if(e.left===null)break;if(t(r,e.left.key)<0){var a=e.left;if(e.left=a.right,a.right=e,e=a,e.left===null)break}o.left=e,o=e,e=e.left}else if(s>0){if(e.right===null)break;if(t(r,e.right.key)>0){var a=e.right;if(e.right=a.left,a.left=e,e=a,e.right===null)break}i.right=e,i=e,e=e.right}else break}return i.right=e.left,o.left=e.right,e.left=n.right,e.right=n.left,e}function tn(r,e,t,n){var i=new We(r,e);if(t===null)return i.left=i.right=null,i;t=De(r,t,n);var o=n(r,t.key);return o<0?(i.left=t.left,i.right=t,t.left=null):o>=0&&(i.right=t.right,i.left=t,t.right=null),i}function Zn(r,e,t){var n=null,i=null;if(e){e=De(r,e,t);var o=t(e.key,r);o===0?(n=e.left,i=e.right):o<0?(i=e.right,e.right=null,n=e):(n=e.left,e.left=null,i=e)}return{left:n,right:i}}function Ri(r,e,t){return e===null?r:(r===null||(e=De(r.key,e,t),e.left=r),e)}function un(r,e,t,n,i){if(r){n(""+e+(t?"â””â”€â”€ ":"â”œâ”€â”€ ")+i(r)+`
`);var o=e+(t?"    ":"â”‚   ");r.left&&un(r.left,o,!1,n,i),r.right&&un(r.right,o,!0,n,i)}}var Fn=function(){function r(e){e===void 0&&(e=Oi),this._root=null,this._size=0,this._comparator=e}return r.prototype.insert=function(e,t){return this._size++,this._root=tn(e,t,this._root,this._comparator)},r.prototype.add=function(e,t){var n=new We(e,t);this._root===null&&(n.left=n.right=null,this._size++,this._root=n);var i=this._comparator,o=De(e,this._root,i),s=i(e,o.key);return s===0?this._root=o:(s<0?(n.left=o.left,n.right=o,o.left=null):s>0&&(n.right=o.right,n.left=o,o.right=null),this._size++,this._root=n),this._root},r.prototype.remove=function(e){this._root=this._remove(e,this._root,this._comparator)},r.prototype._remove=function(e,t,n){var i;if(t===null)return null;t=De(e,t,n);var o=n(e,t.key);return o===0?(t.left===null?i=t.right:(i=De(e,t.left,n),i.right=t.right),this._size--,i):t},r.prototype.pop=function(){var e=this._root;if(e){for(;e.left;)e=e.left;return this._root=De(e.key,this._root,this._comparator),this._root=this._remove(e.key,this._root,this._comparator),{key:e.key,data:e.data}}return null},r.prototype.findStatic=function(e){for(var t=this._root,n=this._comparator;t;){var i=n(e,t.key);if(i===0)return t;i<0?t=t.left:t=t.right}return null},r.prototype.find=function(e){return this._root&&(this._root=De(e,this._root,this._comparator),this._comparator(e,this._root.key)!==0)?null:this._root},r.prototype.contains=function(e){for(var t=this._root,n=this._comparator;t;){var i=n(e,t.key);if(i===0)return!0;i<0?t=t.left:t=t.right}return!1},r.prototype.forEach=function(e,t){for(var n=this._root,i=[],o=!1;!o;)n!==null?(i.push(n),n=n.left):i.length!==0?(n=i.pop(),e.call(t,n),n=n.right):o=!0;return this},r.prototype.range=function(e,t,n,i){for(var o=[],s=this._comparator,a=this._root,l;o.length!==0||a;)if(a)o.push(a),a=a.left;else{if(a=o.pop(),l=s(a.key,t),l>0)break;if(s(a.key,e)>=0&&n.call(i,a))return this;a=a.right}return this},r.prototype.keys=function(){var e=[];return this.forEach(function(t){var n=t.key;return e.push(n)}),e},r.prototype.values=function(){var e=[];return this.forEach(function(t){var n=t.data;return e.push(n)}),e},r.prototype.min=function(){return this._root?this.minNode(this._root).key:null},r.prototype.max=function(){return this._root?this.maxNode(this._root).key:null},r.prototype.minNode=function(e){if(e===void 0&&(e=this._root),e)for(;e.left;)e=e.left;return e},r.prototype.maxNode=function(e){if(e===void 0&&(e=this._root),e)for(;e.right;)e=e.right;return e},r.prototype.at=function(e){for(var t=this._root,n=!1,i=0,o=[];!n;)if(t)o.push(t),t=t.left;else if(o.length>0){if(t=o.pop(),i===e)return t;i++,t=t.right}else n=!0;return null},r.prototype.next=function(e){var t=this._root,n=null;if(e.right){for(n=e.right;n.left;)n=n.left;return n}for(var i=this._comparator;t;){var o=i(e.key,t.key);if(o===0)break;o<0?(n=t,t=t.left):t=t.right}return n},r.prototype.prev=function(e){var t=this._root,n=null;if(e.left!==null){for(n=e.left;n.right;)n=n.right;return n}for(var i=this._comparator;t;){var o=i(e.key,t.key);if(o===0)break;o<0?t=t.left:(n=t,t=t.right)}return n},r.prototype.clear=function(){return this._root=null,this._size=0,this},r.prototype.toList=function(){return Pi(this._root)},r.prototype.load=function(e,t,n){t===void 0&&(t=[]),n===void 0&&(n=!1);var i=e.length,o=this._comparator;if(n&&hn(e,t,0,i-1,o),this._root===null)this._root=fn(e,t,0,i),this._size=i;else{var s=Ii(this.toList(),Ai(e,t),o);i=this._size+i,this._root=cn({head:s},0,i)}return this},r.prototype.isEmpty=function(){return this._root===null},Object.defineProperty(r.prototype,"size",{get:function(){return this._size},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"root",{get:function(){return this._root},enumerable:!0,configurable:!0}),r.prototype.toString=function(e){e===void 0&&(e=function(n){return String(n.key)});var t=[];return un(this._root,"",!0,function(n){return t.push(n)},e),t.join("")},r.prototype.update=function(e,t,n){var i=this._comparator,o=Zn(e,this._root,i),s=o.left,a=o.right;i(e,t)<0?a=tn(t,n,a,i):s=tn(t,n,s,i),this._root=Ri(s,a,i)},r.prototype.split=function(e){return Zn(e,this._root,this._comparator)},r.prototype[Symbol.iterator]=function(){var e;return Li(this,function(t){switch(t.label){case 0:e=this.minNode(),t.label=1;case 1:return e?[4,e]:[3,3];case 2:return t.sent(),e=this.next(e),[3,1];case 3:return[2]}})},r}();function fn(r,e,t,n){var i=n-t;if(i>0){var o=t+Math.floor(i/2),s=r[o],a=e[o],l=new We(s,a);return l.left=fn(r,e,t,o),l.right=fn(r,e,o+1,n),l}return null}function Ai(r,e){for(var t=new We(null,null),n=t,i=0;i<r.length;i++)n=n.next=new We(r[i],e[i]);return n.next=null,t.next}function Pi(r){for(var e=r,t=[],n=!1,i=new We(null,null),o=i;!n;)e?(t.push(e),e=e.left):t.length>0?(e=o=o.next=t.pop(),e=e.right):n=!0;return o.next=null,i.next}function cn(r,e,t){var n=t-e;if(n>0){var i=e+Math.floor(n/2),o=cn(r,e,i),s=r.head;return s.left=o,r.head=r.head.next,s.right=cn(r,i+1,t),s}return null}function Ii(r,e,t){for(var n=new We(null,null),i=n,o=r,s=e;o!==null&&s!==null;)t(o.key,s.key)<0?(i.next=o,o=o.next):(i.next=s,s=s.next),i=i.next;return o!==null?i.next=o:s!==null&&(i.next=s),n.next}function hn(r,e,t,n,i){if(!(t>=n)){for(var o=r[t+n>>1],s=t-1,a=n+1;;){do s++;while(i(r[s],o)<0);do a--;while(i(r[a],o)>0);if(s>=a)break;var l=r[s];r[s]=r[a],r[a]=l,l=e[s],e[s]=e[a],e[a]=l}hn(r,e,t,a,i),hn(r,e,a+1,n,i)}}function Se(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function Qn(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,n.key,n)}}function ve(r,e,t){return e&&Qn(r.prototype,e),t&&Qn(r,t),r}var vt=function(e,t){return e.ll.x<=t.x&&t.x<=e.ur.x&&e.ll.y<=t.y&&t.y<=e.ur.y},pn=function(e,t){if(t.ur.x<e.ll.x||e.ur.x<t.ll.x||t.ur.y<e.ll.y||e.ur.y<t.ll.y)return null;var n=e.ll.x<t.ll.x?t.ll.x:e.ll.x,i=e.ur.x<t.ur.x?e.ur.x:t.ur.x,o=e.ll.y<t.ll.y?t.ll.y:e.ll.y,s=e.ur.y<t.ur.y?e.ur.y:t.ur.y;return{ll:{x:n,y:o},ur:{x:i,y:s}}},Xe=Number.EPSILON;Xe===void 0&&(Xe=Math.pow(2,-52));var Ni=Xe*Xe,dn=function(e,t){if(-Xe<e&&e<Xe&&-Xe<t&&t<Xe)return 0;var n=e-t;return n*n<Ni*e*t?0:e<t?-1:1},Ci=function(){function r(){Se(this,r),this.reset()}return ve(r,[{key:"reset",value:function(){this.xRounder=new Kn,this.yRounder=new Kn}},{key:"round",value:function(t,n){return{x:this.xRounder.round(t),y:this.yRounder.round(n)}}}]),r}(),Kn=function(){function r(){Se(this,r),this.tree=new Fn,this.round(0)}return ve(r,[{key:"round",value:function(t){var n=this.tree.add(t),i=this.tree.prev(n);if(i!==null&&dn(n.key,i.key)===0)return this.tree.remove(t),i.key;var o=this.tree.next(n);return o!==null&&dn(n.key,o.key)===0?(this.tree.remove(t),o.key):t}}]),r}(),Mt=new Ci,xt=function(e,t){return e.x*t.y-e.y*t.x},Ar=function(e,t){return e.x*t.x+e.y*t.y},er=function(e,t,n){var i={x:t.x-e.x,y:t.y-e.y},o={x:n.x-e.x,y:n.y-e.y},s=xt(i,o);return dn(s,0)},Jt=function(e){return Math.sqrt(Ar(e,e))},Fi=function(e,t,n){var i={x:t.x-e.x,y:t.y-e.y},o={x:n.x-e.x,y:n.y-e.y};return xt(o,i)/Jt(o)/Jt(i)},Ti=function(e,t,n){var i={x:t.x-e.x,y:t.y-e.y},o={x:n.x-e.x,y:n.y-e.y};return Ar(o,i)/Jt(o)/Jt(i)},tr=function(e,t,n){return t.y===0?null:{x:e.x+t.x/t.y*(n-e.y),y:n}},nr=function(e,t,n){return t.x===0?null:{x:n,y:e.y+t.y/t.x*(n-e.x)}},Bi=function(e,t,n,i){if(t.x===0)return nr(n,i,e.x);if(i.x===0)return nr(e,t,n.x);if(t.y===0)return tr(n,i,e.y);if(i.y===0)return tr(e,t,n.y);var o=xt(t,i);if(o==0)return null;var s={x:n.x-e.x,y:n.y-e.y},a=xt(s,t)/o,l=xt(s,i)/o,u=e.x+l*t.x,p=n.x+a*i.x,d=e.y+l*t.y,c=n.y+a*i.y,f=(u+p)/2,m=(d+c)/2;return{x:f,y:m}},Oe=function(){ve(r,null,[{key:"compare",value:function(t,n){var i=r.comparePoints(t.point,n.point);return i!==0?i:(t.point!==n.point&&t.link(n),t.isLeft!==n.isLeft?t.isLeft?1:-1:zt.compare(t.segment,n.segment))}},{key:"comparePoints",value:function(t,n){return t.x<n.x?-1:t.x>n.x?1:t.y<n.y?-1:t.y>n.y?1:0}}]);function r(e,t){Se(this,r),e.events===void 0?e.events=[this]:e.events.push(this),this.point=e,this.isLeft=t}return ve(r,[{key:"link",value:function(t){if(t.point===this.point)throw new Error("Tried to link already linked events");for(var n=t.point.events,i=0,o=n.length;i<o;i++){var s=n[i];this.point.events.push(s),s.point=this.point}this.checkForConsuming()}},{key:"checkForConsuming",value:function(){for(var t=this.point.events.length,n=0;n<t;n++){var i=this.point.events[n];if(i.segment.consumedBy===void 0)for(var o=n+1;o<t;o++){var s=this.point.events[o];s.consumedBy===void 0&&i.otherSE.point.events===s.otherSE.point.events&&i.segment.consume(s.segment)}}}},{key:"getAvailableLinkedEvents",value:function(){for(var t=[],n=0,i=this.point.events.length;n<i;n++){var o=this.point.events[n];o!==this&&!o.segment.ringOut&&o.segment.isInResult()&&t.push(o)}return t}},{key:"getLeftmostComparator",value:function(t){var n=this,i=new Map,o=function(a){var l=a.otherSE;i.set(a,{sine:Fi(n.point,t.point,l.point),cosine:Ti(n.point,t.point,l.point)})};return function(s,a){i.has(s)||o(s),i.has(a)||o(a);var l=i.get(s),u=l.sine,p=l.cosine,d=i.get(a),c=d.sine,f=d.cosine;return u>=0&&c>=0?p<f?1:p>f?-1:0:u<0&&c<0?p<f?-1:p>f?1:0:c<u?-1:c>u?1:0}}}]),r}(),$i=0,zt=function(){ve(r,null,[{key:"compare",value:function(t,n){var i=t.leftSE.point.x,o=n.leftSE.point.x,s=t.rightSE.point.x,a=n.rightSE.point.x;if(a<i)return 1;if(s<o)return-1;var l=t.leftSE.point.y,u=n.leftSE.point.y,p=t.rightSE.point.y,d=n.rightSE.point.y;if(i<o){if(u<l&&u<p)return 1;if(u>l&&u>p)return-1;var c=t.comparePoint(n.leftSE.point);if(c<0)return 1;if(c>0)return-1;var f=n.comparePoint(t.rightSE.point);return f!==0?f:-1}if(i>o){if(l<u&&l<d)return-1;if(l>u&&l>d)return 1;var m=n.comparePoint(t.leftSE.point);if(m!==0)return m;var y=t.comparePoint(n.rightSE.point);return y<0?1:y>0?-1:1}if(l<u)return-1;if(l>u)return 1;if(s<a){var b=n.comparePoint(t.rightSE.point);if(b!==0)return b}if(s>a){var A=t.comparePoint(n.rightSE.point);if(A<0)return 1;if(A>0)return-1}if(s!==a){var h=p-l,g=s-i,v=d-u,E=a-o;if(h>g&&v<E)return 1;if(h<g&&v>E)return-1}return s>a?1:s<a||p<d?-1:p>d?1:t.id<n.id?-1:t.id>n.id?1:0}}]);function r(e,t,n,i){Se(this,r),this.id=++$i,this.leftSE=e,e.segment=this,e.otherSE=t,this.rightSE=t,t.segment=this,t.otherSE=e,this.rings=n,this.windings=i}return ve(r,[{key:"replaceRightSE",value:function(t){this.rightSE=t,this.rightSE.segment=this,this.rightSE.otherSE=this.leftSE,this.leftSE.otherSE=this.rightSE}},{key:"bbox",value:function(){var t=this.leftSE.point.y,n=this.rightSE.point.y;return{ll:{x:this.leftSE.point.x,y:t<n?t:n},ur:{x:this.rightSE.point.x,y:t>n?t:n}}}},{key:"vector",value:function(){return{x:this.rightSE.point.x-this.leftSE.point.x,y:this.rightSE.point.y-this.leftSE.point.y}}},{key:"isAnEndpoint",value:function(t){return t.x===this.leftSE.point.x&&t.y===this.leftSE.point.y||t.x===this.rightSE.point.x&&t.y===this.rightSE.point.y}},{key:"comparePoint",value:function(t){if(this.isAnEndpoint(t))return 0;var n=this.leftSE.point,i=this.rightSE.point,o=this.vector();if(n.x===i.x)return t.x===n.x?0:t.x<n.x?1:-1;var s=(t.y-n.y)/o.y,a=n.x+s*o.x;if(t.x===a)return 0;var l=(t.x-n.x)/o.x,u=n.y+l*o.y;return t.y===u?0:t.y<u?-1:1}},{key:"getIntersection",value:function(t){var n=this.bbox(),i=t.bbox(),o=pn(n,i);if(o===null)return null;var s=this.leftSE.point,a=this.rightSE.point,l=t.leftSE.point,u=t.rightSE.point,p=vt(n,l)&&this.comparePoint(l)===0,d=vt(i,s)&&t.comparePoint(s)===0,c=vt(n,u)&&this.comparePoint(u)===0,f=vt(i,a)&&t.comparePoint(a)===0;if(d&&p)return f&&!c?a:!f&&c?u:null;if(d)return c&&s.x===u.x&&s.y===u.y?null:s;if(p)return f&&a.x===l.x&&a.y===l.y?null:l;if(f&&c)return null;if(f)return a;if(c)return u;var m=Bi(s,this.vector(),l,t.vector());return m===null||!vt(o,m)?null:Mt.round(m.x,m.y)}},{key:"split",value:function(t){var n=[],i=t.events!==void 0,o=new Oe(t,!0),s=new Oe(t,!1),a=this.rightSE;this.replaceRightSE(s),n.push(s),n.push(o);var l=new r(o,a,this.rings.slice(),this.windings.slice());return Oe.comparePoints(l.leftSE.point,l.rightSE.point)>0&&l.swapEvents(),Oe.comparePoints(this.leftSE.point,this.rightSE.point)>0&&this.swapEvents(),i&&(o.checkForConsuming(),s.checkForConsuming()),n}},{key:"swapEvents",value:function(){var t=this.rightSE;this.rightSE=this.leftSE,this.leftSE=t,this.leftSE.isLeft=!0,this.rightSE.isLeft=!1;for(var n=0,i=this.windings.length;n<i;n++)this.windings[n]*=-1}},{key:"consume",value:function(t){for(var n=this,i=t;n.consumedBy;)n=n.consumedBy;for(;i.consumedBy;)i=i.consumedBy;var o=r.compare(n,i);if(o!==0){if(o>0){var s=n;n=i,i=s}if(n.prev===i){var a=n;n=i,i=a}for(var l=0,u=i.rings.length;l<u;l++){var p=i.rings[l],d=i.windings[l],c=n.rings.indexOf(p);c===-1?(n.rings.push(p),n.windings.push(d)):n.windings[c]+=d}i.rings=null,i.windings=null,i.consumedBy=n,i.leftSE.consumedBy=n.leftSE,i.rightSE.consumedBy=n.rightSE}}},{key:"prevInResult",value:function(){return this._prevInResult!==void 0?this._prevInResult:(this.prev?this.prev.isInResult()?this._prevInResult=this.prev:this._prevInResult=this.prev.prevInResult():this._prevInResult=null,this._prevInResult)}},{key:"beforeState",value:function(){if(this._beforeState!==void 0)return this._beforeState;if(!this.prev)this._beforeState={rings:[],windings:[],multiPolys:[]};else{var t=this.prev.consumedBy||this.prev;this._beforeState=t.afterState()}return this._beforeState}},{key:"afterState",value:function(){if(this._afterState!==void 0)return this._afterState;var t=this.beforeState();this._afterState={rings:t.rings.slice(0),windings:t.windings.slice(0),multiPolys:[]};for(var n=this._afterState.rings,i=this._afterState.windings,o=this._afterState.multiPolys,s=0,a=this.rings.length;s<a;s++){var l=this.rings[s],u=this.windings[s],p=n.indexOf(l);p===-1?(n.push(l),i.push(u)):i[p]+=u}for(var d=[],c=[],f=0,m=n.length;f<m;f++)if(i[f]!==0){var y=n[f],b=y.poly;if(c.indexOf(b)===-1)if(y.isExterior)d.push(b);else{c.indexOf(b)===-1&&c.push(b);var A=d.indexOf(y.poly);A!==-1&&d.splice(A,1)}}for(var h=0,g=d.length;h<g;h++){var v=d[h].multiPoly;o.indexOf(v)===-1&&o.push(v)}return this._afterState}},{key:"isInResult",value:function(){if(this.consumedBy)return!1;if(this._isInResult!==void 0)return this._isInResult;var t=this.beforeState().multiPolys,n=this.afterState().multiPolys;switch(Me.type){case"union":{var i=t.length===0,o=n.length===0;this._isInResult=i!==o;break}case"intersection":{var s,a;t.length<n.length?(s=t.length,a=n.length):(s=n.length,a=t.length),this._isInResult=a===Me.numMultiPolys&&s<a;break}case"xor":{var l=Math.abs(t.length-n.length);this._isInResult=l%2===1;break}case"difference":{var u=function(d){return d.length===1&&d[0].isSubject};this._isInResult=u(t)!==u(n);break}default:throw new Error("Unrecognized operation type found ".concat(Me.type))}return this._isInResult}}],[{key:"fromRing",value:function(t,n,i){var o,s,a,l=Oe.comparePoints(t,n);if(l<0)o=t,s=n,a=1;else if(l>0)o=n,s=t,a=-1;else throw new Error("Tried to create degenerate segment at [".concat(t.x,", ").concat(t.y,"]"));var u=new Oe(o,!0),p=new Oe(s,!1);return new r(u,p,[i],[a])}}]),r}(),rr=function(){function r(e,t,n){if(Se(this,r),!Array.isArray(e)||e.length===0)throw new Error("Input geometry is not a valid Polygon or MultiPolygon");if(this.poly=t,this.isExterior=n,this.segments=[],typeof e[0][0]!="number"||typeof e[0][1]!="number")throw new Error("Input geometry is not a valid Polygon or MultiPolygon");var i=Mt.round(e[0][0],e[0][1]);this.bbox={ll:{x:i.x,y:i.y},ur:{x:i.x,y:i.y}};for(var o=i,s=1,a=e.length;s<a;s++){if(typeof e[s][0]!="number"||typeof e[s][1]!="number")throw new Error("Input geometry is not a valid Polygon or MultiPolygon");var l=Mt.round(e[s][0],e[s][1]);l.x===o.x&&l.y===o.y||(this.segments.push(zt.fromRing(o,l,this)),l.x<this.bbox.ll.x&&(this.bbox.ll.x=l.x),l.y<this.bbox.ll.y&&(this.bbox.ll.y=l.y),l.x>this.bbox.ur.x&&(this.bbox.ur.x=l.x),l.y>this.bbox.ur.y&&(this.bbox.ur.y=l.y),o=l)}(i.x!==o.x||i.y!==o.y)&&this.segments.push(zt.fromRing(o,i,this))}return ve(r,[{key:"getSweepEvents",value:function(){for(var t=[],n=0,i=this.segments.length;n<i;n++){var o=this.segments[n];t.push(o.leftSE),t.push(o.rightSE)}return t}}]),r}(),Gi=function(){function r(e,t){if(Se(this,r),!Array.isArray(e))throw new Error("Input geometry is not a valid Polygon or MultiPolygon");this.exteriorRing=new rr(e[0],this,!0),this.bbox={ll:{x:this.exteriorRing.bbox.ll.x,y:this.exteriorRing.bbox.ll.y},ur:{x:this.exteriorRing.bbox.ur.x,y:this.exteriorRing.bbox.ur.y}},this.interiorRings=[];for(var n=1,i=e.length;n<i;n++){var o=new rr(e[n],this,!1);o.bbox.ll.x<this.bbox.ll.x&&(this.bbox.ll.x=o.bbox.ll.x),o.bbox.ll.y<this.bbox.ll.y&&(this.bbox.ll.y=o.bbox.ll.y),o.bbox.ur.x>this.bbox.ur.x&&(this.bbox.ur.x=o.bbox.ur.x),o.bbox.ur.y>this.bbox.ur.y&&(this.bbox.ur.y=o.bbox.ur.y),this.interiorRings.push(o)}this.multiPoly=t}return ve(r,[{key:"getSweepEvents",value:function(){for(var t=this.exteriorRing.getSweepEvents(),n=0,i=this.interiorRings.length;n<i;n++)for(var o=this.interiorRings[n].getSweepEvents(),s=0,a=o.length;s<a;s++)t.push(o[s]);return t}}]),r}(),ir=function(){function r(e,t){if(Se(this,r),!Array.isArray(e))throw new Error("Input geometry is not a valid Polygon or MultiPolygon");try{typeof e[0][0][0]=="number"&&(e=[e])}catch{}this.polys=[],this.bbox={ll:{x:Number.POSITIVE_INFINITY,y:Number.POSITIVE_INFINITY},ur:{x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY}};for(var n=0,i=e.length;n<i;n++){var o=new Gi(e[n],this);o.bbox.ll.x<this.bbox.ll.x&&(this.bbox.ll.x=o.bbox.ll.x),o.bbox.ll.y<this.bbox.ll.y&&(this.bbox.ll.y=o.bbox.ll.y),o.bbox.ur.x>this.bbox.ur.x&&(this.bbox.ur.x=o.bbox.ur.x),o.bbox.ur.y>this.bbox.ur.y&&(this.bbox.ur.y=o.bbox.ur.y),this.polys.push(o)}this.isSubject=t}return ve(r,[{key:"getSweepEvents",value:function(){for(var t=[],n=0,i=this.polys.length;n<i;n++)for(var o=this.polys[n].getSweepEvents(),s=0,a=o.length;s<a;s++)t.push(o[s]);return t}}]),r}(),Yi=function(){ve(r,null,[{key:"factory",value:function(t){for(var n=[],i=0,o=t.length;i<o;i++){var s=t[i];if(!(!s.isInResult()||s.ringOut)){for(var a=null,l=s.leftSE,u=s.rightSE,p=[l],d=l.point,c=[];a=l,l=u,p.push(l),l.point!==d;)for(;;){var f=l.getAvailableLinkedEvents();if(f.length===0){var m=p[0].point,y=p[p.length-1].point;throw new Error("Unable to complete output ring starting at [".concat(m.x,",")+" ".concat(m.y,"]. Last matching segment found ends at")+" [".concat(y.x,", ").concat(y.y,"]."))}if(f.length===1){u=f[0].otherSE;break}for(var b=null,A=0,h=c.length;A<h;A++)if(c[A].point===l.point){b=A;break}if(b!==null){var g=c.splice(b)[0],v=p.splice(g.index);v.unshift(v[0].otherSE),n.push(new r(v.reverse()));continue}c.push({index:p.length,point:l.point});var E=l.getLeftmostComparator(a);u=f.sort(E)[0].otherSE;break}n.push(new r(p))}}return n}}]);function r(e){Se(this,r),this.events=e;for(var t=0,n=e.length;t<n;t++)e[t].segment.ringOut=this;this.poly=null}return ve(r,[{key:"getGeom",value:function(){for(var t=this.events[0].point,n=[t],i=1,o=this.events.length-1;i<o;i++){var s=this.events[i].point,a=this.events[i+1].point;er(s,t,a)!==0&&(n.push(s),t=s)}if(n.length===1)return null;var l=n[0],u=n[1];er(l,t,u)===0&&n.shift(),n.push(n[0]);for(var p=this.isExteriorRing()?1:-1,d=this.isExteriorRing()?0:n.length-1,c=this.isExteriorRing()?n.length:-1,f=[],m=d;m!=c;m+=p)f.push([n[m].x,n[m].y]);return f}},{key:"isExteriorRing",value:function(){if(this._isExteriorRing===void 0){var t=this.enclosingRing();this._isExteriorRing=t?!t.isExteriorRing():!0}return this._isExteriorRing}},{key:"enclosingRing",value:function(){return this._enclosingRing===void 0&&(this._enclosingRing=this._calcEnclosingRing()),this._enclosingRing}},{key:"_calcEnclosingRing",value:function(){for(var t=this.events[0],n=1,i=this.events.length;n<i;n++){var o=this.events[n];Oe.compare(t,o)>0&&(t=o)}for(var s=t.segment.prevInResult(),a=s?s.prevInResult():null;;){if(!s)return null;if(!a)return s.ringOut;if(a.ringOut!==s.ringOut)return a.ringOut.enclosingRing()!==s.ringOut?s.ringOut:s.ringOut.enclosingRing();s=a.prevInResult(),a=s?s.prevInResult():null}}}]),r}(),or=function(){function r(e){Se(this,r),this.exteriorRing=e,e.poly=this,this.interiorRings=[]}return ve(r,[{key:"addInterior",value:function(t){this.interiorRings.push(t),t.poly=this}},{key:"getGeom",value:function(){var t=[this.exteriorRing.getGeom()];if(t[0]===null)return null;for(var n=0,i=this.interiorRings.length;n<i;n++){var o=this.interiorRings[n].getGeom();o!==null&&t.push(o)}return t}}]),r}(),qi=function(){function r(e){Se(this,r),this.rings=e,this.polys=this._composePolys(e)}return ve(r,[{key:"getGeom",value:function(){for(var t=[],n=0,i=this.polys.length;n<i;n++){var o=this.polys[n].getGeom();o!==null&&t.push(o)}return t}},{key:"_composePolys",value:function(t){for(var n=[],i=0,o=t.length;i<o;i++){var s=t[i];if(!s.poly)if(s.isExteriorRing())n.push(new or(s));else{var a=s.enclosingRing();a.poly||n.push(new or(a)),a.poly.addInterior(s)}}return n}}]),r}(),Di=function(){function r(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:zt.compare;Se(this,r),this.queue=e,this.tree=new Fn(t),this.segments=[]}return ve(r,[{key:"process",value:function(t){var n=t.segment,i=[];if(t.consumedBy)return t.isLeft?this.queue.remove(t.otherSE):this.tree.remove(n),i;var o=t.isLeft?this.tree.insert(n):this.tree.find(n);if(!o)throw new Error("Unable to find segment #".concat(n.id," ")+"[".concat(n.leftSE.point.x,", ").concat(n.leftSE.point.y,"] -> ")+"[".concat(n.rightSE.point.x,", ").concat(n.rightSE.point.y,"] ")+"in SweepLine tree. Please submit a bug report.");for(var s=o,a=o,l=void 0,u=void 0;l===void 0;)s=this.tree.prev(s),s===null?l=null:s.key.consumedBy===void 0&&(l=s.key);for(;u===void 0;)a=this.tree.next(a),a===null?u=null:a.key.consumedBy===void 0&&(u=a.key);if(t.isLeft){var p=null;if(l){var d=l.getIntersection(n);if(d!==null&&(n.isAnEndpoint(d)||(p=d),!l.isAnEndpoint(d)))for(var c=this._splitSafely(l,d),f=0,m=c.length;f<m;f++)i.push(c[f])}var y=null;if(u){var b=u.getIntersection(n);if(b!==null&&(n.isAnEndpoint(b)||(y=b),!u.isAnEndpoint(b)))for(var A=this._splitSafely(u,b),h=0,g=A.length;h<g;h++)i.push(A[h])}if(p!==null||y!==null){var v=null;if(p===null)v=y;else if(y===null)v=p;else{var E=Oe.comparePoints(p,y);v=E<=0?p:y}this.queue.remove(n.rightSE),i.push(n.rightSE);for(var O=n.split(v),L=0,M=O.length;L<M;L++)i.push(O[L])}i.length>0?(this.tree.remove(n),i.push(t)):(this.segments.push(n),n.prev=l)}else{if(l&&u){var N=l.getIntersection(u);if(N!==null){if(!l.isAnEndpoint(N))for(var T=this._splitSafely(l,N),C=0,G=T.length;C<G;C++)i.push(T[C]);if(!u.isAnEndpoint(N))for(var x=this._splitSafely(u,N),F=0,re=x.length;F<re;F++)i.push(x[F])}}this.tree.remove(n)}return i}},{key:"_splitSafely",value:function(t,n){this.tree.remove(t);var i=t.rightSE;this.queue.remove(i);var o=t.split(n);return o.push(i),t.consumedBy===void 0&&this.tree.insert(t),o}}]),r}(),sr=typeof process<"u"&&{}.POLYGON_CLIPPING_MAX_QUEUE_SIZE||1e6,ji=typeof process<"u"&&{}.POLYGON_CLIPPING_MAX_SWEEPLINE_SEGMENTS||1e6,Xi=function(){function r(){Se(this,r)}return ve(r,[{key:"run",value:function(t,n,i){Me.type=t,Mt.reset();for(var o=[new ir(n,!0)],s=0,a=i.length;s<a;s++)o.push(new ir(i[s],!1));if(Me.numMultiPolys=o.length,Me.type==="difference")for(var l=o[0],u=1;u<o.length;)pn(o[u].bbox,l.bbox)!==null?u++:o.splice(u,1);if(Me.type==="intersection"){for(var p=0,d=o.length;p<d;p++)for(var c=o[p],f=p+1,m=o.length;f<m;f++)if(pn(c.bbox,o[f].bbox)===null)return[]}for(var y=new Fn(Oe.compare),b=0,A=o.length;b<A;b++)for(var h=o[b].getSweepEvents(),g=0,v=h.length;g<v;g++)if(y.insert(h[g]),y.size>sr)throw new Error("Infinite loop when putting segment endpoints in a priority queue (queue size too big). Please file a bug report.");for(var E=new Di(y),O=y.size,L=y.pop();L;){var M=L.key;if(y.size===O){var N=M.segment;throw new Error("Unable to pop() ".concat(M.isLeft?"left":"right"," SweepEvent ")+"[".concat(M.point.x,", ").concat(M.point.y,"] from segment #").concat(N.id," ")+"[".concat(N.leftSE.point.x,", ").concat(N.leftSE.point.y,"] -> ")+"[".concat(N.rightSE.point.x,", ").concat(N.rightSE.point.y,"] from queue. ")+"Please file a bug report.")}if(y.size>sr)throw new Error("Infinite loop when passing sweep line over endpoints (queue size too big). Please file a bug report.");if(E.segments.length>ji)throw new Error("Infinite loop when passing sweep line over endpoints (too many sweep line segments). Please file a bug report.");for(var T=E.process(M),C=0,G=T.length;C<G;C++){var x=T[C];x.consumedBy===void 0&&y.insert(x)}O=y.size,L=y.pop()}Mt.reset();var F=Yi.factory(E.segments),re=new qi(F);return re.getGeom()}}]),r}(),Me=new Xi,Ji=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return Me.run("union",e,n)},zi=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return Me.run("intersection",e,n)},Ui=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return Me.run("xor",e,n)},Wi=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return Me.run("difference",e,n)},Bt={union:Ji,intersection:zi,xor:Ui,difference:Wi};function Hi(r,e){var t=Zi(e),n=null;return r.type==="FeatureCollection"?n=Vi(r):n=Pr(Bt.union(r.geometry.coordinates)),n.geometry.coordinates.forEach(function(i){t.geometry.coordinates.push(i[0])}),t}function Vi(r){var e=r.features.length===2?Bt.union(r.features[0].geometry.coordinates,r.features[1].geometry.coordinates):Bt.union.apply(Bt,r.features.map(function(t){return t.geometry.coordinates}));return Pr(e)}function Pr(r){return Hr(r)}function Zi(r){var e=[[[180,90],[-180,90],[-180,-90],[180,-90],[180,90]]],t=r&&r.geometry.coordinates||e;return Vr(t)}function Qi(r,e,t){let n;ne(r,Ie,s=>t(1,n=s));let{boundaryGeojson:i}=e;return Zr("setCamera")&&n.fitBounds(Rn(i),{padding:20,animate:!1}),Qe(n,"boundary",{type:"geojson",data:Hi(i)}),me(n,{id:"boundary",source:"boundary",...An("black",.5)}),r.$$set=s=>{"boundaryGeojson"in s&&t(0,i=s.boundaryGeojson)},[i]}class Ki extends K{constructor(e){super(),ee(this,e,Qi,null,Q,{boundaryGeojson:0})}}function lr(r){let e,t=ar(r[4])+"",n,i,o,s,a;return{c(){e=z("Length: "),n=z(t),i=I(),o=w("br"),s=I(),a=w("br")},m(l,u){S(l,e,u),S(l,n,u),S(l,i,u),S(l,o,u),S(l,s,u),S(l,a,u)},p(l,u){u&16&&t!==(t=ar(l[4])+"")&&Pn(n,t)},d(l){l&&k(e),l&&k(n),l&&k(i),l&&k(o),l&&k(s),l&&k(a)}}}function eo(r){let e,t,n,i,o,s,a,l,u,p,d,c,f,m,y,b,A,h,g,v,E,O,L,M,N,T,C,G,x,F,re,de,be,oe,ye,ke,ge,U,et,Be,$e,ae,ce,tt,Ge,mt,te,he=r[4]&&lr(r);return{c(){e=w("label"),t=z("Name:"),n=w("br"),i=I(),o=w("input"),s=I(),a=w("br"),l=I(),u=w("br"),p=I(),d=w("label"),c=w("input"),f=z(`
  Area`),m=I(),y=w("label"),b=w("input"),A=z(`
  Route`),h=I(),g=w("label"),v=w("input"),E=z(`
  Crossing`),O=I(),L=w("label"),M=w("input"),N=z(`
  Other`),T=I(),C=w("br"),G=I(),x=w("br"),F=I(),re=w("label"),de=z("Description:"),be=w("br"),oe=I(),ye=w("textarea"),ke=I(),ge=w("br"),U=I(),et=w("br"),Be=I(),he&&he.c(),$e=I(),ae=w("div"),ce=w("button"),ce.textContent="Delete",tt=I(),Ge=w("button"),Ge.textContent="Save",R(o,"type","text"),we(o,"width","100%"),R(c,"type","radio"),c.__value="area",c.value=c.__value,r[7][0].push(c),R(b,"type","radio"),b.__value="route",b.value=b.__value,r[7][0].push(b),R(v,"type","radio"),v.__value="crossing",v.value=v.__value,r[7][0].push(v),R(M,"type","radio"),M.__value="other",M.value=M.__value,r[7][0].push(M),we(ye,"width","100%"),R(ye,"rows","5"),R(ye,"class","svelte-15lna0i"),R(ce,"type","button"),R(Ge,"type","button"),we(ae,"display","flex"),we(ae,"justify-content","space-between")},m(P,Y){S(P,e,Y),_(e,t),_(e,n),_(e,i),_(e,o),at(o,r[0]),S(P,s,Y),S(P,a,Y),S(P,l,Y),S(P,u,Y),S(P,p,Y),S(P,d,Y),_(d,c),c.checked=c.__value===r[1],_(d,f),S(P,m,Y),S(P,y,Y),_(y,b),b.checked=b.__value===r[1],_(y,A),S(P,h,Y),S(P,g,Y),_(g,v),v.checked=v.__value===r[1],_(g,E),S(P,O,Y),S(P,L,Y),_(L,M),M.checked=M.__value===r[1],_(L,N),S(P,T,Y),S(P,C,Y),S(P,G,Y),S(P,x,Y),S(P,F,Y),S(P,re,Y),_(re,de),_(re,be),_(re,oe),_(re,ye),at(ye,r[2]),S(P,ke,Y),S(P,ge,Y),S(P,U,Y),S(P,et,Y),S(P,Be,Y),he&&he.m(P,Y),S(P,$e,Y),S(P,ae,Y),_(ae,ce),_(ae,tt),_(ae,Ge),mt||(te=[X(o,"input",r[5]),X(c,"change",r[6]),X(b,"change",r[8]),X(v,"change",r[9]),X(M,"change",r[10]),X(ye,"input",r[11]),X(ce,"click",r[12]),X(Ge,"click",r[13])],mt=!0)},p(P,[Y]){Y&1&&o.value!==P[0]&&at(o,P[0]),Y&2&&(c.checked=c.__value===P[1]),Y&2&&(b.checked=b.__value===P[1]),Y&2&&(v.checked=v.__value===P[1]),Y&2&&(M.checked=M.__value===P[1]),Y&4&&at(ye,P[2]),P[4]?he?he.p(P,Y):(he=lr(P),he.c(),he.m($e.parentNode,$e)):he&&(he.d(1),he=null)},i:J,o:J,d(P){P&&k(e),P&&k(s),P&&k(a),P&&k(l),P&&k(u),P&&k(p),P&&k(d),r[7][0].splice(r[7][0].indexOf(c),1),P&&k(m),P&&k(y),r[7][0].splice(r[7][0].indexOf(b),1),P&&k(h),P&&k(g),r[7][0].splice(r[7][0].indexOf(v),1),P&&k(O),P&&k(L),r[7][0].splice(r[7][0].indexOf(M),1),P&&k(T),P&&k(C),P&&k(G),P&&k(x),P&&k(F),P&&k(re),P&&k(ke),P&&k(ge),P&&k(U),P&&k(et),P&&k(Be),he&&he.d(P),P&&k($e),P&&k(ae),mt=!1,Ke(te)}}}function ar(r){return r<1e3?Math.round(r)+" m":(r/1e3).toFixed(1)+"km"}function to(r,e,t){let{id:n}=e,{name:i}=e,{intervention_type:o}=e,{description:s}=e,{length_meters:a}=e;const l=[[]];function u(){i=this.value,t(0,i)}function p(){o=this.__value,t(1,o)}function d(){o=this.__value,t(1,o)}function c(){o=this.__value,t(1,o)}function f(){o=this.__value,t(1,o)}function m(){s=this.value,t(2,s)}const y=()=>Rr(n),b=()=>xe.set(null);return r.$$set=A=>{"id"in A&&t(3,n=A.id),"name"in A&&t(0,i=A.name),"intervention_type"in A&&t(1,o=A.intervention_type),"description"in A&&t(2,s=A.description),"length_meters"in A&&t(4,a=A.length_meters)},[i,o,s,n,a,u,p,l,d,c,f,m,y,b]}class no extends K{constructor(e){super(),ee(this,e,to,eo,Q,{id:3,name:0,intervention_type:1,description:2,length_meters:4})}}function ro(r){const e=r-1;return e*e*e+1}function ur(r,{delay:e=0,duration:t=400,easing:n=ro}={}){const i=getComputedStyle(r),o=+i.opacity,s=parseFloat(i.height),a=parseFloat(i.paddingTop),l=parseFloat(i.paddingBottom),u=parseFloat(i.marginTop),p=parseFloat(i.marginBottom),d=parseFloat(i.borderTopWidth),c=parseFloat(i.borderBottomWidth);return{delay:e,duration:t,easing:n,css:f=>`overflow: hidden;opacity: ${Math.min(f*20,1)*o};height: ${f*s}px;padding-top: ${f*a}px;padding-bottom: ${f*l}px;margin-top: ${f*u}px;margin-bottom: ${f*p}px;border-top-width: ${f*d}px;border-bottom-width: ${f*c}px;`}}function fr(r){let e,t,n,i,o;const s=r[10].default,a=yt(s,r,r[9],null);return{c(){e=w("div"),a&&a.c(),we(e,"border","solid 1px black"),we(e,"padding","10px")},m(l,u){S(l,e,u),a&&a.m(e,null),r[13](e),n=!0,i||(o=X(e,"introend",r[14]),i=!0)},p(l,u){a&&a.p&&(!n||u&512)&&_t(a,s,l,l[9],n?wt(s,l[9],u,null):bt(l[9]),null)},i(l){n||(B(a,l),Or(()=>{t||(t=Xn(e,ur,{duration:100},!0)),t.run(1)}),n=!0)},o(l){q(a,l),t||(t=Xn(e,ur,{duration:100},!1)),t.run(0),n=!1},d(l){l&&k(e),a&&a.d(l),r[13](null),l&&t&&t.end(),i=!1,o()}}}function io(r){let e,t,n,i,o,s,a,l,u,p,d=r[4]&&fr(r);return{c(){e=w("button"),t=Dn("svg"),n=Dn("path"),i=I(),o=z(r[1]),s=I(),d&&d.c(),a=Te(),R(n,"d","M9 5l7 7-7 7"),R(t,"style","tran"),R(t,"width","20"),R(t,"height","20"),R(t,"fill","none"),R(t,"stroke-linecap","round"),R(t,"stroke-linejoin","round"),R(t,"stroke-width","2"),R(t,"viewBox","0 0 24 24"),R(t,"stroke","currentColor"),R(t,"class","svelte-t7fpgu"),R(e,"aria-expanded",r[4]),R(e,"class","svelte-t7fpgu"),jn(e,"underlined",r[3])},m(c,f){S(c,e,f),_(e,t),_(t,n),_(e,i),_(e,o),S(c,s,f),d&&d.m(c,f),S(c,a,f),l=!0,u||(p=[X(e,"click",r[5]),X(e,"mouseenter",r[11]),X(e,"mouseleave",r[12])],u=!0)},p(c,[f]){(!l||f&2)&&Pn(o,c[1]),(!l||f&16)&&R(e,"aria-expanded",c[4]),(!l||f&8)&&jn(e,"underlined",c[3]),c[4]?d?(d.p(c,f),f&16&&B(d,1)):(d=fr(c),d.c(),B(d,1),d.m(a.parentNode,a)):d&&(Pt(),q(d,1,1,()=>{d=null}),It())},i(c){l||(B(d),l=!0)},o(c){q(d),l=!1},d(c){c&&k(e),c&&k(s),d&&d.d(c),c&&k(a),u=!1,Ke(p)}}}function oo(r,e,t){let n,i,o,s;ne(r,Fe,h=>t(7,o=h)),ne(r,xe,h=>t(8,s=h));let{$$slots:a={},$$scope:l}=e,{id:u}=e,{label:p}=e;const d=()=>{xe.update(h=>h==u?null:u),s==u&&(an.set(null),an.set(u))};let c;function f(){c==null||c.scrollIntoView({behavior:"smooth"})}const m=()=>Xt.set(u),y=()=>Xt.set(null);function b(h){pe[h?"unshift":"push"](()=>{c=h,t(2,c)})}const A=()=>f();return r.$$set=h=>{"id"in h&&t(0,u=h.id),"label"in h&&t(1,p=h.label),"$$scope"in h&&t(9,l=h.$$scope)},r.$$.update=()=>{r.$$.dirty&257&&t(4,n=s==u),r.$$.dirty&129&&t(3,i=o==u)},[u,p,c,i,n,d,f,o,s,l,a,m,y,b,A]}class so extends K{constructor(e){super(),ee(this,e,oo,io,Q,{id:0,label:1})}}function cr(r,e,t){const n=r.slice();return n[6]=e[t],n[7]=e,n[8]=t,n}function lo(r){let e,t,n,i,o,s;function a(d){r[2](d,r[6])}function l(d){r[3](d,r[6])}function u(d){r[4](d,r[6])}let p={id:r[6].id,length_meters:r[6].properties.length_meters};return r[6].properties.name!==void 0&&(p.name=r[6].properties.name),r[6].properties.intervention_type!==void 0&&(p.intervention_type=r[6].properties.intervention_type),r[6].properties.description!==void 0&&(p.description=r[6].properties.description),e=new no({props:p}),pe.push(()=>Ve(e,"name",a,r[6].properties.name)),pe.push(()=>Ve(e,"intervention_type",l,r[6].properties.intervention_type)),pe.push(()=>Ve(e,"description",u,r[6].properties.description)),{c(){W(e.$$.fragment),o=I()},m(d,c){H(e,d,c),S(d,o,c),s=!0},p(d,c){r=d;const f={};c&1&&(f.id=r[6].id),c&1&&(f.length_meters=r[6].properties.length_meters),!t&&c&1&&(t=!0,f.name=r[6].properties.name,Ze(()=>t=!1)),!n&&c&1&&(n=!0,f.intervention_type=r[6].properties.intervention_type,Ze(()=>n=!1)),!i&&c&1&&(i=!0,f.description=r[6].properties.description,Ze(()=>i=!1)),e.$set(f)},i(d){s||(B(e.$$.fragment,d),s=!0)},o(d){q(e.$$.fragment,d),s=!1},d(d){V(e,d),d&&k(o)}}}function hr(r,e){let t,n,i;return n=new so({props:{id:e[6].id,label:e[8]+1+") "+pr(e[6]),$$slots:{default:[lo]},$$scope:{ctx:e}}}),{key:r,first:null,c(){t=Te(),W(n.$$.fragment),this.first=t},m(o,s){S(o,t,s),H(n,o,s),i=!0},p(o,s){e=o;const a={};s&1&&(a.id=e[6].id),s&1&&(a.label=e[8]+1+") "+pr(e[6])),s&513&&(a.$$scope={dirty:s,ctx:e}),n.$set(a)},i(o){i||(B(n.$$.fragment,o),i=!0)},o(o){q(n.$$.fragment,o),i=!1},d(o){o&&k(t),V(n,o)}}}function ao(r){let e=[],t=new Map,n,i,o,s,a=r[0].features;const l=u=>u[6].id;for(let u=0;u<a.length;u+=1){let p=cr(r,a,u),d=l(p);t.set(d,e[u]=hr(d,p))}return{c(){for(let u=0;u<e.length;u+=1)e[u].c();n=Te()},m(u,p){for(let d=0;d<e.length;d+=1)e[d].m(u,p);S(u,n,p),i=!0,o||(s=X(window,"keydown",r[1]),o=!0)},p(u,[p]){p&1&&(a=u[0].features,Pt(),e=Qr(e,p,l,1,u,a,t,n.parentNode,Kr,hr,n,cr),It())},i(u){if(!i){for(let p=0;p<a.length;p+=1)B(e[p]);i=!0}},o(u){for(let p=0;p<e.length;p+=1)q(e[p]);i=!1},d(u){for(let p=0;p<e.length;p+=1)e[p].d(u);u&&k(n),o=!1,s()}}}function pr(r){if(r.properties.name)return r.properties.name;var e=r.properties.intervention_type;return e=="other"&&(r.geometry.type=="Point"?e="point":r.geometry.type=="LineString"?e="line":e="polygon"),`Untitled ${e}`}function uo(r,e,t){let n,i;ne(r,xe,u=>t(5,n=u)),ne(r,Z,u=>t(0,i=u));function o(u){if(u.key=="Delete"){const p=u.target.tagName;if(p=="INPUT"||p=="TEXTAREA")return;u.preventDefault();const d=n;d&&Rr(d)}}function s(u,p){r.$$.not_equal(p.properties.name,u)&&(p.properties.name=u,Z.set(i))}function a(u,p){r.$$.not_equal(p.properties.intervention_type,u)&&(p.properties.intervention_type=u,Z.set(i))}function l(u,p){r.$$.not_equal(p.properties.description,u)&&(p.properties.description=u,Z.set(i))}return[i,o,s,a,l]}class fo extends K{constructor(e){super(),ee(this,e,uo,ao,Q,{})}}function Ue(r){if(!r)throw new Error("coord is required");if(!Array.isArray(r)){if(r.type==="Feature"&&r.geometry!==null&&r.geometry.type==="Point")return r.geometry.coordinates;if(r.type==="Point")return r.coordinates}if(Array.isArray(r)&&r.length>=2&&!Array.isArray(r[0])&&!Array.isArray(r[1]))return r;throw new Error("coord must be GeoJSON Point or an Array of numbers")}function Ae(r){if(Array.isArray(r))return r;if(r.type==="Feature"){if(r.geometry!==null)return r.geometry.coordinates}else if(r.coordinates)return r.coordinates;throw new Error("coords must be GeoJSON Feature, Geometry Object or an Array")}function gn(r,e){return r.type==="FeatureCollection"?"FeatureCollection":r.type==="GeometryCollection"?"GeometryCollection":r.type==="Feature"&&r.geometry!==null?r.geometry.type:r.type}function je(r,e,t){t===void 0&&(t={});var n=Ue(r),i=Ue(e),o=Ee(i[1]-n[1]),s=Ee(i[0]-n[0]),a=Ee(n[1]),l=Ee(i[1]),u=Math.pow(Math.sin(o/2),2)+Math.pow(Math.sin(s/2),2)*Math.cos(a)*Math.cos(l);return ei(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)),t.units)}function $t(r,e){return e===void 0&&(e={}),ti(r,function(t,n){var i=n.geometry.coordinates;return t+je(i[0],i[1],e)},0)}function co(r){let e,t,n,i,o,s,a,l,u,p,d,c,f,m,y,b,A,h,g,v=r[0].features.length+"",E,O,L,M,N,T,C,G;return{c(){e=w("div"),t=w("label"),n=z(`Scheme name:
    `),i=w("input"),o=I(),s=w("br"),a=I(),l=w("div"),u=w("label"),p=w("input"),d=I(),c=w("button"),c.textContent="Load from GeoJSON",f=I(),m=w("button"),m.textContent="Export to GeoJSON",y=I(),b=w("br"),A=I(),h=w("div"),g=w("span"),E=z(v),O=z(" interventions"),L=I(),M=w("button"),N=z("Clear all"),R(i,"type","text"),R(p,"type","file"),R(p,"id","load_geojson"),R(p,"class","svelte-lhyd1e"),R(c,"type","button"),R(m,"type","button"),R(m,"class","align-right svelte-lhyd1e"),R(M,"type","button"),R(M,"class","align-right svelte-lhyd1e"),M.disabled=T=r[0].features.length==0},m(x,F){S(x,e,F),_(e,t),_(t,n),_(t,i),at(i,r[0].scheme_name),S(x,o,F),S(x,s,F),S(x,a,F),S(x,l,F),_(l,u),_(u,p),_(u,d),_(u,c),_(l,f),_(l,m),S(x,y,F),S(x,b,F),S(x,A,F),S(x,h,F),_(h,g),_(g,E),_(g,O),_(h,L),_(h,M),_(M,N),C||(G=[X(i,"input",r[5]),X(p,"change",r[3]),X(c,"click",po),X(m,"click",r[2]),X(M,"click",r[1])],C=!0)},p(x,[F]){F&1&&i.value!==x[0].scheme_name&&at(i,x[0].scheme_name),F&1&&v!==(v=x[0].features.length+"")&&Pn(E,v),F&1&&T!==(T=x[0].features.length==0)&&(M.disabled=T)},i:J,o:J,d(x){x&&k(e),x&&k(o),x&&k(s),x&&k(a),x&&k(l),x&&k(y),x&&k(b),x&&k(A),x&&k(h),C=!1,Ke(G)}}}function ho(r,e){var t=document.createElement("a");t.setAttribute("href","data:text/plain;charset=utf-8, "+encodeURIComponent(e)),t.setAttribute("download",r),document.body.appendChild(t),t.click(),document.body.removeChild(t)}function po(){document.getElementById("load_geojson").click()}function go(r,e,t){let n;ne(r,Z,c=>t(0,n=c));let{authorityName:i}=e,o=window.localStorage.getItem(i);if(o)try{Z.set(p(JSON.parse(o)))}catch(c){console.log(`Failed to load from local storage: ${c}`)}function s(){confirm("Do you want to clear the current scheme? (You should save it first!)")&&Z.update(c=>(delete c.scheme_name,c.features=[],c))}function a(){const c=JSON.parse(JSON.stringify(n));for(let f of c.features)delete f.properties.hide_while_editing;return c}function l(){let c=a();var f=i;c.authority=i,c.origin="atip-v1",c.scheme_name&&(f+="_"+c.scheme_name),f+=".txt",ho(f,JSON.stringify(c,null,"  "))}function u(c){const f=new FileReader;f.onload=y=>{try{Z.set(p(JSON.parse(y.target.result)))}catch(b){window.alert(`Couldn't load scheme from a file: ${b}`)}};let m=c.target.files;f.readAsText(m[0])}function p(c){let f=1;for(let m of c.features)m.geometry.type=="LineString"&&!m.properties.length_meters&&(m.properties.length_meters=$t(m,{units:"kilometers"})*1e3),m.id=f++;return c}function d(){n.scheme_name=this.value,Z.set(n)}return r.$$set=c=>{"authorityName"in c&&t(4,i=c.authorityName)},r.$$.update=()=>{r.$$.dirty&17&&n&&(console.log("GJ changed, saving to local storage"),window.localStorage.setItem(i,JSON.stringify(a())))},[n,s,l,u,i,d]}class mo extends K{constructor(e){super(),ee(this,e,go,co,Q,{authorityName:4})}}const vo="/atip/route_from_scratch/assets/zoom_out_map-b2e1091a.svg";function yo(r){let e,t,n,i,o;return{c(){e=w("button"),t=w("img"),ni(t.src,n=vo)||R(t,"src",n),R(t,"alt","Zoom to show entire boundary"),R(e,"type","button"),R(e,"title","Zoom to show entire boundary"),R(e,"class","svelte-qzjsqo")},m(s,a){S(s,e,a),_(e,t),i||(o=X(e,"click",r[0]),i=!0)},p:J,i:J,o:J,d(s){s&&k(e),i=!1,o()}}}function _o(r,e,t){let n;ne(r,Ie,s=>t(2,n=s));let{boundaryGeojson:i}=e;function o(){n.fitBounds(Rn(i),{padding:20,animate:!0,duration:500})}return r.$$set=s=>{"boundaryGeojson"in s&&t(1,i=s.boundaryGeojson)},[o,i]}class bo extends K{constructor(e){super(),ee(this,e,_o,yo,Q,{boundaryGeojson:1})}}function wo(r){let e,t,n,i,o,s,a;return{c(){e=w("div"),t=z(`Basemap:
  `),n=w("select"),i=w("option"),i.textContent="Streets",o=w("option"),o.textContent="Satellite",i.__value="streets",i.value=i.__value,o.__value="hybrid",o.value=o.__value,r[0]===void 0&&Or(()=>r[2].call(n)),R(e,"class","svelte-1tbnm6i")},m(l,u){S(l,e,u),_(e,t),_(e,n),_(n,i),_(n,o),Jn(n,r[0]),s||(a=[X(n,"change",r[2]),X(n,"change",r[1])],s=!0)},p(l,[u]){u&1&&Jn(n,l[0])},i:J,o:J,d(l){l&&k(e),s=!1,Ke(a)}}}function xo(r,e,t){let{style:n}=e;function i(){let s=new URLSearchParams(window.location.search);s.set("style",n);let a=`${window.location.pathname}?${s.toString()}${window.location.hash}`;window.location.href=a}function o(){n=ri(this),t(0,n)}return r.$$set=s=>{"style"in s&&t(0,n=s.style)},[n,i,o]}class So extends K{constructor(e){super(),ee(this,e,xo,wo,Q,{style:0})}}const _e={area:"#e41a1c",route:"#377eb8",crossing:"#4daf4a",other:"#984ea3",hovering:"black",lineEndpointColor:"black"},Kt=10,Ut=10;function ko(r){let e,t,n,i,o,s,a,l,u,p,d,c,f,m,y,b,A,h,g;return{c(){e=w("div"),t=w("h1"),t.textContent="Interventions",n=I(),i=w("ul"),o=w("li"),s=w("span"),a=z("Areas"),l=I(),u=w("li"),p=w("span"),d=z("Routes"),c=I(),f=w("li"),m=w("span"),y=z("Crossings"),b=I(),A=w("li"),h=w("span"),g=z("Other"),R(t,"class","svelte-p551i1"),R(s,"class","svelte-p551i1"),we(s,"background",_e.area),R(p,"class","svelte-p551i1"),we(p,"background",_e.route),R(m,"class","svelte-p551i1"),we(m,"background",_e.crossing),R(h,"class","svelte-p551i1"),we(h,"background",_e.other),R(e,"class","svelte-p551i1")},m(v,E){S(v,e,E),_(e,t),_(e,n),_(e,i),_(i,o),_(o,s),_(o,a),_(i,l),_(i,u),_(u,p),_(u,d),_(i,c),_(i,f),_(f,m),_(f,y),_(i,b),_(i,A),_(A,h),_(A,g)},p:J,i:J,o:J,d(v){v&&k(e)}}}class Eo extends K{constructor(e){super(),ee(this,e,null,ko,Q,{})}}let it="interventions";function Mo(r,e,t){let n,i;ne(r,Ie,l=>t(0,n=l)),ne(r,Z,l=>t(1,i=l)),Qe(n,it,{type:"geojson",data:i});const o=["match",["get","intervention_type"],"area",_e.area,"route",_e.route,"crossing",_e.crossing,"other",_e.other,"white"],s=["!=","hide_while_editing",!0];return me(n,{id:"interventions-points",source:it,filter:["all",Vt,s,["!=","endpoint",!0]],...dt(o,Kt)}),me(n,{id:"interventions-lines",source:it,filter:["all",Zt,s],...Et(o,Ut)},"route-lines"),me(n,{id:"interventions-lines-endpoints",source:it,filter:["==","endpoint",!0],type:"circle",paint:{"circle-radius":.5*Ut,"circle-opacity":0,"circle-stroke-color":_e.lineEndpointColor,"circle-stroke-width":2}}),me(n,{id:"interventions-polygons",source:it,filter:["all",In,s],...An(o,.5)},"hover-polygons"),r.$$.update=()=>{if(r.$$.dirty&3){let l=JSON.parse(JSON.stringify(i)),u=[];for(let p of l.features)if(p.geometry.type=="LineString")for(let d of[p.geometry.coordinates[0],p.geometry.coordinates[p.geometry.coordinates.length-1]])u.push({type:"Feature",properties:{endpoint:!0},geometry:{type:"Point",coordinates:d}});l.features=l.features.concat(u),n.getSource(it).setData(l)}},[n,i]}class Lo extends K{constructor(e){super(),ee(this,e,Mo,null,Q,{})}}let ot="hover";function Oo(r,e,t){let n,i,o,s,a;return ne(r,Ie,l=>t(0,n=l)),ne(r,Z,l=>t(1,i=l)),ne(r,Xt,l=>t(2,o=l)),ne(r,Fe,l=>t(3,s=l)),ne(r,xe,l=>t(4,a=l)),Qe(n,ot,{type:"geojson",data:Pe()}),me(n,{id:"hover-polygons",source:ot,filter:In,...Et(_e.hovering,.5*Ut,1)}),me(n,{id:"hover-lines",source:ot,filter:Zt,...Et(_e.hovering,1.5*Ut,1)},"interventions-lines"),me(n,{id:"hover-points",source:ot,filter:Vt,...dt(_e.hovering,1.5*Kt,1)},"interventions-points"),r.$$.update=()=>{if(r.$$.dirty&31){let l=a||s||o;l!=null?n.getSource(ot).setData(i.features.find(u=>u.id==l)):n.getSource(ot).setData(Pe())}},[n,i,o,s,a]}class Ro extends K{constructor(e){super(),ee(this,e,Oo,null,Q,{})}}const Ct="edit-point-mode";var Ot,mn;class Ao{constructor(e){nt(this,Ot);fe(this,"map");fe(this,"active");fe(this,"eventListeners");fe(this,"cursor");this.map=e,this.active=!1,this.eventListeners=[],this.cursor=null,e.on("mousemove",t=>{this.active&&(this.cursor=Po(t.lngLat.toArray()),ie(this,Ot,mn).call(this))}),e.on("click",()=>{if(this.active&&this.cursor){for(let t of this.eventListeners)t(this.cursor);this.stop()}}),Qe(e,Ct,{type:"geojson",data:Pe()}),me(e,{id:"edit-point-mode",source:Ct,...dt(_e.hovering,Kt,1)})}addEventListener(e){this.eventListeners.push(e)}tearDown(){this.map.removeLayer("edit-point-mode"),this.map.removeSource(Ct)}start(){this.active=!0}stop(){this.cursor=null,this.active=!1,ie(this,Ot,mn).call(this)}}Ot=new WeakSet,mn=function(){let e=Pe();this.cursor&&e.features.push(this.cursor),this.map.getSource(Ct).setData(e)};function Po(r){return{type:"Feature",properties:{},geometry:{type:"Point",coordinates:r}}}function Ir(r,e,t){if(t===void 0&&(t={}),t.final===!0)return Io(r,e);var n=Ue(r),i=Ue(e),o=Ee(n[0]),s=Ee(i[0]),a=Ee(n[1]),l=Ee(i[1]),u=Math.sin(s-o)*Math.cos(l),p=Math.cos(a)*Math.sin(l)-Math.sin(a)*Math.cos(l)*Math.cos(s-o);return ln(Math.atan2(u,p))}function Io(r,e){var t=Ir(e,r);return t=(t+180)%360,t}function dr(r,e,t,n){n===void 0&&(n={});var i=Ue(r),o=Ee(i[0]),s=Ee(i[1]),a=Ee(t),l=ii(e,n.units),u=Math.asin(Math.sin(s)*Math.cos(l)+Math.cos(s)*Math.sin(l)*Math.cos(a)),p=o+Math.atan2(Math.sin(a)*Math.sin(l)*Math.cos(s),Math.cos(l)-Math.sin(s)*Math.sin(u)),d=ln(p),c=ln(u);return ct([d,c],n.properties)}function vn(r){if(!r)throw new Error("geojson is required");var e=[];return Nn(r,function(t){No(t,e)}),ze(e)}function No(r,e){var t=[],n=r.geometry;if(n!==null){switch(n.type){case"Polygon":t=Ae(n);break;case"LineString":t=[Ae(n)]}t.forEach(function(i){var o=Co(i,r.properties);o.forEach(function(s){s.id=e.length,e.push(s)})})}}function Co(r,e){var t=[];return r.reduce(function(n,i){var o=ht([n,i],e);return o.bbox=Fo(n,i),t.push(o),i}),t}function Fo(r,e){var t=r[0],n=r[1],i=e[0],o=e[1],s=t<i?t:i,a=n<o?n:o,l=t>i?t:i,u=n>o?n:o;return[s,a,l,u]}var pt={},To={get exports(){return pt},set exports(r){pt=r}},yn={},Bo={get exports(){return yn},set exports(r){yn=r}};(function(r,e){(function(t,n){r.exports=n()})(oi,function(){function t(h,g,v,E,O){(function L(M,N,T,C,G){for(;C>T;){if(C-T>600){var x=C-T+1,F=N-T+1,re=Math.log(x),de=.5*Math.exp(2*re/3),be=.5*Math.sqrt(re*de*(x-de)/x)*(F-x/2<0?-1:1),oe=Math.max(T,Math.floor(N-F*de/x+be)),ye=Math.min(C,Math.floor(N+(x-F)*de/x+be));L(M,N,oe,ye,G)}var ke=M[N],ge=T,U=C;for(n(M,T,N),G(M[C],ke)>0&&n(M,T,C);ge<U;){for(n(M,ge,U),ge++,U--;G(M[ge],ke)<0;)ge++;for(;G(M[U],ke)>0;)U--}G(M[T],ke)===0?n(M,T,U):n(M,++U,C),U<=N&&(T=U+1),N<=U&&(C=U-1)}})(h,g,v||0,E||h.length-1,O||i)}function n(h,g,v){var E=h[g];h[g]=h[v],h[v]=E}function i(h,g){return h<g?-1:h>g?1:0}var o=function(h){h===void 0&&(h=9),this._maxEntries=Math.max(4,h),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()};function s(h,g,v){if(!v)return g.indexOf(h);for(var E=0;E<g.length;E++)if(v(h,g[E]))return E;return-1}function a(h,g){l(h,0,h.children.length,g,h)}function l(h,g,v,E,O){O||(O=b(null)),O.minX=1/0,O.minY=1/0,O.maxX=-1/0,O.maxY=-1/0;for(var L=g;L<v;L++){var M=h.children[L];u(O,h.leaf?E(M):M)}return O}function u(h,g){return h.minX=Math.min(h.minX,g.minX),h.minY=Math.min(h.minY,g.minY),h.maxX=Math.max(h.maxX,g.maxX),h.maxY=Math.max(h.maxY,g.maxY),h}function p(h,g){return h.minX-g.minX}function d(h,g){return h.minY-g.minY}function c(h){return(h.maxX-h.minX)*(h.maxY-h.minY)}function f(h){return h.maxX-h.minX+(h.maxY-h.minY)}function m(h,g){return h.minX<=g.minX&&h.minY<=g.minY&&g.maxX<=h.maxX&&g.maxY<=h.maxY}function y(h,g){return g.minX<=h.maxX&&g.minY<=h.maxY&&g.maxX>=h.minX&&g.maxY>=h.minY}function b(h){return{children:h,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function A(h,g,v,E,O){for(var L=[g,v];L.length;)if(!((v=L.pop())-(g=L.pop())<=E)){var M=g+Math.ceil((v-g)/E/2)*E;t(h,M,g,v,O),L.push(g,M,M,v)}}return o.prototype.all=function(){return this._all(this.data,[])},o.prototype.search=function(h){var g=this.data,v=[];if(!y(h,g))return v;for(var E=this.toBBox,O=[];g;){for(var L=0;L<g.children.length;L++){var M=g.children[L],N=g.leaf?E(M):M;y(h,N)&&(g.leaf?v.push(M):m(h,N)?this._all(M,v):O.push(M))}g=O.pop()}return v},o.prototype.collides=function(h){var g=this.data;if(!y(h,g))return!1;for(var v=[];g;){for(var E=0;E<g.children.length;E++){var O=g.children[E],L=g.leaf?this.toBBox(O):O;if(y(h,L)){if(g.leaf||m(h,L))return!0;v.push(O)}}g=v.pop()}return!1},o.prototype.load=function(h){if(!h||!h.length)return this;if(h.length<this._minEntries){for(var g=0;g<h.length;g++)this.insert(h[g]);return this}var v=this._build(h.slice(),0,h.length-1,0);if(this.data.children.length)if(this.data.height===v.height)this._splitRoot(this.data,v);else{if(this.data.height<v.height){var E=this.data;this.data=v,v=E}this._insert(v,this.data.height-v.height-1,!0)}else this.data=v;return this},o.prototype.insert=function(h){return h&&this._insert(h,this.data.height-1),this},o.prototype.clear=function(){return this.data=b([]),this},o.prototype.remove=function(h,g){if(!h)return this;for(var v,E,O,L=this.data,M=this.toBBox(h),N=[],T=[];L||N.length;){if(L||(L=N.pop(),E=N[N.length-1],v=T.pop(),O=!0),L.leaf){var C=s(h,L.children,g);if(C!==-1)return L.children.splice(C,1),N.push(L),this._condense(N),this}O||L.leaf||!m(L,M)?E?(v++,L=E.children[v],O=!1):L=null:(N.push(L),T.push(v),v=0,E=L,L=L.children[0])}return this},o.prototype.toBBox=function(h){return h},o.prototype.compareMinX=function(h,g){return h.minX-g.minX},o.prototype.compareMinY=function(h,g){return h.minY-g.minY},o.prototype.toJSON=function(){return this.data},o.prototype.fromJSON=function(h){return this.data=h,this},o.prototype._all=function(h,g){for(var v=[];h;)h.leaf?g.push.apply(g,h.children):v.push.apply(v,h.children),h=v.pop();return g},o.prototype._build=function(h,g,v,E){var O,L=v-g+1,M=this._maxEntries;if(L<=M)return a(O=b(h.slice(g,v+1)),this.toBBox),O;E||(E=Math.ceil(Math.log(L)/Math.log(M)),M=Math.ceil(L/Math.pow(M,E-1))),(O=b([])).leaf=!1,O.height=E;var N=Math.ceil(L/M),T=N*Math.ceil(Math.sqrt(M));A(h,g,v,T,this.compareMinX);for(var C=g;C<=v;C+=T){var G=Math.min(C+T-1,v);A(h,C,G,N,this.compareMinY);for(var x=C;x<=G;x+=N){var F=Math.min(x+N-1,G);O.children.push(this._build(h,x,F,E-1))}}return a(O,this.toBBox),O},o.prototype._chooseSubtree=function(h,g,v,E){for(;E.push(g),!g.leaf&&E.length-1!==v;){for(var O=1/0,L=1/0,M=void 0,N=0;N<g.children.length;N++){var T=g.children[N],C=c(T),G=(x=h,F=T,(Math.max(F.maxX,x.maxX)-Math.min(F.minX,x.minX))*(Math.max(F.maxY,x.maxY)-Math.min(F.minY,x.minY))-C);G<L?(L=G,O=C<O?C:O,M=T):G===L&&C<O&&(O=C,M=T)}g=M||g.children[0]}var x,F;return g},o.prototype._insert=function(h,g,v){var E=v?h:this.toBBox(h),O=[],L=this._chooseSubtree(E,this.data,g,O);for(L.children.push(h),u(L,E);g>=0&&O[g].children.length>this._maxEntries;)this._split(O,g),g--;this._adjustParentBBoxes(E,O,g)},o.prototype._split=function(h,g){var v=h[g],E=v.children.length,O=this._minEntries;this._chooseSplitAxis(v,O,E);var L=this._chooseSplitIndex(v,O,E),M=b(v.children.splice(L,v.children.length-L));M.height=v.height,M.leaf=v.leaf,a(v,this.toBBox),a(M,this.toBBox),g?h[g-1].children.push(M):this._splitRoot(v,M)},o.prototype._splitRoot=function(h,g){this.data=b([h,g]),this.data.height=h.height+1,this.data.leaf=!1,a(this.data,this.toBBox)},o.prototype._chooseSplitIndex=function(h,g,v){for(var E,O,L,M,N,T,C,G=1/0,x=1/0,F=g;F<=v-g;F++){var re=l(h,0,F,this.toBBox),de=l(h,F,v,this.toBBox),be=(O=re,L=de,M=void 0,N=void 0,T=void 0,C=void 0,M=Math.max(O.minX,L.minX),N=Math.max(O.minY,L.minY),T=Math.min(O.maxX,L.maxX),C=Math.min(O.maxY,L.maxY),Math.max(0,T-M)*Math.max(0,C-N)),oe=c(re)+c(de);be<G?(G=be,E=F,x=oe<x?oe:x):be===G&&oe<x&&(x=oe,E=F)}return E||v-g},o.prototype._chooseSplitAxis=function(h,g,v){var E=h.leaf?this.compareMinX:p,O=h.leaf?this.compareMinY:d;this._allDistMargin(h,g,v,E)<this._allDistMargin(h,g,v,O)&&h.children.sort(E)},o.prototype._allDistMargin=function(h,g,v,E){h.children.sort(E);for(var O=this.toBBox,L=l(h,0,g,O),M=l(h,v-g,v,O),N=f(L)+f(M),T=g;T<v-g;T++){var C=h.children[T];u(L,h.leaf?O(C):C),N+=f(L)}for(var G=v-g-1;G>=g;G--){var x=h.children[G];u(M,h.leaf?O(x):x),N+=f(M)}return N},o.prototype._adjustParentBBoxes=function(h,g,v){for(var E=v;E>=0;E--)u(g[E],h)},o.prototype._condense=function(h){for(var g=h.length-1,v=void 0;g>=0;g--)h[g].children.length===0?g>0?(v=h[g-1].children).splice(v.indexOf(h[g]),1):this.clear():a(h[g],this.toBBox)},o})})(Bo);const $o=Cn(si),Go=Cn(li),Yo=Cn(ai);var Le=yn,Nr=$o,Cr=Go,st=Yo.default,qo=Cr.featureEach;Cr.coordEach;Nr.polygon;var gr=Nr.featureCollection;function Fr(r){var e=new Le(r);return e.insert=function(t){if(t.type!=="Feature")throw new Error("invalid feature");return t.bbox=t.bbox?t.bbox:st(t),Le.prototype.insert.call(this,t)},e.load=function(t){var n=[];return Array.isArray(t)?t.forEach(function(i){if(i.type!=="Feature")throw new Error("invalid features");i.bbox=i.bbox?i.bbox:st(i),n.push(i)}):qo(t,function(i){if(i.type!=="Feature")throw new Error("invalid features");i.bbox=i.bbox?i.bbox:st(i),n.push(i)}),Le.prototype.load.call(this,n)},e.remove=function(t,n){if(t.type!=="Feature")throw new Error("invalid feature");return t.bbox=t.bbox?t.bbox:st(t),Le.prototype.remove.call(this,t,n)},e.clear=function(){return Le.prototype.clear.call(this)},e.search=function(t){var n=Le.prototype.search.call(this,this.toBBox(t));return gr(n)},e.collides=function(t){return Le.prototype.collides.call(this,this.toBBox(t))},e.all=function(){var t=Le.prototype.all.call(this);return gr(t)},e.toJSON=function(){return Le.prototype.toJSON.call(this)},e.fromJSON=function(t){return Le.prototype.fromJSON.call(this,t)},e.toBBox=function(t){var n;if(t.bbox)n=t.bbox;else if(Array.isArray(t)&&t.length===4)n=t;else if(Array.isArray(t)&&t.length===6)n=[t[0],t[1],t[3],t[4]];else if(t.type==="Feature")n=st(t);else if(t.type==="FeatureCollection")n=st(t);else throw new Error("invalid geojson");return{minX:n[0],minY:n[1],maxX:n[2],maxY:n[3]}},e}To.exports=Fr;pt.default=Fr;function Tr(r,e){var t={},n=[];if(r.type==="LineString"&&(r=zn(r)),e.type==="LineString"&&(e=zn(e)),r.type==="Feature"&&e.type==="Feature"&&r.geometry!==null&&e.geometry!==null&&r.geometry.type==="LineString"&&e.geometry.type==="LineString"&&r.geometry.coordinates.length===2&&e.geometry.coordinates.length===2){var i=mr(r,e);return i&&n.push(i),ze(n)}var o=pt();return o.load(vn(e)),jt(vn(r),function(s){jt(o.search(s),function(a){var l=mr(s,a);if(l){var u=Ae(l).join(",");t[u]||(t[u]=!0,n.push(l))}})}),ze(n)}function mr(r,e){var t=Ae(r),n=Ae(e);if(t.length!==2)throw new Error("<intersects> line1 must only contain 2 coordinates");if(n.length!==2)throw new Error("<intersects> line2 must only contain 2 coordinates");var i=t[0][0],o=t[0][1],s=t[1][0],a=t[1][1],l=n[0][0],u=n[0][1],p=n[1][0],d=n[1][1],c=(d-u)*(s-i)-(p-l)*(a-o),f=(p-l)*(o-u)-(d-u)*(i-l),m=(s-i)*(o-u)-(a-o)*(i-l);if(c===0)return f===0&&m===0,null;var y=f/c,b=m/c;if(y>=0&&y<=1&&b>=0&&b<=1){var A=i+y*(s-i),h=o+y*(a-o);return ct([A,h])}return null}function Lt(r,e,t){t===void 0&&(t={});var n=ct([1/0,1/0],{dist:1/0}),i=0;return Nn(r,function(o){for(var s=Ae(o),a=0;a<s.length-1;a++){var l=ct(s[a]);l.properties.dist=je(e,l,t);var u=ct(s[a+1]);u.properties.dist=je(e,u,t);var p=je(l,u,t),d=Math.max(l.properties.dist,u.properties.dist),c=Ir(l,u),f=dr(e,d,c+90,t),m=dr(e,d,c-90,t),y=Tr(ht([f.geometry.coordinates,m.geometry.coordinates]),ht([l.geometry.coordinates,u.geometry.coordinates])),b=null;y.features.length>0&&(b=y.features[0],b.properties.dist=je(e,b,t),b.properties.location=i+je(l,b,t)),l.properties.dist<n.properties.dist&&(n=l,n.properties.index=a,n.properties.location=i),u.properties.dist<n.properties.dist&&(n=u,n.properties.index=a+1,n.properties.location=i+p),b&&b.properties.dist<n.properties.dist&&(n=b,n.properties.index=a),i+=p}}),n}const lt="edit-polygon-mode";var Ne,He,Rt,_n,At,bn;class Do{constructor(e){nt(this,Ne);nt(this,Rt);nt(this,At);fe(this,"map");fe(this,"active");fe(this,"eventListeners");fe(this,"points");fe(this,"cursor");fe(this,"hover");fe(this,"dragFrom");this.map=e,this.active=!1,this.eventListeners=[],this.points=[],this.cursor=null,this.hover=null,this.dragFrom=null,e.on("mousemove",t=>{if(this.active&&!this.dragFrom)ie(this,Rt,_n).call(this,t);else if(this.active&&this.dragFrom){if(this.hover=="polygon"){let n=this.dragFrom[0]-t.lngLat.lng,i=this.dragFrom[1]-t.lngLat.lat;for(let o of this.points)o[0]-=n,o[1]-=i}else this.points[this.hover]=t.lngLat.toArray();this.dragFrom=t.lngLat.toArray(),ie(this,Ne,He).call(this)}}),e.on("click",t=>{if(this.active&&this.cursor){let n=[];if(yr(this.points).forEach((i,o)=>{n.push([o+1,Lt(i,this.cursor).properties.dist])}),n.sort((i,o)=>i[1]-o[1]),n.length>0){let i=n[0][0];this.points.splice(i,0,this.cursor.geometry.coordinates),this.hover=i}else this.points.push(this.cursor.geometry.coordinates),this.hover=this.points.length-1;ie(this,Ne,He).call(this)}else this.active&&typeof this.hover=="number"&&(this.points.splice(this.hover,1),this.hover=null,ie(this,Ne,He).call(this),ie(this,Rt,_n).call(this,t))}),e.on("mousedown",t=>{this.active&&!this.dragFrom&&this.hover!=null&&(t.preventDefault(),this.cursor=null,this.dragFrom=t.lngLat.toArray())}),e.on("mouseup",()=>{this.active&&this.dragFrom&&(this.dragFrom=null)}),document.addEventListener("keypress",t=>{if(this.active&&t.key=="Enter"){t.preventDefault();let n=ie(this,At,bn).call(this);if(n)for(let i of this.eventListeners)i(n);this.stop()}}),Qe(e,lt,{type:"geojson",data:Pe()}),me(e,{id:"edit-polygon-fill",source:lt,filter:In,...An("red",["case",["boolean",["get","hover"],"false"],1,.5])}),me(e,{id:"edit-polygon-lines",source:lt,filter:Zt,...Et("black",8,.5)}),me(e,{id:"edit-polygon-vertices",source:lt,filter:Vt,...dt(_e.hovering,Kt,["case",["boolean",["get","hover"],"false"],1,.5])})}addEventListener(e){this.eventListeners.push(e)}tearDown(){this.map.removeLayer("edit-polygon-vertices"),this.map.removeLayer("edit-polygon-fill"),this.map.removeLayer("edit-polygon-lines"),this.map.removeSource(lt)}startNew(){this.active=!0}editExisting(e){this.active=!0,this.points=e.geometry.coordinates[0],this.points.pop(),ie(this,Ne,He).call(this)}stop(){this.points=[],this.cursor=null,this.active=!1,this.hover=null,this.dragFrom=null,ie(this,Ne,He).call(this)}}Ne=new WeakSet,He=function(){let e=Pe();this.points.forEach((n,i)=>{let o=vr(n);o.properties.hover=this.hover==i,o.properties.idx=i,e.features.push(o)}),this.cursor&&e.features.push(this.cursor),e.features=e.features.concat(yr(this.points));let t=ie(this,At,bn).call(this);t&&(t.properties.hover=this.hover=="polygon",e.features.push(t)),this.map.getSource(lt).setData(e)},Rt=new WeakSet,_n=function(e){this.cursor=null,this.hover=null;for(let t of this.map.queryRenderedFeatures(e.point,{layers:["edit-polygon-fill","edit-polygon-vertices"]}))if(t.geometry.type=="Polygon"){this.hover="polygon";break}else if(t.geometry.type=="Point"&&Object.hasOwn(t.properties,"idx")){this.hover=t.properties.idx;break}this.hover==null&&(this.cursor=vr(e.lngLat.toArray())),ie(this,Ne,He).call(this)},At=new WeakSet,bn=function(){if(this.points.length<3)return null;let e=[JSON.parse(JSON.stringify(this.points))];return e[0].push(JSON.parse(JSON.stringify(e[0][0]))),{type:"Feature",geometry:{type:"Polygon",coordinates:e},properties:{}}};function vr(r){return{type:"Feature",properties:{},geometry:{type:"Point",coordinates:r}}}function yr(r){let e=[];for(let t=0;t<r.length-1;t++)e.push({type:"Feature",geometry:{type:"LineString",coordinates:[r[t],r[t+1]]},properties:{}});return r.length>=3&&e.push({type:"Feature",geometry:{type:"LineString",coordinates:[r[r.length-1],r[0]]},properties:{}}),e}let $;const Br=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});Br.decode();let Gt=new Uint8Array;function St(){return Gt.byteLength===0&&(Gt=new Uint8Array($.memory.buffer)),Gt}function ut(r,e){return Br.decode(St().subarray(r,r+e))}const Ce=new Array(32).fill(void 0);Ce.push(void 0,null,!0,!1);let kt=Ce.length;function se(r){kt===Ce.length&&Ce.push(Ce.length+1);const e=kt;return kt=Ce[e],Ce[e]=r,e}function D(r){return Ce[r]}function jo(r){r<36||(Ce[r]=kt,kt=r)}function wn(r){const e=D(r);return jo(r),e}function nn(r){return r==null}let Yt=new Float64Array;function Xo(){return Yt.byteLength===0&&(Yt=new Float64Array($.memory.buffer)),Yt}let qt=new Int32Array;function le(){return qt.byteLength===0&&(qt=new Int32Array($.memory.buffer)),qt}let Je=0;const Dt=new TextEncoder("utf-8"),Jo=typeof Dt.encodeInto=="function"?function(r,e){return Dt.encodeInto(r,e)}:function(r,e){const t=Dt.encode(r);return e.set(t),{read:r.length,written:t.length}};function Ft(r,e,t){if(t===void 0){const a=Dt.encode(r),l=e(a.length);return St().subarray(l,l+a.length).set(a),Je=a.length,l}let n=r.length,i=e(n);const o=St();let s=0;for(;s<n;s++){const a=r.charCodeAt(s);if(a>127)break;o[i+s]=a}if(s!==n){s!==0&&(r=r.slice(s)),i=t(i,n,n=s+r.length*3);const a=St().subarray(i+s,i+n),l=Jo(r,a);s+=l.written}return Je=s,i}function xn(r){const e=typeof r;if(e=="number"||e=="boolean"||r==null)return`${r}`;if(e=="string")return`"${r}"`;if(e=="symbol"){const i=r.description;return i==null?"Symbol":`Symbol(${i})`}if(e=="function"){const i=r.name;return typeof i=="string"&&i.length>0?`Function(${i})`:"Function"}if(Array.isArray(r)){const i=r.length;let o="[";i>0&&(o+=xn(r[0]));for(let s=1;s<i;s++)o+=", "+xn(r[s]);return o+="]",o}const t=/\[object ([^\]]+)\]/.exec(toString.call(r));let n;if(t.length>1)n=t[1];else return toString.call(r);if(n=="Object")try{return"Object("+JSON.stringify(r)+")"}catch{return"Object"}return r instanceof Error?`${r.name}: ${r.message}
${r.stack}`:n}function zo(r,e){const t=e(r.length*1);return St().set(r,t/1),Je=r.length,t}function rn(r,e){try{return r.apply(this,e)}catch(t){$.__wbindgen_exn_store(se(t))}}class Wt{static __wrap(e){const t=Object.create(Wt.prototype);return t.ptr=e,t}__destroy_into_raw(){const e=this.ptr;return this.ptr=0,e}free(){const e=this.__destroy_into_raw();$.__wbg_jsroutesnapper_free(e)}constructor(e){try{const o=$.__wbindgen_add_to_stack_pointer(-16),s=zo(e,$.__wbindgen_malloc),a=Je;$.jsroutesnapper_new(o,s,a);var t=le()[o/4+0],n=le()[o/4+1],i=le()[o/4+2];if(i)throw wn(n);return Wt.__wrap(t)}finally{$.__wbindgen_add_to_stack_pointer(16)}}setConfig(e){$.jsroutesnapper_setConfig(this.ptr,se(e))}toFinalFeature(){try{const n=$.__wbindgen_add_to_stack_pointer(-16);$.jsroutesnapper_toFinalFeature(n,this.ptr);var e=le()[n/4+0],t=le()[n/4+1];let i;return e!==0&&(i=ut(e,t).slice(),$.__wbindgen_free(e,t*1)),i}finally{$.__wbindgen_add_to_stack_pointer(16)}}renderGeojson(){try{const n=$.__wbindgen_add_to_stack_pointer(-16);$.jsroutesnapper_renderGeojson(n,this.ptr);var e=le()[n/4+0],t=le()[n/4+1];return ut(e,t)}finally{$.__wbindgen_add_to_stack_pointer(16),$.__wbindgen_free(e,t)}}setSnapMode(e){$.jsroutesnapper_setSnapMode(this.ptr,e)}onMouseMove(e,t,n){return $.jsroutesnapper_onMouseMove(this.ptr,e,t,n)!==0}onClick(){$.jsroutesnapper_onClick(this.ptr)}onDragStart(){return $.jsroutesnapper_onDragStart(this.ptr)!==0}onMouseUp(){return $.jsroutesnapper_onMouseUp(this.ptr)!==0}clearState(){$.jsroutesnapper_clearState(this.ptr)}editExisting(e){try{const i=$.__wbindgen_add_to_stack_pointer(-16);$.jsroutesnapper_editExisting(i,this.ptr,se(e));var t=le()[i/4+0],n=le()[i/4+1];if(n)throw wn(t)}finally{$.__wbindgen_add_to_stack_pointer(16)}}}async function Uo(r,e){if(typeof Response=="function"&&r instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(r,e)}catch(n){if(r.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",n);else throw n}const t=await r.arrayBuffer();return await WebAssembly.instantiate(t,e)}else{const t=await WebAssembly.instantiate(r,e);return t instanceof WebAssembly.Instance?{instance:t,module:r}:t}}function Wo(){const r={};return r.wbg={},r.wbg.__wbindgen_string_new=function(e,t){const n=ut(e,t);return se(n)},r.wbg.__wbindgen_object_drop_ref=function(e){wn(e)},r.wbg.__wbindgen_boolean_get=function(e){const t=D(e);return typeof t=="boolean"?t?1:0:2},r.wbg.__wbindgen_error_new=function(e,t){const n=new Error(ut(e,t));return se(n)},r.wbg.__wbindgen_is_object=function(e){const t=D(e);return typeof t=="object"&&t!==null},r.wbg.__wbindgen_is_undefined=function(e){return D(e)===void 0},r.wbg.__wbindgen_in=function(e,t){return D(e)in D(t)},r.wbg.__wbindgen_number_get=function(e,t){const n=D(t),i=typeof n=="number"?n:void 0;Xo()[e/8+1]=nn(i)?0:i,le()[e/4+0]=!nn(i)},r.wbg.__wbindgen_jsval_loose_eq=function(e,t){return D(e)==D(t)},r.wbg.__wbindgen_string_get=function(e,t){const n=D(t),i=typeof n=="string"?n:void 0;var o=nn(i)?0:Ft(i,$.__wbindgen_malloc,$.__wbindgen_realloc),s=Je;le()[e/4+1]=s,le()[e/4+0]=o},r.wbg.__wbg_String_91fba7ded13ba54c=function(e,t){const n=String(D(t)),i=Ft(n,$.__wbindgen_malloc,$.__wbindgen_realloc),o=Je;le()[e/4+1]=o,le()[e/4+0]=i},r.wbg.__wbindgen_object_clone_ref=function(e){const t=D(e);return se(t)},r.wbg.__wbg_getwithrefkey_15c62c2b8546208d=function(e,t){const n=D(e)[D(t)];return se(n)},r.wbg.__wbg_log_4b5638ad60bdc54a=function(e){console.log(D(e))},r.wbg.__wbg_get_57245cc7d7c7619d=function(e,t){const n=D(e)[t>>>0];return se(n)},r.wbg.__wbg_length_6e3bbe7c8bd4dbd8=function(e){return D(e).length},r.wbg.__wbindgen_is_function=function(e){return typeof D(e)=="function"},r.wbg.__wbg_next_579e583d33566a86=function(e){const t=D(e).next;return se(t)},r.wbg.__wbg_next_aaef7c8aa5e212ac=function(){return rn(function(e){const t=D(e).next();return se(t)},arguments)},r.wbg.__wbg_done_1b73b0672e15f234=function(e){return D(e).done},r.wbg.__wbg_value_1ccc36bc03462d71=function(e){const t=D(e).value;return se(t)},r.wbg.__wbg_iterator_6f9d4f28845f426c=function(){return se(Symbol.iterator)},r.wbg.__wbg_get_765201544a2b6869=function(){return rn(function(e,t){const n=Reflect.get(D(e),D(t));return se(n)},arguments)},r.wbg.__wbg_call_97ae9d8645dc388b=function(){return rn(function(e,t){const n=D(e).call(D(t));return se(n)},arguments)},r.wbg.__wbg_isArray_27c46c67f498e15d=function(e){return Array.isArray(D(e))},r.wbg.__wbg_instanceof_ArrayBuffer_e5e48f4762c5610b=function(e){let t;try{t=D(e)instanceof ArrayBuffer}catch{t=!1}return t},r.wbg.__wbg_buffer_3f3d764d4747d564=function(e){const t=D(e).buffer;return se(t)},r.wbg.__wbg_new_8c3f0052272a457a=function(e){const t=new Uint8Array(D(e));return se(t)},r.wbg.__wbg_set_83db9690f9353e79=function(e,t,n){D(e).set(D(t),n>>>0)},r.wbg.__wbg_length_9e1ae1900cb0fbd5=function(e){return D(e).length},r.wbg.__wbg_instanceof_Uint8Array_971eeda69eb75003=function(e){let t;try{t=D(e)instanceof Uint8Array}catch{t=!1}return t},r.wbg.__wbg_new_abda76e883ba8a5f=function(){const e=new Error;return se(e)},r.wbg.__wbg_stack_658279fe44541cf6=function(e,t){const n=D(t).stack,i=Ft(n,$.__wbindgen_malloc,$.__wbindgen_realloc),o=Je;le()[e/4+1]=o,le()[e/4+0]=i},r.wbg.__wbg_error_f851667af71bcfc6=function(e,t){try{console.error(ut(e,t))}finally{$.__wbindgen_free(e,t)}},r.wbg.__wbindgen_debug_string=function(e,t){const n=xn(D(t)),i=Ft(n,$.__wbindgen_malloc,$.__wbindgen_realloc),o=Je;le()[e/4+1]=o,le()[e/4+0]=i},r.wbg.__wbindgen_throw=function(e,t){throw new Error(ut(e,t))},r.wbg.__wbindgen_memory=function(){const e=$.memory;return se(e)},r}function Ho(r,e){return $=r.exports,$r.__wbindgen_wasm_module=e,Yt=new Float64Array,qt=new Int32Array,Gt=new Uint8Array,$}async function $r(r){typeof r>"u"&&(r="/atip/route_from_scratch/assets/route_snapper_bg.wasm");const e=Wo();(typeof r=="string"||typeof Request=="function"&&r instanceof Request||typeof URL=="function"&&r instanceof URL)&&(r=fetch(r));const{instance:t,module:n}=await Uo(await r,e);return Ho(t,n)}const Tt="route-snapper",_r=10,Vo=30;var Re,Ye;class Zo{constructor(e,t){nt(this,Re);fe(this,"map");fe(this,"inner");fe(this,"active");fe(this,"eventListenersSuccess");fe(this,"eventListenersFailure");this.map=e,console.time("Deserialize and setup JsRouteSnapper"),this.inner=new Wt(t),console.timeEnd("Deserialize and setup JsRouteSnapper"),this.active=!1,this.eventListenersSuccess=[],this.eventListenersFailure=[],Qe(e,Tt,{type:"geojson",data:Pe()}),me(e,{id:"route-points",source:Tt,filter:Vt,...dt(["match",["get","type"],"hovered","green","important","red","black"],["match",["get","type"],"unimportant",_r/2,_r])}),me(e,{id:"route-lines",source:Tt,filter:Zt,...Et("black",2.5)}),e.on("mousemove",n=>{if(!this.active)return;const i=[n.point.x-Vo,n.point.y],o=this.map.unproject(n.point).distanceTo(this.map.unproject(i));this.inner.onMouseMove(n.lngLat.lng,n.lngLat.lat,o)&&ie(this,Re,Ye).call(this)}),e.on("click",()=>{this.active&&(this.inner.onClick(),ie(this,Re,Ye).call(this))}),e.on("dragstart",n=>{this.active&&this.inner.onDragStart()&&this.map.dragPan.disable()}),e.on("mouseup",n=>{this.active&&this.inner.onMouseUp()&&this.map.dragPan.enable()}),document.addEventListener("keypress",n=>{this.active&&n.key=="Enter"&&(n.preventDefault(),this.finish())}),document.addEventListener("keydown",n=>{this.active&&n.key=="Shift"&&(n.preventDefault(),this.inner.setSnapMode(!1),ie(this,Re,Ye).call(this))}),document.addEventListener("keyup",n=>{this.active&&n.key=="Shift"&&(n.preventDefault(),this.inner.setSnapMode(!0),ie(this,Re,Ye).call(this))})}start(){this.active||(this.active=!0,this.map.boxZoom.disable())}stop(){this.active=!1,this.inner.clearState(),ie(this,Re,Ye).call(this),this.map.boxZoom.enable()}editExisting(e){this.active&&window.alert("Bug: editExisting called when tool is already active"),e.properties.waypoints||(e.properties.waypoints=[{lon:e.geometry.coordinates[0][0],lat:e.geometry.coordinates[0][1],snapped:!0},{lon:e.geometry.coordinates[e.geometry.coordinates.length-1][0],lat:e.geometry.coordinates[e.geometry.coordinates.length-1][1],snapped:!0}]),this.start(),this.inner.editExisting(e.properties.waypoints),ie(this,Re,Ye).call(this)}tearDown(){this.map.removeLayer("route-points"),this.map.removeLayer("route-lines"),this.map.removeSource("route-snapper")}addEventListenerSuccess(e){this.eventListenersSuccess.push(e)}addEventListenerFailure(e){this.eventListenersFailure.push(e)}isActive(){return this.active}finish(){let e=this.inner.toFinalFeature();if(e)for(let t of this.eventListenersSuccess)t(JSON.parse(e));else for(let t of this.eventListenersFailure)t();this.stop()}cancel(){this.inner.clearState(),this.finish()}setConfig(e){this.inner.setConfig(e),ie(this,Re,Ye).call(this)}}Re=new WeakSet,Ye=function(){this.map.getSource(Tt).setData(JSON.parse(this.inner.renderGeojson()))};function br(r){let e;return{c(){e=w("p"),e.textContent="Click an intervention to fill out its attributes"},m(t,n){S(t,e,n)},d(t){t&&k(e)}}}function Qo(r){let e,t=r[0]==ft&&br();return{c(){t&&t.c(),e=Te()},m(n,i){t&&t.m(n,i),S(n,e,i)},p(n,[i]){n[0]==ft?t||(t=br(),t.c(),t.m(e.parentNode,e)):t&&(t.d(1),t=null)},i:J,o:J,d(n){t&&t.d(n),n&&k(e)}}}const ft="edit-attribute";function Gr(){}function Ko(r,e,t){let n,i;ne(r,Ie,l=>t(4,n=l)),ne(r,Z,l=>t(5,i=l));let{mode:o}=e,{changeMode:s}=e;function a(){xe.set(null)}return n.on("mousemove",l=>{var u;if(o==ft){let p=n.queryRenderedFeatures(l.point,{layers:["interventions-points","interventions-lines","interventions-polygons"]});Fe.set(((u=p[0])==null?void 0:u.id)||null)}}),n.on("mouseout",()=>{o==ft&&Fe.set(null)}),n.on("click",l=>{if(o==ft){let u=n.queryRenderedFeatures(l.point,{layers:["interventions-points","interventions-lines","interventions-polygons"]});u.length>0?xe.set(u[0].id):xe.set(null)}}),an.subscribe(l=>{if(l){let u=i.features.find(p=>p.id==l);u.geometry.type=="Point"?n.flyTo({center:u.geometry.coordinates,duration:500}):n.fitBounds(Rn(u),{padding:200,duration:500}),s(ft)}}),r.$$set=l=>{"mode"in l&&t(0,o=l.mode),"changeMode"in l&&t(1,s=l.changeMode)},[o,s,Gr,a]}class es extends K{constructor(e){super(),ee(this,e,Ko,Qo,Q,{mode:0,changeMode:1,start:2,stop:3})}get start(){return Gr}get stop(){return this.$$.ctx[3]}}function wr(r){let e;return{c(){e=w("p"),e.textContent="Click an intervention to edit its geometry"},m(t,n){S(t,e,n)},d(t){t&&k(e)}}}function ts(r){let e,t=r[0]==qe&&wr();return{c(){t&&t.c(),e=Te()},m(n,i){t&&t.m(n,i),S(n,e,i)},p(n,[i]){n[0]==qe?t||(t=wr(),t.c(),t.m(e.parentNode,e)):t&&(t.d(1),t=null)},i:J,o:J,d(n){t&&t.d(n),n&&k(e)}}}const qe="edit-geometry";function Yr(){}function ns(r,e,t){let n;ne(r,Ie,d=>t(7,n=d));let{mode:i}=e,{pointTool:o}=e,{polygonTool:s}=e,{routeTool:a}=e;function l(){u&&(o.stop(),s.stop(),a.stop(),Z.update(d=>{let c=d.features.find(f=>f.id==u);return delete c.properties.hide_while_editing,d})),u=null,Fe.set(null)}let u=null;n.on("mousemove",d=>{var c;if(i==qe&&u==null){let f=n.queryRenderedFeatures(d.point,{layers:["interventions-points","interventions-lines","interventions-polygons"]});Fe.set(((c=f[0])==null?void 0:c.id)||null)}}),n.on("mouseout",()=>{i==qe&&u==null&&Fe.set(null)}),n.on("click",d=>{if(i==qe&&u==null){let c=n.queryRenderedFeatures(d.point,{layers:["interventions-points","interventions-lines","interventions-polygons"]});c.length>0&&p(c[0].id)}}),a.addEventListenerSuccess(d=>{i==qe&&(Z.update(c=>{let f=c.features.find(m=>m.id==u);return f.properties.length_meters=d.properties.length_meters,f.properties.waypoints=d.properties.waypoints,delete f.properties.hide_while_editing,f.geometry=d.geometry,c}),u=null)}),a.addEventListenerFailure(()=>{i==qe&&(Z.update(d=>{let c=d.features.find(f=>f.id==u);return delete c.properties.hide_while_editing,d}),u=null)});for(let d of[o,s])d.addEventListener(c=>{i==qe&&(Z.update(f=>{let m=f.features.find(y=>y.id==u);return m.geometry=c.geometry,delete m.properties.hide_while_editing,f}),u=null)});function p(d){Fe.set(null);let c=null;Z.update(m=>(c=m.features.find(y=>y.id==d),c.properties.hide_while_editing=!0,m));let f=c;u=d,f.geometry.type=="LineString"?a.editExisting(f):f.geometry.type=="Polygon"?s.editExisting(f):f.geometry.type=="Point"&&o.start()}return r.$$set=d=>{"mode"in d&&t(0,i=d.mode),"pointTool"in d&&t(1,o=d.pointTool),"polygonTool"in d&&t(2,s=d.polygonTool),"routeTool"in d&&t(3,a=d.routeTool)},[i,o,s,a,Yr,l]}class rs extends K{constructor(e){super(),ee(this,e,ns,ts,Q,{mode:0,pointTool:1,polygonTool:2,routeTool:3,start:4,stop:5})}get start(){return Yr}get stop(){return this.$$.ctx[5]}}async function is(r,e){const t=await fetch(r),n=t.body.getReader(),i=t.headers.get("Content-Length");let o=0,s=[];for(;;){const{done:u,value:p}=await n.read();if(u)break;s.push(p),o+=p.length;const d=100*o/i;e.style=`background: linear-gradient(to right, red ${d}%, transparent 0);`}let a=new Uint8Array(o),l=0;for(let u of s)a.set(u,l),l+=u.length;return a}function os(r){let e,t,n,i,o,s,a,l,u,p,d,c;return{c(){e=w("ul"),e.innerHTML=`<li><b>Click</b> green points on the transport network to create snapped routes</li> 
  <li>Hold <b>Shift</b> to draw a point anywhere</li> 
  <li><b>Click and drag</b> any point to move it</li> 
  <li><b>Click</b> a red waypoint to delete it</li> 
  <li>Press <b>Enter</b> to finish route</li>`,t=I(),n=w("label"),i=w("input"),o=z(`
  Avoid doubling back`),s=I(),a=w("div"),l=w("button"),l.textContent="Finish",u=I(),p=w("button"),p.textContent="Cancel",R(i,"type","checkbox"),R(l,"type","button"),R(p,"type","button"),we(a,"display","flex"),we(a,"justify-content","space-between")},m(f,m){S(f,e,m),S(f,t,m),S(f,n,m),_(n,i),i.checked=r[1],_(n,o),S(f,s,m),S(f,a,m),_(a,l),_(a,u),_(a,p),d||(c=[X(i,"change",r[2]),X(l,"click",r[3]),X(p,"click",r[4])],d=!0)},p(f,[m]){m&2&&(i.checked=f[1])},i:J,o:J,d(f){f&&k(e),f&&k(t),f&&k(n),f&&k(s),f&&k(a),d=!1,Ke(c)}}}function ss(r,e,t){let{routeTool:n}=e,i=!1;function o(){i=this.checked,t(1,i)}const s=()=>n.finish(),a=()=>n.cancel();return r.$$set=l=>{"routeTool"in l&&t(0,n=l.routeTool)},r.$$.update=()=>{r.$$.dirty&3&&n.setConfig({avoid_doubling_back:i})},[n,i,o,s,a]}class ls extends K{constructor(e){super(),ee(this,e,ss,os,Q,{routeTool:0})}}function as(r){let e,t;return e=new ls({props:{routeTool:r[0]}}),{c(){W(e.$$.fragment)},m(n,i){H(e,n,i),t=!0},p(n,i){const o={};i&1&&(o.routeTool=n[0]),e.$set(o)},i(n){t||(B(e.$$.fragment,n),t=!0)},o(n){q(e.$$.fragment,n),t=!1},d(n){V(e,n)}}}function us(r){let e;return{c(){e=w("div"),e.textContent="Route tool loading..."},m(t,n){S(t,e,n),r[7](e)},p:J,i:J,o:J,d(t){t&&k(e),r[7](null)}}}function fs(r){let e,t,n,i;const o=[us,as],s=[];function a(l,u){return l[0]?l[1]==Sn?1:-1:0}return~(e=a(r))&&(t=s[e]=o[e](r)),{c(){t&&t.c(),n=Te()},m(l,u){~e&&s[e].m(l,u),S(l,n,u),i=!0},p(l,[u]){let p=e;e=a(l),e===p?~e&&s[e].p(l,u):(t&&(Pt(),q(s[p],1,1,()=>{s[p]=null}),It()),~e?(t=s[e],t?t.p(l,u):(t=s[e]=o[e](l),t.c()),B(t,1),t.m(n.parentNode,n)):t=null)},i(l){i||(B(t),i=!0)},o(l){q(t),i=!1},d(l){~e&&s[e].d(l),l&&k(n)}}}const Sn="route";function cs(r,e,t){let n;ne(r,Ie,c=>t(8,n=c));let{mode:i}=e,{changeMode:o}=e,{url:s}=e,a,{routeTool:l}=e;function u(){l.isActive()||l.start()}function p(){l==null||l.stop()}Ln(async()=>{await $r(),console.log(`Grabbing ${s}`);try{const c=await is(s,a);t(0,l=new Zo(n,c))}catch(c){console.log(`Route tool broke: ${c}`),t(2,a.innerHTML="Failed to load",a)}l.addEventListenerFailure(()=>{i==Sn&&o("edit-attribute")}),l.addEventListenerSuccess(c=>{i==Sn&&(Z.update(f=>(c.id=Qt(f),c.properties.intervention_type="route",f.features.push(c),f)),o("edit-attribute"),xe.set(c.id))})}),On(()=>{l==null||l.tearDown()});function d(c){pe[c?"unshift":"push"](()=>{a=c,t(2,a)})}return r.$$set=c=>{"mode"in c&&t(1,i=c.mode),"changeMode"in c&&t(3,o=c.changeMode),"url"in c&&t(4,s=c.url),"routeTool"in c&&t(0,l=c.routeTool)},[l,i,a,o,s,u,p,d]}class hs extends K{constructor(e){super(),ee(this,e,cs,fs,Q,{mode:1,changeMode:3,url:4,routeTool:0,start:5,stop:6})}get start(){return this.$$.ctx[5]}get stop(){return this.$$.ctx[6]}}function xr(r){let e;return{c(){e=w("p"),e.textContent="Click to add a new point"},m(t,n){S(t,e,n)},d(t){t&&k(e)}}}function ps(r){let e,t=r[0]==kn&&xr();return{c(){t&&t.c(),e=Te()},m(n,i){t&&t.m(n,i),S(n,e,i)},p(n,[i]){n[0]==kn?t||(t=xr(),t.c(),t.m(e.parentNode,e)):t&&(t.d(1),t=null)},i:J,o:J,d(n){t&&t.d(n),n&&k(e)}}}const kn="point";function ds(r,e,t){let{mode:n}=e,{changeMode:i}=e,{pointTool:o}=e;function s(){o.start()}function a(){o.stop()}return o.addEventListener(l=>{n==kn&&(Z.update(u=>(l.id=Qt(u),l.properties.intervention_type="other",u.features.push(l),u)),i("edit-attribute"),xe.set(l.id))}),r.$$set=l=>{"mode"in l&&t(0,n=l.mode),"changeMode"in l&&t(1,i=l.changeMode),"pointTool"in l&&t(2,o=l.pointTool)},[n,i,o,s,a]}class gs extends K{constructor(e){super(),ee(this,e,ds,ps,Q,{mode:0,changeMode:1,pointTool:2,start:3,stop:4})}get start(){return this.$$.ctx[3]}get stop(){return this.$$.ctx[4]}}function Sr(r){let e;return{c(){e=w("p"),e.innerHTML="Click the map to add a vertex, or click a vertex to delete it. Press <strong>Enter</strong> to finish. Drag a vertex or the polygon to move."},m(t,n){S(t,e,n)},d(t){t&&k(e)}}}function ms(r){let e,t=r[0]==En&&Sr();return{c(){t&&t.c(),e=Te()},m(n,i){t&&t.m(n,i),S(n,e,i)},p(n,[i]){n[0]==En?t||(t=Sr(),t.c(),t.m(e.parentNode,e)):t&&(t.d(1),t=null)},i:J,o:J,d(n){t&&t.d(n),n&&k(e)}}}const En="polygon";function vs(r,e,t){let{mode:n}=e,{changeMode:i}=e,{polygonTool:o}=e;function s(){o.startNew()}function a(){o.stop()}return o.addEventListener(l=>{n==En&&(Z.update(u=>(l.id=Qt(u),l.properties.intervention_type="area",u.features.push(l),u)),i("edit-attribute"),xe.set(l.id))}),r.$$set=l=>{"mode"in l&&t(0,n=l.mode),"changeMode"in l&&t(1,i=l.changeMode),"polygonTool"in l&&t(2,o=l.polygonTool)},[n,i,o,s,a]}class ys extends K{constructor(e){super(),ee(this,e,vs,ms,Q,{mode:0,changeMode:1,polygonTool:2,start:3,stop:4})}get start(){return this.$$.ctx[3]}get stop(){return this.$$.ctx[4]}}function _s(r){var e=r[0],t=r[1],n=r[2],i=r[3],o=je(r.slice(0,2),[n,t]),s=je(r.slice(0,2),[e,i]);if(o>=s){var a=(t+i)/2;return[e,a-(n-e)/2,n,a+(n-e)/2]}else{var l=(e+n)/2;return[l-(i-t)/2,t,l+(i-t)/2,i]}}function bs(r,e){e===void 0&&(e={});var t=e.precision,n=e.coordinates,i=e.mutate;if(t=t==null||isNaN(t)?6:t,n=n==null||isNaN(n)?3:n,!r)throw new Error("<geojson> is required");if(typeof t!="number")throw new Error("<precision> must be a number");if(typeof n!="number")throw new Error("<coordinates> must be a number");(i===!1||i===void 0)&&(r=JSON.parse(JSON.stringify(r)));var o=Math.pow(10,t);return ui(r,function(s){ws(s,o,n)}),r}function ws(r,e,t){r.length>t&&r.splice(t,r.length);for(var n=0;n<r.length;n++)r[n]=Math.round(r[n]*e)/e;return r}function xs(r,e){if(!r)throw new Error("line is required");if(!e)throw new Error("splitter is required");var t=gn(r),n=gn(e);if(t!=="LineString")throw new Error("line must be LineString");if(n==="FeatureCollection")throw new Error("splitter cannot be a FeatureCollection");if(n==="GeometryCollection")throw new Error("splitter cannot be a GeometryCollection");var i=bs(e,{precision:7});switch(n){case"Point":return Mn(r,i);case"MultiPoint":return kr(r,i);case"LineString":case"MultiLineString":case"Polygon":case"MultiPolygon":return kr(r,Tr(r,i))}}function kr(r,e){var t=[],n=pt();return Nn(e,function(i){if(t.forEach(function(a,l){a.id=l}),!t.length)t=Mn(r,i).features,t.forEach(function(a){a.bbox||(a.bbox=_s(fi(a)))}),n.load(ze(t));else{var o=n.search(i);if(o.features.length){var s=qr(i,o);t=t.filter(function(a){return a.id!==s.id}),n.remove(s),jt(Mn(s,i),function(a){t.push(a),n.insert(a)})}}}),ze(t)}function Mn(r,e){var t=[],n=Ae(r)[0],i=Ae(r)[r.geometry.coordinates.length-1];if(on(n,Ue(e))||on(i,Ue(e)))return ze([r]);var o=pt(),s=vn(r);o.load(s);var a=o.search(e);if(!a.features.length)return ze([r]);var l=qr(e,a),u=[n],p=ci(s,function(d,c,f){var m=Ae(c)[1],y=Ue(e);return f===l.id?(d.push(y),t.push(ht(d)),on(y,m)?[y]:[y,m]):(d.push(m),d)},u);return p.length>1&&t.push(ht(p)),ze(t)}function qr(r,e){if(!e.features.length)throw new Error("lines must contain features");if(e.features.length===1)return e.features[0];var t,n=1/0;return jt(e,function(i){var o=Lt(i,r),s=o.properties.dist;s<n&&(t=i,n=s)}),t}function on(r,e){return r[0]===e[0]&&r[1]===e[1]}function Ss(r,e,t){var n=Ae(t);if(gn(t)!=="LineString")throw new Error("line must be a LineString");var i=Lt(t,r),o=Lt(t,e),s;i.properties.index<=o.properties.index?s=[i,o]:s=[o,i];for(var a=[s[0].geometry.coordinates],l=s[0].properties.index+1;l<s[1].properties.index+1;l++)a.push(n[l]);return a.push(s[1].geometry.coordinates),ht(a,t.properties)}function Er(r){let e;return{c(){e=w("p"),e.textContent="Click near a route to split it, or click on the map to cancel"},m(t,n){S(t,e,n)},d(t){t&&k(e)}}}function ks(r){let e,t=r[0]==Ht&&Er();return{c(){t&&t.c(),e=Te()},m(n,i){t&&t.m(n,i),S(n,e,i)},p(n,[i]){n[0]==Ht?t||(t=Er(),t.c(),t.m(e.parentNode,e)):t&&(t.d(1),t=null)},i:J,o:J,d(n){t&&t.d(n),n&&k(e)}}}const Ht="split-route",Es=10,Ms=30;let sn="split-route";function Dr(){}function Mr(r,e){return{type:"Feature",properties:{snapped:e},geometry:{type:"Point",coordinates:r}}}function Ls(r,e,t){let n,i;ne(r,Ie,c=>t(5,n=c)),ne(r,Z,c=>t(7,i=c));let{mode:o}=e,{changeMode:s}=e;function a(){t(4,l=null),u=null}let l=null,u=null;n.on("mousemove",c=>{if(o!=Ht)return;t(4,l=Mr(c.lngLat.toArray(),!1)),u=null;const f=[c.point.x-Ms,c.point.y],m=n.unproject(c.point).distanceTo(n.unproject(f))/1e3;let y=[];for(let[b,A]of i.features.entries())if(A.geometry.type=="LineString"){let h=Lt(A.geometry,l,{units:"kilometers"});h.properties.dist!=null&&h.properties.dist<=m&&y.push([b,h.geometry.coordinates,h.properties.dist])}y.sort((b,A)=>b[2]-A[2]),y.length>0&&(t(4,l=Mr(y[0][1],!0)),u=y[0][0])}),n.on("click",()=>{if(o==Ht)if(u==null)s("edit-attribute");else{let c=xs(i.features[u],l);if(c.features.length==2){let f=c.features[0],m=c.features[1];Z.update(y=>(f.id=y.features[u].id,m.id=Qt(y),f.properties=JSON.parse(JSON.stringify(y.features[u].properties)),m.properties=JSON.parse(JSON.stringify(f.properties)),p(y.features[u],f,m,l),y.features.splice(u,1,f,m),y))}a()}}),Qe(n,sn,{type:"geojson",data:Pe()}),me(n,{id:"draw-split-route",source:sn,...dt("black",Es,["case",["==",["get","snapped"],!0],1,.5])});function p(c,f,m,y){f.properties.length_meters=$t(f,{units:"kilometers"})*1e3,m.properties.length_meters=$t(m,{units:"kilometers"})*1e3,f.properties.waypoints=[],m.properties.waypoints=[];let b=d(c,y),A=!0,h=0;for(let g of c.properties.waypoints){let v=d(c,ct([g.lon,g.lat]));if(A)if(v<b)f.properties.waypoints.push(g);else{let E=g.snapped&&c.properties.waypoints[h-1].snapped;f.properties.waypoints.push({lon:y.geometry.coordinates[0],lat:y.geometry.coordinates[1],snapped:E}),A=!1,m.properties.waypoints.push({lon:y.geometry.coordinates[0],lat:y.geometry.coordinates[1],snapped:E}),m.properties.waypoints.push(g)}else m.properties.waypoints.push(g);h++}}function d(c,f){let m=c.geometry.coordinates[0],y=Ss(m,f,c);return $t(y,{units:"kilometers"})*1e3}return r.$$set=c=>{"mode"in c&&t(0,o=c.mode),"changeMode"in c&&t(1,s=c.changeMode)},r.$$.update=()=>{if(r.$$.dirty&48){let c=Pe();l&&c.features.push(l),n.getSource(sn).setData(c)}},[o,s,Dr,a,l,n]}class Os extends K{constructor(e){super(),ee(this,e,Ls,ks,Q,{mode:0,changeMode:1,start:2,stop:3})}get start(){return Dr}get stop(){return this.$$.ctx[3]}}function Lr(r){let e,t,n={mode:r[2],pointTool:r[9],polygonTool:r[10],routeTool:r[1]};return e=new rs({props:n}),r[15](e),{c(){W(e.$$.fragment)},m(i,o){H(e,i,o),t=!0},p(i,o){const s={};o&4&&(s.mode=i[2]),o&2&&(s.routeTool=i[1]),e.$set(s)},i(i){t||(B(e.$$.fragment,i),t=!0)},o(i){q(e.$$.fragment,i),t=!1},d(i){r[15](null),V(e,i)}}}function Rs(r){let e,t,n,i,o,s,a,l,u,p,d,c,f,m,y,b,A,h,g,v,E,O,L,M,N,T,C,G,x,F,re,de,be,oe,ye,ke,ge,U,et,Be,$e,ae,ce,tt,Ge,mt={mode:r[2],changeMode:r[11]};a=new es({props:mt}),r[13](a);let te=r[1]&&Lr(r),he={mode:r[2],changeMode:r[11],pointTool:r[9]};v=new gs({props:he}),r[17](v);let P={mode:r[2],changeMode:r[11],polygonTool:r[10]};C=new ys({props:P}),r[19](C);function Y(j){r[22](j)}let Tn={mode:r[2],changeMode:r[11],url:r[0]};r[1]!==void 0&&(Tn.routeTool=r[1]),oe=new hs({props:Tn}),r[21](oe),pe.push(()=>Ve(oe,"routeTool",Y,r[1]));let jr={mode:r[2],changeMode:r[11]};return ae=new Os({props:jr}),r[24](ae),{c(){e=w("div"),t=w("div"),n=w("button"),i=z("Edit attributes"),s=I(),W(a.$$.fragment),l=I(),u=w("div"),p=w("button"),d=z("Edit geometry"),f=I(),te&&te.c(),m=I(),y=w("div"),b=w("button"),A=z("New point"),g=I(),W(v.$$.fragment),E=I(),O=w("div"),L=w("button"),M=z("New polygon"),T=I(),W(C.$$.fragment),G=I(),x=w("div"),F=w("button"),re=z("New route"),be=I(),W(oe.$$.fragment),ke=I(),ge=w("div"),U=w("button"),et=z("Split route"),$e=I(),W(ae.$$.fragment),R(n,"type","button"),n.disabled=o=r[2]=="edit-attribute",R(n,"class","svelte-cej5os"),R(p,"type","button"),p.disabled=c=r[2]=="edit-geometry",R(p,"class","svelte-cej5os"),R(b,"type","button"),b.disabled=h=r[2]=="point",R(b,"class","svelte-cej5os"),R(L,"type","button"),L.disabled=N=r[2]=="polygon",R(L,"class","svelte-cej5os"),R(F,"type","button"),F.disabled=de=r[2]=="route",R(F,"class","svelte-cej5os"),R(U,"type","button"),U.disabled=Be=r[2]=="split-route",R(U,"class","svelte-cej5os"),R(e,"class","toolbox svelte-cej5os")},m(j,ue){S(j,e,ue),_(e,t),_(t,n),_(n,i),_(t,s),H(a,t,null),_(e,l),_(e,u),_(u,p),_(p,d),_(u,f),te&&te.m(u,null),_(e,m),_(e,y),_(y,b),_(b,A),_(y,g),H(v,y,null),_(e,E),_(e,O),_(O,L),_(L,M),_(O,T),H(C,O,null),_(e,G),_(e,x),_(x,F),_(F,re),_(x,be),H(oe,x,null),_(e,ke),_(e,ge),_(ge,U),_(U,et),_(ge,$e),H(ae,ge,null),ce=!0,tt||(Ge=[X(n,"click",r[12]),X(p,"click",r[14]),X(b,"click",r[16]),X(L,"click",r[18]),X(F,"click",r[20]),X(U,"click",r[23])],tt=!0)},p(j,[ue]){(!ce||ue&4&&o!==(o=j[2]=="edit-attribute"))&&(n.disabled=o);const Bn={};ue&4&&(Bn.mode=j[2]),a.$set(Bn),(!ce||ue&4&&c!==(c=j[2]=="edit-geometry"))&&(p.disabled=c),j[1]?te?(te.p(j,ue),ue&2&&B(te,1)):(te=Lr(j),te.c(),B(te,1),te.m(u,null)):te&&(Pt(),q(te,1,1,()=>{te=null}),It()),(!ce||ue&4&&h!==(h=j[2]=="point"))&&(b.disabled=h);const $n={};ue&4&&($n.mode=j[2]),v.$set($n),(!ce||ue&4&&N!==(N=j[2]=="polygon"))&&(L.disabled=N);const Gn={};ue&4&&(Gn.mode=j[2]),C.$set(Gn),(!ce||ue&4&&de!==(de=j[2]=="route"))&&(F.disabled=de);const Nt={};ue&4&&(Nt.mode=j[2]),ue&1&&(Nt.url=j[0]),!ye&&ue&2&&(ye=!0,Nt.routeTool=j[1],Ze(()=>ye=!1)),oe.$set(Nt),(!ce||ue&4&&Be!==(Be=j[2]=="split-route"))&&(U.disabled=Be);const Yn={};ue&4&&(Yn.mode=j[2]),ae.$set(Yn)},i(j){ce||(B(a.$$.fragment,j),B(te),B(v.$$.fragment,j),B(C.$$.fragment,j),B(oe.$$.fragment,j),B(ae.$$.fragment,j),ce=!0)},o(j){q(a.$$.fragment,j),q(te),q(v.$$.fragment,j),q(C.$$.fragment,j),q(oe.$$.fragment,j),q(ae.$$.fragment,j),ce=!1},d(j){j&&k(e),r[13](null),V(a),te&&te.d(),r[17](null),V(v),r[19](null),V(C),r[21](null),V(oe),r[24](null),V(ae),tt=!1,Ke(Ge)}}}function As(r,e,t){let n;ne(r,Ie,x=>t(25,n=x));let{routeUrl:i}=e,o,s=new Ao(n),a=new Do(n),l="edit-attribute",u,p,d,c,f,m;function y(x){let F={"edit-attribute":u,"edit-geometry":p,route:d,point:c,polygon:f,"split-route":m};if(l==x){console.log(`Mode is already ${l}, not changing`);return}console.log(`Stopping old mode ${l}`),F[l].stop(),t(2,l=x),console.log(`Starting new mode ${l}`),F[l].start()}On(()=>{s==null||s.tearDown(),a==null||a.tearDown()});const b=()=>y("edit-attribute");function A(x){pe[x?"unshift":"push"](()=>{u=x,t(3,u)})}const h=()=>y("edit-geometry");function g(x){pe[x?"unshift":"push"](()=>{p=x,t(4,p)})}const v=()=>y("point");function E(x){pe[x?"unshift":"push"](()=>{c=x,t(6,c)})}const O=()=>y("polygon");function L(x){pe[x?"unshift":"push"](()=>{f=x,t(7,f)})}const M=()=>y("route");function N(x){pe[x?"unshift":"push"](()=>{d=x,t(5,d)})}function T(x){o=x,t(1,o)}const C=()=>y("split-route");function G(x){pe[x?"unshift":"push"](()=>{m=x,t(8,m)})}return r.$$set=x=>{"routeUrl"in x&&t(0,i=x.routeUrl)},[i,o,l,u,p,d,c,f,m,s,a,y,b,A,h,g,v,E,O,L,M,N,T,C,G]}class Ps extends K{constructor(e){super(),ee(this,e,As,Rs,Q,{routeUrl:0})}}function Is(r){let e,t,n,i,o,s,a,l;return{c(){e=w("div"),t=w("button"),t.textContent="Home",n=I(),i=w("button"),i.textContent="About",o=I(),s=w("button"),s.textContent="Instructions",R(t,"type","button"),R(i,"type","button"),R(s,"type","button"),R(e,"slot","nav")},m(u,p){S(u,e,p),_(e,t),_(e,n),_(e,i),_(e,o),_(e,s),a||(l=[X(t,"click",r[8]),X(i,"click",r[6]),X(s,"click",r[7])],a=!0)},p:J,d(u){u&&k(e),a=!1,Ke(l)}}}function Ns(r){let e,t,n,i,o,s,a,l,u,p,d,c;return o=new bo({props:{boundaryGeojson:r[3]}}),a=new mo({props:{authorityName:r[4]}}),d=new fo({}),{c(){e=w("div"),t=w("h1"),n=z(r[4]),i=I(),W(o.$$.fragment),s=I(),W(a.$$.fragment),l=I(),u=w("br"),p=I(),W(d.$$.fragment),R(e,"slot","sidebar")},m(f,m){S(f,e,m),_(e,t),_(t,n),_(t,i),H(o,t,null),_(e,s),H(a,e,null),_(e,l),_(e,u),_(e,p),H(d,e,null),c=!0},p(f,m){const y={};m&8&&(y.boundaryGeojson=f[3]),o.$set(y)},i(f){c||(B(o.$$.fragment,f),B(a.$$.fragment,f),B(d.$$.fragment,f),c=!0)},o(f){q(o.$$.fragment,f),q(a.$$.fragment,f),q(d.$$.fragment,f),c=!1},d(f){f&&k(e),V(o),V(a),V(d)}}}function Cs(r){let e,t,n,i,o,s,a,l,u,p,d,c;return e=new Ki({props:{boundaryGeojson:r[3]}}),n=new Lo({}),o=new Ro({}),a=new Ps({props:{routeUrl:r[2]}}),u=new So({props:{style:r[5]}}),d=new Eo({}),{c(){W(e.$$.fragment),t=I(),W(n.$$.fragment),i=I(),W(o.$$.fragment),s=I(),W(a.$$.fragment),l=I(),W(u.$$.fragment),p=I(),W(d.$$.fragment)},m(f,m){H(e,f,m),S(f,t,m),H(n,f,m),S(f,i,m),H(o,f,m),S(f,s,m),H(a,f,m),S(f,l,m),H(u,f,m),S(f,p,m),H(d,f,m),c=!0},p(f,m){const y={};m&8&&(y.boundaryGeojson=f[3]),e.$set(y);const b={};m&4&&(b.routeUrl=f[2]),a.$set(b)},i(f){c||(B(e.$$.fragment,f),B(n.$$.fragment,f),B(o.$$.fragment,f),B(a.$$.fragment,f),B(u.$$.fragment,f),B(d.$$.fragment,f),c=!0)},o(f){q(e.$$.fragment,f),q(n.$$.fragment,f),q(o.$$.fragment,f),q(a.$$.fragment,f),q(u.$$.fragment,f),q(d.$$.fragment,f),c=!1},d(f){V(e,f),f&&k(t),V(n,f),f&&k(i),V(o,f),f&&k(s),V(a,f),f&&k(l),V(u,f),f&&k(p),V(d,f)}}}function Fs(r){let e,t,n;return t=new bi({props:{style:r[5],$$slots:{default:[Cs]},$$scope:{ctx:r}}}),{c(){e=w("div"),W(t.$$.fragment),R(e,"slot","main")},m(i,o){S(i,e,o),H(t,e,null),n=!0},p(i,o){const s={};o&16396&&(s.$$scope={dirty:o,ctx:i}),t.$set(s)},i(i){n||(B(t.$$.fragment,i),n=!0)},o(i){q(t.$$.fragment,i),n=!1},d(i){i&&k(e),V(t)}}}function Ts(r){let e,t,n,i,o,s,a,l;e=new Mi({props:{$$slots:{main:[Fs],sidebar:[Ns],nav:[Is]},$$scope:{ctx:r}}});function u(f){r[9](f)}let p={};r[0]!==void 0&&(p.open=r[0]),n=new hi({props:p}),pe.push(()=>Ve(n,"open",u,r[0]));function d(f){r[10](f)}let c={};return r[1]!==void 0&&(c.open=r[1]),s=new vi({props:c}),pe.push(()=>Ve(s,"open",d,r[1])),{c(){W(e.$$.fragment),t=I(),W(n.$$.fragment),o=I(),W(s.$$.fragment)},m(f,m){H(e,f,m),S(f,t,m),H(n,f,m),S(f,o,m),H(s,f,m),l=!0},p(f,[m]){const y={};m&16396&&(y.$$scope={dirty:m,ctx:f}),e.$set(y);const b={};!i&&m&1&&(i=!0,b.open=f[0],Ze(()=>i=!1)),n.$set(b);const A={};!a&&m&2&&(a=!0,A.open=f[1],Ze(()=>a=!1)),s.$set(A)},i(f){l||(B(e.$$.fragment,f),B(n.$$.fragment,f),B(s.$$.fragment,f),l=!0)},o(f){q(e.$$.fragment,f),q(n.$$.fragment,f),q(s.$$.fragment,f),l=!1},d(f){V(e,f),f&&k(t),V(n,f),f&&k(o),V(s,f)}}}function Bs(r,e,t){let n=!1,i=!1,o=window.location.hostname.includes("atip.uk");const s=new URLSearchParams(window.location.search);let a=s.get("authority"),l=s.get("style")||"streets";var u=`https://atip.uk/route-snappers/${a}.bin`;o||(u=`https://atip.uk/route-snappers-dev/${a}.bin`);function p(){t(0,n=!n),t(1,i=!1)}function d(){t(1,i=!i),t(0,n=!1)}let c;Ln(async()=>{t(3,c=await f())});async function f(){const h=await(await fetch(pi)).text(),g=JSON.parse(h);return g.features=g.features.filter(v=>{var E;return((E=v.properties)==null?void 0:E.name)==a}),g}const m=()=>window.open("index.html");function y(A){n=A,t(0,n)}function b(A){i=A,t(1,i)}return[n,i,u,c,a,l,p,d,m,y,b]}class $s extends K{constructor(e){super(),ee(this,e,Bs,Ts,Q,{})}}new $s({target:document.getElementById("app")});
