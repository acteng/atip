<!DOCTYPE html>
<html>
  <head>
    <title>ATIP Route Interventions</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
    <script src="deps/geojson-extent.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.3.0/mapbox-gl-draw.js"></script>
    <script type="module">
      import { App, makeCommonFormFields } from "./app.js";
      import { dropdown } from "./forms.js";
      import { RouteSnapper } from "./route-snapper/lib.js";

      const drawControls = new MapboxDraw({
        displayControlsDefault: false,
        controls: {
          line_string: true,
        },
        // make the lines thicker and dashed
        styles: [
          {
            id: "gl-draw-line",
            type: "line",
            filter: ["==", "$type", "LineString"],
            layout: {
              "line-cap": "round",
              "line-join": "round",
            },
            paint: {
              "line-color": "black",
              "line-dasharray": [0.2, 2],
              "line-width": 5,
            },
          },
        ],
      });
      window.app = new App("routes", drawControls, makeForm, saveForm);

      async function setupRouteSnapper() {
        // TODO Slight hack. These files are stored in an S3 bucket, which only has an HTTP interface. When deployed to Github pages over HTTPS, we can't mix HTTP and HTTPS content, so use the Cloudfront HTTPS interface. That'll need CDN invalidations when we update these files. But when serving locally for development, HTTPS is also fine to use.
        const url = `https://play.abstreet.org/route-snappers/${window.app.authority}.bin`;
        console.log(`Grabbing ${url}`);
        const resp = await fetch(url);
        const mapBytes = await resp.arrayBuffer();
        window.routeSnapper = new RouteSnapper(
          window.app,
          new Uint8Array(mapBytes)
        );
      }
      await setupRouteSnapper();

      document.getElementById("export").onclick = () => {
        window.app.downloadGeojsonFile();
      };
      document.getElementById("load_geojson").onchange = (e) => {
        window.app.loadFromGeojson(e);
      };

      // Properties may all be missing
      function makeForm(props) {
        return `
		${makeCommonFormFields(props)}

           <fieldset>
           <legend>Route type</legend>
           ${dropdown(
             props,
             "route_type",
             "The main type of active travel infrastructure along the route",
             [
               "Footpath",
               "Shared use footpath/cycleway",
               "Cycleway",
               "Contraflow",
               "Quietway",
             ]
           )}
           ${dropdown(
             props,
             "on_carriageway",
             "The main way in which the route relates to roads",
             [
               "Parallel to major road(s)",
               "Parallel to minor road(s)",
               "Off carriageway on existing route",
             ]
           )}
           ${dropdown(
             props,
             "reallocation",
             "The main source of new space for active travel",
             [
               "Reallocation of a complete vehicular lane on the carriageway",
               "Road diet: vehicular carriageway thinned, creating new space",
               "Pavement diet: existing pavement space reallocated",
               "Verge or other unused space reallocated",
             ]
           )}
           ${dropdown(
             props,
             "separation",
             "The main way in which the route is separated from motor traffic",
             [
               "Full separation",
               "Stepped",
               "Part separation",
               "Mandatory lane",
               "Advisory lane",
               "On carriageway (e.g. through modal filters)",
             ]
           )}
               <div class="form-row">
                 <label for="width">Average width of the route in metres:</label>
                 <input type="number" id="width" value="${
                   props.width || ""
                 }" min="0.0" step="0.1">
           </fieldset>
           `;
      }

      function saveForm(app, id) {
        for (const key of [
          "intervention_name",
          "intervention_description",
          "year",
          "budget",
          "route_type",
          "on_carriageway",
          "reallocation",
          "separation",
          "width",
        ]) {
          app.drawControls.setFeatureProperty(
            id,
            key,
            document.getElementById(key).value
          );
        }
      }
    </script>
    <link
      href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.3.0/mapbox-gl-draw.css"
      type="text/css"
    />
    <link rel="stylesheet" href="map_with_sidebar.css" type="text/css" />
    <style>
      .overlay-topright {
        position: absolute;
        top: 80px;
        right: 10px;
        padding: 10px;

        background-color: white;
      }
    </style>
  </head>

  <body>
    <aside id="sidebar">
      <div class="sidebar-content content-container">
        <nav style="justify-content: flex-start">
          <a href="index.html">Home</a>
          <button
            type="button"
            class="link-button"
            style="margin-top: 6px"
            onclick="document.getElementById('credits').classList.toggle('hide-modal');"
          >
            Credits
          </button>
        </nav>
        <nav>
          <a href="areas.html" class="authority-link">Areas</a>
          <a href="crossings.html" class="authority-link">Crossings</a>
          <a href="routes.html" class="authority-link">Routes</a>
          <a href="other.html" class="authority-link">Other</a>
        </nav>

        <h2>Route Interventions</h2>
        <h1 id="authority">Loading...</h1>

        <button type="button" id="export">Export to GeoJSON</button>
        <p>Load from GeoJSON: <input type="file" id="load_geojson" /></p>

        <div id="intervention_list"></div>

        <div
          class="sidebar-toggle rounded-rect left"
          onclick="document.getElementById('sidebar').classList.toggle('collapsed'); app.map.resize();"
        >
          &rarr;
        </div>
      </div>
    </aside>

    <main>
      <div id="map">
        <div id="basemaps-wrapper">
          <select id="basemaps">
            <option value="streets">Regular map</option>
            <option value="hybrid">Satellite</option>
          </select>
        </div>
      </div>
      <div id="panel" class="content-container"></div>
      <div id="snap-tool" class="overlay-topright">
        Route snapping tool loading...
      </div>
    </main>

    <div id="credits"></div>
  </body>
</html>
